<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_term.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_term.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_term.ML
    Author:     Sascha Boehme

Internal language of the Argo solver.

Terms are fully-shared via hash-consing. Alpha-equivalent terms have the same identifier.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* data types *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>meta</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> meta * Argo_Expr.kind * term list

  </span><span class="comment1"><span>(* term operations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> id_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> expr_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.typ</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_term</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> * </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> term_ord</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>ord</span><span>

  </span><span class="comment1"><span>(* context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* identifying expressions *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Expr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Expr.expr </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>identified</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Known</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> identify_item</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>identified</span></span><span> * </span><span class="entity"><span>context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Term</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* data types *)</span></span><span>

</span><span class="comment1"><span>(*
  The type meta is intentionally hidden to prevent that functions outside of this structure
  are able to build terms. Meta stores the identifier of the term as well as the complete
  expression underlying the term.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>meta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * Argo_Expr.expr
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> meta * Argo_Expr.kind * term list


</span><span class="comment1"><span>(* term operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>e</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.type_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  Comparing terms is fast as only the identifiers are compared. No expressions need to
  be taken into account.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id_of</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id_of</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id_of</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id_of</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* sharing of terms *)</span></span><span>

</span><span class="comment1"><span>(*
  Kinds are short representation of expressions. Constants and numbers carry additional
  information and have no arguments. Their kind is hence similar to them. All other expressions
  are stored in a flat way with identifiers of shared terms as arguments instead of expression
  as arguments.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Con</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * Argo_Expr.typ </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Num</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Rat.rat </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Exp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int list

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kind_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Con</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Con</span></span><span> </span><span class="entity"><span>c</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kind_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>n</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kind_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Exp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.int_of_kind</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_of_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Con</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>int_of_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>int_of_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exp</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kind_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Con</span></span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Con</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.con_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kind_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rat.ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kind_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exp</span></span><span> </span><span class="entity"><span>is1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Exp</span></span><span> </span><span class="entity"><span>is2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dict_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kind_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_of_kind</span></span><span> </span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_of_kind</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Kindtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind_ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  The context keeps track of the next unused identifier as well as all shared terms,
  which are indexed by their unique kind. For each term, a boolean marker flag is stored.
  When set to true on an atom, the atom is already asserted to the solver core. When set to
  true on an if-then-else term, the term has already been lifted.

  Zero is intentionally avoided as identifier, since literals use term identifiers
  with a sign as literal identifiers.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  next_id</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
  terms</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>Kindtab.table</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>next_id</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>next_id</span><span class="main"><span>=</span></span><span class="entity"><span>next_id</span></span><span class="main"><span>,</span></span><span> terms</span><span class="main"><span>=</span></span><span class="entity"><span>terms</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>Kindtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_atom</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>next_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>next_id</span></span><span> </span><span class="main"><span>(</span></span><span>Kindtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>note_atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_unique_id</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>next_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_id</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Kindtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_atom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Kindtab.lookup</span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>note_atom</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>with_unique_id</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* identifying expressions *)</span></span><span>

</span><span class="comment1"><span>(*
  Only atoms, i.e., boolean propositons, and if-then-else expressions need to be identified.
  Other terms are identified implicitly. The identification process works bottom-up.

  The solver core needs to know whether an atom has already been added. Likewise, the clausifier
  needs to know whether an if-then-else expression has already been lifted. Therefore,
  the identified term is marked as either "new" when identified for the first time or
  "known" when it has already been identified before.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Expr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Expr.expr </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>identified</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Known</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identify_head</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind_of</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>id_of</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identify</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>identify_head</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span> </span><span>oo</span><span> </span><span class="entity"><span>identify</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identified</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Known</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identified</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identify_item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Expr</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identify</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>identified</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identify_item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>identify_head</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>identified</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Termtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.term_ord</span></span><span class="main"><span>)</span></span><span>
</span></pre>
</body>

</html>