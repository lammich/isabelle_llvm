<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_cdcl.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_cdcl.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_cdcl.ML
    Author:     Sascha Boehme

Propositional satisfiability solver in the style of conflict-driven
clause-learning (CDCL). It features:

 * conflict analysis and clause learning based on the first unique implication point
 * nonchronological backtracking
 * dynamic variable ordering (VSIDS)
 * restarting
 * polarity caching
 * propagation via two watched literals
 * special propagation of binary clauses 
 * minimizing learned clauses
 * support for external knowledge

These features might be added:

 * pruning of unnecessary learned clauses
 * rebuilding the variable heap
 * aligning the restart level with the decision heuristics: keep decisions that would
   be recovered instead of backjumping to level 0

The implementation is inspired by:

  Niklas E'en and Niklas S"orensson. An Extensible SAT-solver. In Enrico
  Giunchiglia and Armando Tacchella, editors, Theory and Applications of
  Satisfiability Testing. Volume 2919 of Lecture Notes in Computer
  Science, pages 502-518. Springer, 2003.

  Niklas S"orensson and Armin Biere. Minimizing Learned Clauses. In
  Oliver Kullmann, editor, Theory and Applications of Satisfiability
  Testing. Volume 5584 of Lecture Notes in Computer Science,
  pages 237-243. Springer, 2009.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_CDCL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* types *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> * 'a

  </span><span class="comment1"><span>(* context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assignment_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>

  </span><span class="comment1"><span>(* enriching the context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_atom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_axiom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* main operations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assume</span><span class="main"><span>:</span></span><span> 'a </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>context</span></span><span> * 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> propagate</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Common.literal</span></span><span> </span><span class="entity"><span>Argo_Common.implied</span></span><span> * </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decide</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> analyze</span><span class="main"><span>:</span></span><span> 'a </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>context</span></span><span> * 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> restart</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Cdcl</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_CDCL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* basic types and operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> * 'a

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Level0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Proof.proof </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Decided</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * int * </span><span class="main"><span>(</span></span><span>bool * reason</span><span class="main"><span>)</span></span><span> Argo_Termtab.table </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Implied</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * int * </span><span class="main"><span>(</span></span><span>Argo_Lit.literal * reason</span><span class="main"><span>)</span></span><span> list * Argo_Proof.proof </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>External</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Level0</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implied</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>External</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>justified</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> * </span><span class="entity"><span>reason</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>watches</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_watches</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_watches</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>wts</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_lit_watches</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_watches</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_lit_watches</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_watches</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>watches_of</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_watches</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ws</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ws</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>watches_of</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_watches</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ws</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ws</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_lit_watches</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>detach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_lit_watches</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="entity"><span>Argo_Cls.eq_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit</span></span><span>


</span><span class="comment1"><span>(* literal values *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.term_of</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>not</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>justified</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_reason_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>justified</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* the trail height and the sequence of assigned literals *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  units</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Common.literal</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the literals that await propagation *)</span></span><span>
  level</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the decision level *)</span></span><span>
  trail</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>justified</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the trail height and the sequence of assigned literals *)</span></span><span>
  vals</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span class="entity"><span>reason</span></span><span class="main"><span>)</span></span><span> </span><span>Argo_Termtab.table</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* mapping of terms to polarity and reason *)</span></span><span>
  wts</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>watches</span></span><span> </span><span>Argo_Termtab.table</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* clauses watched by terms *)</span></span><span>
  heap</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Heap.heap</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* max-priority heap for decision heuristics *)</span></span><span>
  clss</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Cls.table</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* information about clauses *)</span></span><span>
  prf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Proof.context</span></span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(* the proof context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>units</span><span class="main"><span>=</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> level</span><span class="main"><span>=</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> trail</span><span class="main"><span>=</span></span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> vals</span><span class="main"><span>=</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> wts</span><span class="main"><span>=</span></span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> heap</span><span class="main"><span>=</span></span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> clss</span><span class="main"><span>=</span></span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> prf</span><span class="main"><span>=</span></span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>Argo_Termtab.empty</span><span> </span><span>Argo_Termtab.empty</span><span> </span><span class="entity"><span>Argo_Heap.heap</span></span><span>
    </span><span class="entity"><span>Argo_Cls.table</span></span><span> </span><span class="entity"><span>Argo_Proof.cdcl_context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_levels</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>drop_literal</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>drop_levels</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_literal</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>heap</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>drop_literal</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_levels</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Heap.insert</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>drop_literal</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad trail"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="entity"><span>new_level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> trail</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>new_level</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_literal</span></span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>new_level</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>heap</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>new_level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>new_level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* proofs *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_clause</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>lits</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level0_unit_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Level0</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_unit_res</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="entity"><span>prf</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level0_unit_proof</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad reason"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level0_unit_proofs</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>level0_unit_proof</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>the_reason_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Argo_Proof.unsat</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level0_unit_proofs</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* literal operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> trail</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>vals</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>units</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_level0</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level0_unit_proofs</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Level0</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> trail</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implied</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>push_level0</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_decided</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> trail</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assignment_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_watches</span></span><span> </span><span class="entity"><span>old</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>detach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>old</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span>


</span><span class="comment1"><span>(* clause operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>as_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tag_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>prf</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_watches</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clss</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>note_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Cls.put_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>clss</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span class="entity"><span>lit2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cx</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attach</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lit2</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>note_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clss</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>Argo_Heap.count</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>change_watches</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>change_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Cls.put_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_asserting</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  When learning a non-unit clause, the context is backtracked to the highest decision level
  of the assigned literals.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>learn_clause</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>push_level0</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>learn_clause</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ll</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lvl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>lvl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ll</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lvl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>max_level</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="entity"><span>lvl</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_asserting</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  An axiom with one unassigned literal and all remaining literals being assigned to
  false is asserting. An axiom with all literals assigned to false on level 0 makes the
  context unsatisfiable. An axiom with all literals assigned to false on higher levels
  causes backjumping before the highest level, and then the axiom might be asserting if
  only one literal is unassigned on that level.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lj</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lj</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_max</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Ord_List.insert</span><span> </span><span class="entity"><span>level_ord</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="entity"><span>lrs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>fs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_max</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"mismatch between values and literals"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backjump_add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>add_asserting</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_axiom</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>part</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lvl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lvl</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lvl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lvl</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lvl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lvl</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Level0</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>cls</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lr</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lr'</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>backjump_add</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="entity"><span>lr'</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_asserting</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lit2</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attach_clause</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span class="entity"><span>lit2</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad clause"</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* enriching the context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_atom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Heap.insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_axiom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.unsat</span></span><span> </span><span class="entity"><span>p</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_axiom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_duplicates</span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"clause with duplicate literals"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_duplicates</span><span> </span><span class="entity"><span>Argo_Lit.dual_lit</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>analyze_axiom</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>as_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* external knowledge *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>push_level0</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>justified</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>External</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* propagation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> * </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_lits_by</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Lit.eq_id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_binary</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>implied_lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>other_lit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>implied_lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>implied_lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>other_lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>the_reason_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>other_lit</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Lit.literal </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> justified list

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_non_false</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>with_non_false</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lit</span></span><span> </span><span class="entity"><span>l</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_non_false</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="entity"><span>lrs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>first_non_false</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>first_non_false</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>lrs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>with_non_false</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>first_non_false</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>val_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_nary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>change_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>cx</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>first_non_false</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Lit</span></span><span> </span><span class="entity"><span>lit2'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>change_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit2'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replace_watches</span></span><span> </span><span class="entity"><span>lit2</span></span><span> </span><span class="entity"><span>lit2'</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>push_implied</span></span><span> </span><span class="entity"><span>lit1</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>change_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>cls</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>change_watches</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_cls</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_binary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_lits_by</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_cls</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prop_nary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_lits_by</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Cls.get_watches</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_cls</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>watches_of</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>units</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span class="entity"><span>prop_lit</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>prop</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* decisions *)</span></span><span>

</span><span class="comment1"><span>(*
  Decisions are based on an activity heuristics. The most active variable that is
  still unassigned is chosen.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decide</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Argo_Termtab.defined</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.term_of</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Heap.extract</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>push_decided</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Heap.extract</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* conflict analysis and clause learning *)</span></span><span>

</span><span class="comment1"><span>(*
  Learned clauses often contain literals that are redundant, because they are
  subsumed by other literals of the clause. By analyzing the implication graph beyond
  the unique implication point, such redundant literals can be identified and hence
  removed from the learned clause. Only literals occurring in the learned clause and
  their reasons need to be analyzed.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ESSENTIAL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>history_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>h1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>h1</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>h2</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>Argo_Lit.signed_id_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h1</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Implied</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lvl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lvl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lvl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lvl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ESSENTIAL</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Level0</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ESSENTIAL</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Implied</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>essential_lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>essential_lrs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>ESSENTIAL</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>essential_lrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>redundant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>essential_lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>essential_lrs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_step</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_unit_res</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="entity"><span>prf</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>lrs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stop</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>true</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>false</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ESSENTIAL</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redundant</span></span><span> </span><span class="entity"><span>stop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>resolve_step</span></span><span> </span><span class="main"><span>(</span></span><span>sort_distinct</span><span> </span><span class="entity"><span>history_ord</span></span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Literals that are candidates for the learned lemma are marked and unmarked while
  traversing backwards through the trail. The last remaining marked literal is the first
  unique implication point.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unmark</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>remove</span><span> </span><span class="entity"><span>Argo_Lit.eq_id</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ms</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="entity"><span>Argo_Lit.eq_id</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span>

</span><span class="comment1"><span>(*
  Whenever an implication is recorded, the reason for the false literals of the
  asserting clause are known. It is reasonable to store this justification list as part
  of the implication reason. Consequently, the implementation of conflict analysis can
  benefit from this information, which does not need to be re-computed here.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>justification_for</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implied</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>justification_for</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>External</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>justified</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>justification_for</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad reason"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>lrs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Empty</span><span>

</span><span class="comment1"><span>(*
  Beginning from the conflicting clause, the implication graph is traversed to the first
  unique implication point. This breadth-first search is controlled by the topological order of
  the trail, which is traversed backwards. While traversing through the trail, the conflict
  literals of lower levels are collected to form the conflict lemma together with the unique
  implication point. Conflict literals assigned on level 0 are excluded from the conflict lemma.
  Conflict literals assigned on the current level are candidates for the first unique
  implication point.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>from_trail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>first_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>clause_lrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>from_reason</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span>
 
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>from_reason</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Level0</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_unit_res</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="entity"><span>prf</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from_reason</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Heap.increase</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="entity"><span>Argo_Lit.eq_id</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Heap.increase</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>from_trail</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.negate</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from_trail</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clause_lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>justification_for</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>x</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_unit_res</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>clause_lrs</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unmark</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cls</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unsat</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>the_reason_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from_clause</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Heap.decay</span></span><span> </span><span class="entity"><span>heap</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>levels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>learn_clause</span></span><span> </span><span class="entity"><span>lrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_context</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>wts</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>levels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* restarting *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>restart</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>backjump_to</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>