<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_heap.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_heap.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_heap.ML
    Author:     Sascha Boehme

A maximum-priority heap for literals with integer priorities and with inverse indices.
The heap is intended to be used as VSIDS-like decision heuristics. This implementation
is based on pairing heaps described in:

  Chris Okasaki. Purely Functional Data Structures. Chapter 5.
  Cambridge University Press, 1998.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_HEAP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> heap</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> insert</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.literal</span></span><span> * </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> increase</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> count</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decay</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rebuild</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>heap</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Heap</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_HEAP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* heuristic activity constants *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_incr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>128</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decay_incr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>11</span></span><span class="main"><span>)</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>10</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_activity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.pow</span><span> </span><span class="inner_numeral"><span>24</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>activity_rescale</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.pow</span><span> </span><span class="inner_numeral"><span>14</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>


</span><span class="comment1"><span>(* data structures and basic operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Term.term * bool * tree list

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Root</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Some</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Term.term

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  incr</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the increment to apply in an increase operation *)</span></span><span>
  vals</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>parent</span></span><span class="main"><span>)</span></span><span> </span><span>Argo_Termtab.table</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* weights and parents of the stored terms *)</span></span><span>
  tree</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(* the pairing heap of literals; note: the tree caches literal polarities *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>incr</span><span class="main"><span>=</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> vals</span><span class="main"><span>=</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> tree</span><span class="main"><span>=</span></span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_heap'</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>tree</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>heap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="entity"><span>min_incr</span></span><span> </span><span>Argo_Termtab.empty</span><span> </span><span class="entity"><span>E</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_value</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>empty_value</span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_value</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>empty_value</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* weight operations *)</span></span><span>

</span><span class="comment1"><span>(*
  The weight of a term is a pair of activity and count. The activity describes how
  often a term participated in conflicts. The count describes how often a term occurs
  in clauses.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>weight_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>int_ord</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>weight_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>less_than</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_less</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>weight_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>weight_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>weight_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rescale</span></span><span> </span><span class="entity"><span>activity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>activity</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>activity_rescale</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_activity</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_value</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="entity"><span>incr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_count</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_value</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rescale_activities</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_activity</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rescale</span></span><span> </span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span>Argo_Termtab.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>rescale</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* reverse index operations *)</span></span><span>

</span><span class="comment1"><span>(*
  The reverse index is required to retrieve elements when increasing their priorities.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>contains</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>path_to</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Root</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parents</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>path_to</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad heap"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_parent</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_value</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>put_parent</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>None</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>put_parent</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>Root</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>as_root</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>as_root</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>


</span><span class="comment1"><span>(* pairing heap operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trees1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trees2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>less_than</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trees2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_parent</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trees1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_parent</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tree</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tree2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>vals</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>tree1</span></span><span> </span><span class="entity"><span>tree2</span></span><span> </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span>|-&gt;</span><span> </span><span>uncurry</span><span> </span><span class="entity"><span>merge</span></span><span>


</span><span class="comment1"><span>(* cutting subtrees specified by a path *)</span></span><span>

</span><span class="comment1"><span>(*
  The extractions are performed in such a way that the heap is changed in as few positions
  as possible.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_index</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trees</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trees</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>with_index</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span>||&gt;</span><span> </span><span>cons</span><span> </span><span class="entity"><span>tree</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>with_index</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad heap"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_index</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_index</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lift_index</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad heap"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cut</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_index</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>tree</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_index</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cut</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="entity"><span>tree</span></span><span>


</span><span class="comment1"><span>(* filtering the heap *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proper_trees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_tree</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_tree</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_tree</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>proper_trees</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delete</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* exported heap operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Lit.dest</span></span><span> </span><span class="entity"><span>lit</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>contains</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_heap'</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>tree</span><span class="main"><span>=</span></span><span class="entity"><span>E</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> tree</span><span class="main"><span>=</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_heap'</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>as_root</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_pairs</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delete</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_term</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.term_of</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  If the changed weight violates the heap property, the corresponding tree
  is extracted and merged with the root.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_less</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>weight_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>weight_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tree1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>path_to</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_heap'</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>tree1</span></span><span> </span><span class="entity"><span>tree2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>tree</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>tree</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>increase</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_term</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>incr_activity</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rescale_activities</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_term</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>incr_count</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vals</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decay</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_heap</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decay_incr</span></span><span> </span><span class="entity"><span>incr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="entity"><span>tree</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rebuild</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>incr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>heap</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_heap'</span></span><span> </span><span class="entity"><span>incr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_tree</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>