<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_cc.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_cc.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_cc.ML
    Author:     Sascha Boehme
    Author:     Dmitriy Traytel and Matthias Franze, TU Muenchen

Equality reasoning based on congurence closure. It features:

  * congruence closure for any term that participates in equalities
  * support for predicates

These features might be added:

  * caching of explanations while building proofs to obtain shorter proofs
    and faster proof checking
  * propagating relevant merges of equivalence classes to all other theory solvers
  * propagating new relevant negated equalities to all other theory solvers
  * creating lemma "f ~= g | a ~= b | f a = g b" for asserted negated equalities
    between "f a" and "g b" (dynamic ackermannization)

The implementation is inspired by:

  Robert Nieuwenhuis and Albert Oliveras. Fast Congruence Closure and
  Extensions. In Information and Computation, volume 205(4),
  pages 557-580, 2007.

  Harald Ganzinger, George Hagen, Robert Nieuwenhuis, Albert Oliveras,
  Cesare Tinelli. DPLL(T): Fast decision procedures. In Lecture Notes in
  Computer Science, volume 3114, pages 175-188. Springer, 2004.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_CC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* enriching the context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_atom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* main operations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assume</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Common.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="entity"><span>Argo_Common.implied</span></span><span> * </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="entity"><span>Argo_Common.implied</span></span><span> * </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> explain</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Lit.literal</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Cls.clause</span></span><span> * </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_level</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> backtrack</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Cc</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_CC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* tables indexed by pairs of terms *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term2_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span class="entity"><span>Argo_Term.term_ord</span></span><span> </span><span class="entity"><span>Argo_Term.term_ord</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Term2tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> * </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term2_ord</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* equality certificates *)</span></span><span>

</span><span class="comment1"><span>(*
  The solver keeps assumed equalities to produce explanations later on.

  A flat equality (lp, (t1, t2)) consists of the assumed literal and its proof
  as well as the terms t1 and t2 that are assumed to be equal. The literal expresses
  the equality t1 = t2.

  A congruence equality (t1, t2) is an equality t1 = t2 where both terms are
  applications (f a) and (g b).

  A symmetric equality eq is a marker for applying the symmetry rule to eq.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Flat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Common.literal * </span><span class="main"><span>(</span></span><span>Argo_Term.term * Argo_Term.term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Cong</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Term.term * Argo_Term.term </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Symm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> eq

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tp</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tp</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>swap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>symm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.negate</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Cong</span></span><span> </span><span class="entity"><span>tp</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Symm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_app</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad application"</span></span><span>


</span><span class="comment1"><span>(* context *)</span></span><span>

</span><span class="comment1"><span>(*
  Each representative keeps track of the yet unimplied atoms in which this any member of
  this representative's equivalence class occurs. An atom is either a list of equalities
  between two terms, a list of predicates or a certificate. The certificate denotes that
  this equivalence class contains already implied predicates, and the literal accompanying
  the certificate specifies the polarity of these predicates.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Eqs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Term.term * Argo_Term.term</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Preds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Term.term list </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Cert</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Common.literal

</span><span class="comment1"><span>(*
  Each representative has an associated ritem that contains the members of the
  equivalence class, the yet unimplied atoms and further information.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  size</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the size of the equivalence class *)</span></span><span>
  class</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the equivalence class as a list of distinct terms *)</span></span><span>
  occs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* a list of all application terms in which members of
    the equivalence class occur either as function or as argument *)</span></span><span>
  neqs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.term</span></span><span> * </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* a list of terms from disjoint equivalence classes,
    for each term of this list there is a certificate of a negated equality that is
    required to explain why the equivalence classes are disjoint *)</span></span><span>
  atoms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(* the atoms of the representative *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span>Argo_Termtab.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span>Argo_Termtab.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.term</span></span><span> </span><span>Argo_Term2tab.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.term</span></span><span> * </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span>Argo_Termtab.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  repr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* a table mapping terms to their representatives *)</span></span><span>
  rdata</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* a table mapping representatives to their ritems *)</span></span><span>
  apps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* a table mapping a function and an argument to their application *)</span></span><span>
  trace</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the proof forest used to trace assumed and implied equalities *)</span></span><span>
  prf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Proof.context</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the proof context *)</span></span><span>
  back</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr</span></span><span> * </span><span class="entity"><span>rdata</span></span><span> * </span><span class="entity"><span>apps</span></span><span> * </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(* backtracking information *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>repr</span><span class="main"><span>=</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> rdata</span><span class="main"><span>=</span></span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> apps</span><span class="main"><span>=</span></span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> trace</span><span class="main"><span>=</span></span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> prf</span><span class="main"><span>=</span></span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> back</span><span class="main"><span>=</span></span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_context</span></span><span> </span><span>Argo_Termtab.empty</span><span> </span><span>Argo_Termtab.empty</span><span> </span><span>Argo_Term2tab.empty</span><span> </span><span>Argo_Termtab.empty</span><span>
    </span><span class="entity"><span>Argo_Proof.cc_context</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repr_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_repr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="entity"><span>occs</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>size</span><span class="main"><span>=</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>=</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> occs</span><span class="main"><span>=</span></span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> neqs</span><span class="main"><span>=</span></span><span class="entity"><span>neqs</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>atoms</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>as_ritem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>as_pred_ritem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_ritem_of</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_ritem_of</span></span><span> </span><span class="entity"><span>as_ritem</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ritem_of_pred</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_ritem_of</span></span><span> </span><span class="entity"><span>as_pred_ritem</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ritem_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>ri</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ri</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_occ</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>as_ritem</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>occ</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_atoms</span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="entity"><span>occs</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>atoms</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eq_atom</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>as_ritem</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ri</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>put_atoms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ri</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ri</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>put_atoms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>atom</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ri</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_app</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Term2tab.lookup</span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>tp</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_app</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Term2tab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* traces for explanations *)</span></span><span>

</span><span class="comment1"><span>(*
  Assumed and implied equalities are collected in a proof forest for being able to
  produce explanations. For each equivalence class there is one proof tree. The
  equality certificates are oriented towards a root term, that is not necessarily
  the representative of the equivalence class.
*)</span></span><span>

</span><span class="comment1"><span>(*
  Whenever two equivalence classes are merged due to an equality t1 = t2, the shorter
  of the two paths, either from t1 to its root or t2 to its root, is re-oriented such
  that the relevant ti becomes the new root of its tree. Then, a new edge between ti
  and the other term of the equality t1 = t2 is added to connect the two proof trees.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_of</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>depth_of</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reorient</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reorient</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_edge</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>to</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>from</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reorient</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_shortest</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>depth_of</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>depth_of</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trace</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_edge</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_shortest</span></span><span> </span><span class="entity"><span>new_edge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>trace</span></span><span>

</span><span class="comment1"><span>(*
  To produce an explanation that t1 and t2 are equal, the paths to their root are
  extracted from the proof forest. Common ancestors in both paths are dropped.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>path_to_root</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>path</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>path_to_root</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>path</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_common</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>path1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>path2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>drop_common</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>path1</span></span><span> </span><span class="entity"><span>path2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>root</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>drop_common</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>root</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>common_ancestor</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>root</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>path1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>path2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>path_to_root</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>drop_common</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>path1</span></span><span> </span><span class="entity"><span>path2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  The proof of an assumed literal is typically a hypothesis. If the assumed literal is
  already known to be a unit literal, then there is already a proof for it.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proof_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.negate</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_hyp</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  The explanation of equality between two terms t1 and t2 is computed based on the
  paths from t1 and t2 to their common ancestor t in the proof forest. For each of
  the two paths, a transitive proof of equality t1 = t and t = t2 is constructed,
  such that t1 = t2 follows by transitivity.
  
  Each edge of the paths denotes an assumed or implied equality. Implied equalities
  might be due to congruences (f a = g b) for which the equalities f = g and a = b
  need to be explained recursively.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_refl</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>common_ancestor</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans_proof</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans_proof</span></span><span> </span><span>swap</span><span> </span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_trans</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>trans_proof</span></span><span> </span><span class="entity"><span>sw</span></span><span> </span><span class="entity"><span>sy</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>root</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_refl</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Argo_Termtab.lookup</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad trace"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_step</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sy</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans_proof</span></span><span> </span><span class="entity"><span>sw</span></span><span> </span><span class="entity"><span>sy</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span>uncurry</span><span> </span><span class="entity"><span>Argo_Proof.mk_trans</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sw</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>proof_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_of</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_step</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>dest_app</span></span><span> </span><span class="entity"><span>tp</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_cong</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_step</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>proof_step</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>||&gt;</span><span> </span><span>uncurry</span><span> </span><span class="entity"><span>Argo_Proof.mk_symm</span></span><span>

</span><span class="comment1"><span>(*
  All clauses produced by a theory solver are expected to be a lemma.
  The lemma proof must hence be the last proof step.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_proof</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_lemma</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  The explanation for the equality of t1 and t2 used the above algorithm.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>explain_eq</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>close_proof</span></span><span> </span><span class="entity"><span>lit</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  The explanation that t1 and t2 are distinct uses the negated equality u1 ~= u2 that
  explains why the equivalence class containing t1 and u1 and the equivalence class
  containing t2 and u2 are disjoint. The explanations for t1 = u1 and u2 = t2 are
  constructed using the above algorithm. By transitivity, it follows that t1 ~= t2.  
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>finish_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>close_proof</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>finish_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad equality"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>finish_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_symm</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>finish_proof</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>lits</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>explain_neq</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>eq</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>eq'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_step</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prf</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Argo_Proof.mk_trans</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>Argo_Proof.mk_trans</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>finish_proof</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>lits</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* propagating new equalities *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> * </span><span class="entity"><span>context</span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>same_repr</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_atom</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>atoms </span><span class="main"><span>(</span></span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Eqs</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>eq</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_implied</span></span><span> </span><span class="entity"><span>mk_lit</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span>insert</span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_lit</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>same_repr</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_atom</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>copy_occ</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_app</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_app</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>app'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>app'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_app</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>Argo_Lit.Pos</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="entity"><span>eqs1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="entity"><span>eqs2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>eqs1</span></span><span> </span><span class="entity"><span>eqs2</span></span><span> </span><span class="entity"><span>ls</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_lits</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_lits</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad atoms"</span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>ri1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>ri2</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>size</span><span class="main"><span>=</span></span><span class="entity"><span>size1</span></span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>=</span></span><span class="entity"><span>class1</span></span><span class="main"><span>,</span></span><span> occs</span><span class="main"><span>=</span></span><span class="entity"><span>occs1</span></span><span class="main"><span>,</span></span><span> neqs</span><span class="main"><span>=</span></span><span class="entity"><span>neqs1</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>atoms1</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ri1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>size</span><span class="main"><span>=</span></span><span class="entity"><span>size2</span></span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>=</span></span><span class="entity"><span>class2</span></span><span class="main"><span>,</span></span><span> occs</span><span class="main"><span>=</span></span><span class="entity"><span>occs2</span></span><span class="main"><span>,</span></span><span> neqs</span><span class="main"><span>=</span></span><span class="entity"><span>neqs2</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>atoms2</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ri2</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>put_repr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class2</span></span><span> </span><span class="entity"><span>repr</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>cons</span><span> </span><span class="entity"><span>class2</span></span><span> </span><span class="entity"><span>class1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>copy_occ</span></span><span> </span><span class="entity"><span>repr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>occs2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_edge</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>trace</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.merge</span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neqs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqs2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_implied</span></span><span> </span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>neqs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adds</span></span><span> </span><span class="entity"><span>eqs1</span></span><span> </span><span class="entity"><span>eqs2</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>neqs2</span></span><span> </span><span class="entity"><span>eqs1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>neqs1</span></span><span> </span><span class="entity"><span>eqs2</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>Eqs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atoms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>join_atoms</span></span><span> </span><span class="entity"><span>adds</span></span><span> </span><span class="entity"><span>atoms1</span></span><span> </span><span class="entity"><span>atoms2</span></span><span> </span><span class="entity"><span>ls</span></span><span>
    </span><span class="comment1"><span>(* TODO: make sure that all implied literals are propagated *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>size2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="entity"><span>occs</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>atoms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>neqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>same_repr</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>neqs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ri1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ri2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ecx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_neq</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ri2</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_neq</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ri1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>ri1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>ri2</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>ecx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_max_class</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rip</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ri1</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ri2</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>size </span><span class="entity"><span>ri1</span></span><span> </span><span>&gt;=</span><span> </span><span class="main"><span>#</span></span><span>size </span><span class="entity"><span>ri2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="entity"><span>rip</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ri2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ri1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_max_class</span></span><span> </span><span class="entity"><span>check_join</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ritem_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>without</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="entity"><span>Argo_Lit.eq_lit</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flat_merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>without</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  comment missing
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app_merge</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tp</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_app</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>app'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Cong</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>app'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cx</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad application merge"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_occ</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_occ</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_app</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  A negated equality between t1 and t2 is only recorded if t1 and t2 are not already known
  to belong to the same class. In that case, a conflict is raised with an explanation
  why t1 and t2 are equal. Otherwise, the classes of t1 and t2 are marked as disjoint by
  storing the negated equality in the ritems of t1's and t2's representative. All equalities
  between terms of t1's and t2's class are implied as negated equalities. Those equalities
  are found in the ritems of t1's and t2's representative.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_neq</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>size</span><span class="main"><span>=</span></span><span class="entity"><span>size1</span></span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>=</span></span><span class="entity"><span>class1</span></span><span class="main"><span>,</span></span><span> occs</span><span class="main"><span>=</span></span><span class="entity"><span>occs1</span></span><span class="main"><span>,</span></span><span> neqs</span><span class="main"><span>=</span></span><span class="entity"><span>neqs1</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>atoms1</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>size</span><span class="main"><span>=</span></span><span class="entity"><span>size2</span></span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>=</span></span><span class="entity"><span>class2</span></span><span class="main"><span>,</span></span><span> occs</span><span class="main"><span>=</span></span><span class="entity"><span>occs2</span></span><span class="main"><span>,</span></span><span> neqs</span><span class="main"><span>=</span></span><span class="entity"><span>neqs2</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>atoms2</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r2</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_implied</span></span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>Eqs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad negated equality between predicates"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>atoms1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atoms2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>atoms1</span></span><span> </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>atoms2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ri1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size1</span></span><span> </span><span class="entity"><span>class1</span></span><span> </span><span class="entity"><span>occs1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>neqs1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atoms1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ri2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size2</span></span><span> </span><span class="entity"><span>class2</span></span><span> </span><span class="entity"><span>occs2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>symm</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>neqs2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atoms2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>ri1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>ri2</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flat_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tp</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>explain_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.negate</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>without</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>note_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* declaring atoms *)</span></span><span>

</span><span class="comment1"><span>(*
  Only a genuinely new equality term t for the equality "t1 = t2" is added. If t1 and t2 belong
  to the same equality class or if the classes of t1 and t2 are known to be disjoint, the
  respective literal is returned together with an unmodified context.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eq_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Term.eq_term</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_neq</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ritem_of</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_eq_atom</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eq_atom</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Only a genuinely new predicate t, which is an application "t1 t2", is added.
  If there is a predicate that is known to be congruent to the representatives of t1 and t2,
  and that predicate or its negation has already been assummed, the respective literal of t
  is returned together with an unmodified context.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_pred_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_app</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>as_pred_ritem</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>ritem_of_pred</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ri</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_atoms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ri</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Eqs</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad predicate"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  For each term t that is an application "t1 t2", the reflexive equality t = t1 t2 is added
  to the context. This is required for propagations of congruences.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flatten</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_merge</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flatten</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cx</span></span><span>

</span><span class="comment1"><span>(*
  Atoms to be added to the context must either be an equality "t1 = t2" or
  an application "t1 t2" (a predicate). Besides adding the equality or the application,
  reflexive equalities for for all applications in the terms t1 and t2 are added.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>add_eq_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_merge</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_pred_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* assuming external knowledge *)</span></span><span>

</span><span class="comment1"><span>(*
  Assuming a predicate r replaces all predicate atoms of r's ritem with the assumed certificate.
  The predicate atoms are implied, either with positive or with negative polarity based on
  the assumption.

  There must not be a certificate for r since otherwise r would have been assumed before already.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assume_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>mk_lit</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ritem_of_pred</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>{</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>occs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqs</span></span><span class="main"><span>,</span></span><span> atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Preds</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>put_ritem</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ritem</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="entity"><span>occs</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rdata</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>without</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_lit</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad predicate assumption"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  Assumed equalities "t1 = t2" are treated as flat equalities between terms t1 and t2.
  If t1 and t2 are applications, congruences are propagated as part of the merge between t1 and t2.
  Negated equalities are handled likewise.

  Assumed predicates do not trigger congruences. Only predicates of the same class are implied.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>flat_merge</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>flat_neq</span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>assume_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>assume_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* checking for consistency and pending implications *)</span></span><span>

</span><span class="comment1"><span>(*
  The internal model is always kept consistent. All implications are propagated as soon as
  new information is assumed. Hence, there is nothing to be done here.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* explanations *)</span></span><span>

</span><span class="comment1"><span>(*
  The explanation for the predicate t, which is an application of t1 and t2, is constructed
  from the explanation of the predicate application "u1 u2" as well as the equalities "u1 = t1"
  and "u2 = t2" which both are constructed from the proof forest. The substitution rule is
  the proof step that concludes "t1 t2" from "u1 u2" and the two equalities "u1 = t1"
  and "u2 = t2".

  The atoms part of the ritem of t's representative must be a certificate of an already
  assumed predicate for otherwise there would be no explanation for t.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>explain_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ritem_of_pred</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>atoms</span><span class="main"><span>=</span></span><span class="entity"><span>Cert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ritem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.term_of</span></span><span> </span><span class="entity"><span>lit'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_of</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prf</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_eq_proof</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>prf</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_subst</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>close_proof</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>lits</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"no explanation for bad predicate"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  Explanations are produced based on the proof forest that is constructed while assuming new
  information and propagating this among the internal data structures.
  
  For predicates, no distinction between both polarities needs to be done here. The atoms
  part of the relevant ritem knows the assumed polarity.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_eq</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_neq</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ritem_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repr_of'</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Flat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.App</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explain_pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explain</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>


</span><span class="comment1"><span>(* backtracking *)</span></span><span>

</span><span class="comment1"><span>(*
  All information that needs to be reconstructed on backtracking is stored on the backtracking
  stack. On backtracking any current information is replaced by what was stored before. No copying
  nor subtle updates are required thanks to immutable data structures.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_level</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>back</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Empty</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> back</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>repr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdata</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>back</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>repr</span></span><span> </span><span class="entity"><span>rdata</span></span><span> </span><span class="entity"><span>apps</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>back</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>