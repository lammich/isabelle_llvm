<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Code/code_namespace.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Code/code_namespace.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Code/code_namespace.ML
    Author:     Florian Haftmann, TU Muenchen

Mastering target language namespaces.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CODE_NAMESPACE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> variant_case_insensitive</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Name.context</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>Name.context</span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Private</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Public</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_public</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_private</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> join_exports</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>export</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>flat_program</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> flat_program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>{</span></span><span> module_prefix</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> module_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
    reserved</span><span class="main"><span>:</span></span><span> </span><span>Name.context</span><span class="main"><span>,</span></span><span> identifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Printer.identifiers</span></span><span class="main"><span>,</span></span><span> empty_nsp</span><span class="main"><span>:</span></span><span> 'a</span><span class="main"><span>,</span></span><span>
    namify_stmt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Thingol.stmt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * 'a</span><span class="main"><span>,</span></span><span>
    modify_stmt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Thingol.stmt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.stmt</span></span><span> </span><span>option</span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>{</span></span><span> deresolver</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
           flat_program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Dummy</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> export * 'a
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>'b * </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> node</span><span class="main"><span>)</span></span><span> Code_Symbol.Graph.T</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hierarchical_program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>{</span></span><span> module_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
    reserved</span><span class="main"><span>:</span></span><span> </span><span>Name.context</span><span class="main"><span>,</span></span><span> identifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Printer.identifiers</span></span><span class="main"><span>,</span></span><span>
    empty_nsp</span><span class="main"><span>:</span></span><span> 'c</span><span class="main"><span>,</span></span><span> namify_module</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * 'c</span><span class="main"><span>,</span></span><span>
    namify_stmt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Thingol.stmt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * 'c</span><span class="main"><span>,</span></span><span>
    cyclic_modules</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
    class_transitive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span> class_relation_public</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
    empty_data</span><span class="main"><span>:</span></span><span> 'b</span><span class="main"><span>,</span></span><span> memorize_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b </span><span class="main"><span>-&gt;</span></span><span> 'b</span><span class="main"><span>,</span></span><span>
    modify_stmts</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span> * </span><span class="entity"><span>Code_Thingol.stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span> * 'a</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>{</span></span><span> deresolver</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
           hierarchical_program</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_hierarchical</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span> print_module</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c</span><span class="main"><span>,</span></span><span>
    print_stmt</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span> * 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c</span><span class="main"><span>,</span></span><span>
    lift_markup</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Namespace</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CODE_NAMESPACE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(** name handling on case-insensitive file systems **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>restore_for</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span>Symbol.is_ascii_upper</span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span>Symbol.to_ascii_upper</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symbol.is_ascii_upper</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>nth_map</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>Symbol.to_ascii_upper</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>variant_case_insensitive</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symbol.explode</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_lower</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Symbol.to_ascii_lower</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>restore</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implode</span><span> </span><span>o</span><span> </span><span class="entity"><span>restore_for</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span>o</span><span> </span><span>Symbol.explode</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>s_lower</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>restore</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** export **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Private</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Public</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_public</span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_public</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_private</span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>not_private</span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>not_private</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Public</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Public</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Opaque</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Opaque</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Private</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_exports</span></span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>mark_export</span></span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="entity"><span>Private</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dependent_exports</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> class_transitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_transitive</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Type_Constructor</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Type_Class</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_relevant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Class_Relation</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_relevant</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proto_gr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.restrict</span><span> </span><span class="entity"><span>is_relevant</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>proto_gr</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.fold</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_relevant</span></span><span> </span><span class="entity"><span>sym</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>Code_Symbol.Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Thingol.NoStmt</span></span><span class="main"><span>)</span></span><span>
              </span><span>#&gt;</span><span> </span><span>Code_Symbol.Graph.Keys.fold</span><span>
               </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_relevant</span></span><span> </span><span class="entity"><span>sym'</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Code_Symbol.Graph.add_edge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym'</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>class_transitive</span></span><span> </span><span>?</span><span>
          </span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Code_Symbol.Type_Class</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Code_Symbol.Graph.add_edge</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.all_succs</span><span> </span><span class="entity"><span>proto_gr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proto_gr</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deps_of</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.Keys.dest</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.imm_succs</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deps1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deps2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="entity"><span>deps1</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span> is_datatype_or_class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span class="main"><span>,</span></span><span>
      deps_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deps_of</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mark_exports_aux</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> prefix_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_of</span></span><span class="main"><span>,</span></span><span> map_export </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_export</span></span><span class="main"><span>,</span></span><span>
    is_datatype_or_class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span class="main"><span>,</span></span><span> deps_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deps_of</span></span><span class="main"><span>,</span></span><span>
    class_relation_public </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Opaque</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Public</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dependent_export1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dependent_export2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Code_Thingol.Fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Code_Thingol.Classinst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Code_Thingol.Datatypecons</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Public</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Code_Thingol.Classparam</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Public</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Code_Thingol.Class</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Code_Thingol.Classrel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Public</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Opaque</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dependent_exports</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dependent_export1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>export1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dependent_export2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>export2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deps_of</span></span><span> </span><span class="entity"><span>sym</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>export1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps1</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>export2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>export1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps_of</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="entity"><span>map_export</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mark_export</span></span><span> </span><span class="entity"><span>export</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>export</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_export</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefix_of</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mark_export</span></span><span> </span><span class="entity"><span>export</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>dependent_exports</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> prefix_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_of</span></span><span class="main"><span>,</span></span><span> map_export </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_export</span></span><span class="main"><span>,</span></span><span>
    class_transitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_transitive</span></span><span class="main"><span>,</span></span><span> class_relation_public </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps_of</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>dependent_exports</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> class_transitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_transitive</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mark_exports_aux</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> prefix_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_of</span></span><span class="main"><span>,</span></span><span> map_export </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_export</span></span><span class="main"><span>,</span></span><span>
      is_datatype_or_class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_datatype_or_class</span></span><span class="main"><span>,</span></span><span> deps_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deps_of</span></span><span class="main"><span>,</span></span><span>
      class_relation_public </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** fundamental module name hierarchy **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>module_fragments'</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code_Symbol.lookup_module_data</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fragments</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fragment</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Name.variant</span><span> </span><span class="entity"><span>fragment</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>module_fragments</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>module_fragments'</span></span><span> </span><span class="main"><span>{</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> reserved </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_module_namespace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>enforce_upper</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>module_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>module_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.default_prefix</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>module_fragments'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_fragments</span></span><span>
      </span><span class="main"><span>{</span></span><span> module_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> reserved </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>adjust_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>enforce_upper</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name.enforce_case</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>adjust_case</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>module_prefix</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>module_fragments'</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>module_names</span></span><span> </span><span>Symtab.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_symbol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>module_namespace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>force_module</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code_Symbol.lookup</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>module_namespace</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.default_prefix</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>Code_Symbol.default_base</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>prefix_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>force_module</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>prefix_name</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>force_module</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>prefix_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_priority</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.lookup</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_proto_program</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>empty</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_stmt</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Code_Symbol.Graph.Keys.fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_dep</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prioritize</span></span><span> </span><span class="entity"><span>has_priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>uncurry</span><span> </span><span>append</span><span> </span><span>o</span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>has_priority</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** flat program structure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span> * </span><span class="entity"><span>Code_Thingol.stmt</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>Code_Symbol.Graph.T</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>Graph.T</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>module_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>empty_nsp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>namify_stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modify_stmt</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>

    </span><span class="comment1"><span>(* building module name hierarchy *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>module_namespace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_module_namespace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span> </span><span class="main"><span>{</span></span><span> module_prefix </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_prefix</span></span><span class="main"><span>,</span></span><span>
      module_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> reserved </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_symbol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> module_namespace </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_namespace</span></span><span class="main"><span>,</span></span><span>
      force_module </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.explode</span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>}</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span>Long_Name.implode</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym_priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_priority</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* distribute statements over hierarchy *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> prefix_of </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_sym</span></span><span class="main"><span>,</span></span><span>
      map_export </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Graph.map_node</span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>,</span></span><span>
        class_transitive </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> class_relation_public </span><span class="main"><span>=</span></span><span> </span><span>false</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_stmt</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span>Graph.map_node</span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Private</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>sym'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>Graph.map_node</span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.add_edge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>Graph.map_node</span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>AList.map_default</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="entity"><span>module_name'</span></span><span> </span><span class="entity"><span>sym'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proto_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_proto_program</span></span><span>
      </span><span class="main"><span>{</span></span><span> empty </span><span class="main"><span>=</span></span><span> </span><span>Graph.empty</span><span class="main"><span>,</span></span><span> add_stmt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_stmt</span></span><span class="main"><span>,</span></span><span> add_dep </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exports</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* name declarations and statement modifications *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nsp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nsp'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>namify_stmt</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="entity"><span>base</span></span><span> </span><span class="entity"><span>nsp</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gr'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>base'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gr'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nsp'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>empty_nsp</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>declare</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>prioritize</span></span><span> </span><span class="entity"><span>sym_priority</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.keys</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span>
      </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.map_strong_conn</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>syms_bases_exports_stmts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>syms_bases_exports_stmts</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>export</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modify_stmt</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proto_program</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Graph.map</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* qualified and unqualified imports, deresolving *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>base_deresolver</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span>
      </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Graph.get_node</span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>classify_names</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>imports</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>import_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>imports</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imported_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>import_tab</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>here_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.keys</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Code_Symbol.Table.empty</span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Code_Symbol.Table.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base_deresolver</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>here_syms</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Code_Symbol.Table.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span>
            </span><span>Long_Name.append</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>import_tab</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>base_deresolver</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>imported_syms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deresolver_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>(</span></span><span>AList.make</span><span>
      </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>classify_names</span></span><span> </span><span>o</span><span> </span><span>Graph.get_node</span><span> </span><span class="entity"><span>flat_program</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Graph.keys</span><span> </span><span class="entity"><span>flat_program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deresolver</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Long_Name.append</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_deresolver</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>deresolver</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Table.lookup</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>deresolver_tab</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown statement name: "</span></span><span>
            </span><span>^</span><span> </span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span> deresolver </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deresolver</span></span><span class="main"><span>,</span></span><span> flat_program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flat_program</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** hierarchical program structure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Dummy</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> export * 'a
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>'b * </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> node</span><span class="main"><span>)</span></span><span> Code_Symbol.Graph.T</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>node</span></span><span class="main"><span>)</span></span><span> </span><span>Code_Symbol.Graph.T</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_stmt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Stmt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_module_content</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Module</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_module</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_module</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragment</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>name_fragments</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span class="entity"><span>map_module_content</span></span><span>
        </span><span>o</span><span> </span><span class="entity"><span>map_module</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_module_stmts</span></span><span> </span><span class="entity"><span>f_module</span></span><span> </span><span class="entity"><span>f_stmts</span></span><span> </span><span class="entity"><span>sym_base_nodes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>some_modules</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>sym_base_nodes</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>burrow_options</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_module</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>some_export_stmts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>sym_base_nodes</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="entity"><span>export_stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>export_stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>burrow_options</span><span> </span><span>o</span><span> </span><span>burrow_fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f_stmts</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_export_stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>some_export_stmt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>export_stmt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="entity"><span>export_stmt</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Dummy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>some_modules</span></span><span> </span><span class="entity"><span>some_export_stmts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>empty_nsp</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>namify_module</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>namify_stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cyclic_modules</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>class_transitive</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>empty_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>memorize_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modify_stmts</span></span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="entity"><span>exports</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>

    </span><span class="comment1"><span>(* building module name hierarchy *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>module_namespace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_module_namespace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="main"><span>{</span></span><span> module_prefix </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
      module_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> reserved </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_symbol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> module_namespace </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_namespace</span></span><span class="main"><span>,</span></span><span>
      force_module </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.explode</span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym_priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_priority</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* building empty module hierarchy *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_module</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_data</span></span><span class="main"><span>,</span></span><span> </span><span>Code_Symbol.Graph.empty</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>nodes</span></span><span> </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragment</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="entity"><span>empty_module</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>allocate_module</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>allocate_module</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragment</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>name_fragments</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>ensure_module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span class="entity"><span>map_module_content</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>allocate_module</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_program</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>empty_module</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fragments</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>allocate_module</span></span><span> </span><span class="entity"><span>fragments</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>module_namespace</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>allocate_module</span></span><span> </span><span>o</span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span>Option.map</span><span> </span><span>fst</span><span>
          </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.lookup</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* distribute statements over hierarchy *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>{</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> prefix_of </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_sym</span></span><span class="main"><span>,</span></span><span>
      map_export </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name_fragments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>map_module</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>export</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      class_transitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_transitive</span></span><span class="main"><span>,</span></span><span> class_relation_public </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_relation_public</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_stmt</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>map_module</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Public</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Private</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_edge_acyclic_error</span></span><span> </span><span class="entity"><span>error_msg</span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Code_Symbol.Graph.add_edge_acyclic</span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="entity"><span>gr</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Code_Symbol.Graph.CYCLES</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>error_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>sym'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym'</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments_common</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>diff'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>chop_common_prefix</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name_fragments'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_cross_module</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>diff</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>diff'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>diff</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>diff'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sym'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_edge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_cross_module</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>cyclic_modules</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>add_edge_acyclic_error</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Dependency "</span></span><span>
            </span><span>^</span><span> </span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -&gt; "</span></span><span>
            </span><span>^</span><span> </span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym'</span></span><span>
            </span><span>^</span><span> </span><span class="inner_quoted"><span>" would result in module dependency cycle"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dep</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Code_Symbol.Graph.add_edge</span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>map_module</span></span><span> </span><span class="entity"><span>name_fragments_common</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>add_edge</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_cross_module</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="entity"><span>name_fragments'</span></span><span> </span><span class="entity"><span>sym'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proto_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_proto_program</span></span><span>
      </span><span class="main"><span>{</span></span><span> empty </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_program</span></span><span class="main"><span>,</span></span><span> add_stmt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_stmt</span></span><span class="main"><span>,</span></span><span> add_dep </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>program</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mark_exports</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exports</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* name declarations, data and statement modifications *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_declarations</span></span><span> </span><span class="entity"><span>nsps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>module_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt_syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Code_Symbol.Graph.keys</span><span> </span><span class="entity"><span>nodes</span></span><span>
          </span><span>|&gt;</span><span> </span><span>List.partition</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="entity"><span>sym</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prioritize</span></span><span> </span><span class="entity"><span>sym_priority</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare</span></span><span> </span><span class="entity"><span>namify</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nsps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>node</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nsps'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>namify</span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="entity"><span>base</span></span><span> </span><span class="entity"><span>nsps</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nodes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>node</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nsps'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nsps'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nsps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>declare</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>namify_module</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>module_fragments</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>declare</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>namify_stmt</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>the_stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stmt_syms</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>modify_stmts'</span></span><span> </span><span class="entity"><span>syms_stmts</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>modify_stmts</span></span><span> </span><span class="entity"><span>syms_stmts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>stmts'</span></span><span> </span><span>@</span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>syms_stmts</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>stmts'</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nodes''</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>nodes'</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.map_strong_conn</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_module_stmts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_declarations</span></span><span> </span><span class="entity"><span>nsps'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modify_stmts'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>memorize_data</span></span><span> </span><span class="entity"><span>stmt_syms</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_declarations</span></span><span> </span><span class="entity"><span>empty_nsp</span></span><span> </span><span class="entity"><span>proto_program</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* deresolving *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deresolver</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remainder</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop_common_prefix</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefix_fragments</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name_fragment</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name_fragments</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Long_Name.implode</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remainder</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>base'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Code_Symbol.Graph.UNDEF</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown statement name: "</span></span><span>
          </span><span>^</span><span> </span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span> deresolver </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deresolver</span></span><span class="main"><span>,</span></span><span> hierarchical_program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hierarchical_program</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_hierarchical</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>print_module</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>print_stmt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lift_markup</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_node</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Dummy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_node</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Stmt</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lift_markup</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.markup_stmt</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>print_stmt</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_node</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.Module</span></span><span> </span><span class="entity"><span>name_fragment</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Module</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix_fragments'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>name_fragment</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_module</span></span><span> </span><span class="entity"><span>prefix_fragments'</span></span><span>
              </span><span class="entity"><span>name_fragment</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_nodes</span></span><span> </span><span class="entity"><span>prefix_fragments'</span></span><span> </span><span class="entity"><span>nodes</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>print_nodes</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>print_node</span></span><span> </span><span class="entity"><span>prefix_fragments</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>nodes</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>rev</span><span> </span><span>o</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.strong_conn</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nodes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span class="entity"><span>print_nodes</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>