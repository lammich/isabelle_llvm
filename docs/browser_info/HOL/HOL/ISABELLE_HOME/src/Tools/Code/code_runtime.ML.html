<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Code/code_runtime.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Code/code_runtime.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Code/code_runtime.ML
    Author:     Florian Haftmann, TU Muenchen

Runtime services building on code generation into implementation language SML.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CODE_RUNTIME</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> target</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> value</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>cookie</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> * </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_value</span><span class="main"><span>:</span></span><span> 'a </span><span class="entity"><span>cookie</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_value_strict</span><span class="main"><span>:</span></span><span> 'a </span><span class="entity"><span>cookie</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_value_exn</span><span class="main"><span>:</span></span><span> 'a </span><span class="entity"><span>cookie</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>Exn.result</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_holds_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_reflect</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>Path.binding</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_reflect_cmd</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>Path.binding</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>truth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Holds</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_truth</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>truth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mount_computation</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'ml</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'ml </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mount_computation_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'ml</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'ml </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mount_computation_check</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>truth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> polyml_as_definition</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Path.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Runtime</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CODE_RUNTIME</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Basic_Code_Symbol</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** ML compiler as evaluation environment **)</span></span><span>

</span><span class="comment1"><span>(* technical prerequisites *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thisN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Code_Runtime"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.append</span><span> </span><span class="entity"><span>thisN</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>truthN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"truth"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>HoldsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"Holds"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Eval"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>truth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Holds</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Target.add_derived_target</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Code_ML.target_SML</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Type_Constructor</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>prop</span><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.str</span></span><span> </span><span class="entity"><span>truthN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Constant</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Tools.Code_Generator.html#Code_Generator.holds|const"><span>Code_Generator.holds</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.plain_const_syntax</span></span><span> </span><span class="entity"><span>HoldsN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>Code_Target.add_reserved</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>thisN</span></span><span>
  </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Target.add_reserved</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"oo"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"ooo"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"oooo"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"upto"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"downto"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"orf"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"andf"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span class="comment1"><span>(*avoid further pervasive infix names*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Code_Generator.code_runtime_trace|attribute"><span>code_runtime_trace</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_ML</span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="entity"><span>code</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="entity"><span>code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="entity"><span>Code_Preproc.timed</span></span><span> </span><span class="inner_quoted"><span>"compiling ML"</span></span><span> </span><span>Context.proof_of</span><span>
    </span><span class="main"><span>(</span></span><span>ML_Context.exec</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_Compiler0.ML</span><span> </span><span>ML_Env.context</span><span>
    </span><span class="main"><span>{</span></span><span>line </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> file </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generated code"</span></span><span class="main"><span>,</span></span><span> verbose </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>verbose</span></span><span class="main"><span>,</span></span><span>
       debug </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>code</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_ml</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prelude</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prelude</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nval _ = Context.put_generic_context (SOME (Context.map_proof ("</span></span><span> </span><span>^</span><span>
      </span><span class="entity"><span>put_ml</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" (fn () =&gt; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>value</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")) (Context.the_generic_context ())))"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>put</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad compilation for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>put_ml</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile_ML</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>code</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Code_Preproc.timed_exec</span></span><span> </span><span class="inner_quoted"><span>"running ML"</span></span><span> </span><span class="entity"><span>computator</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* evaluation into ML language values *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>cookie</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> * </span><span>string</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Sign.no_frees</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Sign.no_vars</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_compilation_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Target.compilation_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>some_target</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span>false</span><span>
  </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ml_modules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Bytes.content</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_modules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run_compilation_text</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>vs_t</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>vs_t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>value_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>value_name</span></span><span> </span><span>::</span><span> </span><span class="inner_quoted"><span>"()"</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>enclose</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Exn.interruptible_capture</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cookie</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value_code</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>partiality_as_none</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Exn.release</span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>General.Match</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>General.Bind</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>General.Fail</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_value_exn</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Evaluation of term "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>vs_ty_t</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>run_compilation_text</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_compilation_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs_ty_t</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Code_Thingol.dynamic_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Exn.map_res</span><span> </span><span>o</span><span> </span><span class="entity"><span>postproc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_value_strict</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Exn.release</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dynamic_value_exn</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_value</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>partiality_as_none</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dynamic_value_exn</span></span><span> </span><span class="entity"><span>cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_target</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* evaluation for truth or nothing *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Truth_Result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>truth</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Truth_Result"</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_truth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Truth_Result.put</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>truth_cookie</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Truth_Result.get</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_truth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"put_truth"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_holds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>evaluator</span></span><span> </span><span class="entity"><span>vs_t</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>propT</span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a proposition: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iff</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>propT</span><span> </span><span>--&gt;</span><span> </span><span>propT</span><span> </span><span>--&gt;</span><span> </span><span>propT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>partiality_as_none</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>run_compilation_text</span></span><span> </span><span class="entity"><span>truth_cookie</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>evaluator</span></span><span> </span><span class="entity"><span>vs_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>Holds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Thm.mk_binop</span><span> </span><span class="entity"><span>iff</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cprop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="keyword1"><span>PROP</span></span><span> </span><a class="entity_ref" href="../../../../Tools.Code_Generator.html#Code_Generator.holds|const"><span>Code_Generator.holds</span></a><span>›</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_check_holds_oracle</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.&gt;&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Context.map_theory_result</span><span>
  </span><span class="main"><span>(</span></span><span>Thm.add_oracle</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Code_Generator.holds_by_evaluation|oracle"><span>holds_by_evaluation</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>evaluator</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check_holds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>evaluator</span></span><span> </span><span class="entity"><span>vs_t</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_holds_oracle</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>evaluator</span></span><span> </span><span class="entity"><span>vs_ty_t</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>raw_check_holds_oracle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>evaluator</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs_ty_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_holds_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.dynamic_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vs_t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>check_holds_oracle</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_compilation_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs_t</span></span><span class="main"><span>)</span></span><span>
      </span><span>o</span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*local*)</span></span><span>


</span><span class="comment1"><span>(** generator for computations -- partial implementations of the universal morphism from Isabelle to ML terms **)</span></span><span>

</span><span class="comment1"><span>(* auxiliary *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>generated_computationN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Generated_Computation"</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* possible type signatures of constants *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_signatures'</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_range</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_signatures</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Typtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>typ_signatures'</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Typtab.empty</span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>cTs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Typtab.lookup_list</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* name mangling *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tycos_of</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>tycos_of</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tycos_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml_name_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>covered_constsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"covered_consts"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="inner_quoted"><span>"_of_term"</span></span><span> </span><span>o</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>ml_name_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>tycos_of</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_for_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>symbol_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span>maps</span><span> </span><span class="entity"><span>tycos_of</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.const_typargs</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cTs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"eval_"</span></span><span> </span><span>o</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>ml_name_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>symbol_list</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cTs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* checks for input terms *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monomorphic</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_atyps</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type.constraint</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_computation_input</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_comb</span></span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>check_comb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad term, contains abstraction: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_comb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad term, computation cannot proceed on constant "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>monomorphic</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad term, contains polymorphic constant "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* code generation for of the universal morphism *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>print_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Syntax.print_pair</span><span> </span><span>ML_Syntax.print_string</span><span> </span><span>ML_Syntax.print_typ</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_of_term_funs</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>typ_signatures_for</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_for_const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_range</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"t"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_lhs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Const ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", _)"</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" $ "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_rhs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_for_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_eq</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_names</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>print_lhs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>print_rhs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_eqs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ_signs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_signatures_for</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_eq</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typ_signs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n  | "</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>print_eqs</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
    </span><span>|&gt;</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\nand "</span></span><span>
    </span><span>|&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"fun "</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_computation_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>compiled_value</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>requested_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>requested_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No equation available for requested type "</span></span><span>
        </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>requested_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_computation_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>compiled_value</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>requested_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proper_cTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>cTs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ_signatures_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_signatures</span></span><span> </span><span class="entity"><span>proper_cTs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_typ</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>typ_signatures_for</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No equation available for requested type "</span></span><span>
              </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ_signs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>Ts</span></span><span>
              </span><span>|&gt;</span><span> </span><span>cons</span><span> </span><span class="entity"><span>T</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_typ</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typ_signs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>required_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_typ</span></span><span> </span><span class="entity"><span>requested_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>of_term_for_typ'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="entity"><span>required_Ts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_for_const'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_for_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>proper_cTs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_for_const''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>o</span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>eval_for_const'</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_tuple</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>eval_for_const'</span></span><span> </span><span class="entity"><span>proper_cTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_abs</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"fn "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" =&gt; "</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_abs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>eval_for_const''</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cTs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>of_term_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_of_term_funs</span></span><span> </span><span class="main"><span>{</span></span><span>
          typ_signatures_for </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_signatures_for</span></span><span class="main"><span>,</span></span><span>
          eval_for_const </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_for_const'</span></span><span class="main"><span>,</span></span><span>
          of_term_for_typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_term_for_typ'</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>required_Ts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>of_term_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.append</span><span> </span><span class="entity"><span>generated_computationN</span></span><span>
          </span><span>o</span><span> </span><span class="entity"><span>of_term_for_typ'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>requested_Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>cat_lines</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="inner_quoted"><span>"structure "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>generated_computationN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ="</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"struct"</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"val "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>covered_constsN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_list</span><span> </span><span class="entity"><span>print_const</span></span><span> </span><span class="entity"><span>proper_cTs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"val "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>eval_tuple</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>compiled_value</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ()"</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"  ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>eval_abs</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"    "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>eval_tuple</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>");"</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>of_term_code</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"end"</span></span><span>
        </span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>of_term_names</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* dedicated preprocessor for computations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Computation_Preproc_Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.merge</span><span> </span><span>Thm.eq_thm_prop</span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.mksimps</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Computation_Preproc_Data.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span>o</span><span> </span><span>Thm.trim_context</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Computation_Preproc_Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess_conv</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess_term</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.plain_prop_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.rewrite_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Code_Generator.code_computation_unfold|attribute"><span>code_computation_unfold</span></span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.mapping</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"preprocessing equations for computation"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* mounting computations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prechecked_computation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>check_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prechecked_conv</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>raw_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>reject_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>raw_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>checked_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>check_computation_input</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Exn.interruptible_capture</span><span> </span><span class="entity"><span>raw_computation</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>partiality_as_none</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mount_computation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>lift_postproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>preprocess_term</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prechecked_computation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Preproc.static_value</span></span><span>
      </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> lift_postproc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_postproc</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>checked_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>computation</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mount_computation_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>preprocess_conv</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computation_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prechecked_conv</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Preproc.static_conv</span></span><span>
      </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>checked_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>computation_conv</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>holds</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.mk_binop</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>::</span></span><span> </span><span>prop</span><span> </span><span class="main"><span>⇒</span></span><span> </span><span>prop</span><span> </span><span class="main"><span>⇒</span></span><span> </span><span>prop</span><span>›</span></span></span></span><span>
  </span><span class="entity"><span>ct</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cprop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="keyword1"><span>PROP</span></span><span> </span><a class="entity_ref" href="../../../../Tools.Code_Generator.html#Code_Generator.holds|const"><span>Code_Generator.holds</span></a><span>›</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>holds_oracle</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.&gt;&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Context.map_theory_result</span><span>
  </span><span class="main"><span>(</span></span><span>Thm.add_oracle</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Code_Generator.holds|oracle"><span>holds</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>holds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mount_computation_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>raw_computation</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mount_computation_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span> </span><span class="entity"><span>raw_computation</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>holds_oracle</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** variants of universal runtime code generation **)</span></span><span>

</span><span class="comment1"><span>(*FIXME consolidate variants*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>runtime_code''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>tycos</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ml_modules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Code_Target.produce_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>Type_Constructor</span></span><span> </span><span class="entity"><span>tycos</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Bytes.content</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_modules</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tycos'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>target_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Constant "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code.string_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"\nhas a user-defined serialization"</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>const'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>consts'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tycos_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.markup_type</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"\nhas a user-defined serialization"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tyco'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tycos</span></span><span> </span><span class="entity"><span>tycos'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ml_code</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tycos_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts_map</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>runtime_code'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span> </span><span class="entity"><span>named_consts</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="entity"><span>vs_ty_evals</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_const</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cT</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>the_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No constant after preprocessing: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_computation_cTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>the_const</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>strip_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad term after preprocessing: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>evals</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computation_cTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cTs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_computation_cTs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>computation_cTs</span></span><span> </span><span class="entity"><span>named_consts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="comment1"><span>(*FIXME insufficient interfaces require double invocation of code generator*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ml_modules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compiled_value</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Code_Target.compilation_text'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>program''</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Code_Symbol.Type_Constructor</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>Code_Symbol.Constant</span></span><span> </span><span class="entity"><span>consts'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>vs_ty_evals</span></span><span class="main"><span>;</span></span><span>
        </span><span class="comment1"><span>(*FIXME constrain signature*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deresolve_tyco</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deresolve</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.Type_Constructor</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.markup_type</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"\nhas a user-defined serialization"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deresolve_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deresolve</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Symbol.Constant</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Constant "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code.string_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"\nhas a user-defined serialization"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyco_names</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span>map</span><span> </span><span class="entity"><span>deresolve_tyco</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>deresolve_const</span></span><span> </span><span class="entity"><span>named_consts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>generated_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Bytes.content</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_modules</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_term_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>of_term_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>print_computation_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>compiled_value</span></span><span> </span><span class="entity"><span>computation_cTs</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compiled_computation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generated_code</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_term_code</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>compiled_computation</span></span><span>
    </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>{</span></span><span> tyco_map </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tyco_names</span></span><span class="main"><span>,</span></span><span>
      const_map </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>named_consts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>const_names</span></span><span class="main"><span>,</span></span><span>
      of_term_map </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>of_term_names</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>funs_of_maps</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>tyco_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>of_term_map</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span> name_for_tyco </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco_map</span></span><span class="main"><span>,</span></span><span>
    name_for_const </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const_map</span></span><span class="main"><span>,</span></span><span>
    of_term_for_typ </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>of_term_map</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>runtime_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span> </span><span class="entity"><span>named_consts</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="entity"><span>vs_ty_evals</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>runtime_code'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>named_tycos</span></span><span> </span><span class="entity"><span>named_consts</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="entity"><span>vs_ty_evals</span></span><span> </span><span class="entity"><span>deps</span></span><span>
  </span><span>||&gt;</span><span> </span><span class="entity"><span>funs_of_maps</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** code and computation antiquotations **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mount_computationN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"mount_computation"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mount_computation_convN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"mount_computation_conv"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mount_computation_checkN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_this</span></span><span> </span><span class="inner_quoted"><span>"mount_computation_check"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Antiq_Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> named_consts</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    computation_Ts</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> computation_cTs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    position_index</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
    generated_code</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>{</span></span><span>
      name_for_tyco</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
      name_for_const</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
      of_term_for_typ</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span>lazy</span><span>
  </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> named_consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    computation_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> computation_cTs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    position_index </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span>
    generated_code </span><span class="main"><span>=</span></span><span> </span><span>Lazy.lazy</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"empty"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_position_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>position_index </span><span>o</span><span> </span><span>Code_Antiq_Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>named_consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>computation_cTs</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Antiq_Data.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_consts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>named_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>named_consts </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computation_Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>computation_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>computation_Ts </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>computation_cTs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>computation_cTs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>computation_cTs </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>position_index'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>position_index </span><span class="entity"><span>data</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generated_code'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eval"</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>computation_cTs'</span></span><span> </span><span>---&gt;</span><span> </span><span>Term.aT</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Const</span><span> </span><span class="entity"><span>computation_cTs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>preprocess_term</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Code_Thingol.dynamic_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>runtime_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>named_consts'</span></span><span> </span><span class="entity"><span>computation_Ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>evals</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Code_Antiq_Data.put</span><span> </span><span class="main"><span>{</span></span><span> 
        named_consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>named_consts'</span></span><span class="main"><span>,</span></span><span>
        computation_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>computation_Ts'</span></span><span class="main"><span>,</span></span><span>
        computation_cTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>computation_cTs'</span></span><span class="main"><span>,</span></span><span>
        position_index </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>position_index'</span></span><span class="main"><span>,</span></span><span>
        generated_code </span><span class="main"><span>=</span></span><span> </span><span>Lazy.lazy</span><span> </span><span class="entity"><span>generated_code'</span></span><span>
      </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_const</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>register</span></span><span> </span><span class="main"><span>{</span></span><span> named_consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>const</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    computation_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    computation_cTs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>register</span></span><span> </span><span class="main"><span>{</span></span><span> named_consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    computation_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    computation_cTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>body_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>position_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>current_position_index</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name_ofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Lazy.force</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>generated_code </span><span>o</span><span> </span><span>Code_Antiq_Data.get</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>position_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body_code_for</span></span><span> </span><span class="entity"><span>name_ofs</span></span><span> </span><span class="main"><span>(</span></span><span>ML_Context.struct_name</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_code</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>name_for_const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Long_Name.append</span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_for_const</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_computation</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"(Context.proof_of (Context.the_generic_context ()))"</span></span><span class="main"><span>,</span></span><span>
      </span><span>Long_Name.implode</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prfx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>generated_computationN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>covered_constsN</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span>ML_Syntax.atomic</span><span> </span><span>o</span><span> </span><span>ML_Syntax.print_typ</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
      </span><span>Long_Name.append</span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_computation_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>of_term_for_typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="entity"><span>mount_computation_checkN</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"(Context.proof_of (Context.the_generic_context ()))"</span></span><span class="main"><span>,</span></span><span>
      </span><span>Long_Name.implode</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prfx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>generated_computationN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>covered_constsN</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span>Long_Name.append</span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_term_for_typ</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_all_constrs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code.get_type</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst_TFree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>vs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>map_atyps</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_TFree</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts'</span></span><span>
            </span><span>---&gt;</span><span> </span><span class="entity"><span>dT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_all_constrs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_dTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.check_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_dTs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>o</span><span> </span><span>fold_aterms</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>monomorphic</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Polymorphic constant: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>dT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>monomorphic</span></span><span> </span><span class="entity"><span>dT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Polymorphic datatype: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dT</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>add_all_constrs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dTs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ml_code_antiq</span></span><span> </span><span class="entity"><span>raw_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.check_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_const</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>register_const</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_ml_computation_antiq</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>monomorphic</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Polymorphic type: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_computation</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>register_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml_computation_antiq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_ml_computation_antiq</span></span><span> </span><span class="entity"><span>mount_computationN</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml_computation_conv_antiq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_ml_computation_antiq</span></span><span> </span><span class="entity"><span>mount_computation_convN</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ml_computation_check_antiq</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Tools.Code_Generator.html#Code_Generator.holds|const"><span>holds</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_computation_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>register_computation</span></span><span> </span><span class="entity"><span>cTs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*local*)</span></span><span>


</span><span class="comment1"><span>(** reflection support **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_datatype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>some_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>declared_constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code.get_type</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>some_consts</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing_constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>declared_constrs</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>missing_constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Missing constructor(s) "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="entity"><span>missing_constrs</span></span><span>
                </span><span>^</span><span> </span><span class="inner_quoted"><span>" for datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>false_constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>declared_constrs</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>false_constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Non-constructor(s) "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="entity"><span>false_constrs</span></span><span>
                </span><span>^</span><span> </span><span class="inner_quoted"><span>" for datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>declared_constrs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eval_tyco</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.arity_number</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="entity"><span>pr'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyco'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="entity"><span>pr'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Code_Printer.concat</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pr'</span></span><span> </span><span class="entity"><span>Code_Printer.BR</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco'</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="entity"><span>pr'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Code_Printer.concat</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Code_Printer.enum</span></span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pr'</span></span><span> </span><span class="entity"><span>Code_Printer.BR</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco'</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Type_Constructor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eval_constr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.args_number</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="entity"><span>pr'</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.brackify</span></span><span> </span><span class="entity"><span>fxy</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>const'</span></span><span> </span><span>::</span><span> </span><span>the_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.tuplify</span></span><span> </span><span class="entity"><span>pr'</span></span><span> </span><span class="entity"><span>Code_Printer.BR</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Constant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.simple_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eval_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Constant</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.simple_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_reflection</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco_map</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const_map</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Code_Target.add_reserved</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>module_name</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile_ML</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>code</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eval_tyco</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="entity"><span>Code_Printer.str</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco_map</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eval_constr</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="entity"><span>Code_Printer.str</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constr_map</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eval_const</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="entity"><span>Code_Printer.str</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const_map</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_reflection</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.map_binding</span><span> </span><span class="entity"><span>Code_Target.code_path</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preamble</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="inner_quoted"><span>"(* Generated from "</span></span><span> </span><span>^</span><span>
            </span><span>Path.implode</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Resources.thy_path</span></span><span> </span><span class="main"><span>(</span></span><span>Path.basic</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_base_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"; DO NOT EDIT! *)"</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Target.export</span></span><span> </span><span class="entity"><span>code_binding</span></span><span> </span><span class="main"><span>(</span></span><span>Bytes.string</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preamble</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>code</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Target.code_export_message</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_code_reflect</span></span><span> </span><span class="entity"><span>prep_type</span></span><span> </span><span class="entity"><span>prep_const</span></span><span> </span><span class="entity"><span>raw_datatypes</span></span><span> </span><span class="entity"><span>raw_functions</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_cos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>prep_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>o</span><span> </span><span>map</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_cos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_datatypes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tycos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_split</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_datatype</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>datatypes</span></span><span>
      </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span>flat</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>functions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_functions</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>functions</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>runtime_code''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>tycos</span></span><span> </span><span class="entity"><span>consts</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>process_reflection</span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_reflect</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_code_reflect</span></span><span> </span><span class="entity"><span>Code_Target.cert_tyco</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_reflect_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_code_reflect</span></span><span> </span><span class="entity"><span>Code_Target.read_tyco</span></span><span> </span><span class="entity"><span>Code.read_const</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Isar setup **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_consts_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"terms"</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Args.term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"datatypes"</span></span><span>  </span><span>--</span><span> </span><span>Args.colon</span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Args.typ</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span>
  </span><span class="main"><span>(</span></span><span>ML_Antiquotation.declaration</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>code</span><span>›</span></span></span><span>
    </span><span>Args.term</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>ml_code_antiq</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>ML_Antiquotation.declaration</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>computation</span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Args.typ</span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_consts_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>ml_computation_antiq</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>ML_Antiquotation.declaration</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>computation_conv</span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Args.typ</span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_consts_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>ml_computation_conv_antiq</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>ML_Antiquotation.declaration</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>computation_check</span><span>›</span></span></span><span>
    </span><span class="entity"><span>parse_consts_spec</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>ml_computation_check_antiq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_datatype</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Parse.name</span><span> </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>=</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.sym_ident</span><span> </span><span>||</span><span> </span><span>Parse.string</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Scan.fail</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.term</span><span> </span><span>:::</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>|</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_reflect</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"enrich runtime environment with generated code"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>datatypes</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_datatype</span></span><span>
      </span><span>:::</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>and</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_datatype</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>functions</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span>  </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.name</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>file_prefix</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.embedded</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>module_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_datatypes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_functions</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>code_reflect_cmd</span></span><span> </span><span class="entity"><span>raw_datatypes</span></span><span> </span><span class="entity"><span>raw_functions</span></span><span> </span><span class="entity"><span>module_name</span></span><span>
          </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>Path.explode_binding</span><span> </span><span class="entity"><span>file_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*local*)</span></span><span>


</span><span class="comment1"><span>(** using external SML files as substitute for proper definitions -- only for polyml!  **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Loaded_Values</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>notify_val</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>enterVal </span><span>ML_Env.name_space</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Loaded_Values.map</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>string</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abort</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Only value bindings allowed."</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notifying_context</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>ML_Compiler0.context</span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>name_space </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>lookupVal    </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupVal </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    lookupType   </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupType </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    lookupFix    </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupFix </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    lookupStruct </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupStruct </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    lookupSig    </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupSig </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    lookupFunct  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lookupFunct </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    enterVal     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>notify_val</span></span><span class="main"><span>,</span></span><span>
    enterType    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abort</span></span><span class="main"><span>,</span></span><span>
    enterFix     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abort</span></span><span class="main"><span>,</span></span><span>
    enterStruct  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abort</span></span><span class="main"><span>,</span></span><span>
    enterSig     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abort</span></span><span class="main"><span>,</span></span><span>
    enterFunct   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abort</span></span><span class="main"><span>,</span></span><span>
    allVal       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allVal </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    allType      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allType </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    allFix       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allFix </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    allStruct    </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allStruct </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    allSig       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allSig </span><span>ML_Env.name_space</span><span class="main"><span>,</span></span><span>
    allFunct     </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>allFunct </span><span>ML_Env.name_space</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
  print_depth </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span>
  here </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>here </span><span>ML_Env.context</span><span class="main"><span>,</span></span><span>
  print </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>print </span><span>ML_Env.context</span><span class="main"><span>,</span></span><span>
  error </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>error </span><span>ML_Env.context</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>use_file</span></span><span> </span><span class="entity"><span>filepath</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Loaded_Values.put</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.put_generic_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>ML_Compiler0.ML</span><span> </span><span class="entity"><span>notifying_context</span></span><span>
        </span><span class="main"><span>{</span></span><span>line </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> file </span><span class="main"><span>=</span></span><span> </span><span>Path.implode</span><span> </span><span class="entity"><span>filepath</span></span><span class="main"><span>,</span></span><span> verbose </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> debug </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span>File.read</span><span> </span><span class="entity"><span>filepath</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.the_global_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Loaded_Values.get</span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_definiendum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ml_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>thy</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Code_Target.add_reserved</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>ml_name</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Specification.axiomatization</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>Code_Target.set_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Constant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.simple_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Printer.str</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Code_Target.produce_code</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>const</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>Code_Target.generatedN</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_file</span></span><span> </span><span class="entity"><span>filepath</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>definienda</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ml_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>use_file</span></span><span> </span><span class="entity"><span>filepath</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>superfluous</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>definienda</span></span><span> </span><span class="entity"><span>ml_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>superfluous</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Value binding(s) "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="entity"><span>superfluous</span></span><span>
        </span><span>^</span><span> </span><span class="inner_quoted"><span>" found in external file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>filepath</span></span><span>
        </span><span>^</span><span> </span><span class="inner_quoted"><span>" not present among the given contants binding(s)."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>these_definienda</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.make</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>definienda</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_definiendum</span></span><span> </span><span class="entity"><span>these_definienda</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>definienda'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>AList.delete</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ml_names</span></span><span> </span><span class="entity"><span>definienda</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>definienda'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>polyml_as_definition</span></span><span> </span><span class="entity"><span>bTs</span></span><span> </span><span class="entity"><span>filepaths</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>definienda</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remaining</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>process_file</span></span><span> </span><span class="entity"><span>filepaths</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>definienda</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>remaining</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Constant binding(s) "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>remaining</span></span><span class="main"><span>)</span></span><span>
        </span><span>^</span><span> </span><span class="inner_quoted"><span>" not present in external file(s)."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*struct*)</span></span><span>
</span></pre>
</body>

</html>