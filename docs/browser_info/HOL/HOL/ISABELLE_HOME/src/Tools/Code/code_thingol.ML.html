<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Code/code_thingol.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Code/code_thingol.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Code/code_thingol.ML
    Author:     Florian Haftmann, TU Muenchen

Intermediate language ("Thin-gol") representing executable code.
Representation and translation.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> `%%</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> `$</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> `$$</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> `-&gt;</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> `--&gt;</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> `|=&gt;</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> `|==&gt;</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BASIC_CODE_THINGOL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>vname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>`%%</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * itype list
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ITyVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Dict</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>class * class</span><span class="main"><span>)</span></span><span> list * plain_dict
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>plain_dict</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Dict_Const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * class</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>itype * dict list</span><span class="main"><span>)</span></span><span> list
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Dict_Var</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> var</span><span class="main"><span>:</span></span><span> vname</span><span class="main"><span>,</span></span><span> index</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span> length</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>:</span></span><span> class</span><span class="main"><span>,</span></span><span> unique</span><span class="main"><span>:</span></span><span> bool </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> sym</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span class="main"><span>,</span></span><span> typargs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> dicts</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    dom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> range</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span class="main"><span>,</span></span><span> annotation</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>option</span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>IConst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> const
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname option
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> iterm * iterm
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>vname option * itype</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>iterm * itype</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ICase</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> term</span><span class="main"><span>:</span></span><span> iterm</span><span class="main"><span>,</span></span><span> typ</span><span class="main"><span>:</span></span><span> itype</span><span class="main"><span>,</span></span><span> clauses</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>iterm * iterm</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span> primitive</span><span class="main"><span>:</span></span><span> iterm </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> `-&gt; </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> * </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> `--&gt; </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> `$$ </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> `|==&gt; </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>typscheme</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CODE_THINGOL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>BASIC_CODE_THINGOL</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfoldl</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'b</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a * 'b </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfoldr</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'b * 'a</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'b </span><span>list</span><span> * 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_fun_n</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_app</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_abs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_abs_typed</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_let_no_pat</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_let_no_pat</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_pat_abs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_pat_abs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_const_app</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_IVar</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_IAbs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> satisfied_application</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> saturated_application</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> contains_dict_var</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unambiguous_dictss</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_constsyms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_tyconames</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_varnames</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_varnames</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>NoStmt</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>typscheme * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>iterm list * iterm</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm option * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> * thm option
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname list *
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * vname list </span><span class="comment1"><span>(*type argument wrt. canonical order*)</span></span><span class="main"><span>)</span></span><span> * itype list</span><span class="main"><span>)</span></span><span> list
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Datatypecons</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Class</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>class * class</span><span class="main"><span>)</span></span><span> list * </span><span class="main"><span>(</span></span><span>string * itype</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classrel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> class * class
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classparam</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> class
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classinst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> class</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span> tyco</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span> vs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>vname * sort</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
        superinsts</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>class * </span><span class="main"><span>(</span></span><span>itype * dict list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
        inst_params</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>const * int</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
        superinst_params</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>const * int</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span>Code_Symbol.Graph.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unimplemented</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> implemented_deps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_terms_stmt</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_constr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_case</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> group_stmts</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>program</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
      * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> * </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> read_const_exprs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> consts_program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>program</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>typscheme</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dynamic_value</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>typscheme</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> static_conv_thingol</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span> consts</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span> program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> deps</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>typscheme</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> static_conv_isa</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span> consts</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> static_value</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span> lift_postproc</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> consts</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span> program</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> deps</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>typscheme</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Thingol</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CODE_THINGOL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Basic_Code_Symbol</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** auxiliary **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfoldl</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldl</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfoldr</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** language core - types, terms **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>vname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>`%%</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * itype list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ITyVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Dict</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>class * class</span><span class="main"><span>)</span></span><span> list * plain_dict
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>plain_dict</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="entity"><span>Dict_Const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * class</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>itype * dict list</span><span class="main"><span>)</span></span><span> list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Dict_Var</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> var</span><span class="main"><span>:</span></span><span> vname</span><span class="main"><span>,</span></span><span> index</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span> length</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span> class</span><span class="main"><span>:</span></span><span> class</span><span class="main"><span>,</span></span><span> unique</span><span class="main"><span>:</span></span><span> bool </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ty1</span></span><span> </span><span class="entity"><span>`-&gt;</span></span><span> </span><span class="entity"><span>ty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"fun"</span></span><span> </span><span class="entity"><span>`%%</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>`--&gt;</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldr</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>`-&gt;</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_fun</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="inner_quoted"><span>"fun"</span></span><span> </span><span class="entity"><span>`%%</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_fun_n</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_fun</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>tys1</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys2</span></span><span> </span><span class="entity"><span>`--&gt;</span></span><span> </span><span class="entity"><span>ty1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> sym</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span class="main"><span>,</span></span><span> typargs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> dicts</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  dom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> range</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span class="main"><span>,</span></span><span> annotation</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>option</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>IConst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> const
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname option
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> iterm * iterm
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>vname option * itype</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>iterm * itype</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ICase</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> term</span><span class="main"><span>:</span></span><span> iterm</span><span class="main"><span>,</span></span><span> typ</span><span class="main"><span>:</span></span><span> itype</span><span class="main"><span>,</span></span><span> clauses</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>iterm * iterm</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span> primitive</span><span class="main"><span>:</span></span><span> iterm </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*see also signature*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_IVar</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_IAbs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>`$</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vs_tys</span></span><span> </span><span class="entity"><span>`|==&gt;</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldr</span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_ty</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>`-&gt;</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldl</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>t_t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t_t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_abs_typed</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_ty</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfoldr</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_ty</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span>
      </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>v_ty</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>SOME</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_abs_typed</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_let</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_let</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_let_no_pat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_let_no_pat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_let</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span> </span><span class="entity"><span>split_let</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_let_no_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span> </span><span class="entity"><span>split_let_no_pat</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_const_app</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unfold_app</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_constexprs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>c</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_constsyms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_constexprs</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_tycos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>`%%</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_tycos</span></span><span> </span><span class="entity"><span>tys</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_tycos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ITyVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_tyconames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_constexprs</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> typargs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_tycos</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_varnames</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_aux</span></span><span> </span><span class="entity"><span>add_vars</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>v</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>t2</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>fold_term</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_clause</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fold_clause</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_vars</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_aux</span></span><span> </span><span class="entity"><span>add_vars</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold_aux</span></span><span> </span><span class="entity"><span>add_vars</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_varnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_varnames</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>declare_varnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_varnames</span></span><span> </span><span>Name.declare</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_var</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_varnames</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invent_params</span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Name.invent_names</span><span> </span><span class="main"><span>(</span></span><span>Name.build_context</span><span> </span><span class="entity"><span>used</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"a"</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_pat_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_pat_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_var</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_var</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_pat_abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_pat_abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfoldr</span></span><span> </span><span class="entity"><span>split_pat_abs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_abs_eta</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_abs_eta</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_abs_eta</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_abs_eta</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invent_params</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>declare_varnames</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>satisfied_application</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>range</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>given</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>given</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_fun_n</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="entity"><span>range</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invent_params</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>declare_varnames</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>o</span><span> </span><span>drop</span><span> </span><span class="entity"><span>given</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span>SOME</span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>saturated_application</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>satisfied_application</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>vs_tys</span></span><span> </span><span class="entity"><span>`|==&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>,</span></span><span> primitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span>
        clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apply2</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>,</span></span><span>
        primitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distill_minimized_clause</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>restrict_vars_to</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>map_terms_bottom_up</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>purge_unused_vars_in</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>restrict_vars_to</span></span><span> </span><span class="main"><span>(</span></span><span>build</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_varnames</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distill'</span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="entity"><span>pat_args</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_varnames</span></span><span> </span><span class="main"><span>(</span></span><span>nth_drop</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>pat_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varnames_disjunctive</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_vs</span></span><span> </span><span class="main"><span>(</span></span><span>build</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_varnames</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>varnames_disjunctive</span></span><span> </span><span class="entity"><span>pat'</span></span><span>
            </span><span class="comment1"><span>(*prevent mingled scopes resulting in duplicated variables in pattern arguments*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_var</span></span><span> </span><span class="entity"><span>pat'</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="comment1"><span>(*reducible if shadowed by pattern*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_var</span></span><span> </span><span class="entity"><span>body'</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="comment1"><span>(*reducible if absent in body*)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>vs_map</span></span><span>
                 </span><span class="main"><span>(</span></span><span>nth_map</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>pat'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_args</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>purge_unused_vars_in</span></span><span> </span><span class="entity"><span>body'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="entity"><span>body'</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>SOME</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="entity"><span>pat_args</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> clauses </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="entity"><span>v</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>distill'</span></span><span> </span><span class="main"><span>(</span></span><span>AList.delete</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vs_map</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_args</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
                </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="entity"><span>pat_args</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_abs_eta</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>build</span><span> </span><span class="main"><span>(</span></span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>vs_map</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_dict_var</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dict</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exists_plain_dict_var_pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>d</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>exists_plain_dict_var_pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dict_Const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exists_dictss_var</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_plain_dict_var_pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dict_Var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>exists_dictss_var</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span>o</span><span> </span><span>exists</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_dict_var</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>{</span></span><span> dicts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exists_dictss_var</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dss</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>`$</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> primitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contains_dict_var</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unambiguous_dictss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>exists_dictss_var</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>unique</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="entity"><span>unique</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** statements, abstract programs **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>typscheme</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>NoStmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>typscheme * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>iterm list * iterm</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm option * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> * thm option
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname list * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * vname list</span><span class="main"><span>)</span></span><span> * itype list</span><span class="main"><span>)</span></span><span> list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Datatypecons</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Class</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>class * class</span><span class="main"><span>)</span></span><span> list * </span><span class="main"><span>(</span></span><span>string * itype</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classrel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> class * class
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classparam</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> class
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Classinst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> class</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span> tyco</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span> vs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>vname * sort</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      superinsts</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>class * </span><span class="main"><span>(</span></span><span>itype * dict list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      inst_params</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>const * int</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      superinst_params</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>const * int</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm * bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span>Code_Symbol.Graph.T</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unimplemented</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>build</span><span> </span><span>o</span><span> </span><span>Code_Symbol.Graph.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NoStmt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>implemented_deps</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Code_Symbol.Graph.keys</span><span> </span><span class="entity"><span>program</span></span><span>
  </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.all_preds</span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unimplemented</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_classparam_instances_as_term</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>NoStmt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NoStmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tysm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tysm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Datatypecons</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Class</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Classrel</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stmt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Classparam</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stmt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_terms_stmt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Classinst</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>superinsts</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>inst_params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>superinst_params</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Classinst</span></span><span> </span><span class="main"><span>{</span></span><span> class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> tyco </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> vs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> superinsts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>superinsts</span></span><span class="main"><span>,</span></span><span>
          inst_params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_classparam_instances_as_term</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>inst_params</span></span><span class="main"><span>,</span></span><span>
          superinst_params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_classparam_instances_as_term</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>superinst_params</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_constr</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>sym</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Datatypecons</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_case</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_case</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>linear_stmts</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.strong_conn</span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>AList.make</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>group_stmts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_datatypecons</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Datatypecons</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_datatypecons</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_datatype</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_datatype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_class</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Class</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_class</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_classrel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Classrel</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_classrel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_classparam</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Classparam</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_classparam</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_classinst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Classinst</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_classinst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="entity"><span>stmts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_datatypecons</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_datatype</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stmts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="entity"><span>is_datatype</span></span><span> </span><span class="entity"><span>stmts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_class</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_classrel</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_classparam</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stmts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_class</span></span><span> </span><span class="entity"><span>stmts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_fun</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_classinst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stmts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>is_fun</span></span><span> </span><span class="entity"><span>stmts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Illegal mutual dependencies: "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>commas</span><span>
        </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stmts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>linear_stmts</span></span><span> </span><span class="entity"><span>program</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>group</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** translation kernel **)</span></span><span>

</span><span class="comment1"><span>(* generic mechanisms *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>symbolize</span></span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>symbolize</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_dep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Code_Symbol.Graph.add_edge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>program</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_dep</span></span><span>
      </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>deps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>program</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NoStmt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_dep</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>snd</span><span>
      </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.map_node</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>stmt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>deps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PERMISSIVE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translation_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>sub_msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>permissive</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PERMISSIVE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_msg</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"in code equation "</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>some_thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dep_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"with dependency "</span></span><span>
          </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" -&gt; "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.quote</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_dep_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm_msg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dep_msg</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>thm_msg</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>dep_msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"\n("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>thm_msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>",\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>dep_msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>thm_msg</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"\n("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>thm_msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>dep_msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"\n("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>dep_msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>thm_dep_msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>sub_msg</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_permissive</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>prgrm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>prgrm</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>SOME</span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PERMISSIVE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prgrm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_wellsorted</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_class</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.class_error</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_typ</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="inner_quoted"><span>"Type "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" not of sort "</span></span><span> </span><span>^</span><span>
        </span><span>Syntax.string_of_sort</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>translation_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>deps</span></span><span>
      </span><span class="inner_quoted"><span>"Wellsortedness error"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>err_typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>err_class</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* inference of type annotations for disambiguation with type classes *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tagged_type</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_tagged_type</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_tagged_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_tagged_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fastype_of_tagged_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span>o</span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_tagged_type</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proj_sort</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_sort_constraints</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>null</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>proj_sort</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Preproc.sortargs</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>mk_tagged_type</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_sort_constraints</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>annotate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>erase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reinfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer_Context.infer_types</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_types</span><span> </span><span>Type.strip_sorts</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reinferred_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reinfer</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>erase</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>tag_term</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>reinferred_rhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>annotate_eqns</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Proof_Context.theory_of</span><span> </span><span>|&gt;</span><span> </span><span>Proof_Context.init_global</span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>Type_Infer_Context.const_sorts</span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
      </span><span class="comment1"><span>(*avoid spurious fixed variables: there is no eigen context for equations*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>some_abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annotate</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* abstract dictionary construction *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>typarg_witness</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Weakening</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>class * class</span><span class="main"><span>)</span></span><span> list * plain_typarg_witness
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>plain_typarg_witness</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Global</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * class</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>typ * typarg_witness list</span><span class="main"><span>)</span></span><span> list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Local</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> var</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span> index</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span> sort</span><span class="main"><span>:</span></span><span> sort</span><span class="main"><span>,</span></span><span> unique</span><span class="main"><span>:</span></span><span> bool </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>brand_unique</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Global</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>brand_unique</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Local</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> unique </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Local</span></span><span> </span><span class="main"><span>{</span></span><span> var </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> index </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> sort </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> unique </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>construct_dictionaries</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proj_sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_relation</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Weakening</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>classrels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sub_class</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>super_class</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Weakening</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sub_class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>super_class</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>classrels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brand_unique</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_constructor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dss</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Weakening</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Global</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>map</span><span class="main"><span>)</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_variable</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proj_sort</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Weakening</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Local</span></span><span>
        </span><span class="main"><span>{</span></span><span> var </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> index </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> sort </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sort'</span></span><span class="main"><span>,</span></span><span> unique </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sort'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typarg_witnesses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.of_sort_derivation</span><span> </span><span class="entity"><span>algebra</span></span><span>
      </span><span class="main"><span>{</span></span><span>class_relation </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span>Sorts.classrel_derivation</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_relation</span></span><span> </span><span class="entity"><span>unique</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       type_constructor </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_constructor</span></span><span class="main"><span>,</span></span><span>
       type_variable </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_variable</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proj_sort</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Sorts.CLASS_ERROR</span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_wellsorted</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typarg_witnesses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* translation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_undefined_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>{</span></span><span> sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Code.is_undefined</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_undefined_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.get_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_datatype</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_tyvar_sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cos</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Datatype</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Type_Constructor</span></span><span> </span><span class="entity"><span>stmt_datatype</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stmt_datatypecons</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Datatypecons</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stmt_classparam</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>class</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Classparam</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stmt_fun</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code.equations_of_cert</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>cert</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="entity"><span>NoStmt</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqns'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>annotate_eqns</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>some_case_cong</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.get_case_cong</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_tyvar_sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
            </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>ty</span></span><span>
            </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_eqns</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>eqns'</span></span><span>
            </span><span>#&gt;&gt;</span><span>
             </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>NoStmt</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyscm</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tyscm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_case_cong</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code.get_type_of_constr_or_abstr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stmt_datatypecons</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Axclass.class_of_param</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stmt_classparam</span></span><span> </span><span class="entity"><span>class</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stmt_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Preproc.cert</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>stmt_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>algbr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>super_classes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Sorts.minimize_sort</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span>o</span><span> </span><span>Sorts.super_classes</span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>params </span><span class="main"><span>(</span></span><span class="entity"><span>Axclass.get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_class</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>super_class</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>ensure_classrel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>super_class</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>super_classes</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Class</span></span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>Name.aT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Type_Class</span></span><span> </span><span class="entity"><span>stmt_class</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ensure_classrel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub_class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>super_class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_classrel</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>sub_class</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>super_class</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Classrel</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Class_Relation</span></span><span> </span><span class="entity"><span>stmt_classrel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub_class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>super_class</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ensure_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>algbr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>super_classes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Sorts.minimize_sort</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span>o</span><span> </span><span>Sorts.super_classes</span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>these_class_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span>o</span><span> </span><span class="entity"><span>Axclass.get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>these_class_params</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>superclass_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>these_class_params</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Sorts.complete_sort</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span>o</span><span> </span><span>Sorts.super_classes</span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent_names</span><span> </span><span>Name.context</span><span> </span><span>Name.aT</span><span> </span><span class="main"><span>(</span></span><span>Sorts.mg_domain</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>class</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sorts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.mg_domain</span><span> </span><span class="main"><span>(</span></span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>class</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sort2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span>
      </span><span>Sorts.inter_sort</span><span> </span><span class="main"><span>(</span></span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sort1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>sorts'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity_typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity_typ'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_super_instance</span></span><span> </span><span class="entity"><span>super_class</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>super_class</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_dicts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>super_class</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>super_class</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Dict</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Dict_Const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>super_class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_classparam_instance</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>map_type_tfree</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>arity_typ'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_length</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Axclass.unoverload_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_const</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>Logic.unvarifyT_global</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>snd</span><span>
          </span><span>o</span><span> </span><span>Logic.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>const</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom_length</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_inst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>class</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>ensure_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_tyvar_sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>translate_super_instance</span></span><span> </span><span class="entity"><span>super_classes</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>translate_classparam_instance</span></span><span> </span><span class="entity"><span>class_params</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>translate_classparam_instance</span></span><span> </span><span class="entity"><span>superclass_params</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>superinsts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst_params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>superinst_params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Classinst</span></span><span> </span><span class="main"><span>{</span></span><span> class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> tyco </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> vs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span>
            superinsts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>superinsts</span></span><span class="main"><span>,</span></span><span> inst_params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst_params</span></span><span class="main"><span>,</span></span><span> superinst_params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>superinst_params</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Class_Instance</span></span><span> </span><span class="entity"><span>stmt_inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ITyVar</span></span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ensure_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>`%%</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>translate_app</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.dest_abs_global</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.desymbolize</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.used_free</span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fastype_of_tagged_term</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>ty</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>rty</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="entity"><span>t'</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`|=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>translate_app</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="entity"><span>t'</span></span><span>
            </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
            </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_eqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
  </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
  </span><span>#&gt;&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proper</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_eqns</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>maybe_permissive</span></span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_eqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>Code.is_abstr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>translation_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>deps</span></span><span>
          </span><span class="inner_quoted"><span>"Abstraction violation"</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"constant "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>Code.string_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>annotate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_tagged_type</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.const_typargs</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sorts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Preproc.sortargs</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>range</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_type</span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>c</span></span><span>
    </span><span>||&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typargs</span></span><span>
    </span><span>||&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_dicts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typargs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>sorts</span></span><span class="main"><span>)</span></span><span>
    </span><span>||&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>range</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>range</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>{</span></span><span> sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> typargs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typargs</span></span><span class="main"><span>,</span></span><span> dicts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>,</span></span><span>
        dom </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> range </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>range</span></span><span class="main"><span>,</span></span><span> annotation </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>annotate</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dom</span></span><span> </span><span class="entity"><span>`--&gt;</span></span><span> </span><span class="entity"><span>range</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>t_pos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>project_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span>o</span><span> </span><span>nth_drop</span><span> </span><span class="entity"><span>t_pos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distill_clauses</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>pat</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distill_minimized_clause</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty_case</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_case</span></span><span class="main"><span>,</span></span><span>
          clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_undefined_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>distill_clauses</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>project_clause</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span>
          primitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_pats</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>t_pos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_cases</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>xs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>nth_drop</span><span> </span><span class="entity"><span>t_pos</span></span><span>
          </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>case_pats</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>case_pats</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_case'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>case_pats</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>project_cases</span></span><span> </span><span class="entity"><span>tys</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>o</span><span> </span><span>binder_types</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>ty_case</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distill_clauses</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="entity"><span>ts_clause</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>constr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> dom </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>constr</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>pat_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>distill_minimized_clause</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>constrs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts_clause</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>translate_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>c_ty</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>ICase</span></span><span> </span><span class="main"><span>{</span></span><span> term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_term</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_case'</span></span><span class="main"><span>,</span></span><span>
              clauses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_undefined_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>distill_clauses</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>project_cases</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span>
              primitive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_app</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c_ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>translate_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>some_abs</span></span><span> </span><span class="entity"><span>c_ty</span></span><span>
  </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Code.get_case_schema</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wanted</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pattern_schema</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>satisfied_application</span></span><span> </span><span class="entity"><span>wanted</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_tagged_type</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>translate_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>pattern_schema</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs_tys</span></span><span> </span><span class="entity"><span>`|==&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>`$$</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_tyvar_sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>algbr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proj_sort</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proj_sort</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_dicts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_dict</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Weakening</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>classrels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ensure_classrel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>classrels</span></span><span>
          </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_plain_dict</span></span><span> </span><span class="entity"><span>d</span></span><span>
          </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Dict</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>translate_plain_dict</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Global</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>ensure_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>inst</span></span><span>
          </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>ty</span></span><span>
            </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>translate_dict</span></span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dss</span></span><span>
          </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>Dict_Const</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_plain_dict</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Local</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>ensure_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Dict_Var</span></span><span> </span><span class="main"><span>{</span></span><span> var </span><span class="main"><span>=</span></span><span> </span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> index </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span>
            length </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> unique </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>construct_dictionaries</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span>
    </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>typarg_witnesses</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>translate_dict</span></span><span> </span><span class="entity"><span>typarg_witnesses</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* store *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Data</span></span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.empty</span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_generation</span></span><span> </span><span class="entity"><span>ignore_cache</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>thing</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Program.change_yield</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ignore_cache</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>thing</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thing</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thing</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* program generation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_abstract_constructors</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.is_abstr</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>abstrs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cannot export abstract constructor(s): "</span></span><span>
      </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.string_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abstrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_generation_for_consts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ignore_cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>permissive</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>check_abstract_constructors</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Code_Preproc.timed</span></span><span> </span><span class="inner_quoted"><span>"translating program"</span></span><span> </span><span class="main"><span>#</span></span><span>ctxt
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>invoke_generation</span></span><span> </span><span class="entity"><span>ignore_cache</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ensure_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>permissive</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> algebra </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> eqngr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_generation_for_consts'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ignore_cache_and_permissive</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>invoke_generation_for_consts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="main"><span>{</span></span><span> ignore_cache </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ignore_cache_and_permissive</span></span><span class="main"><span>,</span></span><span> permissive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ignore_cache_and_permissive</span></span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Preproc.obtain</span></span><span> </span><span class="entity"><span>ignore_cache_and_permissive</span></span><span>
      </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> terms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span>
  </span><span>|&gt;</span><span> </span><span>snd</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_generation_for_consts''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>invoke_generation_for_consts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="main"><span>{</span></span><span> ignore_cache </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> permissive </span><span class="main"><span>=</span></span><span> </span><span>false</span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="entity"><span>algebra_eqngr</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span> deps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> program </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consts_program_permissive</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>invoke_generation_for_consts'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consts_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.restrict</span><span>
      </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Code_Symbol.Graph.all_succs</span><span> </span><span class="entity"><span>program</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>invoke_generation_for_consts'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>consts</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>project</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* value evaluation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_term_types</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>fold_atyps</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span>eq_fst</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
      </span><span>o</span><span> </span><span>dest_TFree</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>annotate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.dummy_pattern</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummy_constant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.dummy_pattern</span><span>›</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_value</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate_tyvar_sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>translate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algbr</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span>false</span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Fun</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_value</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Code_Symbol.Graph.get_node</span><span> </span><span class="entity"><span>program1</span></span><span> </span><span class="entity"><span>dummy_constant</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.immediate_succs</span><span> </span><span class="entity"><span>program1</span></span><span> </span><span class="entity"><span>dummy_constant</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.del_node</span><span> </span><span class="entity"><span>dummy_constant</span></span><span> </span><span class="entity"><span>program1</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deps_all</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.all_succs</span><span> </span><span class="entity"><span>program2</span></span><span> </span><span class="entity"><span>deps'</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps_all</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program2</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>program3</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deps'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ensure_stmt</span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>stmt_value</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.dummy_pattern</span><span>›</span></span><span>
    </span><span>#&gt;</span><span> </span><span>snd</span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>term_value</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_evaluation</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>program</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs_ty_t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Code_Preproc.timed</span></span><span> </span><span class="inner_quoted"><span>"translating term"</span></span><span> </span><span class="main"><span>#</span></span><span>ctxt
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>invoke_generation</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ensure_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> algebra </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> eqngr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>,</span></span><span> t </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>vs_ty_t'</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Preproc.dynamic_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>dynamic_evaluation</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Preproc.dynamic_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>postproc</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>dynamic_evaluation</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_evaluation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="entity"><span>static_eval</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>static_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invoke_generation_for_consts''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_evaluation_thingol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>static_eval</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>evaluation</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>dynamic_eval</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs_ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Code_Preproc.timed</span></span><span> </span><span class="inner_quoted"><span>"translating term"</span></span><span> </span><span class="main"><span>#</span></span><span>ctxt
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>ensure_value</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> t </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>dynamic_eval</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs_ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>static_evaluation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program_deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>evaluation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>program </span><span class="entity"><span>program_deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>static_eval</span></span><span> </span><span class="entity"><span>program_deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_evaluation_isa</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="entity"><span>static_eval</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>static_evaluation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program_deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>static_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>program </span><span class="entity"><span>program_deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_conv_thingol</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_consts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Preproc.static_conv</span></span><span> </span><span class="entity"><span>ctxt_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>static_evaluation_thingol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program_deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>static_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>program_deps</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vs_ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>static_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>vs_ty</span></span><span> </span><span class="entity"><span>deps</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_conv_isa</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_consts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Preproc.static_conv</span></span><span> </span><span class="entity"><span>ctxt_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>static_evaluation_isa</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>static_value</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_postproc_consts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Preproc.static_value</span></span><span> </span><span class="entity"><span>ctxt_postproc_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>static_evaluation_thingol</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>algebra_eqngr</span></span><span> </span><span class="entity"><span>comp</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** constant expressions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_const_exprs_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>this_theory</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context.theory_base_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Context.get_theory</span><span> </span><span class="main"><span>{</span></span><span>long </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consts_of</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>constants </span><span class="main"><span>(</span></span><span>Consts.dest</span><span> </span><span class="main"><span>(</span></span><span>Sign.consts_of</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.is_abstr</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>belongs_here</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Sign.declared_const</span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Theory.parents_of</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consts_of_select</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>belongs_here</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consts_of</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_const_expr</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Syntax.parse_input</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Markup.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Symbol_Pos.implode</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts_of</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"._"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts_of_select</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>this_theory</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Code.read_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>str</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Code.read_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>str</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>apply2</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>read_const_expr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_const_exprs_all</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span> </span><span>o</span><span> </span><span class="entity"><span>read_const_exprs_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_const_exprs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>const_exprs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts_permissive</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>read_const_exprs_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>const_exprs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts'</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>consts_program_permissive</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts_permissive</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>implemented_deps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.is_abstr</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts'</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** diagnostic commands **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_depgr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>eqngr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Preproc.obtain</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> terms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Graph.all_succs</span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_consts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqngr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.writeln</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Preproc.pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>code_depgr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>coalesce_strong_conn</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Graph.strong_conn</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xss_ys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span>commas</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>y_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss_ys</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>coalesced_succs_for</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>Graph.immediate_succs</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>y_for</span></span><span>
      </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coalesced_succs_for</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss_ys</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>Graph.get_node</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>succs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss_ys</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_deps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_entry</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.string_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Graph_Display.content_node</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>label</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>code_depgr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Graph.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.pretty_cert</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>coalesce_strong_conn</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_entry</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Graph_Display.display_graph</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_thms_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>read_const_exprs_all</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_deps_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_deps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>read_const_exprs_all</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_thms</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"print system of code equations for code"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>code_thms_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.context_of</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_deps</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"visualize dependencies of code equations for code"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>code_deps_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.context_of</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*struct*)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Basic_Code_Thingol</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BASIC_CODE_THINGOL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Thingol</span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>