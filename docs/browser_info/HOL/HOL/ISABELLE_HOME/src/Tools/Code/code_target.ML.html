<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Code/code_target.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Code/code_target.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Code/code_target.ML
    Author:     Florian Haftmann, TU Muenchen

Generic infrastructure for target language data.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CODE_TARGET</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cert_tyco</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> read_tyco</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Singleton</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * Pretty.T </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string list * Pretty.T</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> next_export</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> export_code_for</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> * </span><span class="main"><span>(</span></span><span>Path.T</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span>  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> produce_code_for</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>Bytes.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>option</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> present_code_for</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Bytes.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_code_for</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> export_code</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> * </span><span class="main"><span>(</span></span><span>Path.T</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> * </span><span>Token.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> export_code_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> * </span><span>Input.source</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> * </span><span>Token.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> produce_code</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>Bytes.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>option</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> present_code</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Bytes.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_code</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span>Token.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> codeN</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> generatedN</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_path</span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Path.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_export_message</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> export</span><span class="main"><span>:</span></span><span> </span><span>Path.binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Bytes.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compilation_text</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>class</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Code_Thingol.itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Code_Thingol.iterm</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>Bytes.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compilation_text'</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>class</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Code_Thingol.itype</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Code_Thingol.iterm</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>Bytes.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>serializer</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.literals</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>language</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ancestry</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assert_target</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_language</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>language</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_derived_target</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_literals</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>literals</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_args</span><span class="main"><span>:</span></span><span> 'a </span><span>parser</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_code_width</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>,</span></span><span> 'e</span><span class="main"><span>,</span></span><span> 'f</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>symbol_attr_decl</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_identifiers</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>symbol_attr_decl</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_printings</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.raw_const_syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Printer.tyco_syntax</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>unit</span><span class="main"><span>,</span></span><span> </span><span>unit</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>symbol_attr_decl</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_reserved</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Target</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CODE_TARGET</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Basic_Code_Symbol</span><span class="main"><span>;</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Basic_Code_Thingol</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.literals</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>,</span></span><span> 'e</span><span class="main"><span>,</span></span><span> 'f</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>symbol_attr_decl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'a </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'b </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    </span><span>class</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'c </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>class</span><span> * </span><span>class</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'd </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span>class</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'e </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * 'f </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Code_Symbol.attr</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tyco_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.tyco_syntax</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.raw_const_syntax</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** checking and parsing of symbols **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Sign.declared_const</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such constant: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.read_const</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Sign.declared_tyname</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such type constructor: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span>Proof_Context.read_type_name</span><span> </span><span class="main"><span>{</span></span><span>proper </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> strict </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Axclass.get_info</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_classrel_ident</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.class</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>&lt;</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span>Parse.class</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cert_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>read_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span>Proof_Context.read_class</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_class</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_inst_ident</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>::</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span>Parse.class</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Symbol.map_attr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Symbol.map_attr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Proof_Context.read_class</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.read_class</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Symbol.map_attr</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>o</span><span> </span><span>apply2</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_class</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Code_Symbol.map_attr</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_tyco</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.read_class</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>o</span><span> </span><span>apply2</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.read_class</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_name</span></span><span> </span><span class="entity"><span>is_module</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad empty code name"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.explode</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_module</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name.desymbolize</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad code name without module component: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name.desymbolize</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>y'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ys'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>y'</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_module</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid code name: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
      </span><span>^</span><span> </span><span class="inner_quoted"><span>"better try "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.implode</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** theory data **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Singleton</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * Pretty.T </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string list * Pretty.T</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>serializer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>
    reserved_syms</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    identifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Printer.identifiers</span></span><span class="main"><span>,</span></span><span>
    includes</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    class_syntax</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
    tyco_syntax</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Printer.tyco_syntax</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
    const_syntax</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Printer.const_syntax</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
    module_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>language</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>serializer</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>serializer</span></span><span class="main"><span>,</span></span><span> literals</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>literals</span></span><span class="main"><span>,</span></span><span>
  check</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>env_var</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> make_destination</span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Path.T</span><span class="main"><span>,</span></span><span> make_command</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
  evaluation_args</span><span class="main"><span>:</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Thingol.program</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Code_Thingol.program</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge_ancestry</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ancestry</span></span><span> * </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.join</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>serial</span><span class="main"><span>:</span></span><span> </span><span>serial</span><span class="main"><span>,</span></span><span> language</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>language</span></span><span class="main"><span>,</span></span><span> ancestry</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ancestry</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Targets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span> * </span><span class="entity"><span>Code_Printer.data</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span> * </span><span>int</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>targets1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>targets2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>targets'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Symtab.join</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>target1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>target1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>target2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>serial </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>target1</span></span><span class="main"><span>,</span></span><span> language </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>language </span><span class="entity"><span>target1</span></span><span class="main"><span>,</span></span><span>
            ancestry </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>merge_ancestry</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ancestry </span><span class="entity"><span>target1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>ancestry </span><span class="entity"><span>target2</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>Code_Printer.merge_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Incompatible targets: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>targets1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>targets2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>index'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>targets'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exists_target</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Targets.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup_target_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Targets.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>target_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown code target language: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reset_index</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Targets.get</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Targets.map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Theory.at_begin</span><span> </span><span class="entity"><span>reset_index</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_export</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Targets.map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Targets.get</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"export"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_ancestry</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>the_target_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="entity"><span>lookup_target_data</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>this_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_target_data</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ancestry </span><span class="entity"><span>target</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modifies</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>ancestry</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>o</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifies</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>the_target_data</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ancestry</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>this_data</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>data'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Code_Printer.merge_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>datas</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modify</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>allocate_target</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Attempt to overwrite existing target "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Targets.map</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span>Symtab.update</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Printer.empty_data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_language</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>language</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>allocate_target</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>{</span></span><span>serial </span><span class="main"><span>=</span></span><span> </span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> language </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>language</span></span><span class="main"><span>,</span></span><span>
    ancestry </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_derived_target</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>initial_ancestry</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>initial_ancestry</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Must derive from existing target(s)"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_target_data</span></span><span> </span><span class="entity"><span>target_name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_target_data</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown code target language: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>target_name'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>target_data'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>target_data'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>targets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>the_target_data</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>initial_ancestry</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>supremum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>target'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>target</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>target'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Incompatible targets"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targets</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ancestries</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ancestry </span><span class="entity"><span>targets</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>initial_ancestry</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ancestry'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ancestry</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>merge_ancestry</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ancestry</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ancestry'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ancestries</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>allocate_target</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>{</span></span><span>serial </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>serial </span><span class="entity"><span>supremum</span></span><span class="main"><span>,</span></span><span> language </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>language </span><span class="entity"><span>supremum</span></span><span class="main"><span>,</span></span><span>
      ancestry </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ancestry</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_target</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Targets.map</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span>Symtab.map_entry</span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span class="entity"><span>Code_Printer.map_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_reserved</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_identifiers</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>2</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_printings</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>3</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** serializers **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>codeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"code"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>generatedN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Generated_Code"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.append</span><span> </span><span class="main"><span>(</span></span><span>Path.basic</span><span> </span><span class="entity"><span>codeN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_export_message</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span>Export.message</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Path.basic</span><span> </span><span class="entity"><span>codeN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Generated_Files.add_files</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Export.export</span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>(</span></span><span>Bytes.contents_blob</span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_logical</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>file_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>file_pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.binding</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>path</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>file_pos</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_path</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Singleton</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>(</span></span><span>Path.ext</span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="entity"><span>modules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span> </span><span>+</span><span> </span><span>Path.make</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modules</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>tap</span><span> </span><span class="entity"><span>code_export_message</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_physical</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Singleton</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Bytes.write</span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="entity"><span>code_modules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>segments</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Path.basic</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span class="entity"><span>Isabelle_System.make_directory</span></span><span> </span><span class="main"><span>(</span></span><span>Path.appends</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>segments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span>Bytes.write</span><span> </span><span class="main"><span>(</span></span><span>Path.appends</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>segments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
     </span><span class="entity"><span>code_modules</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_result</span></span><span> </span><span class="entity"><span>some_file</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_code</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>some_file</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>file_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>next_export</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>export_logical</span></span><span> </span><span class="main"><span>(</span></span><span>Path.basic</span><span> </span><span class="entity"><span>file_prefix</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>pretty_code</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>export_logical</span></span><span> </span><span class="entity"><span>file_prefix</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>pretty_code</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>file</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>File.full_path</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Resources.master_directory</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>file</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>File.check_dir</span><span> </span><span class="main"><span>(</span></span><span>Path.dir</span><span> </span><span class="entity"><span>root</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>export_physical</span></span><span> </span><span class="entity"><span>root</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>pretty_code</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>produce_result</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.format</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Singleton</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>deresolve</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="entity"><span>code_modules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>code_modules</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>deresolve</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>present_result</span></span><span> </span><span class="entity"><span>selects</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_modules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.format</span></span><span> </span><span class="entity"><span>selects</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pretty_modules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Singleton</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>p</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hierarchy</span></span><span> </span><span class="entity"><span>code_modules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Bytes.appends</span><span> </span><span class="main"><span>(</span></span><span>separate</span><span> </span><span class="main"><span>(</span></span><span>Bytes.string</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>code_modules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** serializer usage **)</span></span><span>

</span><span class="comment1"><span>(* technical aside: pretty printing width *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_code_width</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Code_Generator.default_code_width|attribute"><span>default_code_width</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>80</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_width</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>default_code_width</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>the_width</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span>o</span><span> </span><span class="entity"><span>default_width</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* montage *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_language</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span>language </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="entity"><span>lookup_target_data</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_literals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>literals </span><span>o</span><span> </span><span class="entity"><span>the_language</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_evaluation_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>evaluation_args </span><span>o</span><span> </span><span class="entity"><span>the_language</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>activate_target</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modify</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>join_ancestry</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serializer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>serializer </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>language</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span> serializer </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>serializer</span></span><span class="main"><span>,</span></span><span> data </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> modify </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>modify</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_program_for_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>syms_hidden</span></span><span> </span><span class="entity"><span>syms1</span></span><span> </span><span class="entity"><span>program1</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syms2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms_hidden</span></span><span> </span><span class="entity"><span>syms1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms_hidden</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unimplemented</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.unimplemented</span></span><span> </span><span class="entity"><span>program2</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>unimplemented</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No code equations for "</span></span><span> </span><span>^</span><span>
        </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.markup_const</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unimplemented</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syms3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.all_succs</span><span> </span><span class="entity"><span>program2</span></span><span> </span><span class="entity"><span>syms2</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>program2</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>program3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_includes_for_syms</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_include</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>content</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>select_include</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>proto_program</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>serializer</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modify</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>activate_target</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>printings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.the_printings</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_name</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hidden_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Symbol.symbols_of</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prepared_program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_program_for_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hidden_syms</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>proto_program</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prepared_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hidden_syms</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Symbol.Graph.all_succs</span><span> </span><span class="entity"><span>proto_program</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>project_includes_for_syms</span></span><span> </span><span class="entity"><span>all_syms</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.dest_module_data</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prepared_serializer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>serializer</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span>
      reserved_syms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.the_reserved</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span>
      identifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.the_identifiers</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span>
      includes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>includes</span></span><span class="main"><span>,</span></span><span>
      const_syntax </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Symbol.lookup_constant_data</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>,</span></span><span>
      tyco_syntax </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Symbol.lookup_type_constructor_data</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>,</span></span><span>
      class_syntax </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Symbol.lookup_type_class_data</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>,</span></span><span>
      module_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_serializer</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>modify</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_program</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prepared_syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_serializer</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_program</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prepared_syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exports</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>prepared_syms</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Code_Preproc.timed_exec</span></span><span> </span><span class="inner_quoted"><span>"serializing"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prepared_serializer</span></span><span> </span><span class="entity"><span>prepared_program</span></span><span> </span><span class="entity"><span>exports</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_module_name</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Empty module name not allowed here"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assert_module_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_code_for</span></span><span> </span><span class="entity"><span>some_file</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.format</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_width</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>some_width</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invoke_serializer</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export_result</span></span><span> </span><span class="entity"><span>some_file</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>produce_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serializer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invoke_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assert_module_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>produce_result</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_width</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_width</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>serializer</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>present_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serializer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invoke_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assert_module_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selects</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>present_result</span></span><span> </span><span class="entity"><span>selects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_width</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>some_width</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>serializer</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_code_for</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>strict</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>env_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_destination</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_command</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>check </span><span class="main"><span>(</span></span><span class="entity"><span>the_language</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Printer.format</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>80</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ext_check</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>destination</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_destination</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory</span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>export_result</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>destination</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>invoke_serializer</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>generatedN</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_command</span></span><span> </span><span class="entity"><span>generatedN</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"cd "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>p</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" &amp;&amp; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" 2&gt;&amp;1"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Isabelle_System.bash</span></span><span> </span><span class="entity"><span>context_cmd</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Code check failed for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>cmd</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>getenv</span><span> </span><span class="entity"><span>env_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>strict</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_var</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" not set; cannot check code for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_var</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" not set; skipped checking code for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Isabelle_System.with_tmp_dir</span></span><span> </span><span class="inner_quoted"><span>"Code_Test"</span></span><span> </span><span class="entity"><span>ext_check</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dynamic_compilation_text</span></span><span> </span><span class="entity"><span>prepared_serializer</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="entity"><span>prepared_program</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Code_Thingol.contains_dict_var</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"Term to be evaluated contains free dictionaries"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ITyVar</span></span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="entity"><span>`-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepared_program</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Code_Symbol.Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.value</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>Code_Thingol.Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"dummy"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span>o</span><span>
          </span><span>Code_Symbol.Graph.add_edge</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Code_Symbol.value</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepared_serializer</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Code_Symbol.value</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_code</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>value_name</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>produce_result</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Code_Symbol.value</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>compilation_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compilation_text'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default_width</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>evaluation_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_evaluation_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_serializer</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepared_program</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_serializer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>generatedN</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>evaluation_args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Code_Preproc.timed_exec</span></span><span> </span><span class="inner_quoted"><span>"serializing"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dynamic_compilation_text</span></span><span> </span><span class="entity"><span>prepared_serializer</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="entity"><span>prepared_program</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compilation_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fst</span><span> </span><span>oo</span><span> </span><span class="entity"><span>compilation_text'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>syms</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* local *)</span></span><span>


</span><span class="comment1"><span>(* code generation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_destination</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>location</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>source</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Input.string_of</span><span> </span><span class="entity"><span>source</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Input.pos_of</span><span> </span><span class="entity"><span>source</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>delimited</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Input.is_delimited</span><span> </span><span class="entity"><span>source</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>location</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>location</span></span><span class="main"><span>,</span></span><span> </span><span>Path.explode_pos</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad bad empty "</span></span><span> </span><span>^</span><span> </span><span>Markup.markup</span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"file"</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" argument"</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>legacy_feature</span><span>
            </span><span class="main"><span>(</span></span><span>Markup.markup</span><span> </span><span>Markup.keyword1</span><span> </span><span class="inner_quoted"><span>"export_code"</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" with "</span></span><span> </span><span>^</span><span>
              </span><span>Markup.markup</span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"file"</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" argument"</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.report</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span>Markup.language_path</span><span> </span><span class="entity"><span>delimited</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Path.explode_pos</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.report</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span>Markup.path</span><span> </span><span class="main"><span>(</span></span><span>File.symbolic_path</span><span> </span><span class="entity"><span>path</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>location</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>path</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_code</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>seris</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>seris</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span>|-&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>module_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_file</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>export_code_for</span></span><span> </span><span class="entity"><span>some_file</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>module_name</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_code_cmd</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span> </span><span class="entity"><span>seris</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.read_const_exprs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>export_code</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>Option.map</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prep_destination</span></span><span> </span><span class="entity"><span>seris</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>produce_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>produce_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>present_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>present_code_for</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="entity"><span>some_module_name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_code</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>seris</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.consts_program</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>seris</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span>|-&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>strict</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>check_code_for</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>strict</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>program</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_code_cmd</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span> </span><span class="entity"><span>seris</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>check_code</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Thingol.read_const_exprs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seris</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** serializer configuration **)</span></span><span>

</span><span class="comment1"><span>(* reserved symbol names *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_reserved</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>join_ancestry</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.the_reserved</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Reserved symbol "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" already declared"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>map_reserved</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* checking of syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_const_syntax</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>syn</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Code_Printer.requires_args</span></span><span> </span><span class="entity"><span>syn</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>Code.args_number</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Too many arguments in syntax for constant "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Code_Printer.prep_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_literals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>syn</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tyco_syntax</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>syn</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>syn</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>Sign.arity_number</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Number of arguments mismatch in syntax for type constructor "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tyco</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>syn</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* custom symbol names *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arrange_name_decls</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arrange</span></span><span> </span><span class="entity"><span>is_module</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_name</span></span><span> </span><span class="entity"><span>is_module</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>some_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>target_names</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Code_Symbol.maps_attr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_name_decls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cert_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>arrange_name_decls</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_name_decls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>arrange_name_decls</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_identifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_identifiers</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.set_data</span></span><span> </span><span class="entity"><span>sym_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_set_identifiers</span></span><span> </span><span class="entity"><span>prep_name_decl</span></span><span> </span><span class="entity"><span>raw_name_decls</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>set_identifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_name_decl</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_name_decls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_identifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_set_identifiers</span></span><span> </span><span class="entity"><span>cert_name_decls</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_identifiers_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_set_identifiers</span></span><span> </span><span class="entity"><span>read_name_decls</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* custom printings *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arrange_printings</span></span><span> </span><span class="entity"><span>prep_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arrange</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target_syns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_syn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>some_syn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>target_syns</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Code_Symbol.maps_attr'</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="entity"><span>check_const_syntax</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="entity"><span>check_tyco_syntax</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>arrange</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_content</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Code_Printer.str</span></span><span> </span><span class="main"><span>(</span></span><span>split_lines</span><span> </span><span class="entity"><span>raw_content</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_printings</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cert_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>arrange_printings</span></span><span> </span><span class="entity"><span>cert_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_printings</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_syms'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>arrange_printings</span></span><span> </span><span class="entity"><span>read_syms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_printing</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_syn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_printings</span></span><span> </span><span class="entity"><span>target_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.set_data</span></span><span> </span><span class="entity"><span>sym_syn</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_set_printings</span></span><span> </span><span class="entity"><span>prep_print_decl</span></span><span> </span><span class="entity"><span>raw_print_decls</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>set_printing</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_print_decl</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_print_decls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_printings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_set_printings</span></span><span> </span><span class="entity"><span>cert_printings</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_printings_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_set_printings</span></span><span> </span><span class="entity"><span>read_printings</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* concrete syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_args</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Scan.read</span><span> </span><span>Token.stopper</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>args</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad serializer arguments"</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Isar setup **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constantK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_constructorK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_classK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class_relationK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class_instanceK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code_moduleK</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>constant</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>type_constructor</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>type_class</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>class_relation</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>class_instance</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>code_module</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_constants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constantK</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Constant</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_type_constructors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_constructorK</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.type_const</span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Type_Constructor</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_classes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_classK</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.class</span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Type_Class</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_class_relations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_relationK</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_classrel_ident</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Class_Relation</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_instances</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_instanceK</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_inst_ident</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Class_Instance</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_simple_symbols</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeats1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_constants</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_type_constructors</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_classes</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_class_relations</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_instances</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>parse_keyword</span></span><span> </span><span class="entity"><span>parse_isa</span></span><span> </span><span class="entity"><span>parse_target</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>parse_keyword</span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_isa</span></span><span> </span><span>--|</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>⇀</span></span><span>›</span></span></span><span> </span><span>||</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>=&gt;</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
    </span><span>--</span><span> </span><span>Parse.and_list1</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="entity"><span>parse_target</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_symbol_pragma</span></span><span> </span><span class="entity"><span>parse_const</span></span><span> </span><span class="entity"><span>parse_tyco</span></span><span> </span><span class="entity"><span>parse_class</span></span><span> </span><span class="entity"><span>parse_classrel</span></span><span> </span><span class="entity"><span>parse_inst</span></span><span> </span><span class="entity"><span>parse_module</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>constantK</span></span><span> </span><span>Parse.term</span><span> </span><span class="entity"><span>parse_const</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Constant</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>type_constructorK</span></span><span> </span><span>Parse.type_const</span><span> </span><span class="entity"><span>parse_tyco</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Type_Constructor</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>type_classK</span></span><span> </span><span>Parse.class</span><span> </span><span class="entity"><span>parse_class</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Type_Class</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>class_relationK</span></span><span> </span><span class="entity"><span>parse_classrel_ident</span></span><span> </span><span class="entity"><span>parse_classrel</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Class_Relation</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>class_instanceK</span></span><span> </span><span class="entity"><span>parse_inst_ident</span></span><span> </span><span class="entity"><span>parse_inst</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Class_Instance</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_single_symbol_pragma</span></span><span> </span><span class="entity"><span>code_moduleK</span></span><span> </span><span>Parse.name</span><span> </span><span class="entity"><span>parse_module</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Module</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_symbol_pragmas</span></span><span> </span><span class="entity"><span>parse_const</span></span><span> </span><span class="entity"><span>parse_tyco</span></span><span> </span><span class="entity"><span>parse_class</span></span><span> </span><span class="entity"><span>parse_classrel</span></span><span> </span><span class="entity"><span>parse_inst</span></span><span> </span><span class="entity"><span>parse_module</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"code symbol pragma"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_symbol_pragma</span></span><span> </span><span class="entity"><span>parse_const</span></span><span> </span><span class="entity"><span>parse_tyco</span></span><span> </span><span class="entity"><span>parse_class</span></span><span> </span><span class="entity"><span>parse_classrel</span></span><span> </span><span class="entity"><span>parse_inst</span></span><span> </span><span class="entity"><span>parse_module</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_expr_argsP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.args</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_expr_inP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_public</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>in</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.name</span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>module_name</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.name</span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
    </span><span>--</span><span> </span><span>Scan.option</span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>file_prefix</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span>||</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>file</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>{</span></span><span>physical </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
          </span><span>--</span><span> </span><span>Parse.!!!</span><span> </span><span>Parse.path_input</span><span class="main"><span>)</span></span><span>
    </span><span>--</span><span> </span><span class="entity"><span>code_expr_argsP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>seri_args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>export_code_cmd</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span> </span><span class="entity"><span>seri_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_expr_checkingP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_public</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>checking</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span>
    </span><span class="main"><span>(</span></span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>?</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>code_expr_argsP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>seri_args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check_code_cmd</span></span><span> </span><span class="entity"><span>all_public</span></span><span> </span><span class="entity"><span>raw_cs</span></span><span> </span><span class="entity"><span>seri_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_reserved</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"declare words as reserved for target language"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.name</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserveds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span>o</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_reserved</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reserveds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_identifier</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"declare mandatory names for code symbols"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_symbol_pragmas</span></span><span> </span><span>Parse.name</span><span> </span><span>Parse.name</span><span> </span><span>Parse.name</span><span> </span><span>Parse.name</span><span> </span><span>Parse.name</span><span> </span><span>Parse.name</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span>o</span><span> </span><span>fold</span><span> </span><span class="entity"><span>set_identifiers_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_printing</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"declare dedicated printing for code symbols"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_symbol_pragmas</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.parse_const_syntax</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Printer.parse_tyco_syntax</span></span><span class="main"><span>)</span></span><span>
      </span><span>Parse.string</span><span> </span><span class="main"><span>(</span></span><span>Parse.minus</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.minus</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Parse.embedded</span><span> </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_simple_symbols</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span>o</span><span> </span><span>fold</span><span> </span><span class="entity"><span>set_printings_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>export_code</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"generate executable code for constants"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>open</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span>--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.term</span><span>
      </span><span>:|--</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code_expr_checkingP</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>code_expr_inP</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_const_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Args.theory</span><span> </span><span>--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Args.term</span><span>
  </span><span>&gt;&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.check_const</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_symbols</span></span><span> </span><span class="entity"><span>keyword</span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="entity"><span>internalize</span></span><span> </span><span class="entity"><span>mark_symbol</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>keyword</span></span><span> </span><span>--|</span><span> </span><span>Args.colon</span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Args.theory</span><span> </span><span>--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mark_symbol</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>internalize</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_symbols</span></span><span> </span><span class="entity"><span>constantK</span></span><span> </span><span>Args.term</span><span>
  </span><span class="entity"><span>Code.check_const</span></span><span> </span><span class="entity"><span>Constant</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_symbols</span></span><span> </span><span class="entity"><span>type_constructorK</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span>
  </span><span>Sign.intern_type</span><span> </span><span class="entity"><span>Type_Constructor</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_classes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_symbols</span></span><span> </span><span class="entity"><span>type_classK</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span>
  </span><span>Sign.intern_class</span><span> </span><span class="entity"><span>Type_Class</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_instances</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_symbols</span></span><span> </span><span class="entity"><span>class_instanceK</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.name</span><span> </span><span>--|</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span> </span><span>--</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>Sign.intern_class</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span>Sign.intern_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_class</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Class_Instance</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Document_Output.antiquotation_raw</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>code_stmts</span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_const_terms</span></span><span> </span><span>--</span><span>
      </span><span>Scan.repeats</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_consts</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_types</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_classes</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_instances</span></span><span class="main"><span>)</span></span><span>
      </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.parens</span><span> </span><span class="main"><span>(</span></span><span>Args.name</span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Parse.int</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>symbols</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_width</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>present_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>symbols</span></span><span>
         </span><span class="entity"><span>target_name</span></span><span> </span><span class="inner_quoted"><span>"Example"</span></span><span> </span><span class="entity"><span>some_width</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Bytes.content</span><span>
       </span><span>|&gt;</span><span> </span><span>trim_line</span><span>
       </span><span>|&gt;</span><span> </span><span class="entity"><span>Document_Output.verbatim</span></span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span class="entity"><span>Document_Antiquotation.thy_output_display</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*struct*)</span></span><span>
</span></pre>
</body>

</html>