<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/IsaPlanner/zipper.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/IsaPlanner/zipper.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/IsaPlanner/zipper.ML
    Author:     Lucas Dixon, University of Edinburgh

A notion roughly based on Huet's Zippers for Isabelle terms.
*)</span></span><span>   

</span><span class="comment1"><span>(* abstract term for no more than pattern matching *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ABSTRACT_TRM</span></span><span> </span><span class="main"><span>=</span></span><span> 
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>typ</span></span><span>   </span><span class="comment1"><span>(* types *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>aname</span></span><span> </span><span class="comment1"><span>(* abstraction names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="comment1"><span>(* parameter/free variable names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="comment1"><span>(* constant names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>vname</span></span><span> </span><span class="comment1"><span>(* meta variable names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>bname</span></span><span> </span><span class="comment1"><span>(* bound var name *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cname * typ
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> aname * typ * term
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> fname * typ
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> vname * typ
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bname
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term * term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>IsabelleTrmWrap</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ABSTRACT_TRM</span></span><span class="main"><span>=</span></span><span> 
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span> 
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>typ</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span>Term.typ</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* types *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>aname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* abstraction names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* parameter/free variable names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* constant names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>vname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span>int</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* meta variable names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>bname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* bound var name *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Concrete version for the Trm structure *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>TRM_CTXT_DATA</span></span><span> </span><span class="main"><span>=</span></span><span> 
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Trm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ABSTRACT_TRM</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>dtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.aname * Trm.typ
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AppL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.T
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AppR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.T</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> apply </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Trm.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_pos </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>dtrm</span></span><span> * </span><span class="entity"><span>dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* A trm context = list of derivatives *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>TRM_CTXT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> D </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT_DATA</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D.dtrm</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_empty </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>D.Trm.aname</span></span><span> * </span><span class="entity"><span>D.Trm.typ</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_appl </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>D.Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_appr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>D.Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_dtrm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_path </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_outerctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> apply </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>D.Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>D.Trm.T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nty_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.Trm.aname</span></span><span> * </span><span class="entity"><span>D.Trm.typ</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ty_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>D.Trm.typ</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>D.dtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_up </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_down </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* A zipper = a term looked at, at a particular point in the term *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ZIPPER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> C </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mktop </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.D.Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.D.Trm.T</span></span><span> * </span><span class="entity"><span>C.T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> goto_top </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> at_top </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>C.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_outerctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_trm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.D.Trm.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>C.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>C.D.Trm.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> top_trm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>C.D.Trm.T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> zipto </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="comment1"><span>(* follow context down *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nty_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.D.Trm.aname</span></span><span> * </span><span class="entity"><span>C.D.Trm.typ</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ty_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>C.D.Trm.typ</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_of_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_on_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>C.D.dtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_up_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_down_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a

  </span><span class="comment1"><span>(* searching through a zipper *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>zsearch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Here</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> T </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LookIn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> T</span><span class="main"><span>;</span></span><span>
  </span><span class="comment1"><span>(* lazily search through the zipper *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lzy_search </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>zsearch</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="comment1"><span>(* lazy search with folded data *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pf_lzy_search </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span class="entity"><span>zsearch</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
                      </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="comment1"><span>(* zsearch list is or-choices *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> searchfold </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>'a * </span><span class="entity"><span>zsearch</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
                      </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="comment1"><span>(* limit function to the current focus of the zipper, 
     but give function the zipper's context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> limit_pcapply </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> 
                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> limit_apply </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> limit_capply </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span>

  </span><span class="comment1"><span>(* moving around zippers with option types *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_app </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_left </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_right </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_left_or_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_up_right_or_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_down_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_down_left </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_down_right </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> omove_down_app </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

  </span><span class="comment1"><span>(* moving around zippers, raising exceptions *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> move </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_app </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_left </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_right </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_left_or_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_up_right_or_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_down_abs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_down_left </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_down_right </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> move_down_app </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>T</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Zipper data for an generic trm *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>TrmCtxtDataFUN</span></span><span class="main"><span>(</span></span><span>Trm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ABSTRACT_TRM</span></span><span class="main"><span>)</span></span><span> 
</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT_DATA</span></span><span> 
</span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Trm</span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* a dtrm is, in McBridge-speak, a differentiated term. It represents
  the different ways a term can occur within its datatype constructors *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>dtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.aname * Trm.typ
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AppL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.T
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AppR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Trm.T</span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* apply a dtrm to a term, ie put the dtrm above it, building context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppL</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AppL</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppR</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AppR</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_pos</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* functor for making term contexts given term data *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>TrmCtxtFUN</span></span><span class="main"><span>(</span></span><span>D </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT_DATA</span></span><span class="main"><span>)</span></span><span> 
 </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D.dtrm</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.null</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_abs</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_appl</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_appr</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_dtrm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d</span></span><span>::</span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_path</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_path</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_path</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>_</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_path</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h2</span></span><span>::</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>D.eq_pos</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span class="entity"><span>h2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>eq_path</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* add context to outside of existing context *)</span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_outerctxt</span></span><span> </span><span class="entity"><span>ctop</span></span><span> </span><span class="entity"><span>cbottom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cbottom</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ctop</span></span><span class="main"><span>;</span></span><span> 

  </span><span class="comment1"><span>(* mkterm : zipper -&gt; trm -&gt; trm *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Basics.fold</span><span> </span><span class="entity"><span>D.apply</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="comment1"><span>(* named type context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nty_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="entity"><span>nty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ntys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nty</span></span><span>::</span><span class="entity"><span>ntys</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ntys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ntys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="comment1"><span>(* type context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>::</span><span class="entity"><span>tys</span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.map</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>D.dtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fold_up</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Basics.fold</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fold_down</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Basics.fold_rev</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.dtrm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* zippers in terms of term contexts *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>ZipperFUN</span></span><span class="main"><span>(</span></span><span>C </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRM_CTXT</span></span><span class="main"><span>)</span></span><span> 
 </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ZIPPER</span></span><span>
</span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span> 

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.D</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D.Trm</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.D.Trm.T</span></span><span> * </span><span class="entity"><span>C.T</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mktop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C.empty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_trm</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>goto_top</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>C.is_empty</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.apply</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C.empty</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>at_top</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.is_empty</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>C.empty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span class="main"><span>)</span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_outerctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C.add_outerctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>top_trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>goto_top</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nty_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.nty_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ty_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.ty_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_of_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_on_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C.map</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_up_ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.fold_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_down_ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.fold_down</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.apply</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_app</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_left</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_left</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_right</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_left_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_left_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_left_or_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_up_right_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_right_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_up_right_or_abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_down_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_down_abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_down_left</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_down_left</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_down_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_down_right</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>omove_down_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>omove_down_app</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D.apply</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_abs"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_app</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_app"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_left</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_left</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_left"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_right</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_right"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_left_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_left_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_left_or_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_left_or_abs"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_up_right_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_right_or_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_up_right_or_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_up_right_or_abs"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_down_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_down_abs"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_down_left</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_down_left"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_down_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_down_right"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_down_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trm.$</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppR</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>D.AppL</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>move_down_app</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>move</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"move_down_app"</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* follow the given path down the given zipper *)</span></span><span>
  </span><span class="comment1"><span>(* implicit arguments: C.D.dtrm list, then T *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zipto</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.fold_down</span></span><span> 
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>C.D.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>move_down_abs</span></span><span> 
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>C.D.AppL</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>move_down_right</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>C.D.AppR</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>move_down_left</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> 

  </span><span class="comment1"><span>(* Note: interpretted as being examined depth first *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>zsearch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Here</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> T </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LookIn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> T</span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* lazy search *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lzy_search</span></span><span> </span><span class="entity"><span>fsearch</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>LookIn</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lzy</span></span><span> </span><span class="entity"><span>z</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hz</span></span><span class="main"><span>,</span></span><span class="entity"><span>mz</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
                 </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hz</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.append</span><span> </span><span class="entity"><span>mz</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>lzy</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.make</span><span> </span><span>o</span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>fsearch</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* path folded lazy search - the search list is defined in terms of
  the path passed through: the data a is updated with every zipper
  considered *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pf_lzy_search</span></span><span> </span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a0</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>LookIn</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lzy</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>z</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>hz</span></span><span class="main"><span>,</span></span><span class="entity"><span>mz</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>hz</span></span><span class="main"><span>,</span></span><span>Seq.append</span><span> </span><span class="entity"><span>mz</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.make</span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>lzy</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="entity"><span>slist</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>slist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a0</span></span><span> </span><span class="entity"><span>z</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>slist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* Note: depth first over zsearch results *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>searchfold</span></span><span> </span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a0</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span>SOME</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LookIn</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
               </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span class="entity"><span>mz</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span>Seq.append</span><span> </span><span class="entity"><span>mz</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lzyl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsearch</span></span><span> </span><span class="entity"><span>a0</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>limit_pcapply</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z2</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>z</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_outerctxt</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>z2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>limit_capply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>z2</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>C.T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>z</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_outerctxt</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>z2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>limit_apply</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>limit_capply</span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* now build these for Isabelle terms *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>TrmCtxtData</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TrmCtxtDataFUN</span></span><span class="main"><span>(</span></span><span>IsabelleTrmWrap</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>TrmCtxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TrmCtxtFUN</span></span><span class="main"><span>(</span></span><span>TrmCtxtData</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Zipper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ZipperFUN</span></span><span class="main"><span>(</span></span><span>TrmCtxt</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(* For searching through Zippers below the current focus...
   KEY for naming scheme:    

   td = starting at the top down
   lr = going from left to right
   rl = going from right to left

   bl = starting at the bottom left
   br = starting at the bottom right
   ul = going up then left
   ur = going up then right
   ru = going right then up
   lu = going left then up
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ZIPPER_SEARCH</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Z </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ZIPPER</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> leaves_lr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> leaves_rl </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_bl_ru </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_bl_ur </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_td_lr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_td_rl </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Z.T</span></span><span> </span><span>Seq.seq</span><span>
  
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>ZipperSearchFUN</span></span><span class="main"><span>(</span></span><span>Zipper </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ZIPPER</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ZIPPER_SEARCH</span></span><span>
</span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Zipper</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.C</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C.D</span></span><span class="main"><span>;</span></span><span> 
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D.Trm</span></span><span class="main"><span>;</span></span><span> 

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_leaves_lr</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_leaves_rl</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>leaves_lr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_leaves_lr</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>leaves_rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_leaves_rl</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_all_td_lr</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_all_td_rl</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_all_bl_ur</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sf_all_bl_ru</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Z.trm</span></span><span> </span><span class="entity"><span>z</span></span><span> 
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Trm.$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_left</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_right</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Trm.Abs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.LookIn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z.move_down_abs</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Z.Here</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_td_lr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_all_td_lr</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_td_rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_all_td_rl</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_bl_ur</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_all_bl_ru</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_bl_ru</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z.lzy_search</span></span><span> </span><span class="entity"><span>sf_all_bl_ur</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>ZipperSearch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ZipperSearchFUN</span></span><span class="main"><span>(</span></span><span>Zipper</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>