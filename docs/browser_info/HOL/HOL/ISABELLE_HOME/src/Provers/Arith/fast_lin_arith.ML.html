<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/Arith/fast_lin_arith.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/Arith/fast_lin_arith.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Provers/Arith/fast_lin_arith.ML
    Author:     Tobias Nipkow and Tjark Weber and Sascha Boehme

A generic linear arithmetic package.

Only take premises and conclusions into account that are already
(negated) (in)equations. lin_arith_simproc tries to prove or disprove
the term.
*)</span></span><span>

</span><span class="comment1"><span>(*** Data needed for setting up the linear arithmetic package ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIN_ARITH_LOGIC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conjI       </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* P ==&gt; Q ==&gt; P &amp; Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ccontr      </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* (~ P ==&gt; False) ==&gt; P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> notI        </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* (P ==&gt; False) ==&gt; ~ P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_lessD   </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* ~(m &lt; n) ==&gt; n &lt;= m *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_leD     </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* ~(m &lt;= n) ==&gt; n &lt; m *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sym         </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* x = y ==&gt; y = x *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trueI       </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* True *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_Eq       </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atomize     </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_Trueprop </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> neg_prop    </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_False    </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_nat      </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_nat_thm  </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="comment1"><span>(*
mk_Eq(~in) = `in == False'
mk_Eq(in) = `in == True'
where `in' is an (in)equality.

neg_prop(t) = neg  if t is wrapped up in Trueprop and neg is the
  (logically) negated version of t (again wrapped up in Trueprop),
  where the negation of a negative term is the term itself (no
  double negation!); raises TERM ("neg_prop", [t]) if t is not of
  the form 'Trueprop $ _'

is_nat(parameter-types,t) =  t:nat
mk_nat_thm(t) = "0 &lt;= t"
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIN_ARITH_DATA</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*internal representation of linear (in-)equations:*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>decomp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>Rat.rat</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>Rat.rat</span><span> * </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>Rat.rat</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>Rat.rat</span><span> * </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decomp</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>decomp</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> domain_is_nat</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="comment1"><span>(*abstraction for proof replay*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abstract_arith</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abstract</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(*preprocessing, performed on a representation of subgoals as list of premises:*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pre_decomp</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(*preprocessing, performed on the goal -- must do the same as 'pre_decomp':*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pre_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>

  </span><span class="comment1"><span>(*the limit on the number of ~= allowed; because each ~= is split
    into two cases, this can lead to an explosion*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> neq_limit</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="comment1"><span>(*
decomp(`x Rel y') should yield (p,i,Rel,q,j,d)
   where Rel is one of "&lt;", "~&lt;", "&lt;=", "~&lt;=" and "=" and
         p (q, respectively) is the decomposition of the sum term x
         (y, respectively) into a list of summand * multiplicity
         pairs and a constant summand and d indicates if the domain
         is discrete.

domain_is_nat(`x Rel y') t should yield true iff x is of type "nat".

The relationship between pre_decomp and pre_tac is somewhat tricky.  The
internal representation of a subgoal and the corresponding theorem must
be modified by pre_decomp (pre_tac, resp.) in a corresponding way.  See
the comment for split_items below.  (This is even necessary for eta- and
beta-equivalent modifications, as some of the lin. arith. code is not
insensitive to them.)

Simpset must reduce contradictory &lt;= to False.
   It should also cancel common summands to keep &lt;= reduced;
   otherwise &lt;= can grow to massive proportions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>FAST_LIN_ARITH</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prems_lin_arith_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lin_arith_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lin_arith_simproc</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_data</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>add_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> mult_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> inj_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
      lessD</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> neqE</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> simpset</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>,</span></span><span>
      number_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>{</span></span><span>add_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> mult_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> inj_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
      lessD</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> neqE</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> simpset</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>,</span></span><span>
      number_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_inj_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_lessD</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_simprocs</span><span class="main"><span>:</span></span><span> </span><span>simproc</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_number_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Fast_Lin_Arith</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> LA_Logic</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIN_ARITH_LOGIC</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> LA_Data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIN_ARITH_DATA</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>FAST_LIN_ARITH</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>


</span><span class="comment1"><span>(** theory data **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>add_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    mult_mono_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    inj_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    lessD</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    neqE</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    simpset</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>,</span></span><span>
    number_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    lessD </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span>empty_ss</span><span class="main"><span>,</span></span><span>
    number_of </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms1</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms1</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms1</span></span><span class="main"><span>,</span></span><span>
      lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD1</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE1</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpset1</span></span><span class="main"><span>,</span></span><span> number_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of1</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms2</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms2</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms2</span></span><span class="main"><span>,</span></span><span>
      lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD2</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE2</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpset2</span></span><span class="main"><span>,</span></span><span> number_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of2</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_mono_thms1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_mono_thms2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mult_mono_thms1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mult_mono_thms2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     inj_thms </span><span class="main"><span>=</span></span><span> </span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_thms1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inj_thms2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     lessD </span><span class="main"><span>=</span></span><span> </span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lessD1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lessD2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     neqE </span><span class="main"><span>=</span></span><span> </span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neqE1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqE2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     simpset </span><span class="main"><span>=</span></span><span> </span><span>merge_ss</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simpset1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     number_of </span><span class="main"><span>=</span></span><span> </span><span>merge_options</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_of1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>number_of2</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_neqE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>neqE </span><span class="main"><span>(</span></span><span class="entity"><span>get_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_inj_thms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span>
    lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> number_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_lessD</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span>
    lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> number_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_simpset</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span>
      lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span>simpset_map</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span>
      number_of </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_inj_thms</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_inj_thms</span></span><span> </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_lessD</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_lessD</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_simps</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_simpset</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_simprocs</span></span><span> </span><span class="entity"><span>procs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_simpset</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimprocs</span><span> </span><span class="entity"><span>procs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_number_of</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span class="main"><span>,</span></span><span> inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>,</span></span><span>
    lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>,</span></span><span> neqE </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neqE</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> number_of </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>number_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>number_of </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"number_of"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** A fast decision procedure ***)</span></span><span>
</span><span class="comment1"><span>(*** Code ported from HOL Light ***)</span></span><span>
</span><span class="comment1"><span>(* possible optimizations:
   use (var,coeff) rep or vector rep  tp save space;
   treat non-negative atoms separately rather than adding 0 &lt;= atom
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lineq_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Le</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Lt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Asm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="comment1"><span>(* index of atom *)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LessD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NotLessD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NotLeD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NotLeDD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Multiplied</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * injust
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Added</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust * injust</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lineq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * lineq_type * int list * injust</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Finding a (counter) example from the trace of a failed elimination        *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Examples are represented as rational numbers,                             *)</span></span><span>
</span><span class="comment1"><span>(* Dont blame John Harrison for this code - it is entirely mine. TN          *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NoEx</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Coding: (i,true,cs) means i &lt;= cs and (i,false,cs) means i &lt; cs.
   In general, true means the bound is included, false means it is excluded.
   Need to know if it is a lower or upper bound for unambiguous interpretation!
*)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* End of counterexample finder. The actual decision procedure starts here.  *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Calculate new (in)equality type after addition.                           *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>Lt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="entity"><span>Lt</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span class="entity"><span>Le</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Le</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Multiply out an (in)equation.                                             *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>multiply_ineq</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"multiply_ineq"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>=</span></span><span class="entity"><span>Le</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>=</span></span><span class="entity"><span>Lt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"multiply_ineq"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.mult</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Multiplied</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Add together (in)equations.                                               *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_ineq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="entity"><span>just1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty2</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span class="entity"><span>just2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>Integer.add</span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span>+</span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span class="entity"><span>find_add_type</span></span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>Added</span></span><span class="main"><span>(</span></span><span class="entity"><span>just1</span></span><span class="main"><span>,</span></span><span class="entity"><span>just2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Elimination of variable between a single pair of (in)equations.           *)</span></span><span>
</span><span class="comment1"><span>(* If they're both inequalities, 1st coefficient must be +ve, 2nd -ve.       *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_var</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty2</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.lcm</span><span> </span><span class="entity"><span>c1</span></span><span> </span><span class="entity"><span>c2</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span>~</span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"elim_var"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty1</span></span><span class="main"><span>=</span></span><span class="entity"><span>Eq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>=</span></span><span class="entity"><span>Eq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span>~</span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_ineq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>multiply_ineq</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>i1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>multiply_ineq</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* The main refutation-finding code.                                         *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_trivial</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_contradictory</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Le</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Lt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>calc_blowup</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;&gt;</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>p</span></span><span> </span><span>*</span><span> </span><span>length</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Main elimination code:                                                    *)</span></span><span>
</span><span class="comment1"><span>(*                                                                           *)</span></span><span>
</span><span class="comment1"><span>(* (1) Looks for immediate solutions (false assertions with no variables).   *)</span></span><span>
</span><span class="comment1"><span>(*                                                                           *)</span></span><span>
</span><span class="comment1"><span>(* (2) If there are any equations, picks a variable with the lowest absolute *)</span></span><span>
</span><span class="comment1"><span>(* coefficient in any of them, and uses it to eliminate.                     *)</span></span><span>
</span><span class="comment1"><span>(*                                                                           *)</span></span><span>
</span><span class="comment1"><span>(* (3) Otherwise, chooses a variable in the inequality to minimize the       *)</span></span><span>
</span><span class="comment1"><span>(* blowup (number of consequences generated) and eliminates it.              *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_first</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>List.Empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_ineqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ineqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>LA_Data.trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span>tracing</span><span class="main"><span>(</span></span><span>cat_lines</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span>::</span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>string_of_int</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" =  "</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Lt</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" &lt;  "</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Le</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" &lt;= "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
       </span><span>commas</span><span class="main"><span>(</span></span><span>map</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ineqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>history</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>lineq</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> injust </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Failure</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> history</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_ineqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ineqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>triv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>is_trivial</span></span><span> </span><span class="entity"><span>ineqs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>triv</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="entity"><span>is_contradictory</span></span><span> </span><span class="entity"><span>triv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nontriv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>j</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>nontriv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Failure</span></span><span> </span><span class="entity"><span>hist</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noneqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>=</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nontriv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
           </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>abs</span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>hd</span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ceq</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>othereqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="entity"><span>extract_first</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ceq</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ioth</span></span><span class="main"><span>,</span></span><span class="entity"><span>roth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
                                     </span><span class="main"><span>(</span></span><span class="entity"><span>othereqs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>noneqs</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>others</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_var</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>roth</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ioth</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>others</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>nontriv</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lists</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>noneqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>numlist</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>lists</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>coeffs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lists</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>numlist</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>blows</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>calc_blowup</span></span><span> </span><span class="entity"><span>coeffs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iblows</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>blows</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>numlist</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nziblows</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iblows</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>nziblows</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Failure</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="entity"><span>nontriv</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span class="main"><span>(</span></span><span>fst</span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>fst</span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nziblows</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no</span></span><span class="main"><span>,</span></span><span class="entity"><span>yes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ineqs</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>neg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>yes</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no</span></span><span> </span><span>@</span><span> </span><span>map_product</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>neg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>nontriv</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Translate back a proof.                                                   *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msgs</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>LA_Data.trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msgs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msgs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>LA_Data.trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msgs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>LA_Data.trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>union_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span>Envir.aeconv</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_atoms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>union_term</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>union_term</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atoms_of</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_atoms</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*
Simplification may detect a contradiction 'prematurely' due to type
information: n+1 &lt;= 0 is simplified to False and does not need to be crossed
with 0 &lt;= n.
*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>FalseE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>thm</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkthm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>just</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>injust</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>add_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mono_thms0</span></span><span class="main"><span>,</span></span><span> mult_mono_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult_mono_thms0</span></span><span class="main"><span>,</span></span><span>
      inj_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inj_thms0</span></span><span class="main"><span>,</span></span><span> lessD </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lessD0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>add_mono_thms0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mult_mono_thms0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inj_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inj_thms0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lessD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lessD0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simpset_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>simpset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>only_concl</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atoms_of</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>only_concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>use_first</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add2</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>use_first</span></span><span> </span><span class="entity"><span>add_mono_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.conjI</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_add</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add2</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_thms</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>add2</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_add</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm1</span></span><span class="main"><span>]</span></span><span> </span><span>RL</span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>try_add</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>]</span></span><span> </span><span>RL</span><span> </span><span class="entity"><span>inj_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm2</span></span><span class="main"><span>;</span></span><span>
                   </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Linear arithmetic: failed to add thms"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mult_by_add</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mul</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_thms</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mul</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>simpset_ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span>
      </span><span class="main"><span>(</span></span><span>Conv.binop_conv</span><span> </span><span class="entity"><span>rewr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>discharge_prem</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>rewr</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>LA_Logic.trueI</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>use_first</span></span><span> </span><span class="entity"><span>mult_mono_thms</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mult_by_add</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>mth</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mth</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cprop_of</span><span> </span><span>|&gt;</span><span> </span><span>Drule.strip_imp_concl</span><span>
              </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg1</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg1</span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>cv</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>mth</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make1</span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>number_of</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>rewrite_concl</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>discharge_prem</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mult_by_add</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mult_by_add</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mult_thm</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.sym</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.sym</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Simplified:"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_simplify</span></span><span> </span><span class="entity"><span>simpset_ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>LA_Logic.is_False</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>FalseE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="entity"><span>i</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LA_Data.abstract</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nat_thm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LA_Data.abstract_arith</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Logic.mk_nat_thm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step0</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>step2</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Asm</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step0</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Asm "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nat</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step0</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nat "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_thm</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LessD</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="inner_quoted"><span>"L"</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>RL</span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NotLeD</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="inner_quoted"><span>"NLe"</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.not_leD</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NotLeDD</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="inner_quoted"><span>"NLeD"</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.not_leD</span></span><span class="main"><span>]</span></span><span> </span><span>RL</span><span> </span><span class="entity"><span>lessD</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NotLessD</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="inner_quoted"><span>"NL"</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>LA_Logic.not_lessD</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Added</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step2</span></span><span> </span><span class="inner_quoted"><span>"+"</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>add_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>|-&gt;</span><span> </span><span class="entity"><span>simp</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Multiplied</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>step1</span></span><span> </span><span class="inner_quoted"><span>"*"</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mult_thm</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>finish</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>thm</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"mkthm"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>just</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Final thm:"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="entity"><span>simpset_ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"After simplification:"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>fls</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>LA_Logic.is_False</span></span><span> </span><span class="entity"><span>fls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Assumptions:"</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
            </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Proved:"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fls</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span>warning</span><span> </span><span class="inner_quoted"><span>"Linear arithmetic should have refuted the assumptions but failed to."</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>finish</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>fls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>FalseE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"False reached early:"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>finish</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>coeff</span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="entity"><span>atom</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>AList.lookup</span><span> </span><span>Envir.aeconv</span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="entity"><span>atom</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>integ</span></span><span class="main"><span>(</span></span><span class="entity"><span>rlhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span class="entity"><span>rrhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rn</span></span><span class="main"><span>,</span></span><span class="entity"><span>rd</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rat.dest</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span class="main"><span>,</span></span><span class="entity"><span>sd</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rat.dest</span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.lcms</span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Rat.dest</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>rlhs</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>rrhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mult</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rat.dest</span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span> </span><span>*</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="entity"><span>rlhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rn</span></span><span>*</span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>rd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="entity"><span>rrhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sn</span></span><span>*</span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>sd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mklineq</span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>item</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span class="entity"><span>discrete</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>integ</span></span><span> </span><span class="entity"><span>item</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhsa</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coeff</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atoms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rhsa</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coeff</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atoms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>diff</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>-</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhsa</span></span><span> </span><span class="entity"><span>lhsa</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span>-</span><span class="entity"><span>j</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>just</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Asm</span></span><span> </span><span class="entity"><span>k</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Multiplied</span></span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="inner_quoted"><span>"&lt;="</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"~&lt;="</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>discrete</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span>-</span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>NotLeDD</span></span><span class="main"><span>(</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Lt</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>NotLeD</span></span><span class="main"><span>(</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"&lt;"</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>discrete</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>LessD</span></span><span class="main"><span>(</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Lt</span></span><span class="main"><span>,</span></span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"~&lt;"</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span>~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>NotLessD</span></span><span class="main"><span>(</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lineq</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span class="entity"><span>diff</span></span><span class="main"><span>,</span></span><span class="entity"><span>just</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>     </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mklineq"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Print (counter) example                                                   *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mknat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pTs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lineq</span></span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>LA_Logic.is_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atom</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>=</span></span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ixs</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lineq</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nat</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* This code is tricky. It takes a list of premises in the order they occur
in the subgoal. Numerical premises are coded as SOME(tuple), non-numerical
ones as NONE. Going through the premises, each numeric one is converted into
a Lineq. The tricky bit is to convert ~= which is split into two cases &lt; and
&gt;. Thus split_items returns a list of equation systems. This may blow up if
there are many ~=, but in practice it does not seem to happen. The really
tricky bit is to arrange the order of the cases such that they coincide with
the order in which the cases are in the end generated by the tactic that
applies the generated refutation thms (see function 'refute_tac').

For variables n of type nat, a constraint 0 &lt;= n is added.
*)</span></span><span>

</span><span class="comment1"><span>(* FIXME: To optimize, the splitting of cases and the search for refutations *)</span></span><span>
</span><span class="comment1"><span>(*        could be intertwined: separate the first (fully split) case,       *)</span></span><span>
</span><span class="comment1"><span>(*        refute it, continue with splitting and refuting.  Terminate with   *)</span></span><span>
</span><span class="comment1"><span>(*        failure as soon as a case could not be refuted; i.e. delay further *)</span></span><span>
</span><span class="comment1"><span>(*        splitting until after a refutation for other cases has been found. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_items</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="comment1"><span>(* splits inequalities '~=' into '&lt;' and '&gt;'; this corresponds to *)</span></span><span>
  </span><span class="comment1"><span>(* 'REPEAT_DETERM (eresolve_tac neqE i)' at the theorem/tactic    *)</span></span><span>
  </span><span class="comment1"><span>(* level                                                          *)</span></span><span>
  </span><span class="comment1"><span>(* FIXME: this is currently sensitive to the order of theorems in *)</span></span><span>
  </span><span class="comment1"><span>(*        neqE:  The theorem for type "nat" must come first.  A   *)</span></span><span>
  </span><span class="comment1"><span>(*        better (i.e. less likely to break when neqE changes)    *)</span></span><span>
  </span><span class="comment1"><span>(*        implementation should *test* which theorem from neqE    *)</span></span><span>
  </span><span class="comment1"><span>(*        can be applied, and split the premise accordingly.      *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineqs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span>option</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span>option</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span>option</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span>option</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ineqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="entity"><span>ineqs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ineq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ineqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"~="</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="comment1"><span>(* [| ?l ~= ?r; ?l &lt; ?r ==&gt; ?R; ?r &lt; ?l ==&gt; ?R |] ==&gt; ?R *)</span></span><span>
            </span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineqs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"&lt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
            </span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineqs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"&lt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nat</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>ineq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_neq'</span></span><span> </span><span class="entity"><span>nat_only</span></span><span> </span><span class="entity"><span>ineqs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ineqs</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>elim_neq'</span></span><span> </span><span>true</span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_neq'</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ignore_neq</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ignore_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"~="</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>number_hyps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>             </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>number_hyps</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_hyps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>number_hyps</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>number_hyps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="comment1"><span>(* user-defined preprocessing of the subgoal *)</span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>LA_Data.pre_decomp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Library.single</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>subgoals</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Preprocessing yields "</span></span><span> </span><span>^</span><span>
         </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>subgoals</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" subgoal(s) total."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="comment1"><span>(* produce the internal encoding of (in-)equalities *)</span></span><span>
       </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LA_Data.domain_is_nat</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="comment1"><span>(* splitting of inequalities *)</span></span><span>
       </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                     </span><span>Library.single</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>ignore_neq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subgoals</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="comment1"><span>(* numbering of hypotheses, ignoring irrelevant ones *)</span></span><span>
       </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_hyps</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Splitting of inequalities yields "</span></span><span> </span><span>^</span><span>
    </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" subgoal(s) total."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="entity"><span>result</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refutes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>initems</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>initemss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>js</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atoms_of</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>initems</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>atoms</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mkleq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mklineq</span></span><span> </span><span class="entity"><span>atoms</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ixs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iatoms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atoms</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ixs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>natlineqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mknat</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>ixs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iatoms</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ineqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mkleq</span></span><span> </span><span class="entity"><span>initems</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>natlineqs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ineqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Contradiction! ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>js</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="entity"><span>refute</span></span><span> </span><span class="entity"><span>initemss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>js</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Failure</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>js</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>refutes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_items</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> * </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"prove:"</span></span><span>
    </span><span class="comment1"><span>(* append the negated conclusion to 'Hs' -- this corresponds to     *)</span></span><span>
    </span><span class="comment1"><span>(* 'DETERM (resolve_tac [LA_Logic.notI, LA_Logic.ccontr] i)' at the *)</span></span><span>
    </span><span class="comment1"><span>(* theorem/tactic level                                             *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Hs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>LA_Logic.neg_prop</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_neq</span></span><span> </span><span>NONE</span><span>                 </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_neq</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"~="</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neq_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>LA_Data.neq_limit</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>is_neq</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.decomp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>neq_limit</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"neq_limit exceeded (current value is "</span></span><span> </span><span>^</span><span>
        </span><span>string_of_int</span><span> </span><span class="entity"><span>neq_limit</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"), ignoring all inequalities"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>do_pre</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"neg_prop"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="comment1"><span>(* since no meta-logic negation is available, we can only fail if   *)</span></span><span>
    </span><span class="comment1"><span>(* the conclusion is not of the form 'Trueprop $ _' (simply         *)</span></span><span>
    </span><span class="comment1"><span>(* dropping the conclusion doesn't work either, because even        *)</span></span><span>
    </span><span class="comment1"><span>(* 'False' does not imply arbitrary 'concl::prop')                  *)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"prove failed (cannot negate conclusion)."</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refute_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>justs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"refute_tac (on subgoal "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", with "</span></span><span> </span><span>^</span><span>
          </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>justs</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" justification(s)):"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>state</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neqE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_neqE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>just1</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="comment1"><span>(* eliminate inequalities *)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>neqE</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>all_tac</span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
          </span><span>PRIMITIVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"State after neqE:"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
          </span><span class="comment1"><span>(* use theorems generated from the actual justifications *)</span></span><span>
          </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mkthm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="comment1"><span>(* rewrite "[| A1; ...; An |] ==&gt; B" to "[| A1; ...; An; ~B |] ==&gt; False" *)</span></span><span>
      </span><span>DETERM</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>LA_Logic.notI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LA_Logic.ccontr</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="comment1"><span>(* user-defined preprocessing of the subgoal *)</span></span><span>
      </span><span>DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Data.pre_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span>PRIMITIVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"State after pre_tac:"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="comment1"><span>(* prove every resulting subgoal, using its justification *)</span></span><span>
      </span><span>EVERY</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>just1</span></span><span> </span><span class="entity"><span>justs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  </span><span class="entity"><span>state</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*
Fast but very incomplete decider. Only premises and conclusions
that are already (negated) (in)equations are taken into account.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simpset_lin_arith_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_params</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_assums_hyp</span><span> </span><span class="entity"><span>A</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>A</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Trying to refute subgoal "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>A</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Refutation failed."</span></span><span class="main"><span>;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Refutation succeeded."</span></span><span class="main"><span>;</span></span><span>
                               </span><span class="entity"><span>refute_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prems_lin_arith_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Method.insert_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.prems_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
  </span><span class="entity"><span>simpset_lin_arith_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lin_arith_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>simpset_lin_arith_tac</span></span><span> </span><span class="main"><span>(</span></span><span>empty_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** Forward proof from theorems **)</span></span><span>

</span><span class="comment1"><span>(* More tricky code. Needs to arrange the proofs of the multiple cases (due
to splits of ~= premises) such that it coincides with the order of the cases
generated by function split_items. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>splittree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tip</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm list
                   </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Spl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm * cterm * splittree * cterm * splittree</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* "(ct1 ==&gt; ?R) ==&gt; (ct2 ==&gt; ?R) ==&gt; ?R" is taken to (ct1, ct2) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>imp</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> * </span><span>cterm</span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Il</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>imp</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp1</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>Il</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ict1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>imp1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct1</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>Ict1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ir</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ict2r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>Ir</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ict2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>Ict2r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct2</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>Ict2</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>splitasms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>splittree</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neqE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_neqE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tip</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>asms'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tip</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>asms'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>neqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>rev</span><span> </span><span class="entity"><span>asms'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neqs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neq</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asm</span></span><span>::</span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asm</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>neq</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>spl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>spl</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>ct1</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>ct2</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Spl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span>@</span><span class="main"><span>[</span></span><span class="entity"><span>thm1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>ct2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span>@</span><span class="main"><span>[</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asm</span></span><span>::</span><span class="entity"><span>asms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>elim_neq</span></span><span> </span><span class="entity"><span>neqE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fwdproof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tip</span></span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>splittree</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span>::</span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkthm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fwdproof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fwdproof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tree1</span></span><span> </span><span class="entity"><span>js</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fwdproof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tree2</span></span><span> </span><span class="entity"><span>js1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ct1</span></span><span> </span><span class="entity"><span>thm1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ct2</span></span><span> </span><span class="entity"><span>thm2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm2'</span></span><span> </span><span>COMP</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1'</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="comment1"><span>(* FIXME needs handle THM _ =&gt; NONE ? *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>Tconcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>injust</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nTconcl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LA_Logic.neg_prop</span></span><span> </span><span class="entity"><span>Tconcl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cnTconcl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>nTconcl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nTconclthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>cnTconcl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>splitasms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Tip</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nTconclthm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Falsethm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fwdproof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="entity"><span>js</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>contr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>LA_Logic.ccontr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>LA_Logic.notI</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>cnTconcl</span></span><span> </span><span class="entity"><span>Falsethm</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>contr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Proved by lin. arith. prover:"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LA_Logic.mk_Eq</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="comment1"><span>(*in case concl contains ?-var, which makes assume fail:*)</span></span><span>   </span><span class="comment1"><span>(* FIXME Variable.import_terms *)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* PRE: concl is not negated!
   This assumption is OK because
   1. lin_arith_simproc tries both to prove and disprove concl and
   2. lin_arith_simproc is applied by the Simplifier which
      dives into terms and will thus try the non-negated concl anyway.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lin_arith_simproc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>LA_Logic.atomize</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.prems_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Tconcl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LA_Logic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="entity"><span>Tconcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="comment1"><span>(* concl provable? *)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>Tconcl</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nTconcl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LA_Logic.neg_prop</span></span><span> </span><span class="entity"><span>Tconcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span class="entity"><span>nTconcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="comment1"><span>(* ~concl provable? *)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>split_neq</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>nTconcl</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="entity"><span>split_neq</span></span><span> </span><span>false</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>