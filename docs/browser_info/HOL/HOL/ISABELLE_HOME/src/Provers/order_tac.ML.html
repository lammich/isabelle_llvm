<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/order_tac.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/order_tac.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>REIFY_TABLE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>table</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>table</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_var </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>table</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_term </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Reifytab</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>REIFY_TABLE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_var</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tis</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span>Envir.aeconv</span><span> </span><span class="entity"><span>tis</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_var</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_var</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_term</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tis</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tis</span></span><span>
                            </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span>fst</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LOGIC_SIGNATURE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_Trueprop </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_Trueprop </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Trueprop_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Not </span><span class="main"><span>:</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conj </span><span class="main"><span>:</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> disj </span><span class="main"><span>:</span></span><span> </span><span>term</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> notI </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(* (P ⟹ False) ⟹ ¬ P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ccontr </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(* (¬ P ⟹ False) ⟹ P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conjI </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(* P ⟹ Q ⟹ P ∧ Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conjE </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(* P ∧ Q ⟹ (P ⟹ Q ⟹ R) ⟹ R *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> disjE </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(* P ∨ Q ⟹ (P ⟹ R) ⟹ (Q ⟹ R) ⟹ R *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_not_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="comment1"><span>(* ¬ (¬ P) ≡ P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> de_Morgan_conj_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="comment1"><span>(* ¬ (P ∧ Q) ≡ ¬ P ∨ ¬ Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> de_Morgan_disj_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="comment1"><span>(* ¬ (P ∨ Q) ≡ ¬ P ∧ ¬ Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conj_disj_distribL_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="comment1"><span>(* P ∧ (Q ∨ R) ≡ (P ∧ Q) ∨ (P ∧ R) *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conj_disj_distribR_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="comment1"><span>(* (Q ∨ R) ∧ P ≡ (Q ∧ P) ∨ (R ∧ P) *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Control tracing output of the solver. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>order_trace_cfg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> "</span><span class="entity_def" id="Orderings.order_trace|attribute"><span>order_trace</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(* In partial orders, literals of the form ¬ x &lt; y will force the order solver to perform case
   distinctions, which leads to an exponential blowup of the runtime. The split limit controls
   the number of literals of this form that are passed to the solver. 
 *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>order_split_limit_cfg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> "</span><span class="entity_def" id="Orderings.order_split_limit|attribute"><span>order_split_limit</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>order_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Order</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Linorder</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>order_literal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span class="entity"><span>Order_Procedure.order_atom</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>order_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    kind </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>order_kind</span></span><span class="main"><span>,</span></span><span>
    ops </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> thms </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> conv_thms </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BASE_ORDER_TAC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tac </span><span class="main"><span>:</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>order_literal</span></span><span> </span><span class="entity"><span>Order_Procedure.fm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Order_Procedure.prf_trm</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>order_context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Base_Order_Tac</span></span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Logic_Sig </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LOGIC_SIGNATURE</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> excluded_types </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BASE_ORDER_TAC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Order_Procedure</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_curry0</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_curry1</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_curry2</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dereify_term</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>App</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Const "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" not in"</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Reifytab.get_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>integer_of_int</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>dereify_term'</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dereify_order_fm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"lt"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.Not</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"disj"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.disj</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"conj"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.conj</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>dereify_term</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_AppP</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span>::</span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>strip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replay_conv</span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="entity"><span>cvp</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"all_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>list_curry0</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> 
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>list_curry1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"atom_conv"</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"neg_atom_conv"</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"arg_conv"</span></span><span class="main"><span>,</span></span><span> </span><span>Conv.arg_conv</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>list_curry2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"combination_conv"</span></span><span class="main"><span>,</span></span><span> </span><span>Conv.combination_conv</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"then_conv"</span></span><span class="main"><span>,</span></span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>then_conv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_conv</span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="entity"><span>c</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Can't replay conversion: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rp_conv</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>strip_AppP</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>||&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>rp_conv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>PThm</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_conv</span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="entity"><span>c</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>cvs</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>cvs</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected "</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>arity</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" arguments for conversion "</span></span><span> </span><span>^</span><span>
                          </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" but got "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>cvs</span></span><span> </span><span>|&gt;</span><span> </span><span>Int.toString</span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" arguments"</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unexpected constructor in conversion proof"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>rp_conv</span></span><span> </span><span class="entity"><span>cvp</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replay_prf_trm</span></span><span> </span><span class="entity"><span>replay_conv</span></span><span> </span><span class="entity"><span>dereify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thmtab</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PThm</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thmtab</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cannot replay theorem: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Appt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="entity"><span>p</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Drule.infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dereify</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AppP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AbsP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reified_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dereify</span></span><span> </span><span class="entity"><span>reified_t</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Logic_Sig.mk_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Assumption.assume</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="main"><span>(</span></span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>t_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assmtab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>t_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rp</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>reified_t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dereify</span></span><span> </span><span class="entity"><span>reified_t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Logic_Sig.mk_Trueprop</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="entity"><span>t</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Assumption not found:"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span>::</span><span>Termtab.keys</span><span> </span><span class="entity"><span>assmtab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Logic_Sig.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replay_conv</span></span><span> </span><span class="entity"><span>cp</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>thm</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>conv_thm</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="main"><span>(</span></span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conv_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assmtab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>replay_prf_trm'</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="entity"><span>p</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replay_order_prf_trm</span></span><span> </span><span class="entity"><span>ord_ops</span></span><span> </span><span class="main"><span>{</span></span><span>thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conv_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thmtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"conjE"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.conjE</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"conjI"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.conjI</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"disjE"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.disjE</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>convs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>list_curry0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>Conv.rewr_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conv_thms</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"not_not_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.not_not_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"de_Morgan_conj_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.de_Morgan_conj_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"de_Morgan_disj_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.de_Morgan_disj_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"conj_disj_distribR_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.conj_disj_distribR_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"conj_disj_distribL_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Logic_Sig.conj_disj_distribL_conv</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dereify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dereify_order_fm</span></span><span> </span><span class="entity"><span>ord_ops</span></span><span> </span><span class="entity"><span>reifytab</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>replay_prf_trm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replay_conv</span></span><span> </span><span class="entity"><span>convs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dereify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thmtab</span></span><span> </span><span class="entity"><span>assmtab</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Logic_Sig.Not</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>nt</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_Not</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>limit_not_less</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>order_trace_cfg</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>order_split_limit_cfg</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_not_less_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_Not</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Logic_Sig.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binop</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_less_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_not_less_term</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>not_less_prems</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>limit</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"order split limit exceeded"</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_not_less_term</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span> </span><span>@</span><span>
      </span><span>take</span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>not_less_prems</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decomp</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_excluded</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>excluded_types</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decomp''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Order_Procedure</span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_match</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Pattern.match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_excluded</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>try_match</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>try_match</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>try_match</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                      </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LEQ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LESS</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>decomp''</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decomp'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Logic_Sig.Not</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>decomp''</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>decomp''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>decomp'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decomp''</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>try</span><span> </span><span class="entity"><span>Logic_Sig.dest_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="entity"><span>decomp'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maximal_envs</span></span><span> </span><span class="entity"><span>envs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_opt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>test_opt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>leq_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Vartab.forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tyenv2</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>test_opt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ty2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyenv1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>Vartab.forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tenv2</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>test_opt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tenv1</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>leq_env</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>env2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>envs</span></span><span> </span><span class="entity"><span>es</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_order</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="entity"><span>fold_env</span></span><span> </span><span class="entity"><span>envs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>graph</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int_Graph.new_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="entity"><span>envs</span></span><span> </span><span>Int_Graph.empty</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>graph</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Int_Graph.add_edge</span><span> </span><span class="entity"><span>env_order</span></span><span> </span><span class="entity"><span>graph</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>strong_conns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int_Graph.strong_conn</span><span> </span><span class="entity"><span>graph</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maximals</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>Int_Graph.all_succs</span><span> </span><span class="entity"><span>graph</span></span><span> </span><span class="entity"><span>comp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>strong_conns</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Int_Graph.all_preds</span><span> </span><span class="entity"><span>graph</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maximals</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_tac</span></span><span> </span><span class="entity"><span>raw_order_proc</span></span><span> </span><span class="entity"><span>octxt</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>prems</span><span class="main"><span>=</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> context</span><span class="main"><span>=</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>order_trace_cfg</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>these'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>these'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>these'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>these'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>prems</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span>Thm.eta_conversion</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>these'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decomp</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ops </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maximal_envs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>env_of</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_tac'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>no_tac</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>order_tac'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ops </span><span class="entity"><span>octxt</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.eta_contract</span><span> </span><span>o</span><span> </span><span>Envir.subst_term</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>kind </span><span class="entity"><span>octxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                                   </span><span class="entity"><span>Order</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>limit_not_less</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ops </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span>
      
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reify_prem</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctor</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reifytab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>Reifytab.get_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>Reifytab.get_var</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reifytab</span></span><span>
                </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctor</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>Int_of_integer</span></span><span> </span><span class="entity"><span>vp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reified_prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reifytab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>reify_prem</span></span><span> </span><span class="entity"><span>decomp_prems</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Reifytab.empty</span></span><span class="main"><span>)</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reified_prems_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>reified_prems</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_conj_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>decomp_prems</span></span><span>
                                   </span><span>|&gt;</span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Logic_Sig.conjI</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                   </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span>Thm.eta_conversion</span><span> 
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems_conj_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span>
              
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>raw_order_proc</span></span><span> </span><span class="entity"><span>reified_prems_conj</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pretty_term_list</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span>show_types</span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pretty_thm_list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_type_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_trace</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
                </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"order kind:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kind </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"order operators:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span> </span><span class="entity"><span>pretty_term_list</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                                                     </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_type_of</span></span><span> </span><span class="entity"><span>le</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"premises:"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_thm_list</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"selected premises:"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_thm_list</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>decomp_prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"reified premises:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>reified_prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"contradiction:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span>Option.isSome</span><span> </span><span class="entity"><span>proof</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pp</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"order solver called with the parameters"</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_trace</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assmtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>prems_conj</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems_conj_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replay_order_prf_trm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>octxt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reifytab</span></span><span> </span><span class="entity"><span>assmtab</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>replay</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>`</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_of</span></span><span> </span><span>o</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>decomp_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>order_tac'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>env_groups</span></span><span>
       </span><span>|&gt;</span><span> </span><span>FIRST</span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ad_absurdum_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Logic_Sig.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Logic.strip_assums_concl</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Logic_Sig.Not</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>resolve0_tac</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Logic_Sig.notI</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>resolve0_tac</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Logic_Sig.ccontr</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve0_tac</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Logic_Sig.ccontr</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>raw_order_proc</span></span><span> </span><span class="entity"><span>octxt</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>ad_absurdum_tac</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>order_tac</span></span><span> </span><span class="entity"><span>raw_order_proc</span></span><span> </span><span class="entity"><span>octxt</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Order_Tac</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Base_Tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BASE_ORDER_TAC</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_context_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind1</span></span><span class="main"><span>,</span></span><span> ops </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ops1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind2</span></span><span class="main"><span>,</span></span><span> ops </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ops2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>kind1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ops1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ops2</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_data_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>order_context_eq</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_context</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>order_context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.merge</span><span> </span><span class="entity"><span>order_data_eq</span></span><span> </span><span class="entity"><span>data</span></span><span>
  </span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>octxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> raw_proc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>raw_proc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ops</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ops </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>thms </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>conv_thms </span><span class="entity"><span>octxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>octxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> ops </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ops</span></span><span class="main"><span>,</span></span><span> thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conv_thms</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>context</span></span><span> </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Library.insert</span><span> </span><span class="entity"><span>order_data_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>octxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_proc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_order</span></span><span> </span><span class="main"><span>{</span></span><span>
      ops </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> lt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        trans </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ y ⟹ y ≤ z ⟹ x ≤ z *)</span></span><span>
        refl </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ x *)</span></span><span>
        eqD1 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqD1</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x = y ⟹ x ≤ y *)</span></span><span>
        eqD2 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqD2</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x = y ⟹ y ≤ x *)</span></span><span>
        antisym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>antisym</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ y ⟹ y ≤ x ⟹ x = y *)</span></span><span>
        contr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contr</span></span><span> </span><span class="comment1"><span>(* ¬ P ⟹ P ⟹ R *)</span></span><span>
      </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        less_le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>less_le</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x &lt; y ≡ x ≤ y ∧ x ≠ y *)</span></span><span>
        nless_le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nless_le</span></span><span> </span><span class="comment1"><span>(* ¬ a &lt; b ≡ ¬ a ≤ b ∨ a = b *)</span></span><span>
      </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>declare</span></span><span> </span><span class="main"><span>{</span></span><span>
      kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Order</span></span><span class="main"><span>,</span></span><span>
      ops </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"trans"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"refl"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eqD1"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqD1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eqD2"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqD2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"antisym"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>antisym</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"contr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>contr</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"less_le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>less_le</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nless_le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nless_le</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      raw_proc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Base_Tac.tac</span></span><span> </span><span class="entity"><span>Order_Procedure.po_contr_prf</span></span><span>
     </span><span class="main"><span>}</span></span><span>                

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_linorder</span></span><span> </span><span class="main"><span>{</span></span><span>
      ops </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> lt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        trans </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ y ⟹ y ≤ z ⟹ x ≤ z *)</span></span><span>
        refl </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ x *)</span></span><span>
        eqD1 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqD1</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x = y ⟹ x ≤ y *)</span></span><span>
        eqD2 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqD2</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x = y ⟹ y ≤ x *)</span></span><span>
        antisym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>antisym</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x ≤ y ⟹ y ≤ x ⟹ x = y *)</span></span><span>
        contr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contr</span></span><span> </span><span class="comment1"><span>(* ¬ P ⟹ P ⟹ R *)</span></span><span>
      </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        less_le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>less_le</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* x &lt; y ≡ x ≤ y ∧ x ≠ y *)</span></span><span>
        nless_le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nless_le</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* ¬ x &lt; y ≡ y ≤ x *)</span></span><span>
        nle_le </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nle_le</span></span><span> </span><span class="comment1"><span>(* ¬ a ≤ b ≡ b ≤ a ∧ b ≠ a *)</span></span><span>
      </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>declare</span></span><span> </span><span class="main"><span>{</span></span><span>
      kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Linorder</span></span><span class="main"><span>,</span></span><span>
      ops </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lt</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"trans"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"refl"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eqD1"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqD1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eqD2"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqD2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"antisym"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>antisym</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"contr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>contr</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      conv_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"less_le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>less_le</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nless_le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nless_le</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nle_le"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nle_le</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      raw_proc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Base_Tac.tac</span></span><span> </span><span class="entity"><span>Order_Procedure.lo_contr_prf</span></span><span>
     </span><span class="main"><span>}</span></span><span>
  
  </span><span class="comment1"><span>(* Try to solve the goal by calling the order solver with each of the declared orders. *)</span></span><span>      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>octxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CHANGED</span><span> </span><span>o</span><span> </span><span class="entity"><span>tac0</span></span><span> </span><span class="entity"><span>octxt</span></span><span> </span><span class="entity"><span>simp_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>app_tac</span></span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>