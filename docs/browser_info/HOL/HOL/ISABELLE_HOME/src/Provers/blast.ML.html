<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/blast.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/blast.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Provers/blast.ML
    Author:     Lawrence C Paulson, Cambridge University Computer Laboratory
    Copyright   1997  University of Cambridge

Generic tableau prover with proof reconstruction

  SKOLEMIZES ReplaceI WRONGLY: allow new vars in prems, or forbid such rules??
  Needs explicit instantiation of assumptions?

Given the typeargs system, constructor Const could be eliminated, with
TConst replaced by a constructor that takes the typargs list as an argument.
However, Const is heavily used for logical connectives.

Blast_tac is often more powerful than fast_tac, but has some limitations.
Blast_tac...
  * ignores wrappers (addss, addbefore, addafter, addWrapper, ...);
    this restriction is intrinsic
  * ignores elimination rules that don't have the correct format
        (conclusion must be a formula variable)
  * rules must not require higher-order unification, e.g. apply_type in ZF
    + message "Function unknown's argument not a bound variable" relates to this
  * its proof strategy is more general but can actually be slower

Known problems:
  "Recursive" chains of rules can sometimes exclude other unsafe formulae
        from expansion.  This happens because newly-created formulae always
        have priority over existing ones.  But obviously recursive rules
        such as transitivity are treated specially to prevent this.  Sometimes
        the formulae get into the wrong order (see WRONG below).

  With substition for equalities (hyp_subst_tac):
        When substitution affects an unsafe formula or literal, it is moved
        back to the list of safe formulae.
        But there's no way of putting it in the right place.  A "moved" or
        "no DETERM" flag would prevent proofs failing here.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BLAST_DATA</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Classical</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CLASSICAL</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Trueprop_const</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equality_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> notE</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>           </span><span class="comment1"><span>(* [| ~P;  P |] ==&gt; R *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ccontr</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hyp_subst_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BLAST</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> TRANS </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>    </span><span class="comment1"><span>(*reports translation errors*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * term list
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Skolem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * term option Unsynchronized.ref list
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Var</span></span><span>   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term option Unsynchronized.ref
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Abs</span></span><span>   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string*term
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>$</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term*term</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_limit</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> stats</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> blast_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="comment1"><span>(*debugging tools*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>branch</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tryIt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>{</span></span><span>fullTrace</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>branch</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
      result</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>branch</span></span><span> </span><span>list</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span> * </span><span>exn</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Blast</span></span><span class="main"><span>(</span></span><span>Data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BLAST_DATA</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BLAST</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Classical</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.Classical</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* options *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.blast_depth_limit|attribute"><span>blast_depth_limit</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>20</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹blast_trace›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stats</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹blast_stats›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Const</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * term list  </span><span class="comment1"><span>(*typargs constant--as a term!*)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Skolem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * term option Unsynchronized.ref list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free</span></span><span>   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Var</span></span><span>    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term option Unsynchronized.ref
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Bound</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Abs</span></span><span>    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string*term
  </span><span class="main"><span>|</span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>$</span></span><span>   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term*term</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Pending formulae carry md (may duplicate) flags*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>branch</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>pairs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span>*</span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="comment1"><span>(*safe formulae on this level*)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span>*</span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*unsafe formulae on this level*)</span></span><span>
     lits</span><span class="main"><span>:</span></span><span>   </span><span class="entity"><span>term</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>                 </span><span class="comment1"><span>(*literals: irreducible formulae*)</span></span><span>
     vars</span><span class="main"><span>:</span></span><span>   </span><span class="entity"><span>term</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*variables occurring in branch*)</span></span><span>
     lim</span><span class="main"><span>:</span></span><span>    </span><span>int</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>                      </span><span class="comment1"><span>(*resource limit*)</span></span><span>


</span><span class="comment1"><span>(* global state information *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>ctxt</span><span class="main"><span>:</span></span><span> Proof.context</span><span class="main"><span>,</span></span><span>
  names</span><span class="main"><span>:</span></span><span> Name.context Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
  fullTrace</span><span class="main"><span>:</span></span><span> branch list list Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
  trail</span><span class="main"><span>:</span></span><span> term option Unsynchronized.ref list Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
  ntrail</span><span class="main"><span>:</span></span><span> int Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
  nclosed</span><span class="main"><span>:</span></span><span> int Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
  ntried</span><span class="main"><span>:</span></span><span> int Unsynchronized.ref</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reserved_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>Sign.const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"blast: theory contains reserved constant "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>initialize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="inner_quoted"><span>"*False*"</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>State</span></span><span>
     </span><span class="main"><span>{</span></span><span>ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
      names </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      fullTrace </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      trail </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      ntrail </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span>
      nclosed </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*number of branches closed during the search*)</span></span><span>
      ntried </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(*number of branches created by splitting (counting from 1)*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gensym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Unsynchronized.change_result</span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span>Name.variant</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Basic syntactic operations **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_Var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_Var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_Var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rand</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* maps   (f, [t1,...,tn])  to  f(t1,...,tn) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list_comb</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> * </span><span class="entity"><span>term</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>$</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* maps   f(t1,...,tn)  to  (f, [t1,...,tn]) ; naturally tail-recursive*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_comb</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> * </span><span class="entity"><span>term</span></span><span> </span><span>list</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span>   </span><span class="entity"><span>stripc</span></span><span>  </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>stripc</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* maps   f(t1,...,tn)  to  f , which is never a combination *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>head_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head_of</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>head_of</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Particular constants **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.not_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isNot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isNot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkGoal</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TruepropC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TruepropT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.Trueprop_const</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.$</span><span> </span><span class="main"><span>(</span></span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TruepropC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TruepropT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TruepropC</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_Trueprop</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** Dealing with overloaded constants ***)</span></span><span>

</span><span class="comment1"><span>(*alist is a map from TVar names to Vars.  We need to unify the TVars
  faithfully in order to track overloading*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromType</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Type</span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_comb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fromType</span></span><span> </span><span class="entity"><span>alist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fromType</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="main"><span>(</span></span><span>Term.TFree</span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fromType</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="main"><span>(</span></span><span>Term.TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>alist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ixn</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>alist</span></span><span> </span><span>:=</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>alist</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>t'</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromConst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fromType</span></span><span> </span><span class="entity"><span>alist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.const_typargs</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Tests whether 2 terms are alpha-convertible; chases instantiations*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>aconvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b</span></span><span>  </span><span class="comment1"><span>(*arglists must then be equal*)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>        </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>=</span></span><span class="entity"><span>w</span></span><span>   </span><span class="comment1"><span>(*both Vars are un-assigned*)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>      </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=</span></span><span class="entity"><span>j</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>     </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>          </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="entity"><span>$</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=</span></span><span>  </span><span>false</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>aconvs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aconvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>aconvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aconvs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mem_term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mem_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>mem_term</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ins_term</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mem_term</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mem_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mem_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v'</span></span><span>::</span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span>              </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>=</span></span><span class="entity"><span>v'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>mem_var</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ins_var</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mem_var</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Vars **)</span></span><span>

</span><span class="comment1"><span>(*Accumulates the Vars in the term, suppressing duplicates*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_vars_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ins_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span>
</span><span class="comment1"><span>(*Term list version.  [The fold functionals are slow]*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>    </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(*Var list version.*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>add_vars_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_vars_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_vars_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_vars_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span>::</span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>   </span><span class="comment1"><span>(*v must be a ref NONE*)</span></span><span>
        </span><span class="entity"><span>add_vars_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ins_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Chase assignments in "vars"; return a list of unassigned variables*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vars_in_vars</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_vars_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*increment a term's non-local bound variables
     inc is  increment for bound variables
     lev is  level at which a bound variable is considered 'loose'*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_bv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&gt;=</span><span class="entity"><span>lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Bound</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>inc</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_boundvars</span></span><span>  </span><span class="inner_numeral"><span>0</span></span><span>  </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>incr_boundvars</span></span><span> </span><span class="entity"><span>inc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>incr_bv</span></span><span class="main"><span>(</span></span><span class="entity"><span>inc</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Accumulate all 'loose' bound vars referring to level 'lev' or beyond.
   (Bound 0) is loose at level 0 *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="entity"><span>lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>js</span></span><span>
                                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>           </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>loose_bnos</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_loose_bnos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="entity"><span>lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>  </span><span class="entity"><span>t</span></span><span>    </span><span class="comment1"><span>(*var is locally bound*)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=</span></span><span class="entity"><span>lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>incr_boundvars</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>arg</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Bound</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(*loose: change it*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>subst</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span>  </span><span class="entity"><span>$</span></span><span>  </span><span class="entity"><span>subst</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Normalize...but not the bodies of ABSTRACTIONS*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars_in_vars</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nf</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Weak (one-level) normalize for use in unification*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wkNormAux</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>!</span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="entity"><span>u</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>wkNormAux</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nf</span></span><span>          </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nf</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>     </span><span class="comment1"><span>(*eta-contract if possible*)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>wkNormAux</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>nb</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loose_bnos</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>nb</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr_boundvars</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nb</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>nb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>head_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free</span></span><span> </span><span class="main"><span>_</span></span><span>         </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>              </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>wkNormAux</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Does variable v occur in u?  For unification.
  Dangling bound vars are also forbidden.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varOccur</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>occL</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>   </span><span class="comment1"><span>(*same as (exists occ), but faster*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occL</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span>::</span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>occL</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>us</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>v</span></span><span class="main"><span>=</span></span><span class="entity"><span>w</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>!</span><span class="entity"><span>w</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occL</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(*ignore Const, since term variables can't occur in types (?) *)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>u</span></span><span>  </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>  </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>f</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>occ</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Restore the trail to some previous state: for backtracking*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clearTo</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>while</span></span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>&lt;&gt;</span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>do</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
         </span><span class="entity"><span>trail</span></span><span> </span><span>:=</span><span> </span><span>tl</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>trail</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span class="entity"><span>ntrail</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*First-order unification with bound variables.
  "vars" is a list of variables local to the rule and NOT to be put
        on the trail (no point in doing so)
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unify</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>varOccur</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mem_var</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*avoid updating Vars in the branch if possible!*)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Var</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>mem_var</span></span><span class="main"><span>(</span></span><span class="entity"><span>dest_Var</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dest_Var</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>
                            </span><span class="entity"><span>trail</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>trail</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>ntrail</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unifyAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wkNorm</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>wkNorm</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>nu</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update</span></span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span class="main"><span>,</span></span><span class="entity"><span>nu</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nu</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>nt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update</span></span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span class="main"><span>,</span></span><span class="entity"><span>nu</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>ats</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Const</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>bts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>=</span></span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unifysAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>ats</span></span><span class="main"><span>,</span></span><span class="entity"><span>bts</span></span><span class="main"><span>)</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unifyAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*NB: can yield unifiers having dangling Bound vars!*)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>g</span></span><span class="entity"><span>$</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unifyAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>unifyAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nt</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>nu</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nt</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>nu</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>unifysAux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unifysAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unifyAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>unifysAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unifysAux</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>unifyAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>UNIFY</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Convert from "real" terms to prototerms; eta-contract.
  Code is similar to fromSubgoal.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromTerm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alistVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>alistTVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Const</span><span> </span><span class="entity"><span>aT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fromConst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>alistTVar</span></span><span> </span><span class="entity"><span>aT</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Free</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ixn</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>alistVar</span></span><span> </span><span>:=</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>t'</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span>  </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>u</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="entity"><span>u'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loose_bnos</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>incr_boundvars</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>f</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span>Term.$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>t</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*A debugging function: replaces all Vars by dummy Frees for visual inspection
  of whether they are distinct.  Function revert undoes the assignments.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instVars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_quoted"><span>"a"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updated</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>ts</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>updated</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>updated</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                       </span><span class="entity"><span>v</span></span><span>       </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"?"</span></span><span> </span><span>^</span><span> </span><span>!</span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                       </span><span class="entity"><span>name</span></span><span>    </span><span>:=</span><span> </span><span>Symbol.bump_string</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>_</span></span><span>             </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>revert</span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>:=</span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>updated</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>revert</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* A1==&gt;...An==&gt;B  goes to  [A1,...,An], where B is not an implication *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>strip_Trueprop</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>B</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* A1==&gt;...An==&gt;B  goes to B, where B is not an implication *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>B</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_Trueprop</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** Conversion of Elimination Rules to Tableau Operations ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ElimBadConcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ElimBadPrem</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*The conclusion becomes the goal/negated assumption *False*: delete it!
  If we don't find it then the premise is ill-formed and could cause
  PROOF FAILED*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete_concl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ElimBadPrem</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>delete_concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*False*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"*Goal*"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Ps</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>delete_concl</span></span><span> </span><span class="entity"><span>Ps</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>delete_concl</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skoPrem</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>skoPrem</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gensym</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="inner_quoted"><span>"S"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>skoPrem</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>convertPrem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>delete_concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkGoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Expects elimination rules to have a formula variable as conclusion*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>convertRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span>::</span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>v</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*False*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>convertPrem</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>skoPrem</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Bind</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ElimBadConcl</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Like dup_elim, but puts the duplicated major premise FIRST*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rev_dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>revcut_rl</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.assumption</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Rotate the assumptions in all new subgoals for the LIFO discipline*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="comment1"><span>(*Count new hyps so that they can be rotated*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>                         </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="entity"><span>Ps</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span>::</span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span>                    </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span>::</span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>::</span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.rotate_rule</span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rot_subgoals_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rot</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="entity"><span>rot_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rot</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>nNewHyps</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cond_tracing</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cond_tracing</span></span><span> </span><span>false</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Resolution/matching tactics: if upd then the proof state may be updated.
  Matching makes the tactics more deterministic in the presence of Vars.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>emtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rmtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>match_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Tableau rule from elimination rule.
  Flag "upd" says that the inference updated the branch.
  Flag "dup" requests duplication of the affected formula.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromRule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>rl0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>rl0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>fromTerm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>convertRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup</span></span><span class="main"><span>,</span></span><span class="entity"><span>rot</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>emtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dup</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rev_dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>rot_subgoals_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rot</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>trl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
    </span><span class="entity"><span>ElimBadPrem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*reject: prems don't preserve conclusion*)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context_Position.is_visible</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Ignoring weak elimination rule\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl0</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span>Option.NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ElimBadConcl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*ignore: conclusion is not just a variable*)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Ignoring ill-formed elimination rule:\n"</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"conclusion should be a variable\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span>Option.NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Conversion of Introduction Rules ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>convertIntrPrem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkGoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>convertIntrRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>mkGoal</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>convertIntrPrem</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>skoPrem</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Tableau rule from introduction rule.
  Flag "upd" says that the inference updated the branch.
  Flag "dup" requests duplication of the affected formula.
  Since unsafe rules are now delayed, "dup" is always FALSE for
  introduction rules.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromIntrRule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>rl0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>rl0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>fromTerm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>convertIntrRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span class="main"><span>,</span></span><span class="entity"><span>dup</span></span><span class="main"><span>,</span></span><span class="entity"><span>rot</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rmtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dup</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Classical.dup_intr</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>rot_subgoals_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rot</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>trl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummyVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"etc"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Convert from prototerms to ordinary terms with dummy types
  Ignore abstractions; identify all Vars; STOP at given depth*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span>             </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummyVar</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(*no need to convert typargs*)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>Term.Free</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>Term.Bound</span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummyVar</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummyVar</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span>Term.$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toTerm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Too flexible assertions or goals. Motivated by examples such as "(⋀P. ~P) ⟹ 0==1"*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isVarForm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isVarForm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isVarForm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>netMkRules</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nps</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Classical.netpair</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pG</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toTerm</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inet</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.unify_term</span><span> </span><span class="entity"><span>inet</span></span><span> </span><span class="entity"><span>pG</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nps</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fromIntrRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>order_list</span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isVarForm</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(*The formula is too flexible, reject*)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toTerm</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elims</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>enet</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.unify_term</span><span> </span><span class="entity"><span>enet</span></span><span> </span><span class="entity"><span>pP</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nps</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fromRule</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>order_list</span><span> </span><span class="entity"><span>elims</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Normalize a branch--for tracing*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normLev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span class="entity"><span>Hs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>norm2</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>norm2</span></span><span> </span><span class="entity"><span>Hs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normBr</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>normLev</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
      lits  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
      vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
      lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummyTVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.TVar</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummyVar2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"var"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*convert blast_tac's type representation to real types for tracing*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>showType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Term.TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummyTVar</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showType</span></span><span> </span><span class="entity"><span>t</span></span><span>         </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>strip_comb</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.Type</span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>showType</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Display top-level overloading if any*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Sign.const_instance</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>showType</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>some</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Convert from prototerms to ordinary terms with dummy types for tracing*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Free</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.Bound</span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummyVar2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dummyVar</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Term.Abs</span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dummyVar</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Term.$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>showTerm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>showTerm</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Convert a Goal to an ordinary Not.  Used also in dup_intr, where a goal like
  Ex(P) is duplicated as the assumption ~Ex(P). *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>G</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negOfGoal2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Converts all Goals to Nots in the safe parts of a branch.  They could
  have been moved there from the literals list after substitution (equalSubst).
  There can be at most one--this function could be made more efficient.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negOfGoals</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>negOfGoal2</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Tactic.  Convert *Goal* to negated assumption in FIRST position*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negOfGoal_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Data.ccontr</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.ccontr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>traceTerm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="entity"><span>t'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>topType</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stm</span></span><span>   </span><span class="comment1"><span>(*no type to attach*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stm</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" :: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Print tracing information at each iteration of prover*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_prover</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fullTrace</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>brs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>printPairs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>traceTerm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>printPairs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>traceTerm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"  (Unsafe)"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>printPairs</span></span><span> </span><span class="main"><span>_</span></span><span>                 </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>printBrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>brs0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>fullTrace</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>brs0</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>fullTrace</span></span><span class="main"><span>;</span></span><span>
             </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"+"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>;</span></span><span>
             </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" ["</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>lim</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"] "</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="entity"><span>printPairs</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>;</span></span><span>
             </span><span>tracing</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>printBrs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>normBr</span></span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Tracing: variables updated in the last branch operation?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>traceVars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ntrl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>-</span><span class="entity"><span>ntrl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>" 1 variable UPDATED:"</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" variables UPDATED:"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span class="comment1"><span>(*display the instantiations themselves, though no variable names*)</span></span><span>
       </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"   "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span>List.take</span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>-</span><span class="entity"><span>ntrl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span>tracing</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Tracing: how many new branches are created?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>traceNew</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"branch closed by rule"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"branch extended (1 new subgoal)"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"branch split: "</span></span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" new subgoals"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>traceNew</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** Code for handling equality: naive substitution, like hyp_subst_tac ***)</span></span><span>

</span><span class="comment1"><span>(*Replace the ATOMIC term "old" by "new" in t*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_atomic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old</span></span><span class="main"><span>,</span></span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>u</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>old</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>t</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Eta-contract a term from outside: just enough to reduce it to an atom*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span>  </span><span class="entity"><span>eta_contract2</span></span><span> </span><span class="entity"><span>body</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>Bound</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loose_bnos</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t0</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr_boundvars</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>eta_contract2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eta_contract2</span></span><span> </span><span class="entity"><span>t</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*When can we safely delete the equality?
    Not if it equates two constants; consider 0=1.
    Not if it resembles x=t[x], since substitution does not eliminate x.
    Not if it resembles ?x=0; another goal could instantiate ?x to Suc(i)
  Prefer to eliminate Bound variables if possible.
  Result:  true = use as is,  false = reorient first *)</span></span><span>

</span><span class="comment1"><span>(*Can t occur in u?  For substitution.
  Does NOT examine the args of Skolem terms: substitution does not affect them.
  REFLEXIVE because hyp_subst_tac fails on x=x.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>substOccur</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*NO vars are permitted in u except the arguments of t, if it is
        a Skolem term.  This ensures that no equations are deleted that could
        be instantiated to a cycle.  For example, x=?a is rejected because ?a
        could be instantiated to Suc(x).*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                     </span><span class="entity"><span>Skolem</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>vars</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>occEq</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occEq</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mem_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occEq</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occEq</span></span><span> </span><span class="entity"><span>u</span></span><span>  </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>  </span><span class="entity"><span>occEq</span></span><span> </span><span class="entity"><span>f</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>occEq</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Take apart an equality.  NO constant Trueprop*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.equality_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eta_contract_atom</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Reject the equality if u occurs in (or equals!) t*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>substOccur</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*IF the goal is an equality with a substitutable variable
  THEN orient that equality ELSE raise exception DEST_EQ*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>orientGoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>        </span><span class="comment1"><span>(*eliminates t*)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>        </span><span class="comment1"><span>(*eliminates u*)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>        </span><span class="comment1"><span>(*eliminates t*)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Free</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>        </span><span class="comment1"><span>(*eliminates u*)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>             </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Substitute through the branch if an equality goal (else raise DEST_EQ).
  Moves affected literals back into the branch, but it is not clear where
  they should go: this could make proofs fail.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equalSubst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>orientGoal</span></span><span class="main"><span>(</span></span><span class="entity"><span>dest_eq</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_atomic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst2</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*substitute throughout list; extract affected formulae*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subForm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nG</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>G</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nG</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>nG</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="comment1"><span>(*substitute throughout "stack frame"; extract affected formulae*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subFrame</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span class="entity"><span>Hs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>subForm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Gs</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>subForm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Hs</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>changed''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Gs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>frames</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="comment1"><span>(*substitute throughout literals; extract affected ones*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subLit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nlits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nlit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>lit</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nlit</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nlit</span></span><span>::</span><span class="entity"><span>nlits</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>nlit</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nlits</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>subLit</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pairs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>subFrame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Substituting "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>traceTerm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>^</span><span>
                              </span><span class="inner_quoted"><span>" for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>traceTerm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" in branch"</span></span><span> </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>changed'</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs'</span></span><span class="main"><span>,</span></span><span>   </span><span class="comment1"><span>(*affected formulas, and others*)</span></span><span>
       lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits'</span></span><span class="main"><span>,</span></span><span>                   </span><span class="comment1"><span>(*unaffected literals*)</span></span><span>
       vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
       lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PROVE</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Trying eq_contr_tac first INCREASES the effort, slowing reconstruction*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.notE</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>eq_assume_tac</span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Try to unify complementary literals and return the corresponding tactic. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryClose</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eContr_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Data.notE</span></span><span> </span><span class="entity"><span>contr_tac</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eAssume_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TRACE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>asm_rl</span><span> </span><span class="main"><span>(</span></span><span>eq_assume_tac</span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unify</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>eAssume_tac</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eAssume_tac</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isNot</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eContr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isNot</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eContr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Were there Skolem terms in the premise?  Must NOT chase Vars*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="entity"><span>body</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="main"><span>_</span></span><span>              </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Attach the right "may duplicate" flag to new formulae: if they contain
  Skolem terms then allow duplication.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>joinMd</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>joinMd</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span>::</span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hasSkolem</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>joinMd</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** Backtracking and Pruning **)</span></span><span>

</span><span class="comment1"><span>(*clashVar vars (n,trail) determines whether any of the last n elements
  of "trail" occur in "vars" OR in their instantiations*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clashVar</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clashVar</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clash</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clash</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clash</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span>::</span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varOccur</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>clash</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>clash</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*nbrs = # of branches just prior to closing this one.  Delete choice points
  for goals proved by the latest inference, provided NO variables in the
  next branch have been updated.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prune</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nxtVars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>choices</span></span><span>  </span><span class="comment1"><span>(*DON'T prune at very end: allow
                                             backtracking over bad proofs*)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prune</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nbrs</span></span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nxtVars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>traceIt</span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ll</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>last</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>lc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>choices</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ll</span></span><span>&lt;</span><span class="entity"><span>lc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Pruning "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span class="main"><span>(</span></span><span class="entity"><span>lc</span></span><span>-</span><span class="entity"><span>ll</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" levels"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                     </span><span class="entity"><span>last</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>last</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pruneAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>last</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>last</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pruneAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>last</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl'</span></span><span class="main"><span>,</span></span><span class="entity"><span>nbrs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>exn</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nbrs'</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>nbrs</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>last</span></span><span>  </span><span class="comment1"><span>(*don't backtrack beyond first solution of goal*)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nbrs'</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>nbrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>pruneAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>last</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(* nbrs'=nbrs *)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>clashVar</span></span><span> </span><span class="entity"><span>nxtVars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl</span></span><span>-</span><span class="entity"><span>ntrl'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trl</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>last</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*no clashes: can go back at least this far!*)</span></span><span>
                          </span><span class="entity"><span>pruneAux</span></span><span class="main"><span>(</span></span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrl'</span></span><span class="main"><span>,</span></span><span> </span><span>List.drop</span><span class="main"><span>(</span></span><span class="entity"><span>trl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrl</span></span><span>-</span><span class="entity"><span>ntrl'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                   </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>traceIt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pruneAux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nextVars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>vars</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nextVars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>                              </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>choices</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nbrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exn</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Backtracking; now there are "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>nbrs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" branches"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>exn</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PROVE</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Add the literal G, handling *Goal* and detecting duplicates.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addLit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(*New literal is a *Goal*, so change all other Goals to Nots*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G'</span></span><span class="main"><span>)</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>G'</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="main"><span>_</span></span><span>                   </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"*Goal*"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>aconv</span></span><span> </span><span class="entity"><span>G'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="entity"><span>lits</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>G'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="entity"><span>lits</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="entity"><span>lits</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"*Goal*"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>$</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>change</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>addLit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ins_term</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*For calculating the "penalty" to assess on a branching factor of n
  log2 seems a little too severe*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>log</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span>&lt;</span><span class="inner_numeral"><span>4</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>log</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>4</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*match(t,u) says whether the term u might be an instance of the pattern t
  Used to detect "recursive" rules such as transitivity*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>tas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>tbs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"*Goal*"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.not_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"*Goal*"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>matchs</span></span><span> </span><span class="entity"><span>tas</span></span><span> </span><span class="entity"><span>tbs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>        </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>=</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>=</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>(</span></span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="entity"><span>$</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>           </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="entity"><span>$</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>           </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>t</span></span><span>               </span><span class="entity"><span>u</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>matchs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>matchs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>matchs</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>printStats</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ntried</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nclosed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Timing.message</span><span> </span><span class="main"><span>(</span></span><span>Timing.result</span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" for search.  Closed: "</span></span><span>
             </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>nclosed</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
             </span><span class="inner_quoted"><span>" tried: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>ntried</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
             </span><span class="inner_quoted"><span>" tactics: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Tableau prover based on leanTaP.  Argument is a list of branches.  Each
  branch contains a list of unexpanded formulae, a list of literals, and a
  bound on unsafe expansions.
 "start" is CPU time at start, for printing search time
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cont</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nclosed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ntried</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="entity"><span>Classical.rep_cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Classical.claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safeList</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsafeList</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>printStats</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                 </span><span class="entity"><span>cont</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>   </span><span class="comment1"><span>(*all branches closed!*)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>brs0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="comment1"><span>(*apply a safe rule only (possibly allowing instantiation);
               defer any unsafe formulae*)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PRV</span></span><span> </span><span class="comment1"><span>(*backtrack to precisely this recursion!*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ntrl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nbrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>brs0</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nxtVars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nextVars</span></span><span> </span><span class="entity"><span>brs</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>G</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>netMkRules</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>safeList</span></span><span>
              </span><span class="comment1"><span>(*Make a new branch, decrementing "lim" if instantiations occur*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>newBr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lim'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>joinMd</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                                      </span><span class="entity"><span>negOfGoals</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                             lits  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
                             vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span>
                             lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim'</span></span><span class="main"><span>}</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>joinMd</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                             lits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
                             vars </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span>
                             lim  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim'</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>prems</span></span><span> </span><span>@</span><span>
                  </span><span class="entity"><span>brs</span></span><span>
              </span><span class="comment1"><span>(*Seek a matching rule.  If unifiable then add new premises
                to branch.*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>grls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unify</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>  </span><span class="comment1"><span>(*P comes from the rule; G comes from the branch.*)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updated</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ntrl</span></span><span> </span><span>&lt;</span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span> </span><span class="comment1"><span>(*branch updated*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lim'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>updated</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span>+</span><span class="entity"><span>log</span></span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lim</span></span><span>   </span><span class="comment1"><span>(*discourage branching updates*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars_in_vars</span></span><span> </span><span class="entity"><span>vars</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>prems</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>choices'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nbrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PRV</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>choices</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span class="main"><span>(</span></span><span class="entity"><span>updated</span></span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>::</span><span> </span><span class="entity"><span>tacs</span></span><span>  </span><span class="comment1"><span>(*no duplication; rotate*)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                         </span><span class="entity"><span>traceNew</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>traceVars</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="comment1"><span>(*closed the branch: prune!*)</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>nclosed</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>nclosed</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
                             </span><span class="entity"><span>prv</span></span><span class="main"><span>(</span></span><span class="entity"><span>tacs'</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>prune</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nbrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nxtVars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*prems non-null*)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lim'</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="comment1"><span>(*faster to kill ALL the alternatives*)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Excessive branching: KILLED"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>ntried</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>ntried</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
                             </span><span class="entity"><span>prv</span></span><span class="main"><span>(</span></span><span class="entity"><span>tacs'</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices'</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>newBr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lim'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PRV</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>updated</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                                </span><span class="comment1"><span>(*Backtrack at this level.
                                  Reset Vars and try another rule*)</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>grls</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*backtrack to previous level*)</span></span><span>
                                </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>grls</span></span><span>
              </span><span class="comment1"><span>(*Try to close branch by unifying with head goal*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>closeF</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>closeF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span>::</span><span class="entity"><span>Ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tryClose</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                        </span><span>NONE</span><span>     </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>closeF</span></span><span> </span><span class="entity"><span>Ls</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>choices'</span></span><span> </span><span class="main"><span>=</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"branch closed"</span></span><span class="main"><span>;</span></span><span>
                                                     </span><span class="entity"><span>traceVars</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>)</span></span><span>
                                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                     </span><span class="entity"><span>prune</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nbrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nxtVars</span></span><span class="main"><span>,</span></span><span>
                                            </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nbrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PRV</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>nclosed</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>nclosed</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span>::</span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PRV</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                    </span><span class="comment1"><span>(*reset Vars and try another literal
                                      [this handler is pruned if possible!]*)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>closeF</span></span><span> </span><span class="entity"><span>Ls</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="comment1"><span>(*Try to unify a queued formula (safe or unsafe) with head goal*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>closeFl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>closeFl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="entity"><span>closeF</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>br</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>closeF</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>closeFl</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="entity"><span>trace_prover</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>brs0</span></span><span class="main"><span>;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lim</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Limit reached."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>equalSubst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
                         lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                    </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>DEST_EQ</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>   </span><span class="entity"><span>closeF</span></span><span> </span><span class="entity"><span>lits</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>   </span><span class="entity"><span>closeFl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CLOSEF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>rules</span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>netMkRules</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>unsafeList</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*there are no plausible unsafe rules*)</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"moving formula to literals"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                              </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                                   </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
                                    lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>addLit</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                    vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                                    lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span>  </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*G admits some unsafe rules: try later*)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"moving formula to unsafe list"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                            </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>negOfGoal_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tacs</span></span><span>
                                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>br</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe</span></span><span>@</span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
                                  lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
                                  vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                                  lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span>  </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="comment1"><span>(*no more "safe" formulae: transfer unsafe down a level*)</span></span><span>
           </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>,</span></span><span class="entity"><span>unsafe</span></span><span>@</span><span class="entity"><span>unsafe'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span>
                 lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
                 vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                 lim    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>brs0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>Hs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="comment1"><span>(*no safe steps possible at any level: apply a unsafe rule*)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PRV</span></span><span> </span><span class="comment1"><span>(*backtrack to precisely this recursion!*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>H</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ntrl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>netMkRules</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>unsafeList</span></span><span>
              </span><span class="comment1"><span>(*new premises of unsafe rules may NOT be duplicated*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>newPrem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>dup</span></span><span class="main"><span>,</span></span><span class="entity"><span>lim'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Gs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Q</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>Hs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dup</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Hs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>md</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Hs</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>lits'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="entity"><span>isGoal</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>negOfGoal</span></span><span> </span><span class="entity"><span>lits</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lits</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Gs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                               </span><span class="comment1"><span>(*Recursive in this premise.  Don't make new
                                 "stack frame".  New unsafe premises will end up
                                 at the BACK of the queue, preventing
                                 exclusion of others*)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Gs'</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>Hs'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                       lits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits'</span></span><span class="main"><span>,</span></span><span>
                       vars </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                       lim  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim'</span></span><span class="main"><span>}</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>newBr</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newPrem</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>  </span><span>@</span><span>  </span><span class="entity"><span>brs</span></span><span>
              </span><span class="comment1"><span>(*Seek a matching rule.  If unifiable then add new premises
                to branch.*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>grls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unify</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_vars</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updated</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ntrl</span></span><span> </span><span>&lt;</span><span> </span><span>!</span><span class="entity"><span>ntrail</span></span><span> </span><span class="comment1"><span>(*branch updated*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars_in_vars</span></span><span> </span><span class="entity"><span>vars</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>prems</span></span><span>
                            </span><span class="comment1"><span>(*duplicate H if md permits*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>md</span></span><span> </span><span class="comment1"><span>(*earlier had "andalso vars' &lt;&gt; vars":
                                  duplicate only if the subgoal has new vars*)</span></span><span>
                             </span><span class="comment1"><span>(*any instances of P in the subgoals?
                               NB: boolean "recur" affects tracing only!*)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>recur</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lim'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*Decrement "lim" extra if updates occur*)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>updated</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span>+</span><span class="entity"><span>log</span></span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lim</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span>
                                 </span><span class="comment1"><span>(*It is tempting to leave "lim" UNCHANGED if
                                   both dup and recur are false.  Proofs are
                                   found at shallower depths, but looping
                                   occurs too often...*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mayUndo</span></span><span> </span><span class="main"><span>=</span></span><span>
                             </span><span class="comment1"><span>(*Allowing backtracking from a rule application
                               if other matching rules exist, if the rule
                               updated variables, or if the rule did not
                               introduce new variables.  This latter condition
                               means it is not a standard "gamma-rule" but
                               some other form of unsafe rule.  Aim is to
                               emulate Fast_tac, which allows all unsafe steps
                               to be undone.*)</span></span><span>
                             </span><span>not</span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>grls</span></span><span class="main"><span>)</span></span><span>   </span><span class="comment1"><span>(*other rules to try?*)</span></span><span>
                             </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>updated</span></span><span>
                             </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>=</span></span><span class="entity"><span>vars'</span></span><span>   </span><span class="comment1"><span>(*no new Vars?*)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>(</span></span><span class="entity"><span>updated</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
                       </span><span class="comment1"><span>(*if recur then perhaps shouldn't call rotate_tac: new
                         formulae should be last, but that's WRONG if the new
                         formulae are Goals, since they remain in the first
                         position*)</span></span><span>

                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lim'</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="comment1"><span>(*it's faster to kill ALL the alternatives*)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Excessive branching: KILLED"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                            </span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="entity"><span>traceNew</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>dup</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" (duplicating)"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>recur</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" (recursive)"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="entity"><span>traceVars</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nclosed</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>nclosed</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ntried</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>ntried</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
                         </span><span class="entity"><span>prv</span></span><span class="main"><span>(</span></span><span class="entity"><span>tac'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>ntrl</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>brs0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PRV</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="entity"><span>newBr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PRV</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mayUndo</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="comment1"><span>(*reset Vars and try another rule*)</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="entity"><span>clearTo</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ntrl</span></span><span class="main"><span>;</span></span><span>  </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>grls</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*backtrack to previous level*)</span></span><span>
                                   </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>grls</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="entity"><span>trace_prover</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>brs0</span></span><span class="main"><span>;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lim</span></span><span>&lt;</span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Limit reached."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>deeper</span></span><span> </span><span class="entity"><span>rules</span></span><span>
             </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NEWBRANCHES</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="comment1"><span>(*cannot close branch: move H to literals*)</span></span><span>
                 </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>brs0</span></span><span>::</span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Hs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                       lits  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>H</span></span><span>::</span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span>
                       vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                       lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span>  </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>prv</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>ntrail</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PROVE</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Construct an initial branch.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>initBranch</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>pairs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     lits  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     vars  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_terms_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     lim   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Conversion &amp; Skolemization of the Isabelle proof state ***)</span></span><span>

</span><span class="comment1"><span>(*Make a list of all the parameters in a subgoal, even if nested*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Term</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>discard_foralls</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discard_foralls</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>discard_foralls</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*List of variables not appearing as arguments to the given parameter*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>getVars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>                  </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>getVars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>alist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>getVars</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>getVars</span></span><span> </span><span class="entity"><span>alist</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>TRANS</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Translation of a subgoal: Skolemize all parameters*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fromSubgoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alistVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>alistTVar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hdvar</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ht</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_comb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span>Term.Bound</span><span> </span><span class="entity"><span>i</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="entity"><span>lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TRANS</span></span><span>
                      </span><span class="inner_quoted"><span>"Function unknown's argument not a parameter"</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>i</span></span><span>-</span><span class="entity"><span>lev</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>ts</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TRANS</span></span><span>
                      </span><span class="inner_quoted"><span>"Function unknown's argument not a bound variable"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ht</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Term.Const</span><span> </span><span class="entity"><span>aT</span></span><span>    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fromConst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>alistTVar</span></span><span> </span><span class="entity"><span>aT</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Term.Free</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Term.Bound</span><span> </span><span class="entity"><span>i</span></span><span>     </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bound</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Term.Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ix</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alistVar</span></span><span> </span><span>:=</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                          </span><span>::</span><span> </span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hdvar</span></span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>=</span></span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Var</span></span><span> </span><span class="entity"><span>v</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TRANS</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Discrepancy among occurrences of "</span></span><span>
                                 </span><span>^</span><span> </span><span>Term.string_of_vname</span><span> </span><span class="entity"><span>ix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Term.Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Abs</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TRANS</span></span><span> </span><span class="inner_quoted"><span>"argument not in normal form"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>npars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_params</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(*Skolemize a subgoal from a proof state*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skoSubgoal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="entity"><span>npars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>skoSubgoal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>subst_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gensym</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="inner_quoted"><span>"T"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>getVars</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>alistVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>skoSubgoal</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>from</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>discard_foralls</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Tableau engine and proof reconstruction operating on subgoal 1.
 "start" is CPU time at start, for printing SEARCH time (also prints reconstruction time)
 "lim" is depth limit.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_blast</span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initialize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skoprem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fromSubgoal</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyps</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_prems</span></span><span> </span><span class="entity"><span>skoprem</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp_concl</span></span><span> </span><span class="entity"><span>skoprem</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cont</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tacs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.start</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span class="main"><span>(</span></span><span>EVERY'</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>tacs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"PROOF FAILED for depth "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                       </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cell</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Timing.message</span><span> </span><span class="main"><span>(</span></span><span>Timing.result</span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" for reconstruction"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                       </span><span>Seq.make</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cell</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"PROOF RAISED EXN TERM for depth "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                       </span><span class="entity"><span>backtrack</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>choices</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>initBranch</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkGoal</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cont</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PROVE</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TRANS</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_tracing</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Blast: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SELECT_GOAL</span><span>
    </span><span class="main"><span>(</span></span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>raw_blast</span></span><span> </span><span class="main"><span>(</span></span><span>Timing.start</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>blast_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.start</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>depth_limit</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>SELECT_GOAL</span><span>
     </span><span class="main"><span>(</span></span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span>DEEPEN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>raw_blast</span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** For debugging: these apply the prover to a subgoal and return
     the resulting tactics, trace, etc.                            ***)</span></span><span>

</span><span class="comment1"><span>(*Read a string to make an initial, singleton branch*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readGoal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.read_prop</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>fromTerm</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>rand</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mkGoal</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryIt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lim</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>State</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fullTrace</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initialize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>timeap</span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span>Timing.start</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>initBranch</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>readGoal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span>fullTrace </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>fullTrace</span></span><span class="main"><span>,</span></span><span> result </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** method setup **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.blast|method"><span>blast</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span>Parse.nat</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>Classical.cla_modifiers</span></span><span> </span><span>&gt;&gt;</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>blast_tac</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>lim</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lim</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"classical tableau prover"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>