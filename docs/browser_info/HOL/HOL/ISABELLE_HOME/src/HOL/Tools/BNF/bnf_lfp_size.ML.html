<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_lfp_size.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_lfp_size.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_lfp_size.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2014

Generation of size functions for datatypes.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_LFP_SIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_size</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_size_global</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> size_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> size_of_global</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_LFP_Size</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_LFP_SIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Def</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Def_Sugar</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"size_"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sizeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"size"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_genN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"size_gen"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_mapN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"size_gen_o_map"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_neqN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"size_neq"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_plus_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.plus_class.plus|const"><span>Groups.plus</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
  </span><span class="entity"><span>HOLogic.natT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.natT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.natT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.natT</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_abs_zero_nat</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>HOLogic.zero</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_unabs_def_unused_0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>funpow</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Fixpoint_Base.html#BNF_Fixpoint_Base.fun_cong_unused_0|fact"><span>fun_cong_unused_0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_size_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>size_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.arity_number</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Name.invent</span><span> </span><span>Name.context</span><span> </span><span>Name.aT</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Thm.global_cterm_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_const</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Constant "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>size_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" registered as size function for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span>^</span><span>
      </span><span class="inner_quoted"><span>" must have type\n"</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>size_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_size</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>size_name</span></span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span> </span><span class="entity"><span>size_simps</span></span><span> </span><span class="entity"><span>size_gen_o_maps</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_size_type</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>size_name</span></span><span class="main"><span>;</span></span><span>
   </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overloaded_size_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_maps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_size_global</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>size_name</span></span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span> </span><span class="entity"><span>size_simps</span></span><span> </span><span class="entity"><span>size_gen_o_maps</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_size_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>size_name</span></span><span class="main"><span>;</span></span><span>
   </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overloaded_size_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_maps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_of_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_overloaded_size_defs_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overloaded_size_def</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.inj_on_id|fact"><span>inj_on_id</span></a><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.snd_comp_apfst|fact"><span>snd_comp_apfst</span></a><span class="main"><span>[</span></span><span class="operator"><span>simplified</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.apfst_def|fact"><span>apfst_def</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_gen_o_map_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>size_def</span></span><span> </span><span class="entity"><span>rec_o_map</span></span><span> </span><span class="entity"><span>inj_maps</span></span><span> </span><span class="entity"><span>size_maps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>size_def</span></span><span class="main"><span>]</span></span><span> </span><span>THEN</span><span>
  </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_o_map</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
    </span><span class="entity"><span>asm_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss_only</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_maps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>size_maps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>size_gen_o_map_simps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span>IF_UNSOLVED</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_def|fact"><span>id_def</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.o_def|fact"><span>o_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_neq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="entity"><span>exhaust</span></span><span> </span><span class="entity"><span>sizes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Nat.html#Nat.neq0_conv|fact"><span>neq0_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sizes</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_DETERM</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Nat.html#Nat.zero_less_Suc|fact"><span>zero_less_Suc</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span>
    </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Nat.html#Nat.trans_less_add2|fact"><span>trans_less_add2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_datatype_size</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>T </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> BT </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> fp </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span class="main"><span>,</span></span><span>
        fp_res </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>bnfs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_bnfs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
        fp_co_induct_sugar </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>fp_sugars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>B_ify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>co_rec </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>co_rec_thms </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>rec_T1</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>recs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binder_fun_types</span></span><span> </span><span class="entity"><span>rec_T1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>rec_Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>HOLogic.natT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substCnatT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.subst_atomic_types</span><span> </span><span class="entity"><span>Cs_rho</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_TsB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>variant_names</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>pre</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_names</span></span><span> </span><span class="entity"><span>num_As</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_names</span></span><span> </span><span class="entity"><span>f_Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_names</span></span><span> </span><span class="entity"><span>f_TsB</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As_fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_bs</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>base</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="entity"><span>base</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>size_N</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
          </span><span>Long_Name.base_name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_names</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_prod_C</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>T'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_prod_C</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As_fs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_abs_zero_nat</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_size_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_prod_C</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>snd_const</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_maps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_mapss'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>mk_size_of_typ</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>mk_to_natT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_gen_o_maps</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>size_gen_o_mapss'</span></span><span class="main"><span>)</span></span><span>
                </span><span>#&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_abs_zero_nat</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_abs_zero_nat</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_of_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>mk_size_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>substCnatT</span></span><span> </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_recursive_or_plain_case</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>

      </span><span class="comment1"><span>(* We want the size function to enjoy the following properties:

          1. The size of a list should coincide with its length.
          2. All the nonrecursive constructors of a type should have the same size.
          3. Each constructor through which nested recursion takes place should count as at least
             one in the generic size function.
          4. The "size" function should be definable as "size_t (%_. 0) ... (%_. 0)", where "size_t"
             is the generic function.

         This explains the somewhat convoluted logic ahead. *)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_case</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_recursive_or_plain_case</span></span><span> </span><span>o</span><span> </span><span>binder_types</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_arg_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.zero</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.Suc_zero</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_arg</span></span><span> </span><span class="entity"><span>rec_arg_T</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>rec_arg_T</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>x_Ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_names</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x_names</span></span><span> </span><span class="entity"><span>x_Ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>summands</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_mapss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>fold_map</span><span> </span><span class="entity"><span>mk_size_of_arg</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span>|&gt;&gt;</span><span> </span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.zero</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>summands</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>base_case</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>mk_plus_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>summands</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.Suc_zero</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>append</span><span> </span><span class="entity"><span>size_gen_o_mapss</span></span><span>
          </span><span>#&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>substCnatT</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_rhs</span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold_map</span><span> </span><span class="entity"><span>mk_size_arg</span></span><span> </span><span class="entity"><span>rec_arg_Ts</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substCnatT</span></span><span> </span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maybe_conceal_def_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.def_binding</span><span>
        </span><span>#&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="entity"><span>bnf_internals</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>Binding.concealed</span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_rhss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nested_size_gen_o_mapss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>mk_size_rhs</span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>size_rhss</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_size_gen_o_maps_complete</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>null</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_size_gen_o_mapss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_size_gen_o_maps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span>Thm.eq_thm_prop</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_size_gen_o_mapss</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_size_consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_size_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lthy1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1_old</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy0</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Local_Theory.define</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>maybe_conceal_def_binding</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>#&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>size_bs</span></span><span> </span><span class="entity"><span>size_rhss</span></span><span>
        </span><span>||&gt;</span><span> </span><span>`</span><span>Local_Theory.end_nested</span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export_morphism</span><span> </span><span class="entity"><span>lthy1_old</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_size_defs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_consts0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_size_consts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>retype_const_or_free</span></span><span> </span><span class="entity"><span>size_Ts</span></span><span> </span><span class="entity"><span>size_consts0</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_constsB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.map_types</span><span> </span><span class="entity"><span>B_ify</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_consts</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zeros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_abs_zero_nat</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_rhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zeros</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_consts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>overloaded_size_rhss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.size_class.size|const"><span>size</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>overloaded_size_Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_def_bs</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_conceal_def_binding</span></span><span> </span><span>o</span><span> </span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_overloaded"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_bs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_overloaded_size</span></span><span> </span><span class="entity"><span>def_b</span></span><span> </span><span class="entity"><span>lhs0</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>lhs0</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Local_Theory.define</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>thy_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overloaded_size_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory_result</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Class.instantiation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_names</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>dest_TFree</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.class_size</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span>#&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>define_overloaded_size</span></span><span> </span><span class="entity"><span>overloaded_size_def_bs</span></span><span> </span><span class="entity"><span>overloaded_size_consts</span></span><span>
             </span><span class="entity"><span>overloaded_size_rhss</span></span><span>
           </span><span>##&gt;</span><span> </span><span class="entity"><span>Class.prove_instantiation_instance</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Class.intro_classes_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span>##&gt;</span><span> </span><span>Local_Theory.exit_global</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_defs'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_unabs_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_As</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_defs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_defs_unused_0</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_unabs_def_unused_0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_As</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_defs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_defs'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_unabs_def</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>overloaded_size_defs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_size_maps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pointful</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_size_gen_o_maps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>nested_size_gen_o_maps</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_inj_maps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Basic_BNFs.html#Basic_BNFs.Product_Type.prod.inj_map|fact"><span>prod.inj_map</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="entity"><span>inj_map_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_bnfs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span>Thm.eq_thm_prop</span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_size_simp</span></span><span> </span><span class="entity"><span>size_def'</span></span><span> </span><span class="entity"><span>simp0</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>size_def'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.asm_full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss_only</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Fixpoint_Base.html#BNF_Fixpoint_Base.inj_on_convol_ident|fact"><span>inj_on_convol_ident</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_def|fact"><span>id_def</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.o_def|fact"><span>o_def</span></a><span>
          </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.snd_conv|fact"><span>snd_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span> </span><span class="entity"><span>all_inj_maps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>nested_size_maps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="entity"><span>size_defs_unused_0</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_overloaded_size_simp</span></span><span> </span><span class="entity"><span>overloaded_size_def'</span></span><span> </span><span class="entity"><span>simp0</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>overloaded_size_def'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.monoid_add_class.add_0_left|fact"><span>add_0_left</span></a><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.monoid_add_class.add_0_right|fact"><span>add_0_right</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overloaded_size_defs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>all_overloaded_size_defs_of</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_simpss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span class="entity"><span>derive_size_simp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_defs'</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>size_simpss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_simpss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span class="entity"><span>derive_overloaded_size_simp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>overloaded_size_defs'</span></span><span> </span><span class="entity"><span>size_simpss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded_size_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>overloaded_size_simpss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>append</span><span> </span><span class="entity"><span>size_simpss</span></span><span> </span><span class="entity"><span>overloaded_size_simpss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>size_simpss</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rhs_is_zero</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trueprop</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>trueprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
          </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.zero</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_neq_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size_thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>rhs_is_zero</span></span><span> </span><span class="entity"><span>size_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_LFP_Util.mk_not_eq</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.zero</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>mk_size_neq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>exhaust </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr_sugar </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fp_ctr_sugar </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_thms</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>single</span><span>
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="entity"><span>overloaded_size_consts</span></span><span> </span><span class="entity"><span>overloaded_size_simpss</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ABs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_names</span></span><span> </span><span class="entity"><span>num_As</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ABs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>liveness</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ABs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live_gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.find</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>liveness</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>live_gs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maps0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>map_of_bnf</span></span><span> </span><span class="entity"><span>fp_bnfs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>replicate</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gmaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>map0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>map0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>live_gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maps0</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_conds</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>Logic.dest_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_size_gen_o_maps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_inj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>live_gs</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsizes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size_constB</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_constB</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsB</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_constsB</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_lhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fsizes</span></span><span> </span><span class="entity"><span>gmaps</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fgs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fB</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>fB</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fB</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fsB</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_rhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fgs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_consts</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_goals</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fsB</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span>
                </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="entity"><span>size_gen_o_map_conds</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>oo</span><span>
                </span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_gen_o_map_lhss</span></span><span> </span><span class="entity"><span>size_gen_o_map_rhss</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_o_maps</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>co_rec_o_maps </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_gen_o_map_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nested_size_gen_o_maps_complete</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size_def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rec_o_map</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>mk_size_gen_o_map_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>size_def</span></span><span> </span><span class="entity"><span>rec_o_map</span></span><span> </span><span class="entity"><span>all_inj_maps</span></span><span> </span><span class="entity"><span>nested_size_maps</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                    </span><span>|&gt;</span><span> </span><span>single</span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>size_gen_o_map_goals</span></span><span> </span><span class="entity"><span>size_defs</span></span><span> </span><span class="entity"><span>rec_o_maps</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>replicate</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>size_gen_o_map_thmss</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>massage_multi_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>T_names</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>sizeN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>size_genN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>size_gen_o_mapN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_gen_o_map_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>size_neqN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_neq_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>massage_multi_notes</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>noted</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>lthy2</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span> </span><span class="entity"><span>size_consts</span></span><span> </span><span class="entity"><span>size_simps</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span>
            </span><span class="entity"><span>overloaded_size_consts</span></span><span> </span><span class="entity"><span>overloaded_size_simps</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>size_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(*Ideally, this would be issued only if the "code" plugin is enabled.*)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substitute_noted_thm</span></span><span> </span><span class="entity"><span>noted</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>lthy3</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morph</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi0</span></span><span> </span><span>$&gt;</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                 </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morph</span></span><span> </span><span class="entity"><span>overloaded_size_def</span></span><span class="main"><span>,</span></span><span>
                   </span><span>map</span><span> </span><span class="entity"><span>morph</span></span><span> </span><span class="entity"><span>overloaded_size_simps</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>morph</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>size_gen_o_map_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
           </span><span class="entity"><span>T_names</span></span><span> </span><span class="entity"><span>size_consts</span></span><span> </span><span class="entity"><span>overloaded_size_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>generate_datatype_size</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin_Name.declare_setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>size</span><span>›</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars_interpretation</span></span><span> </span><span class="entity"><span>size_plugin</span></span><span> </span><span class="entity"><span>generate_datatype_size</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>