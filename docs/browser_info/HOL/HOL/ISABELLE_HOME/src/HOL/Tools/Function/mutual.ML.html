<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Function/mutual.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Function/mutual.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Function/mutual.ML
    Author:     Alexander Krauss, TU Muenchen

Mutual recursive function definitions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>FUNCTION_MUTUAL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_function_mutual </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Function_Common.function_config</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="comment1"><span>(* defname *)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="comment1"><span>(* goalstate *)</span></span><span>
        * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Function_Common.function_result</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* proof continuation *)</span></span><span>
       </span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Function_Mutual</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>FUNCTION_MUTUAL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Lib</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Common</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>qgar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mutual_part</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MutualPart</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>i </span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  i' </span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  fname </span><span class="main"><span>:</span></span><span> binding</span><span class="main"><span>,</span></span><span>
  fT </span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  cargTs</span><span class="main"><span>:</span></span><span> typ list</span><span class="main"><span>,</span></span><span>
  f_def</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>

  f</span><span class="main"><span>:</span></span><span> term option</span><span class="main"><span>,</span></span><span>
  f_defthm </span><span class="main"><span>:</span></span><span> thm option</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mutual_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mutual</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>n </span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  n' </span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  fsum_name </span><span class="main"><span>:</span></span><span> binding</span><span class="main"><span>,</span></span><span>
  fsum_type</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>

  ST</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  RST</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>

  parts</span><span class="main"><span>:</span></span><span> mutual_part list</span><span class="main"><span>,</span></span><span>
  fqgars</span><span class="main"><span>:</span></span><span> qgar list</span><span class="main"><span>,</span></span><span>
  qglrs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list * term list * term * term</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>

  fsum </span><span class="main"><span>:</span></span><span> term option</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mutual_induct_Pnames</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>5</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"Q"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"R"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"S"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_part</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the</span><span> </span><span>o</span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* FIXME *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prod_abs</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>HOLogic.pair_const</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_eqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fqgars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arity_of</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fqgars</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>curried_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>caTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uaTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>caTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uaTs</span></span><span> </span><span>---&gt;</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>caTss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>resultTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>curried_types</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>caTss</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dresultTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>resultTs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>dresultTs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RST</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Balanced_Tree.make</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>Sum_Tree.mk_sumT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dresultTs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Balanced_Tree.make</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>Sum_Tree.mk_sumT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argTs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsum_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>derived_name_suffix</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="inner_quoted"><span>"_sum"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>fsum_var_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_binding</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fsum_name</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsum_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>RST</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsum_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsum_var_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>caTs</span></span><span> </span><span class="entity"><span>resultT</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>caTs</span></span><span> </span><span class="comment1"><span>(* FIXME: Bind xs properly *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ta</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Ta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>resultT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dresultTs</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_exp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sum_Tree.mk_proj</span></span><span> </span><span class="entity"><span>RST</span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fsum_var</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>Sum_Tree.mk_inj</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fsum_var</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>lambda</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>f_exp</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rew</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>lambda</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>f_exp</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span>
          </span><span class="main"><span>{</span></span><span>i </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> i' </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> fname </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> fT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>,</span></span><span> cargTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>caTs</span></span><span class="main"><span>,</span></span><span>
            f_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> f </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> f_defthm </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rew</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rews</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>define</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>caTss</span></span><span> </span><span class="entity"><span>resultTs</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>convert_eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_part</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>parts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rews</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sum_Tree.mk_inj</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prod_abs</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span>Envir.beta_norm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sum_Tree.mk_inj</span></span><span> </span><span class="entity"><span>RST</span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qglrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>convert_eqs</span></span><span> </span><span class="entity"><span>fqgars</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span>n </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> n' </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> fsum_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fsum_name</span></span><span class="main"><span>,</span></span><span> fsum_type </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>,</span></span><span>
      ST </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>,</span></span><span> RST </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RST</span></span><span class="main"><span>,</span></span><span> parts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>,</span></span><span> fqgars </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fqgars</span></span><span class="main"><span>,</span></span><span> qglrs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>,</span></span><span> fsum </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_projections</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>mutual</span></span><span> </span><span class="entity"><span>fsum</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span>i</span><span class="main"><span>=</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> i'</span><span class="main"><span>=</span></span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.make_def_binding</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>function_internals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fname</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_defthm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Local_Theory.define</span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Term.subst_bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsum</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span>i </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> i' </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> fname </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> fT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>,</span></span><span> cargTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span>
            f_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>,</span></span><span> f </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> f_defthm </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f_defthm</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsum_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RST</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fqgars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mutual</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span>n </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> n' </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> fsum_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fsum_name</span></span><span class="main"><span>,</span></span><span> fsum_type </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>,</span></span><span> ST </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>,</span></span><span>
      RST </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RST</span></span><span class="main"><span>,</span></span><span> parts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parts'</span></span><span class="main"><span>,</span></span><span> fqgars </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fqgars</span></span><span class="main"><span>,</span></span><span> qglrs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>,</span></span><span> fsum </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fsum</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>in_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pre_qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pre_gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pre_rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oqnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pre_qs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="entity"><span>oqnames</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pre_qs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_gs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_rhs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ags</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>import</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqs</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>ags</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>forall_intr_rename</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqnames</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>F</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>import</span></span><span> </span><span class="entity"><span>export</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>recover_mutual_psimp</span></span><span> </span><span class="entity"><span>all_orig_fdefs</span></span><span> </span><span class="entity"><span>parts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>import</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sum_psimp_eq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span>f</span><span class="main"><span>=</span></span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_part</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="entity"><span>parts</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>psimp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>import</span></span><span> </span><span class="entity"><span>sum_psimp_eq</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>restore_cond</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>cprems_of</span><span> </span><span class="entity"><span>psimp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>psimp</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cond</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>psimp</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>General.Fail</span><span> </span><span class="inner_quoted"><span>"Too many conditions"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Thm.declare_hyps</span><span> </span><span class="main"><span>(</span></span><span>Thm.chyps_of</span><span> </span><span class="entity"><span>simp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.prove</span><span> </span><span class="entity"><span>simp_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_orig_fdefs</span></span><span>
          </span><span>THEN</span><span> </span><span class="entity"><span>EqSubst.eqsubst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>simp</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span>THEN</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>restore_cond</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>export</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_applied_form</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>caTs</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>caTs</span></span><span> </span><span class="comment1"><span>(* FIXME: Bind xs properly *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.combination</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.reflexive</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mutual_induct_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="entity"><span>all_f_defs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newPs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Pname</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargTs</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mutual_induct_Pnames</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parts</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_P</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>avars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cargTs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="entity"><span>avars</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span class="entity"><span>atup</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>avars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_P</span></span><span> </span><span class="entity"><span>parts</span></span><span> </span><span class="entity"><span>newPs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_exp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sum_Tree.mk_sumcases</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="entity"><span>Ps</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_inst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>case_exp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>induct</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>Sum_Tree.sumcase_split_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>all_f_defs</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>afs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cargTs</span></span><span> </span><span class="comment1"><span>(* FIXME! *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sum_Tree.mk_inj</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="entity"><span>afs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inj</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>Sum_Tree.sumcase_split_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>afs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>newPs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>cargTs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>project</span></span><span> </span><span class="entity"><span>induct_inst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parts</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mutual_cases_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cases_rule</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> cargTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Variable.variant_frees</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sumtree_inj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sum_Tree.mk_inj</span></span><span> </span><span class="entity"><span>ST</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_subgoal_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair_inject|fact"><span>Pair_inject</span></a><span> </span><a class="entity_ref" href="../../../../../Sum_Type.html#Sum_Type.Inl_inject|fact"><span>Inl_inject</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>elim_format</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../Sum_Type.html#Sum_Type.Inr_inject|fact"><span>Inr_inject</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>elim_format</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.notE|fact"><span>HOL.notE</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../Sum_Type.html#Sum_Type.sum.distinct|fact"><span>Sum_Type.sum.distinct</span></a><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.notE|fact"><span>HOL.notE</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../Sum_Type.html#Sum_Type.sum.distinct|fact"><span>Sum_Type.sum.distinct</span></a><span class="main"><span>(</span></span><span>2</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>cases_rule</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>P</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>sumtree_inj</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="entity"><span>prep_subgoal_tac</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>P</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.solve_constraints</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_partial_rules_mutual</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>inner_cont</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>parts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fqgars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inner_cont</span></span><span> </span><span class="entity"><span>proof</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>FunctionResult</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> cases</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="entity"><span>cases_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>psimps</span></span><span class="main"><span>,</span></span><span> simple_pinducts</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="entity"><span>simple_pinduct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>termination</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domintros</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pelims</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>result</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_f_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span>f_defthm </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>,</span></span><span> f </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargTs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mk_applied_form</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>cargTs</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>parts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>split_list</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_orig_fdefs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>MutualPart</span></span><span> </span><span class="main"><span>{</span></span><span>f_defthm </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parts</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_mpsimp</span></span><span> </span><span class="entity"><span>fqgar</span></span><span> </span><span class="entity"><span>sum_psimp</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>in_context</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>fqgar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recover_mutual_psimp</span></span><span> </span><span class="entity"><span>all_orig_fdefs</span></span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sum_psimp</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rew_simpset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>all_f_defs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mpsimps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_mpsimp</span></span><span> </span><span class="entity"><span>fqgars</span></span><span> </span><span class="entity"><span>psimps</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>minducts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mutual_induct_rules</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>simple_pinduct</span></span><span> </span><span class="entity"><span>all_f_defs</span></span><span> </span><span class="entity"><span>m</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mcases</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mutual_cases_rule</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>cases_rule</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ST</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mtermination</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="entity"><span>rew_simpset</span></span><span> </span><span class="entity"><span>termination</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mdomintros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_simplify</span></span><span> </span><span class="entity"><span>rew_simpset</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>domintros</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>FunctionResult</span></span><span> </span><span class="main"><span>{</span></span><span> fs</span><span class="main"><span>=</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> G</span><span class="main"><span>=</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> R</span><span class="main"><span>=</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> dom</span><span class="main"><span>=</span></span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span>
      psimps</span><span class="main"><span>=</span></span><span class="entity"><span>mpsimps</span></span><span class="main"><span>,</span></span><span> simple_pinducts</span><span class="main"><span>=</span></span><span class="entity"><span>minducts</span></span><span class="main"><span>,</span></span><span>
      cases</span><span class="main"><span>=</span></span><span class="entity"><span>mcases</span></span><span class="main"><span>,</span></span><span> pelims</span><span class="main"><span>=</span></span><span class="entity"><span>pelims</span></span><span class="main"><span>,</span></span><span> termination</span><span class="main"><span>=</span></span><span class="entity"><span>mtermination</span></span><span class="main"><span>,</span></span><span>
      domintros</span><span class="main"><span>=</span></span><span class="entity"><span>mdomintros</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_function_mutual</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>eqss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutual</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Mutual</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fsum_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>analyze_eqs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>eqss</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fsum</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goalstate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cont</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Function_Core.prepare_function</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fsum_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fsum_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>qglrs</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mutual'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>define_projections</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>mutual</span></span><span> </span><span class="entity"><span>fsum</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cont'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_partial_rules_mutual</span></span><span> </span><span class="entity"><span>lthy''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cont</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>goalstate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cont'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>