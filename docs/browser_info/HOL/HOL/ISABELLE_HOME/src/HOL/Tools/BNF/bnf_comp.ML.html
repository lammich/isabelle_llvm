<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_comp.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_comp.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_comp.ML
    Author:     Dmitriy Traytel, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2012

Composition of bounded natural functors.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_COMP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typedef_threshold</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_typedef_threshold</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_typedef_threshold_yield</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    'a * </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ID_bnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> DEADID_bnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>comp_cache</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>map_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     set_unfoldss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     rel_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     pred_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_comp_cache</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>comp_cache</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_unfolds</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> BAD_DEAD </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bnf_of_typ</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_comp_sort</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clean_compose_bnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> kill_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lift_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> permute_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> permute_and_kill_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lift_and_permute_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> normalize_bnfs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> ''a </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> ''a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>''a </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> ''a </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>int</span><span> </span><span>list</span><span> </span><span>list</span><span> * ''a </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compose_bnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>absT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     abs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     rep</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morph_absT_info</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>absT_info</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_absT</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_abs</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_rep</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> seal_bnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>BNF_Def.bnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_Def.bnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span class="entity"><span>absT_info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_Comp</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_COMP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Def</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Comp_Tactics</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="BNF_Composition.bnf_typedef_threshold|attribute"><span>bnf_typedef_threshold</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>6</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_typedef_threshold_yield</span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span>||&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ID_bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"BNF_Composition.ID"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>DEADID_bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"BNF_Composition.DEADID"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>comp_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Typtab.table</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>T_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span>sort</span><span> </span><span>Term_Ord.typ_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_kill</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"k"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_lift</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"l"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_permute</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"p"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_compose</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"c"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>oDs</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>map</span><span> </span><span class="entity"><span>typ_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_comp</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf_Ds_As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  map_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  set_unfoldss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  rel_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  pred_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_comp_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.empty</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>map_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> set_unfoldss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> rel_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> pred_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.is_reflexive</span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span>Thm.eq_thm</span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adds_to_thms</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>news</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span>eq_set</span><span> </span><span>Thm.eq_thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_reflexive</span></span><span> </span><span class="entity"><span>news</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_to_unfolds</span></span><span> </span><span class="entity"><span>map</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>pred</span></span><span>
  </span><span class="main"><span>{</span></span><span class="entity"><span>map_unfolds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_unfoldss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_unfolds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_unfolds</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>map_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>map_unfolds</span></span><span> </span><span class="entity"><span>map</span></span><span class="main"><span>,</span></span><span>
    set_unfoldss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>adds_to_thms</span></span><span> </span><span class="entity"><span>set_unfoldss</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>,</span></span><span>
    rel_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>rel_unfolds</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span>
    pred_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>pred_unfolds</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_bnf_to_unfolds</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_to_unfolds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_def_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_defs_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_def_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_def_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bdTN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"bdT"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_killN</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_kill"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_liftN</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_lift"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_permuteN</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="inner_quoted"><span>"_permute_"</span></span><span> </span><span>^</span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_bnf_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf_def|fact"><span>id_bnf_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expand_id_bnf_def</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Envir.expand_term_defs</span><span> </span><span>dest_Const</span><span>
    </span><span class="main"><span>[</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>id_bnf_def</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>dest_Const</span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.csum|const"><span>csum</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.cprod|const"><span>cprod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.natLeq|const"><span>natLeq</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clean_compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>onwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>odeads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>inner</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ideadss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inwitss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: check olive = length inners &gt; 0,
                   forall inner from inners. ilive = live,
                   forall inner from inners. idead = dead  *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>odeads</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ideadss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ass_repl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Bss_repl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Qs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"Q"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>Ass_repl</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>CCA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>CBs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>Bss_repl</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>CAs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_setss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ilive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_bds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>Ass_repl</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%f1 ... fn. outer.map (inner_1.map f1 ... fn) ... (inner_m.map f1 ... fn)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>fs'</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>CBs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span>
        </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
          </span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%Q1 ... Qn. outer.rel (inner_1.rel Q1 ... Qn) ... (inner_m.rel Q1 ... Qn)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>Qs'</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>CBs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span>
        </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
          </span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%P1 ... Pn. outer.pred (inner_1.pred P1 ... Pn) ... (inner_m.pred P1 ... Pn)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>Ps'</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span>
        </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
          </span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Union o collect {outer.set_1 ... outer.set_m} o outer.map inner_1.set_i ... inner_m.set_i*)</span></span><span>
    </span><span class="comment1"><span>(*Union o collect {image inner_1.set_i o outer.set_1 ... image inner_m.set_i o outer.set_m}*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_set</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>setTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_collect</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="entity"><span>setTs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>setTs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_setss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>CAs</span></span><span> </span><span class="entity"><span>setTs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_inner_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inner_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>collect_image</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_collect</span></span><span>
          </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_image</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_sets</span></span><span> </span><span class="entity"><span>outer_sets</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>CCA</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Library.foldl1</span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_Union</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outer_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_inner_sets</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Union</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>collect_image</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets_alt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_split</span><span> </span><span class="entity"><span>mk_set</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_simplified_set</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_set'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf|const"><span>id_bnf</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_simplified_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_set_map_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Goal.prove</span><span> </span><span class="comment1"><span>(*no sorry*)</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>tac</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>set'_eq_set</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sets'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_split</span><span> </span><span class="entity"><span>mk_simplified_set</span></span><span> </span><span class="entity"><span>sets</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*(inner_1.bd +c ... +c inner_m.bd) *c outer.bd*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_cprod</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldr1</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>mk_csum</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_bds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_bd</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.natLeq|const"><span>natLeq</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ordIso</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso|const"><span>ordIso</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>bd_bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_mem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ordIso</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>bd'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_ordIso_natLeq_tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>bd</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_single_set_map0_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_set_map0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_set_map_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>set_map0_of_bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_single_set_map0_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>inner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_bd_regularCard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>quick_and_dirty</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>mk_comp_set_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_set_map_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>sets_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>quick_and_dirty</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>replicate</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_set_bds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_set_bdss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_bd_Cinfinites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_bd_regularCards</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_set_bd_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.comp_single_set_bd_strict|fact"><span>comp_single_set_bd_strict</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>nth</span><span> </span><span class="entity"><span>inner_bd_Cinfinites</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>inner_bd_regularCards</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>inner_set_bdss</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
              </span><span>nth</span><span> </span><span class="entity"><span>outer_set_bds</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_bd_Cinfinite</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.Cinfinite_cprod2|fact"><span>Cinfinite_cprod2</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.Cinfinite_Cnotzero|fact"><span>Cinfinite_Cnotzero</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span>nth</span><span> </span><span class="entity"><span>inner_bd_Cinfinites</span></span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>single_set_bd_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>single_set_bd_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ilive</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Gbd_Fbd_Cinfinites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>single_bd_Cinfinite</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>inners</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>set_alt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>single_set_bds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>mk_comp_set_bd_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span> </span><span class="entity"><span>set_alt</span></span><span> </span><span class="entity"><span>single_set_bds</span></span><span>
            </span><span class="entity"><span>Gbd_Fbd_Cinfinites</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span> </span><span class="entity"><span>single_set_bd_thmss</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>CCA</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_setss</span></span><span> </span><span class="entity"><span>CAs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_sets</span></span><span> </span><span class="entity"><span>CCA</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_comp_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_mono_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_rel_Grp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_Grp_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.OO_Grp_cong|fact"><span>OO_Grp_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.arg_cong2|fact"><span>arg_cong2</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span>
               </span><span class="main"><span>[</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>outer_rel_Grp</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../Relation.html#Relation.conversep|const"><span>conversep</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>rel_conversep_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outer_rel_Grp</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>OF</span><span>
                 </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rel_OO_Grp_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.Ball_Collect|fact"><span>Ball_Collect</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pred_cong0_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>OF</span><span> </span><span>map</span><span> </span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.Collect_inj|fact"><span>Collect_inj</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.Ball_Collect|fact"><span>Ball_Collect</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
        </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pred_alt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip_axioms</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span>
      </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>onwits</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>onwits</span></span><span> </span><span class="entity"><span>CAs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_witss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>inwitss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_witsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>inner_witss</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_wits</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inner_witsss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|-&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>map_product</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>iwit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>owit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>owit</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>iwit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>flat</span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>minimize_wits</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>absfree</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_comp_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_set_map_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>bnf_def</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>CCA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Morphism.thm_morphism</span><span> </span><span class="inner_quoted"><span>"BNF"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id_bnf_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>$&gt;</span><span> </span><span>Morphism.term_morphism</span><span> </span><span class="inner_quoted"><span>"BNF"</span></span><span> </span><span class="entity"><span>expand_id_bnf_def</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morph_bnf</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>bnf'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>bnf''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_bnf_to_unfolds</span></span><span> </span><span class="entity"><span>bnf''</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Killing live variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_kill_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_killN</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: check 0 &lt; n &lt;= live *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>killedAs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*lthy3*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="entity"><span>killedAs</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*names_lthy*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>killedAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>lives</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*bnf.map id ... id*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.id_const</span></span><span> </span><span class="entity"><span>killedAs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*bnf.rel (op =) ... (op =)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>killedAs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*bnf.pred (%_. True) ... (%_ True)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>killedAs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp_assoc|fact"><span>comp_assoc</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_comp|fact"><span>id_comp</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp_id|fact"><span>comp_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_kill_map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>killedAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>kill_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.ord_le_eq_trans|fact"><span>ord_le_eq_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Relation.html#Relation.eq_OO|fact"><span>eq_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_Grp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_Grp_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.OO_Grp_cong|fact"><span>OO_Grp_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.arg_cong2|fact"><span>arg_cong2</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span>
              </span><span class="main"><span>[</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_Grp</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../Relation.html#Relation.conversep|const"><span>conversep</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>rel_conversep_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_Grp</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_cong0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>OF</span><span>
                </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.trans|fact"><span>trans</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.Grp_UNIV_id|fact"><span>Grp_UNIV_id</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.refl|fact"><span>refl</span></a><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.eq_alt|fact"><span>eq_alt</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span>
                 </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.Grp_fst_snd|fact"><span>Grp_fst_snd</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip_axioms</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span>
      </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>absfree</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>bnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>killedAs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_bnf_to_unfolds</span></span><span> </span><span class="entity"><span>bnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_kill</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_kill_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Adding dummy live variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_lift_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_liftN</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: check 0 &lt; n *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>newAs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>newBs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*lthy3*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*names_lthy*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%f1 ... fn. bnf.map*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>newAs</span></span><span> </span><span class="entity"><span>newBs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%Q1 ... Qn. bnf.rel*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>newAs</span></span><span> </span><span class="entity"><span>newBs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%P1 ... Pn. bnf.pred*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>newAs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_set</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>newAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>bnf_sets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp_assoc|fact"><span>comp_assoc</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_comp|fact"><span>id_comp</span></a><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp_id|fact"><span>comp_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>(</span></span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>quick_and_dirty</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>empty_natural_tac</span></span><span> </span><span>@</span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>quick_and_dirty</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_lift_set_bd_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lift_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip_axioms</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span>
      </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>bnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span>Binding.empty</span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_bnf_to_unfolds</span></span><span> </span><span class="entity"><span>bnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_lift</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_lift_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Changing the order of live variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_permuteN</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Binding.reset_pos</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*lthy3*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*names_lthy*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%f(1) ... f(n). bnf.map fσ(1) ... fσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%Q(1) ... Q(n). bnf.rel Qσ(1) ... Qσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*%P(1) ... P(n). bnf.pred Pσ(1) ... Pσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>(</span></span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>mk_permute_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip_axioms</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="entity"><span>bd_card_order_tac</span></span><span>
      </span><span class="entity"><span>bd_cinfinite_tac</span></span><span> </span><span class="entity"><span>bd_regularCard_tac</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>bnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span>Binding.empty</span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_bnf_to_unfolds</span></span><span> </span><span class="entity"><span>bnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_permute</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Composition pipeline *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute_and_kill_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
  </span><span>#&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kill_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_and_permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lift_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
  </span><span>#&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_bnfs</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>bnfs</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>before_kill_src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>As</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_indices</span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="entity"><span>before_kill_src</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>before_kill_dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>append</span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="entity"><span>live_poss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kill_ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>length</span><span> </span><span class="entity"><span>kill_poss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inners'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute_and_kill_bnf</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>bnfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>bnfs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>kill_ns</span></span><span> </span><span class="entity"><span>before_kill_src</span></span><span> </span><span class="entity"><span>before_kill_dest</span></span><span> </span><span class="entity"><span>bnfs</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ass'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>nth</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>live_poss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>after_lift_dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>As</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_poss</span></span><span> </span><span class="entity"><span>after_lift_dest</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>after_lift_src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>append</span><span> </span><span class="entity"><span>new_poss</span></span><span> </span><span class="entity"><span>old_poss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lift_ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>As</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>kill_poss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lift_and_permute_bnf</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>bnfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>bnfs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>lift_ns</span></span><span> </span><span class="entity"><span>after_lift_src</span></span><span> </span><span class="entity"><span>after_lift_dest</span></span><span> </span><span class="entity"><span>inners'</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_comp_sort</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Library.sort</span><span> </span><span class="main"><span>(</span></span><span>Term_Ord.typ_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_bnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tfreess</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>kill_poss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inners'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>normalize_bnfs</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>oDs</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span>append</span><span> </span><span>oo</span><span> </span><span>curry</span><span> </span><span>swap</span><span> </span><span>oo</span><span> </span><span>map</span><span> </span><span>o</span><span> </span><span>nth</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>cache'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>clean_compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>tfreess</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_compose</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>bnf_Ds_As</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>cache_comp</span></span><span> </span><span class="entity"><span>key</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>raw_compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Hide the type of the bound (optimization) and unfold the definitions (nicer to the user) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>absT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   abs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   rep</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_absT_info</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>{</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>absT </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span>
   repT </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span>
   abs </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span>
   rep </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>,</span></span><span>
   abs_inject </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs_inject</span></span><span class="main"><span>,</span></span><span>
   abs_inverse </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs_inverse</span></span><span class="main"><span>,</span></span><span>
   type_definition </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_absT</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="entity"><span>repU</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repU</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_absT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_repT</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>absU</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>repT</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_repT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_repT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf|const"><span>id_bnf</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf|const"><span>id_bnf</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span class="entity"><span>getT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>getT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.subst_atomic_types</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span>range_type</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span>domain_type</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_of_line</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>threshold</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Term.size_of_typ</span><span> </span><span class="entity"><span>repT</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>out_of_line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>typedef</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>{</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Typedef.info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf|const"><span>id_bnf</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf|const"><span>id_bnf</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>type_definition_id_bnf_UNIV</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Typedef.html#Typedef.type_definition.Abs_inverse|fact"><span>type_definition.Abs_inverse</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Typedef.html#Typedef.type_definition.Abs_inject|fact"><span>type_definition.Abs_inject</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Typedef.html#Typedef.type_definition.Abs_cases|fact"><span>type_definition.Abs_cases</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>seal_bnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*names_lthy*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"R"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_bind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTA_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TA_params</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>repTA_tfrees</span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TA</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_bind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA_params</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>exI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>UNIV_I</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RepA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RepB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TB</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>repTB</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>AbsA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>AbsB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repTB</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>TB</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_inject'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span> </span><span>OF</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_inverse'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span> </span><span>OF</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>absT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>,</span></span><span> repT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>,</span></span><span> abs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AbsA</span></span><span class="main"><span>,</span></span><span> rep </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>,</span></span><span> abs_inject </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inject'</span></span><span class="main"><span>,</span></span><span>
      abs_inverse </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse'</span></span><span class="main"><span>,</span></span><span> type_definition </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AbsB</span></span><span class="main"><span>,</span></span><span>
      </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_vimage2p</span></span><span> </span><span class="entity"><span>RepA</span></span><span> </span><span class="entity"><span>RepB</span></span><span> </span><span>$</span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>Ps'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*bd may depend only on dead type variables*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_relT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>bnf_bd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bdT_bind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bdTN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bdT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bd_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bdT_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bdT_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bdT_bind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>exI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>UNIV_I</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_card_order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bdT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_bd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.ordIso_refl|fact"><span>ordIso_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_dir_image</span></span><span> </span><span class="entity"><span>bnf_bd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_bd_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bdT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_bdT_inj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Abs_inj_thm</span></span><span> </span><span class="entity"><span>Abs_bdT_inject</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_bdT_bij</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Abs_bij_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>Abs_bdT_inj</span></span><span> </span><span class="entity"><span>Abs_bdT_cases</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.dir_image|fact"><span>dir_image</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Abs_bdT_inj</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_card_order</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.card_order_dir_image|fact"><span>card_order_dir_image</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Abs_bdT_bij</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_card_order_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.Cinfinite_cong|fact"><span>Cinfinite_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct1</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.regularCard_ordIso|fact"><span>regularCard_ordIso</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Cinfinite_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>bd_regularCard_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_card_order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_map_id0|fact"><span>type_copy_map_id0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_id0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_map_comp0|fact"><span>type_copy_map_comp0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_comp0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>EVERY'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_map_cong0|fact"><span>type_copy_map_cong0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>select_prem_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>meta_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>meta_mp</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>o_apply</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>equalityD2</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>set_mp</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_map0_tac</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_set_map0|fact"><span>type_copy_set_map0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordLess_ordIso_trans|fact"><span>ordLess_ordIso_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_set_bd|fact"><span>type_copy_set_bd</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.vimage2p_relcompp_mono|fact"><span>vimage2p_relcompp_mono</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.vimage2p_cong|fact"><span>vimage2p_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SELECT_GOAL</span><span> </span><span>o</span><span> </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.vimage2p_relcompp_converse|fact"><span>vimage2p_relcompp_converse</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span>
       </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>o_apply</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_vimage2p_Grp_Rep|fact"><span>type_copy_vimage2p_Grp_Rep</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.vimage2p_relcompp_converse|fact"><span>vimage2p_relcompp_converse</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
       </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span>EVERY'</span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="bound"><span>f</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Fun.html#Fun.comp|const"><span>∘</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.Ball_comp_iff|fact"><span>Ball_comp_iff</span></a><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.conj_comp_iff|fact"><span>conj_comp_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip_axioms</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>set_map0_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bd_card_order</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>fold</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>AbsA</span></span><span> </span><span>$</span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>I</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.type_copy_wit|fact"><span>type_copy_wit</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>bnf_def</span></span><span> </span><span class="entity"><span>Hardly_Inline</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>user_policy</span></span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>all_deads</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf_map</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf_bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>bnf_rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>bnf_pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Composition.html#BNF_Composition.id_bnf_apply|fact"><span>id_bnf_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>map_unfolds </span><span class="entity"><span>unfold_set</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>set_unfoldss </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
       </span><span class="main"><span>#</span></span><span>rel_unfolds </span><span class="entity"><span>unfold_set</span></span><span> </span><span>@</span><span> </span><span class="main"><span>#</span></span><span>pred_unfolds </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bnf'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>morph_bnf_defs</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm_morphism</span><span> </span><span class="inner_quoted"><span>"BNF"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>unfolds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_def_of_bnf</span></span><span> </span><span class="entity"><span>bnf''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_defs_of_bnf</span></span><span> </span><span class="entity"><span>bnf''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_def_of_bnf</span></span><span> </span><span class="entity"><span>bnf''</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.def_binding</span><span> </span><span>o</span><span> </span><span>Binding.concealed</span><span> </span><span>o</span><span> </span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>bnf_b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf_b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>mapN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>relN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>setN</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_qualify</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_setN</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_def</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_def</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>set_defs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>def</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>noted</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TA</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>register_bnf_raw</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>morph_bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substitute_noted_thm</span></span><span> </span><span class="entity"><span>noted</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_deads</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT_info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>BAD_DEAD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bnf_of_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DEADID_bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ID_bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bnf_of_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unexpected schematic variable"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bnf_of_typ</span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_bad_dead</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Library.inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD_DEAD</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>bnf_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bnf_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>DEADID_bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lives_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds_As</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.typ_subst_TVars</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>tvars'</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds_As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>namei</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>nonzero_string_of_int</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span>o</span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>namei</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>odead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dead_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>odead</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_T_of_bnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oDs_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds</span></span><span>
              </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oDs_pos</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oDs_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inners</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span>split_list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bnf_of_typ</span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Ds0</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>compose_bnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="entity"><span>check_bad_dead</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>