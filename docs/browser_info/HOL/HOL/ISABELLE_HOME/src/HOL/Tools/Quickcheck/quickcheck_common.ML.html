<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Quickcheck/quickcheck_common.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Quickcheck/quickcheck_common.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Quickcheck/quickcheck_common.ML
    Author:     Florian Haftmann, Lukas Bulwahn, TU Muenchen

Common functions for quickcheck's generators.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>QUICKCHECK_COMMON</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compat_prefs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_LFP_Compat.preference</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> strip_imp </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reflect_bool </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> define_functions </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> perhaps_constrain</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_goals</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>option</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_predicate </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_safe_if </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> collect_results </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Quickcheck.result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Quickcheck.result</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Quickcheck.result</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>Quickcheck.report</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> *
      </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> generator_test_goal_terms </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>generator</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Quickcheck.result</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Old_Datatype_Aux.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.descr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ensure_sort </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>sort</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> *
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.descr</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span>
        * </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>instantiation</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Old_Datatype_Aux.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ensure_common_sort_datatype </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> * </span><span class="entity"><span>instantiation</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> datatype_interpretation </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>sort</span><span> * </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_mk_parametric_generator_expr </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_fun_upd </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> post_process_term </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> test_term </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Quickcheck.result</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Quickcheck_Common</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>QUICKCHECK_COMMON</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* static options *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat_prefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>BNF_LFP_Compat.Include_GFPs</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>define_foundationally</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>


</span><span class="comment1"><span>(* HOLogic's term functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_imp</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_imp</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_imp</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reflect_bool</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_undefined</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* testing functions: testing with increasing sizes (and cardinalities) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>Quickcheck.report</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_test_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvars</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfrees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span>error</span><span> </span><span class="inner_quoted"><span>"Term to be tested contains type variables"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span>error</span><span> </span><span class="inner_quoted"><span>"Term to be tested contains schematic variables"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>cpu</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.timing</span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>description</span></span><span class="main"><span>,</span></span><span> </span><span>Time.toMilliseconds</span><span> </span><span class="entity"><span>cpu</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compile</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.genuine_only</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abort_potential</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.abort_potential</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_test_term</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="entity"><span>Quickcheck.empty_result</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>try</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comp_time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="inner_quoted"><span>"quickcheck compilation"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_timing</span></span><span> </span><span class="entity"><span>comp_time</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&gt;</span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.size</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Quickcheck.verbose_message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"[Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"] Test data size: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>current_size</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>k</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>report</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"size "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>Quickcheck.verbose_message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>time</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms"</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_timing</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_report</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>report</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>with_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>abort_potential</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Quickcheck.pretty_counterex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>cex</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Quickcheck continues to find a genuine counterexample..."</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="entity"><span>with_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>k</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Conjecture is not executable with Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span>!</span><span class="entity"><span>current_result</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Testing conjecture with Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>response</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exec_time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="inner_quoted"><span>"quickcheck execution"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>with_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_response</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span> </span><span class="entity"><span>response</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_timing</span></span><span> </span><span class="entity"><span>exec_time</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>!</span><span class="entity"><span>current_result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_term_with_cardinality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_matters_for</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compile</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.genuine_only</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abort_potential</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.abort_potential</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>check_test_term</span></span><span> </span><span class="entity"><span>ts'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_free_names</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="entity"><span>Quickcheck.empty_result</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_card_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(* FIXME: why decrement size by one? *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Quickcheck.verbose_message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"[Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"] Test "</span></span><span> </span><span>^</span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"data size: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>size</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" and "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"cardinality: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timing</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"size "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>size</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" and card "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_timing</span></span><span> </span><span class="entity"><span>timing</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enumeration_card_size</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>size_matters_for</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>map_product</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.size</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>s1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>try</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comp_time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cpu_time</span></span><span> </span><span class="inner_quoted"><span>"quickcheck compilation"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.add_timing</span></span><span> </span><span class="entity"><span>comp_time</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Conjecture is not executable with Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span>!</span><span class="entity"><span>current_result</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Testing conjecture with Quickcheck-"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="entity"><span>enum</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test_card_size</span></span><span> </span><span class="entity"><span>test_fun</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>enum</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>Quickcheck.add_response</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>eval_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>abort_potential</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="entity"><span>Quickcheck.add_response</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>eval_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>current_result</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_terms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>eval_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Quickcheck.pretty_counterex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>cex</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="entity"><span>Quickcheck.message</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      </span><span class="inner_quoted"><span>"Quickcheck continues to find a genuine counterexample..."</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="entity"><span>test</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>drop_prefix</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>enum</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="entity"><span>enumeration_card_size</span></span><span class="main"><span>;</span></span><span> </span><span>!</span><span class="entity"><span>current_result</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_finite_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.finite_type_size</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Enum.html#Enum.finite_1|type"><span>Enum.finite_1</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Enum.html#Enum.finite_2|type"><span>Enum.finite_2</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Enum.html#Enum.finite_3|type"><span>Enum.finite_3</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span>
     </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Enum.html#Enum.finite_4|type"><span>Enum.finite_4</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Enum.html#Enum.finite_5|type"><span>Enum.finite_5</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>WELLSORTED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monomorphic_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>default_T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>map_types</span><span> </span><span>o</span><span> </span><span>map_atyps</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>default_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Sign.of_sort</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>T'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>WELLSORTED</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"For instantiation with default_type "</span></span><span> </span><span>^</span><span>
              </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>default_T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":\n"</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>^</span><span>
              </span><span class="inner_quoted"><span>" to be substituted for variable "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span>
              </span><span class="inner_quoted"><span>" does not have sort "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_sort</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>wellsorted_error</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Wellsorted_Error</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term * term list


</span><span class="comment1"><span>(* minimalistic preprocessing *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_all</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_all</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_all</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>swap</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.all_simps|fact"><span>all_simps</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.not_ex|fact"><span>not_ex</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.not_all|fact"><span>not_all</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.imp_conjL|fact"><span>imp_conjL</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.fun_eq_iff|fact"><span>fun_eq_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.bot_fun_def|fact"><span>bot_fun_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.less_bool_def|fact"><span>less_bool_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>rewrs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Object_Logic.atomize_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_all</span></span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_frees</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t'</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>vs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>vs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Subtype_Predicates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_predicate</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Subtype_Predicates.map</span><span> </span><span>o</span><span> </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subtype_preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Subtype_Predicates.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.defined</span><span> </span><span>Term.could_unify</span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>p</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span>Term.could_unify</span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Typedef.get_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tyco</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repT'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.varifyT_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rep_type </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repT'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.subst_type</span><span> </span><span class="entity"><span>substT</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.varifyT_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>abs_type </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>Rep_name </span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_imp</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>subst_of</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="entity"><span>get_match</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.subst_free</span><span> </span><span class="entity"><span>subst</span></span><span>
     </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_imp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* instantiation of type variables with concrete types *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_goals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_goal_and_eval_terms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>check_goal</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_insts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.finite_types</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_finite_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Quickcheck.default_type</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_goals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfree_names</span><span> </span><span class="entity"><span>check_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Term</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>map_goal_and_eval_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>monomorphic_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>WELLSORTED</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Wellsorted_Error</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_insts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>check_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>error_msg</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cat_lines</span><span>
        </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Wellsorted_Error</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst_goals</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_wellsorted_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_wellsorted_term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Wellsorted_Error</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>correct_inst_goals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="entity"><span>is_wellsorted_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst_goals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="entity"><span>error_msg</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.quiet</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>error_msg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>correct_inst_goals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* compilation of testing functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_safe_if</span></span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span class="entity"><span>none</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>then_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>else_t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>genuine</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>then_t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>if_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quickcheck_Random.html#Quickcheck_Random.catch_match|const"><span>Quickcheck_Random.catch_match</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>if_t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>then_t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>else_t</span></span><span> </span><span class="entity"><span>genuine</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>if_t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>genuine_only</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>none</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>else_t</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_results</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>results</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>results</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_results</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>results</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Quickcheck.found_counterexample</span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>results</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>collect_results</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>results</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generator_test_goal_terms</span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>use_subtype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.use_subtype</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eval_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_equation_eval_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_imp</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>add_eval_term</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eval_term</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_term'</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>test_term</span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>test_term_with_cardinality</span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>instantiate_goals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>goals</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>use_subtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subtype_preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>add_equation_eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.finite_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>collect_results</span></span><span> </span><span class="entity"><span>test_term'</span></span><span> </span><span class="entity"><span>goals'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>collect_results</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>test_term</span></span><span> </span><span class="entity"><span>generator</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>catch_code_errors</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goals'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* defining functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pat_completeness_auto</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Pat_Completeness.pat_completeness_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_functions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_equations</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>termination_tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>define_foundationally</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>termination_tac</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_equations</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Function.add_function</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs_t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>Function_Common.default_config</span></span><span> </span><span class="entity"><span>pat_completeness_auto</span></span><span>
      </span><span>#&gt;</span><span> </span><span>snd</span><span>
      </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Function.prove_termination</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>termination_tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>snd</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Local_Theory.define</span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>Binding.concealed</span><span> </span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_undefined</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>apfst</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_equations</span></span><span> </span><span class="entity"><span>consts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eq</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>Skip_Proof.cheat_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs_t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>lthy</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Local_Theory.note</span><span>
             </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span>o</span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"simps"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> 
        </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** ensuring sort constraints **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Old_Datatype_Aux.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.descr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>perhaps_constrain</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>meet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.meet_sort</span><span> </span><span class="main"><span>(</span></span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.varifyT_global</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.empty</span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>meet</span></span><span> </span><span class="entity"><span>insts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>vtab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Sorts.CLASS_ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_sort</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sort_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aux_sort</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_descr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>instantiate</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>raw_tycos</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_descr</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_tycos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tycos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prfx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auxnames</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_TUs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Sorts.inter_sort</span><span> </span><span class="entity"><span>algebra</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sort_vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insts_of</span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="entity"><span>constr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>maps</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.interpret_construction</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>constr</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts_of</span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>{</span></span><span> atyp </span><span class="main"><span>=</span></span><span> </span><span>single</span><span class="main"><span>,</span></span><span> dtyp </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>}</span></span><span>
        </span><span>@</span><span> </span><span class="entity"><span>insts_of</span></span><span> </span><span class="entity"><span>aux_sort</span></span><span> </span><span class="main"><span>{</span></span><span> atyp </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> dtyp </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Sorts.has_instance</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tycos</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_inst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>perhaps_constrain</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>instantiate</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>descr</span></span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tycos</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auxnames</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>o</span><span> </span><span>map_atyps</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_TUs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_common_sort_datatype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>instantiate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ensure_sort</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Typerep.html#Typerep.typerep|class"><span>typerep</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term_of|class"><span>term_of</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>BNF_LFP_Compat.the_descr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>compat_prefs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>instantiate</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>datatype_interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>BNF_LFP_Compat.interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>compat_prefs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>ensure_common_sort_datatype</span></span><span>


</span><span class="comment1"><span>(** generic parametric compilation **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_mk_parametric_generator_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_generator_expr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_of_bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>if_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>else_t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>if_t</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mk_generator_expr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eval_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>else_t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>absdummy</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="entity"><span>mk_if</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_of_bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** post-processing of function terms **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_fun_upd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_fun_upd</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_fun_upd"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_fun_upd</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_fun_upds</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_fun_upd</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_fun_upds"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_fun_upds</span></span><span> </span><span class="entity"><span>t0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fun_upds</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_fun_upd</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.empty|const"><span>Set.empty</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>tps</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.insert|const"><span>insert</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
        </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"make_set"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_coset</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.UNIV|const"><span>UNIV</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_coset</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invert</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>invert</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.minus_class.minus|const"><span>Groups.minus_class.minus</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.UNIV|const"><span>UNIV</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>invert</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Map.html#Map.empty|const"><span>Map.empty</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>tps</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_fun_upd</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_process_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_Abs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"map_Abs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_args</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>post_process_term</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_fun_upds</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>post_process_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_Abs</span></span><span> </span><span class="entity"><span>post_process_term</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                     </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span>rev</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span>rev</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>make_coset</span></span><span> </span><span class="entity"><span>T1</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span>rev</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>T1</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"post_process_term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_fun_upds</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_fun_upds</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>process_args</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>process_args</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>