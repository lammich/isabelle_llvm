<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/smt_solver.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/smt_solver.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/smt_solver.ML
    Author:     Sascha Boehme, TU Muenchen

SMT solvers registry and SMT tactic.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SMT_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*configuration*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Unsat</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Time_Out</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parsed_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>outcome</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_Failure.failure</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
     fact_ids</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
     atp_proof</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Proof.atp_step</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver_config</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
     class</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Util.class</span></span><span class="main"><span>,</span></span><span>
     avail</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     command</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     options</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     smt_options</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     good_slices</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span> * </span><span>bool</span><span> * </span><span>int</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     outcome</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>outcome</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     parse_proof</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
       </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
       </span><span class="entity"><span>parsed_proof</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
     replay</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span>

  </span><span class="comment1"><span>(*registry*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_solver</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>solver_config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> good_slices</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span> * </span><span>bool</span><span> * </span><span>int</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(*filter*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> smt_filter</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>parsed_proof</span></span><span>

  </span><span class="comment1"><span>(*tactic*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> smt_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> smt_tac'</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>

  </span><span class="comment1"><span>(*solver information*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    command</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    smt_options</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    good_slices</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span> * </span><span>bool</span><span> * </span><span>int</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    parse_proof</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>parsed_proof</span></span><span class="main"><span>,</span></span><span>
    replay</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> name_and_info_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>solver_info</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>SMT_Solver</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* interface to external solvers *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_command</span></span><span> </span><span class="entity"><span>command</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>problem_path</span></span><span> </span><span class="entity"><span>proof_path</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Bash.strings</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>command</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
    </span><span>File.bash_platform_path</span><span> </span><span class="entity"><span>problem_path</span></span><span> </span><span>^</span><span>
    </span><span class="inner_quoted"><span>" &gt; "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>proof_path</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" 2&gt;&amp;1"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span> </span><span class="entity"><span>input</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>SMT_Config.certificates_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.is_available</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The SMT solver "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not installed"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.debug_files</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>with_trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invoking SMT solver "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ..."</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cache_IO.run</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.debug_files</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.ext</span><span> </span><span class="inner_quoted"><span>"smt_in"</span></span><span> </span><span class="entity"><span>base_path</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Path.ext</span><span> </span><span class="inner_quoted"><span>"smt_out"</span></span><span> </span><span class="entity"><span>base_path</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Cache_IO.raw_run</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span> </span><span class="entity"><span>input</span></span><span> </span><span class="entity"><span>in_path</span></span><span> </span><span class="entity"><span>out_path</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>certs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Cache_IO.lookup</span></span><span> </span><span class="entity"><span>certs</span></span><span> </span><span class="entity"><span>input</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>key</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.read_only_certificates</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad certificate cache: missing certificate"</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>Cache_IO.run_and_cache</span></span><span> </span><span class="entity"><span>certs</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span> </span><span class="entity"><span>input</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>output</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>with_trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Using cached certificate from "</span></span><span> </span><span>^</span><span>
            </span><span>Path.print</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cache_IO.cache_path_of</span></span><span> </span><span class="entity"><span>certs</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ..."</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>output</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Z3 and cvc returns 1 if "get-proof" or "get-model" fails.
veriT returns 255 in that case and 14 for timeouts. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normal_return_codes</span></span><span> </span><span class="inner_quoted"><span>"z3"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normal_return_codes</span></span><span> </span><span class="inner_quoted"><span>"verit"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>14</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>255</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normal_return_codes</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run_solver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span> </span><span class="entity"><span>input</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.big_list</span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="inner_quoted"><span>"Problem:"</span></span><span> </span><span>o</span><span> </span><span>split_lines</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>elapsed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>redirected_output </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>,</span></span><span> output </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>return_code</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Timing.timing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.with_timeout</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>run</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mk_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="inner_quoted"><span>"Solver:"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>err</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>drop_suffix</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="inner_quoted"><span>"Result:"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="inner_quoted"><span>"Time:"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>Value.print_time</span><span> </span><span class="entity"><span>elapsed</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"s"</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.statistics_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="inner_quoted"><span>"Time:"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>Value.print_time</span><span> </span><span class="entity"><span>elapsed</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"s"</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normal_return_codes</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>return_code</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Abnormal_Termination</span></span><span> </span><span class="entity"><span>return_code</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_assms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span>o</span><span>
    </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Assertions:"</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_replay_data</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_eq</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>p_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_eq</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>p_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_eq</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>SMT_Config.trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Names:"</span></span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"sorts:"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>p_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"functions:"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>p_term</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>command</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>smt_options</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>SMT_Config.solver_options_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comments</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>str</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ithms</span></span><span>
      </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_assms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>SMT_Translate.translate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>smt_options</span></span><span> </span><span class="entity"><span>comments</span></span><span>
      </span><span>||&gt;</span><span> </span><span>tap</span><span> </span><span class="entity"><span>trace_replay_data</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>run_solver</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_command</span></span><span> </span><span class="entity"><span>command</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>str</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* configuration *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Unsat</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Time_Out</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parsed_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>outcome</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_Failure.failure</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   fact_ids</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   atp_proof</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Proof.atp_step</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver_config</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
   class</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Util.class</span></span><span class="main"><span>,</span></span><span>
   avail</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   command</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   options</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   smt_options</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   good_slices</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span> * </span><span>bool</span><span> * </span><span>int</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   outcome</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>outcome</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   parse_proof</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="entity"><span>parsed_proof</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   replay</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span>


</span><span class="comment1"><span>(* check well-sortedness *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_topsort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span>
    </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* top sorts cause problems with atomization *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_topsort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_topsort</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Normalize.drop_fact_warning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>TrueI</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thm</span></span><span>


</span><span class="comment1"><span>(* registry *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  command</span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  smt_options</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  good_slices</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span> * </span><span>bool</span><span> * </span><span>int</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  parse_proof</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>parsed_proof</span></span><span class="main"><span>,</span></span><span>
  replay</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Solvers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solver_info</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_proof</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>parse_proof0</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="entity"><span>xfacts</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Unsat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parse_proof0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>pp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pp</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="entity"><span>xfacts</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>lines</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>outcome </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> fact_ids </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> atp_proof </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Time_Out</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Time_Out</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Counterexample</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>replay0</span></span><span> </span><span class="entity"><span>oracle</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>replay_data</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_Translate.replay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Unsat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.oracle</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>oracle</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>replay0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="entity"><span>lines</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No proof reconstruction for solver -- \
            \declare [[smt_oracle]] to allow oracle"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Time_Out</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Time_Out</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Counterexample</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfalse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>avail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>command</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>smt_options</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>good_slices</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span>
    parse_proof </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_proof0</span></span><span class="main"><span>,</span></span><span> replay </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replay0</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>solver_config</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="entity"><span>oracle</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      command </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>command</span></span><span class="main"><span>,</span></span><span>
      smt_options </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>smt_options</span></span><span class="main"><span>,</span></span><span>
      good_slices </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>good_slices</span></span><span class="main"><span>,</span></span><span>
      parse_proof </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parse_proof0</span></span><span class="main"><span>,</span></span><span>
      replay </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>replay0</span></span><span> </span><span class="entity"><span>oracle</span></span><span class="main"><span>}</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> class </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> avail </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>avail</span></span><span class="main"><span>,</span></span><span> options </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Thm.add_oracle</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>cfalse</span></span><span class="main"><span>)</span></span><span> </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>oracle</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>Solvers.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="entity"><span>oracle</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
    </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.add_solver</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Solvers.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_and_info_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.solver_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>good_slices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>good_slices </span><span>oo</span><span> </span><span class="entity"><span>get_info</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_solver_and_replay</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>SMT_Util.Axiom</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>check_topsort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>command</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>smt_options</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replay</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_and_info_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>invoke</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>command</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>smt_options</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Normalize.normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>replay</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* filter (for Sledgehammer) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>smt_filter</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>xfacts</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>SMT_Config.timeout</span></span><span> </span><span class="main"><span>(</span></span><span>Time.toReal</span><span> </span><span class="entity"><span>time_limit</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>goal</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span>||&gt;</span><span> </span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span></span></span><span> </span><span>|-&gt;</span><span> </span><span>Thm.apply</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>negate</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Normalize.atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ct</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Failure.Other_Failure</span></span><span> </span><span class="inner_quoted"><span>"cannot atomize goal"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjecture</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>cprop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.Conjecture</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conjecture</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>SMT_Util.Hypothesis</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>@</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>SMT_Util.Axiom</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xfacts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_topsort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>command</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>smt_options</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parse_proof</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_and_info_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>invoke</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>command</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>smt_options</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Normalize.normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>parse_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>replay_data</span></span><span> </span><span class="entity"><span>xfacts</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="entity"><span>fail</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>outcome </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fail</span></span><span class="main"><span>,</span></span><span> fact_ids </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> atp_proof </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span>


</span><span class="comment1"><span>(* SMT tactic *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>str_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fail</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="inner_quoted"><span>"Solver "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>SMT_Config.solver_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>SMT_Failure.string_of_failure</span></span><span> </span><span class="entity"><span>fail</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_solve</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_solver_and_replay</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
      </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fail</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMT_Failure.Counterexample</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verbose_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>str_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fail</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fail</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMT_Failure.Time_Out</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verbose_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SMT: Solver "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.solver_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span>
          </span><span class="entity"><span>SMT_Failure.string_of_failure</span></span><span> </span><span class="entity"><span>fail</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" (setting the "</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"configuration option "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Config.name_of</span><span> </span><span class="entity"><span>SMT_Config.timeout</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" might help)"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMT_Failure.SMT</span></span><span> </span><span class="entity"><span>fail</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>str_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fail</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>resolve</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>no_tac</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Normalize.atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ccontr|fact"><span>ccontr</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>THEN'</span><span> </span><span class="entity"><span>SUBPROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>resolve</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>smt_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>safe_solve</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>smt_tac'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>oo</span><span> </span><span class="entity"><span>apply_solver_and_replay</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>