<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer.ML
    Author:     Fabian Immler, TU Muenchen
    Author:     Makarius
    Author:     Jasmin Blanchette, TU Muenchen

Sledgehammer's heart.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Fact.fact</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Fact.fact_override</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.proof_method</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>play_outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.play_outcome</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.params</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>induction_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.induction_rules</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>prover_problem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.prover_problem</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>prover_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.prover_result</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>preplay_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>sledgehammer_outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> prover_result * preplay_result list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_Unknown</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_TimeOut</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_ResourcesOut</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_None</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> short_string_of_sledgehammer_outcome </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sledgehammer_outcome</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_factss </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>fact</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> run_sledgehammer </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>sledgehammer_outcome</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem_Generate</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Fact</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Preplay</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Minimize</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_ATP_Systems</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Prover</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Prover_ATP</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Prover_Minimize</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_MaSh</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>preplay_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>sledgehammer_outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> prover_result * preplay_result list
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_Unknown</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_TimeOut</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_ResourcesOut</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_None</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"some"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="entity"><span>SH_Unknown</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"unknown"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="entity"><span>SH_TimeOut</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"timeout"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="entity"><span>SH_ResourcesOut</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"resources_out"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="entity"><span>SH_None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"none"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_nonfixed_terms_global</span></span><span> </span><span class="entity"><span>nonfixeds</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Same.commit</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.map_aterms_same</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nonfixeds</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span>Logic.bad_schematic</span><span> </span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_outcome</span></span><span> </span><span class="entity"><span>outcomes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outcomes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_TimeOut</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outcomes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>resources_out</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_ResourcesOut</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outcomes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unknown</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outcomes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>none</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_None</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outcomes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>some</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>unknown</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>timeout</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>resources_out</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>alternative</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>none</span></span><span>
    </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>play_one_line_proofs</span></span><span> </span><span class="entity"><span>minimize</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>methss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.zeroTime</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Chained</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>used_facts</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chained</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.goal</span></span><span> </span><span class="entity"><span>state</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.get_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>

       </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_methss</span></span><span> </span><span class="entity"><span>ress</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ress</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>try_methss</span></span><span> </span><span class="entity"><span>ress</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meths</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>methss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>meths</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
                 qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 obtains </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 label </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal_t</span></span><span class="main"><span>,</span></span><span>
                 subproofs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span>
                 comment </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>}</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ress'</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="entity"><span>preplay_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>minimize</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_names'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>minimized_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_step</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>meth</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                        </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts_of_isar_step</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used_facts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_names'</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>any_succeeded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ress'</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="entity"><span>try_methss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ress'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ress</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>any_succeeded</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>methss</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span class="entity"><span>try_methss</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>methss</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome</span></span><span class="main"><span>,</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Chained</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_one_line_proof</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>preferred_meth</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>preplay_results</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="comment1"><span>(* Select best method if preplay succeeded *)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>best_meth</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_outcome</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_used_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>best_used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_outcome</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(* Otherwise select preferred method *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preferred_meth</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span> </span><span class="entity"><span>preferred_meth</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>outcome</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span>Time.zeroTime</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Chained</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>launch_prover</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>verbose</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slices</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>learn</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>problem</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>prover_problem</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>slice</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abduce</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"Launched"</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>abduce</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>" (abduce)"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>" (falsify)"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" with "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" fact"</span></span><span> </span><span>^</span><span>
          </span><span class="entity"><span>plural_s</span></span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_time</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slice_timeout</span></span><span> </span><span class="entity"><span>slice_size</span></span><span> </span><span class="entity"><span>slices</span></span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>abduce</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>" (abduce)"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>" (falsify)"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_used_facts</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>used_from</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>used_from</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>filter_used_facts</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>used_facts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"@"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>commas</span><span>
      </span><span>|&gt;</span><span> </span><span>prefix</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Facts in "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"falsification"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"proof"</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>writeln</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spying_str_of_res</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>outcome </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_from</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>prover_result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_used_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>used_facts</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_indices</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>facts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>filter_used_facts</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>used_facts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span>eq_fst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"@"</span></span><span> </span><span>o</span><span> </span><span>string_of_int</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_info</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_filter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_indices</span></span><span> </span><span class="entity"><span>facts</span></span><span>
              </span><span class="comment1"><span>(* "Int.max" is there for robustness *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unknowns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_used_facts</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>indices</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"?"</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span>commas</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indices</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>unknowns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>filter_infos</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="entity"><span>filter_info</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"actual"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_from</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indices</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filters</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>commas</span><span> </span><span class="entity"><span>fact_filters</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>indices</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="inner_quoted"><span>"Success: Found "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"falsification"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"proof"</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" with "</span></span><span> </span><span>^</span><span>
          </span><span>string_of_int</span><span> </span><span class="entity"><span>num_used_facts</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" fact"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>plural_s</span></span><span> </span><span class="entity"><span>num_used_facts</span></span><span> </span><span>^</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_used_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>filter_infos</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>spying_str_of_res</span></span><span> </span><span class="main"><span>{</span></span><span>outcome </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>failure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="inner_quoted"><span>"Failure: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_atp_failure</span></span><span> </span><span class="entity"><span>failure</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span class="entity"><span>get_minimizing_prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>learn</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="entity"><span>slice</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span>?</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>outcome </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_from</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>print_used_facts</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>used_from</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>spy</span></span><span> </span><span>?</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spying_str_of_res</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_prover_result</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>minimize</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>subgoal</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>prover_result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chosen_preplay_outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ATP_Proof.TimedOut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>SH_TimeOut</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>select_one_line_proof</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ATP_Proof.OutOfResources</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>SH_ResourcesOut</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>select_one_line_proof</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>SH_None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>select_one_line_proof</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preplay_results</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>play_one_line_proofs</span></span><span> </span><span class="entity"><span>minimize</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>subgoal</span></span><span>
              </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chosen_preplay_outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>select_one_line_proof</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>preferred_methss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chosen_preplay_outcome</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>output_message</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chosen_preplay_outcome</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output_message</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_prover_result_for_inconsistency</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>prover_result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ATP_Proof.TimedOut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>SH_TimeOut</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ATP_Proof.OutOfResources</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>SH_ResourcesOut</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>SH_None</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="entity"><span>sledgehammer_goal_as_fact</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>sledgehammer_goal_as_fact</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"The goal is inconsistent"</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"The goal is falsified by these facts: "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="inner_quoted"><span>"Derived \"False\" from these facts alone: "</span></span><span> </span><span>^</span><span>
          </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>used_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_expected_outcome</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prover_name</span></span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outcome_code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>short_string_of_sledgehammer_outcome</span></span><span> </span><span class="entity"><span>outcome</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="comment1"><span>(* The "expect" argument is deliberately ignored if the prover is missing so that
       "Metis_Examples" can be processed on any machine. *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_prover_installed</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prover_name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expect</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"some"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"some_preplayed"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preplay_results</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unexpected outcome: the external prover found a proof but preplay failed"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unknown"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"timeout"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_TimeOut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"resources_out"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_ResourcesOut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"none"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SH_None</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unexpected outcome: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>outcome_code</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>launch_prover_and_preplay</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>debug</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expect</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span>
    </span><span class="entity"><span>has_already_found_something</span></span><span> </span><span class="entity"><span>found_something</span></span><span> </span><span class="entity"><span>massage_message</span></span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="entity"><span>learn</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>problem</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slice</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prover_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hard_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.scale</span><span> </span><span class="inner_numeral"><span>5.0</span></span><span> </span><span class="entity"><span>timeout</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flip_problem</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>comment</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>,</span></span><span> factss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assumption.all_assms_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assm_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>assms</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.get_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subgoal</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>polymorphic_subgoal_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assm_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Logic.varify_global</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nonfixeds</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>assm_ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_free_names</span><span> </span><span class="entity"><span>subgoal_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>monomorphic_subgoal_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subgoal_t</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>varify_nonfixed_terms_global</span></span><span> </span><span class="entity"><span>nonfixeds</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Skip_Proof.make_thm</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>polymorphic_subgoal_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>monomorphic_subgoal_t</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_facts</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sledgehammer_goal_as_fact</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Assum</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subgoal_thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>{</span></span><span>comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>,</span></span><span> state </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> goal </span><span class="main"><span>=</span></span><span> </span><span>Thm.trivial</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>cprop</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> subgoal </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
         subgoal_count </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> factss </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="entity"><span>new_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>,</span></span><span>
         has_already_found_something </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_already_found_something</span></span><span class="main"><span>,</span></span><span>
         found_something </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>found_something</span></span><span> </span><span class="inner_quoted"><span>"a falsification"</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>flip_problem</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>really_go</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>launch_prover</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>learn</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="entity"><span>slice</span></span><span> </span><span class="entity"><span>prover_name</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>analyze_prover_result_for_inconsistency</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>preplay_prover_result</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>subgoal</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>really_go</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>really_go</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
           </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exn</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Exn.is_interrupt</span><span> </span><span class="entity"><span>exn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Exn.reraise</span><span> </span><span class="entity"><span>exn</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Runtime.exn_message</span><span> </span><span class="entity"><span>exn</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timeout.apply</span><span> </span><span class="entity"><span>hard_timeout</span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_expected_outcome</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prover_name</span></span><span> </span><span class="entity"><span>expect</span></span><span> </span><span class="entity"><span>outcome</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Auto_Try</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span>
            </span><span class="entity"><span>massage_message</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"falsification"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"proof"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_facts</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="inner_quoted"><span>"Selected "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
  </span><span class="inner_quoted"><span>"fact"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>plural_s</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_factss</span></span><span> </span><span class="entity"><span>factss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>factss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="inner_quoted"><span>"Found no relevant facts"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_of_facts</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(* FUDGE (loosely inspired by Seventeen evaluation) *)</span></span><span>
  </span><span class="main"><span>[</span></span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>veritN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spassN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iproverN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>spassN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z3N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>iproverN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spassN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampireN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z3N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z3N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvc4N</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>zipperpositionN</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>schedule_of_provers</span></span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="entity"><span>num_slices</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known_provers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unknown_provers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>provers</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>known_provers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_default_slices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>round_robin</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>round_robin</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>round_robin</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>provers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>round_robin</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>provers</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prover</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_slices</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>num_default_slices</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>take</span><span> </span><span class="entity"><span>num_slices</span></span><span> </span><span class="entity"><span>default_slice_schedule</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>default_slice_schedule</span></span><span>
      </span><span>@</span><span> </span><span class="entity"><span>round_robin</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_slices</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>num_default_slices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unknown_provers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>known_provers</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prover_slices_of_schedule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>subgoal</span></span><span> </span><span class="entity"><span>factss</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>abduce</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>schedule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>triplicate_slices</span></span><span> </span><span class="entity"><span>original</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abduce</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abduce</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_facts</span></span><span class="main"><span>,</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mashN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mepoN</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mepoN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>meshN</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mashN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>shifted_once</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="entity"><span>original</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>shifted_twice</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="entity"><span>shifted_once</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>original</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>shifted_once</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>shifted_twice</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_extra</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATP_Slice</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_enc0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_trans0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncurried_aliases0</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>extra_extra0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>ATP_Slice</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format0</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>type_enc0</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>lam_trans0</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span class="main"><span>,</span></span><span>
          </span><span>the_default</span><span> </span><span class="entity"><span>uncurried_aliases0</span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_extra0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_extra</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extra</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMT_Slice</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_slice</span></span><span> </span><span class="entity"><span>max_slice_size</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>slice_size0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abduce0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_facts0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>slice_size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slice_size0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>the_subgoal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.get_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subgoal</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_not_False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_subgoal</span></span><span> </span><span>aconv</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>prop</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abduce</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>abduce</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>abduce0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>goal_not_False</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>max_candidates</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>max_candidates</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>falsify0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>goal_not_False</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.is_schematic</span><span> </span><span class="entity"><span>the_subgoal</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>fact_filter0</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>num_facts0</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_facts</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts_of_filter</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abduce</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_filter</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>adjust_extra</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schedule</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span class="entity"><span>fact_filter</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>triplicate_slices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_slices</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prover</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>provers</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_threads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Multithreading.max_threads</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="entity"><span>slices_left</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>schedule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slice0</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>slices</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prover_slices'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slices</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prover_slices</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>slice</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>slice_size</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>adjust_slice</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>slices_left</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>max_threads</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>max_threads</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>slice0</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slice</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="entity"><span>prover_slices'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slices_left</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>slice_size</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schedule</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="entity"><span>slices_left</span></span><span> </span><span class="entity"><span>schedule</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>translate_schedule</span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>schedule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schedule</span></span><span>
    </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run_sledgehammer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>verbose</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>provers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>falsify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induction_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_facts</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>max_proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slices</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_override</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>only</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>error</span><span> </span><span class="inner_quoted"><span>"No prover is set"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>subgoal_count</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>error</span><span> </span><span class="inner_quoted"><span>"No subgoal!"</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_None</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.assert_backward</span></span><span> </span><span class="entity"><span>state</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Normal</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>writeln</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>found_proofs_and_falsifications</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"found_proofs_and_falsifications"</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_already_found_something</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Normal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>Synchronized.value</span><span> </span><span class="entity"><span>found_proofs_and_falsifications</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>false</span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>found_something</span></span><span> </span><span class="entity"><span>a_proof_or_inconsistency</span></span><span> </span><span class="entity"><span>prover_name</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Normal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>Synchronized.change</span><span> </span><span class="entity"><span>found_proofs_and_falsifications</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found "</span></span><span> </span><span>^</span><span>
             </span><span class="entity"><span>a_proof_or_inconsistency</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>seen_messages</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"seen_messages"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_until_left_paren</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_until_left_paren</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.size</span><span> </span><span class="entity"><span>s</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>strip_until_left_paren</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="comment1"><span>(* Remove the measured preplay time when looking for duplicates. This is
           admittedly rather ad hoc. *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_time</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>" s)"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>" ms)"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>strip_until_left_paren</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>s</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_message</span></span><span> </span><span class="entity"><span>proof_or_inconsistency</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_time</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Synchronized.value</span><span> </span><span class="entity"><span>seen_messages</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="inner_quoted"><span>"Found duplicate "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>proof_or_inconsistency</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span>Synchronized.change</span><span> </span><span class="entity"><span>seen_messages</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induction_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>Instantiate</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chained_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.goal</span></span><span> </span><span class="entity"><span>state</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_subgoal</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_prover_supported</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such prover: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="inner_quoted"><span>"Sledgehammering..."</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"***"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Starting "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>str_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" mode"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>elapsed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.timing</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>nearly_all_facts_of_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="entity"><span>chained_thms</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl_t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"All"</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"Extracting "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>all_facts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" facts from background theory in "</span></span><span> </span><span>^</span><span>
          </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toMilliseconds</span><span> </span><span class="entity"><span>elapsed</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spying_str_of_factss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>commas</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_factss</span></span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_max_facts</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prover</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Integer.max</span><span> </span><span class="entity"><span>max_facts</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>get_slices</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prover</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>provers</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
              </span><span>*</span><span> </span><span class="inner_numeral"><span>51</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>50</span></span><span>  </span><span class="comment1"><span>(* some slack to account for filtering of induction facts below *)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>elapsed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.timing</span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>relevant_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>provers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>max_max_facts</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>all_facts</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induction_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>only</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Include</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Exclude</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>induction_rules</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>factss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_filter_out_induction_rules</span></span><span> </span><span class="entity"><span>induction_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>factss</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"All"</span></span><span class="main"><span>,</span></span><span>
              </span><span class="inner_quoted"><span>"Filtering facts in "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toMilliseconds</span><span> </span><span class="entity"><span>elapsed</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
              </span><span class="inner_quoted"><span>" ms (MaSh algorithm: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>str_of_mash_algorithm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_mash_algorithm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of_factss</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span class="entity"><span>spy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"All"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Selected facts: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>spying_str_of_factss</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>factss</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>launch_provers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>factss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_factss</span></span><span> </span><span class="entity"><span>provers</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>{</span></span><span>comment </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> state </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> subgoal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> subgoal_count </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span>
               factss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>factss</span></span><span class="main"><span>,</span></span><span> has_already_found_something </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_already_found_something</span></span><span class="main"><span>,</span></span><span>
               found_something </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>found_something</span></span><span> </span><span class="inner_quoted"><span>"a proof"</span></span><span class="main"><span>}</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>learn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mash_learn_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>launch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>launch_prover_and_preplay</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>has_already_found_something</span></span><span>
              </span><span class="entity"><span>found_something</span></span><span> </span><span class="entity"><span>massage_message</span></span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="entity"><span>learn</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schedule</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Auto_Try</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>provers</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>schedule_of_provers</span></span><span> </span><span class="entity"><span>provers</span></span><span> </span><span class="entity"><span>slices</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prover_slices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prover_slices_of_schedule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>factss</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>schedule</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Running "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>prover_slices</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Auto_Try</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slice</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>launch</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="entity"><span>slice</span></span><span> </span><span class="entity"><span>prover</span></span><span class="main"><span>)</span></span><span>
                </span><span class="entity"><span>prover_slices</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>learn</span></span><span> </span><span class="entity"><span>chained_thms</span></span><span class="main"><span>;</span></span><span>
               </span><span>Par_List.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prover</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>slice</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Synchronized.value</span><span> </span><span class="entity"><span>found_proofs_and_falsifications</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>max_proofs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                     </span><span class="entity"><span>launch</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="entity"><span>slice</span></span><span> </span><span class="entity"><span>prover</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>SH_None</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="entity"><span>prover_slices</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>max_outcome</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normal_failure</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span>
             </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>falsify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"falsification"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"proof"</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
              </span><span class="inner_quoted"><span>" found"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
           </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>launch_provers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SH_TimeOut</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outcome</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>SH_Some</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="inner_quoted"><span>"Done"</span></span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_Unknown</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>normal_failure</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Warning: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_TimeOut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>normal_failure</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_ResourcesOut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>normal_failure</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SH_None</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>normal_failure</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>writeln</span><span> </span><span class="entity"><span>writeln_result</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Warning: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>