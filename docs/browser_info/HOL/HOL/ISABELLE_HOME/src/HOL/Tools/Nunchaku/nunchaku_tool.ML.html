<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nunchaku/nunchaku_tool.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nunchaku/nunchaku_tool.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nunchaku/nunchaku_tool.ML
    Author:     Jasmin Blanchette, VU Amsterdam
    Copyright   2015, 2016, 2017

Interface to the external "nunchaku" tool.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NUNCHAKU_TOOL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nunchaku_Problem.ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nunchaku_Problem.tm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>nun_problem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nunchaku_Problem.nun_problem</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tool_params</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>solvers</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     overlord</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     min_bound</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     max_bound</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
     bound_increment</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     debug</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     specialize</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     timeout</span><span class="main"><span>:</span></span><span> </span><span>Time.time</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>nun_solution</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>tys</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> * </span><span class="entity"><span>tm</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     tms</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> * </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>nun_outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Unsat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * string * nun_solution
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * string * nun_solution</span><span class="main"><span>)</span></span><span> option
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Timeout</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Var_Not_Set</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Cannot_Execute</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Not_Found</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CVC4_Cannot_Execute</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CVC4_Not_Found</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown_Error</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * string

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nunchaku_home_env_var</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> solve_nun_problem</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tool_params</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nun_problem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nun_outcome</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nunchaku_Tool</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NUNCHAKU_TOOL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nunchaku_Util</span><span class="main"><span>;</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nunchaku_Problem</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tool_params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>solvers</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   overlord</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   min_bound</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   max_bound</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   bound_increment</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   debug</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   specialize</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   timeout</span><span class="main"><span>:</span></span><span> </span><span>Time.time</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>nun_solution</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>tys</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> * </span><span class="entity"><span>tm</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   tms</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> * </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>nun_outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Unsat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * string * nun_solution
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * string * nun_solution</span><span class="main"><span>)</span></span><span> option
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Timeout</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Var_Not_Set</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Cannot_Execute</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nunchaku_Not_Found</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CVC4_Cannot_Execute</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CVC4_Not_Found</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown_Error</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * string</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nunchaku_home_env_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"NUNCHAKU_HOME"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unknown_solver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"unknown"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cached_outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"Nunchaku_Tool.cached_outcome"</span></span><span>
  </span><span class="main"><span>(</span></span><span>NONE</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tool_params</span></span><span> * </span><span class="entity"><span>nun_problem</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>nun_outcome</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncached_solve_nun_problem</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>solvers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>overlord</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_increment</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>specialize</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tool_params</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>problem</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>sound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>with_tmp_or_overlord_file</span></span><span> </span><span class="entity"><span>overlord</span></span><span> </span><span class="inner_quoted"><span>"nunchaku"</span></span><span> </span><span class="inner_quoted"><span>"nun"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prob_path</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>getenv</span><span> </span><span class="entity"><span>nunchaku_home_env_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>Nunchaku_Var_Not_Set</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bash_cmd</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="inner_quoted"><span>"PATH=\"$CVC4_HOME:$KODKODI/bin:$SMBC_HOME:$PATH\" \"$"</span></span><span> </span><span>^</span><span>
          </span><span class="entity"><span>nunchaku_home_env_var</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\"/nunchaku --skolems-in-model --no-color "</span></span><span> </span><span>^</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>specialize</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"--no-specialize "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"--solvers \""</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bash.string</span><span> </span><span class="entity"><span>solvers</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\" "</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"--timeout "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toSeconds</span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"--kodkod-min-bound "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>min_bound</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>max_bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"--kodkod-max-bound "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"--kodkod-bound-increment "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>bound_increment</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
          </span><span>File.bash_path</span><span> </span><span class="entity"><span>prob_path</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comments</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>bash_cmd</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"This file was generated by Isabelle (most likely Nunchaku)"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timestamp</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prob_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"# "</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comments</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>str_of_nun_problem</span></span><span> </span><span class="entity"><span>problem</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>File.write</span><span> </span><span class="entity"><span>prob_path</span></span><span> </span><span class="entity"><span>prob_str</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Isabelle_System.bash_process</span></span><span> </span><span class="main"><span>(</span></span><span>Bash.script</span><span> </span><span class="entity"><span>bash_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Process_Result.rc</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Process_Result.out</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Process_Result.err</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>backend</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"{backend:"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>split_lines</span><span> </span><span class="entity"><span>out</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>space_explode</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unknown_solver</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"SAT"</span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span>o</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>backend</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>tys </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> tms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"UNSAT"</span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Unsat</span></span><span> </span><span class="entity"><span>backend</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="inner_quoted"><span>"TIMEOUT"</span></span><span> </span><span class="entity"><span>out</span></span><span>
            </span><span class="comment1"><span>(* FIXME: temporary *)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="inner_quoted"><span>"kodkod failed (errcode 152)"</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Timeout</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"UNKNOWN"</span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Unknown</span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>126</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Nunchaku_Cannot_Execute</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>127</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Nunchaku_Not_Found</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Unknown_Error</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rc</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>simplify_spaces</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elide_string</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>out</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve_nun_problem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>solvers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>overlord</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>debug</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>problem</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overlord</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>debug</span></span><span class="main"><span>,</span></span><span>
        </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span class="main"><span>(</span></span><span>Synchronized.value</span><span> </span><span class="entity"><span>cached_outcome</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>key</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>outcome</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uncached_solve_nun_problem</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>problem</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Synchronized.change</span><span> </span><span class="entity"><span>cached_outcome</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outcome</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Unsat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>outcome</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>