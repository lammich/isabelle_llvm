<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Function/function_core.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Function/function_core.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Function/function_core.ML
    Author:     Alexander Krauss, TU Muenchen

Core of the function package.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>FUNCTION_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Unsynchronized.ref</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_function </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Function_Common.function_config</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="comment1"><span>(* defname *)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* defined symbol *)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* specification *)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span>   </span><span class="comment1"><span>(* f *)</span></span><span>
        * </span><span>thm</span><span>  </span><span class="comment1"><span>(* goalstate *)</span></span><span>
        * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Function_Common.function_result</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* continuation *)</span></span><span>
       </span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Function_Core</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>FUNCTION_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>boolT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Lib</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Common</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>fvar</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  domT</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  ranT</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  h</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  y</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  x</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  z</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  a</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  P</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  D</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  Pbool</span><span class="main"><span>:</span></span><span>term</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>rec_call_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RCInfo</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>RIvs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(* Call context: fixes and assumes *)</span></span><span>
  CCas</span><span class="main"><span>:</span></span><span> thm list</span><span class="main"><span>,</span></span><span>
  rcarg</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>                 </span><span class="comment1"><span>(* The recursive argument *)</span></span><span>
  llRI</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  h_assum</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>}</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>clause_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>ctxt </span><span class="main"><span>:</span></span><span> Proof.context</span><span class="main"><span>,</span></span><span>
  qs </span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  gs </span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  lhs</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  rhs</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  cqs</span><span class="main"><span>:</span></span><span> cterm list</span><span class="main"><span>,</span></span><span>
  ags</span><span class="main"><span>:</span></span><span> thm list</span><span class="main"><span>,</span></span><span>
  case_hyp </span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>}</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_clause_ctx</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.transfer</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
    qs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> gs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> cqs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> ags </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> case_hyp </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span> </span><span class="main"><span>}</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>clause_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>no</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  qglr </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list * term list * term * term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  cdata </span><span class="main"><span>:</span></span><span> clause_context</span><span class="main"><span>,</span></span><span>
  tree</span><span class="main"><span>:</span></span><span> Function_Context_Tree.ctx_tree</span><span class="main"><span>,</span></span><span>
  lGI</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  RCs</span><span class="main"><span>:</span></span><span> rec_call_info list</span><span class="main"><span>}</span></span><span>


</span><span class="comment1"><span>(* Theory dependencies. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc_induct_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.accp_induct_rule|fact"><span>accp_induct_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex1_implies_ex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.fundef_ex1_existence|fact"><span>Fun_Def.fundef_ex1_existence</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex1_implies_un</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.fundef_ex1_uniqueness|fact"><span>Fun_Def.fundef_ex1_uniqueness</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex1_implies_iff</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.fundef_ex1_iff|fact"><span>Fun_Def.fundef_ex1_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc_downward</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.accp_downward|fact"><span>accp_downward</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>accI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.accp.accI|fact"><span>accp.accI</span></a><span class="antiquote"><span>}</span></span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_calls</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_Ri</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span class="entity"><span>assumes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_Ri</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Function_Context_Tree.traverse_tree</span></span><span> </span><span class="entity"><span>add_Ri</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** building proof obligations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_compat_proof_obligations</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>glrs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_impl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>qs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>incr_boundvars</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>qs'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Logic.mk_implies</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>shift</span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>gs'</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Logic.all_const</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>qs'</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>abstract_over</span><span> </span><span class="entity"><span>fvar</span></span><span>
        </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>subst_bound</span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>mk_impl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unordered_pairs</span></span><span> </span><span class="entity"><span>glrs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_completeness</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pbool</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>qglrs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_case</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>Pbool</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>Pbool</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_case</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clauses</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pbool</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** making a context with it's own local bindings **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_clause_context</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre_qs</span></span><span class="main"><span>,</span></span><span class="entity"><span>pre_gs</span></span><span class="main"><span>,</span></span><span class="entity"><span>pre_lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>pre_rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pre_qs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pre_qs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_gs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_lhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>pre_rhs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ags</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_hyp</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> qs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> gs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span>
      cqs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> ags </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> case_hyp </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* lowlevel term function. FIXME: remove *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>lev</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>body</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_clause_info</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>no</span></span><span> </span><span class="entity"><span>cdata</span></span><span> </span><span class="entity"><span>qglr</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="entity"><span>RCs</span></span><span> </span><span class="entity"><span>GIntro_thm</span></span><span> </span><span class="entity"><span>RIntro_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cdata</span></span><span>

    </span><span class="comment1"><span>(* Instantiate the GIntro thm with "f" and import into the clause context. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lGI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>GIntro_thm</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>ags</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_call_info</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RI</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llRI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RI</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_elim</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcfix</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>ags</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>rcassm</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>h_assum</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rcarg</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcassm</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcfix</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Pattern.rewrite_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span>RIvs</span><span class="main"><span>=</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> rcarg</span><span class="main"><span>=</span></span><span class="entity"><span>rcarg</span></span><span class="main"><span>,</span></span><span> CCas</span><span class="main"><span>=</span></span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> llRI</span><span class="main"><span>=</span></span><span class="entity"><span>llRI</span></span><span class="main"><span>,</span></span><span> h_assum</span><span class="main"><span>=</span></span><span class="entity"><span>h_assum</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RC_infos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_call_info</span></span><span> </span><span class="entity"><span>RCs</span></span><span> </span><span class="entity"><span>RIntro_thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>no</span><span class="main"><span>=</span></span><span class="entity"><span>no</span></span><span class="main"><span>,</span></span><span> cdata</span><span class="main"><span>=</span></span><span class="entity"><span>cdata</span></span><span class="main"><span>,</span></span><span> qglr</span><span class="main"><span>=</span></span><span class="entity"><span>qglr</span></span><span class="main"><span>,</span></span><span> lGI</span><span class="main"><span>=</span></span><span class="entity"><span>lGI</span></span><span class="main"><span>,</span></span><span> RCs</span><span class="main"><span>=</span></span><span class="entity"><span>RC_infos</span></span><span class="main"><span>,</span></span><span>
      tree</span><span class="main"><span>=</span></span><span class="entity"><span>tree</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>store_compat_thms</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>store_compat_thms</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>thms1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>store_compat_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* expects i &lt;= j *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_compat_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Returns "Gsi, Gsj, lhs_i = lhs_j |-- rhs_j_f = rhs_i_f" *)</span></span><span>
</span><span class="comment1"><span>(* if j &lt; i, then turn around *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_compat_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>ctxi</span></span><span> </span><span class="entity"><span>ctxj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span>cqs</span><span class="main"><span>=</span></span><span class="entity"><span>cqsi</span></span><span class="main"><span>,</span></span><span>ags</span><span class="main"><span>=</span></span><span class="entity"><span>agsi</span></span><span class="main"><span>,</span></span><span>lhs</span><span class="main"><span>=</span></span><span class="entity"><span>lhsi</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxi</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span>cqs</span><span class="main"><span>=</span></span><span class="entity"><span>cqsj</span></span><span class="main"><span>,</span></span><span>ags</span><span class="main"><span>=</span></span><span class="entity"><span>agsj</span></span><span class="main"><span>,</span></span><span>lhs</span><span class="main"><span>=</span></span><span class="entity"><span>lhsj</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxj</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhsi_eq_lhsj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhsi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhsj</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_compat_thm</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>cts</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>compat</span></span><span>         </span><span class="comment1"><span>(* "!!qj qi. Gsj =&gt; Gsi =&gt; lhsj = lhsi ==&gt; rhsj = rhsi" *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cqsj</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cqsi</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "Gsj =&gt; Gsi =&gt; lhsj = lhsi ==&gt; rhsj = rhsi" *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>agsj</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>agsi</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>lhsi_eq_lhsj</span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "Gsj, Gsi, lhsi = lhsj |-- rhsj = rhsi" *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_compat_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>cts</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>compat</span></span><span>        </span><span class="comment1"><span>(* "!!qi qj. Gsi =&gt; Gsj =&gt; lhsi = lhsj ==&gt; rhsi = rhsj" *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cqsi</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cqsj</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "Gsi =&gt; Gsj =&gt; lhsi = lhsj ==&gt; rhsi = rhsj" *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>agsi</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>agsj</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>lhsi_eq_lhsj</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "Gsi, Gsj, lhsi = lhsj |-- rhsj = rhsi" *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Generates the replacement lemma in fully quantified form. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_replacement_lemma</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>ih_elim</span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>cdata</span><span class="main"><span>=</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RCs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>arg1_conv</span><span> </span><span>o</span><span> </span><span>arg_conv</span><span> </span><span>o</span><span> </span><span>arg_conv</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_elim_case</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ih_conv</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_hyp</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>eq_reflection</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ih_elim</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ris</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>llRI</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>llRI</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>h_assums</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>h_assum</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h_assum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eql</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Function_Context_Tree.rewrite_by_tree</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>ih_elim_case</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ris</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>h_assums</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tree</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>replace_lemma</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>eql</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>h_assums</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>cqs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>replace_lemma</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_uniqueness_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>clausei</span></span><span> </span><span class="entity"><span>clausej</span></span><span> </span><span class="entity"><span>RLj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>no</span><span class="main"><span>=</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> cdata</span><span class="main"><span>=</span></span><span class="entity"><span>cctxi</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span>ctxt</span><span class="main"><span>=</span></span><span class="entity"><span>ctxti</span></span><span class="main"><span>,</span></span><span> lhs</span><span class="main"><span>=</span></span><span class="entity"><span>lhsi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>clausei</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>no</span><span class="main"><span>=</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> qglr</span><span class="main"><span>=</span></span><span class="entity"><span>cdescj</span></span><span class="main"><span>,</span></span><span> RCs</span><span class="main"><span>=</span></span><span class="entity"><span>RCsj</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clausej</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cctxj</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span>ags </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>agsj'</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhsj'</span></span><span class="main"><span>,</span></span><span> rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhsj'</span></span><span class="main"><span>,</span></span><span> qs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qsj'</span></span><span class="main"><span>,</span></span><span> cqs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cqsj'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_clause_context</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxti</span></span><span> </span><span class="entity"><span>cdescj</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhsj'h</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhsj'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_compat_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>cctxi</span></span><span> </span><span class="entity"><span>cctxj</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ghsj'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>h_assum</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qsj'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h_assum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCsj</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RLj_import</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RLj</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqsj'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>agsj'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>Ghsj'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>y_eq_rhsj'h</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhsj'h</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhsi_eq_lhsj'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhsi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhsj'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="comment1"><span>(* lhs_i = lhs_j' |-- lhs_i = lhs_j' *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhsi_eq_lhsj'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* lhs_i = lhs_j' |-- x = lhs_j' *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>RLj_import</span></span><span>
      </span><span class="comment1"><span>(* Rj1' ... Rjk', lhs_i = lhs_j' |-- rhs_j'_h = rhs_j'_f *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>it</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compat</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* lhs_i = lhs_j', Gj', Rj1' ... Rjk' |-- rhs_j'_h = rhs_i_f *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>y_eq_rhsj'h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>it</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* lhs_i = lhs_j', Gj', Rj1' ... Rjk', y = rhs_j_h' |-- y = rhs_i_f *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ghsj'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>agsj'</span></span><span>
      </span><span class="comment1"><span>(* lhs_i = lhs_j' , y = rhs_j_h' |-- Gj', Rj1'...Rjk' ==&gt; y = rhs_i_f *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>y_eq_rhsj'h</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>lhsi_eq_lhsj'</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cqsj'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_uniqueness_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="entity"><span>ih_intro</span></span><span> </span><span class="entity"><span>G_cases</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>rep_lemmas</span></span><span> </span><span class="entity"><span>clausei</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>cdata </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lGI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RCs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clausei</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhsC</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_intro_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_hyp</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ih_intro</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_RC</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>llRI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RIvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>CCas</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llRI</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>ih_intro_case</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>CCas</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RIvs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>existence</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_RC</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCs</span></span><span> </span><span class="entity"><span>lGI</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhsC</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>G_lhs_y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unique_clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_uniqueness_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>clausei</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>rep_lemmas</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_implies_eta</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>AB</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.bicompose</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>flatten </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> match </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> incremented </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>AB</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Seq.list_of</span><span> </span><span>|&gt;</span><span> </span><span>the_single</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uniqueness</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>G_cases</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>P</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>G_lhs_y</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>elim_implies_eta</span></span><span> </span><span class="entity"><span>unique_clauses</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>G_lhs_y</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>lambda</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* P2 y := (lhs, y): G *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exactly_one</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ex1I|fact"><span>ex1I</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate'</span><span>
          </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>P2</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rhsC</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>existence</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uniqueness</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_hyp</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>cqs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>function_value</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>existence</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ihyp</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>RS</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>refl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>exactly_one</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>function_value</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_stuff</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span class="entity"><span>compat</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>G_elim</span></span><span> </span><span class="entity"><span>f_def</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>

    </span><span class="comment1"><span>(* Inductive Hypothesis: !!z. (z,x):R ==&gt; EX!y. (z,y):G *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.all_const</span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"z"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span>
      </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ranT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
          </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ihyp_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ihyp_thm</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_def</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>ex1_implies_ex</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_elim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ihyp_thm</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_def</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>ex1_implies_un</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"Proving Replacement lemmas..."</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repLemmas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_replacement_lemma</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>ih_elim</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"Proving cases for unique existence..."</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ex1s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>values</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>split_list</span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_uniqueness_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="entity"><span>ih_intro</span></span><span> </span><span class="entity"><span>G_elim</span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>repLemmas</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"Proving: Graph is a function"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>graph_is_function</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>complete</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ex1s</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ihyp</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.compose</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>it</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acc_induct_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "EX! y. (?x,y):G" *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Var</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>it</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>it</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goalstate</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span>Conjunction.intr</span><span> </span><span class="entity"><span>graph_is_function</span></span><span> </span><span class="entity"><span>complete</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span>Goal.protect</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compat</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>complete</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>goalstate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>values</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* wrapper -- restores quantifiers in rule specifications *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inductive_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>intrs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intrs_gen</span></span><span class="main"><span>,</span></span><span> elims </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>elim_gen</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> preds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="entity"><span>Rdef</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Proof_Context.concealed</span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Inductive.add_inductive</span></span><span>
          </span><span class="main"><span>{</span></span><span>quiet_mode </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
            verbose </span><span class="main"><span>=</span></span><span> </span><span>!</span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span>
            alt_name </span><span class="main"><span>=</span></span><span> </span><span>Binding.empty</span><span class="main"><span>,</span></span><span>
            coind </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
            no_elim </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
            no_ind </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
            skip_mono </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>binding</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* relation *)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* no parameters *)</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* intro rules *)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* no special monos *)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Proof_Context.restore_naming</span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>requantify</span></span><span> </span><span class="entity"><span>orig_intro</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_all_all</span></span><span> </span><span class="entity"><span>orig_intro</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_frees</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varmap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frees</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>forall_intr_rename</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varmap</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Rdef</span></span><span class="main"><span>,</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>requantify</span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="entity"><span>intrs_gen</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.forall_intr_vars</span><span> </span><span class="entity"><span>elim_gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_graph</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>RCss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>G_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_type</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_GIntro</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_h_assm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rcarg</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcassm</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcfix</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_h_assm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>G_intros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_GIntro</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>RCss</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>inductive_def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>G_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>G_intros</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_function</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_def_binding</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.make_def_binding</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>function_internals</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>derived_name_suffix</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="inner_quoted"><span>"_sumC"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_def</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.THE_default|const"><span>Fun_Def.THE_default</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span>--&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ranT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.define</span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.map_name</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="inner_quoted"><span>"C"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f_def_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_recursion_relation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qglrs</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>RCss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>R_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_type</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_RIntro</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rcarg</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcassm</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcfix</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* "!!qs xs. CS ==&gt; G =&gt; (r, lhs) : R" *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R_intross</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_RIntro</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clauses</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qglrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCss</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RIntro_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_elim</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>inductive_def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>R_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>R_intross</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span>Library.unflat</span><span> </span><span class="entity"><span>R_intross</span></span><span> </span><span class="entity"><span>RIntro_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_elim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix_globals</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pbool</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span>
      </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"h_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"y_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"x_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"z_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"a_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"D_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"P_fd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Pb_fd"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span>h </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      y </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      x </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      z </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      a </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      D </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      P </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      Pbool </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pbool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      fvar </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span>
      domT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span>
      ranT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ranT</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_RC</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bound</span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span>abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>rcfix</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>inst_term</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rcassm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst_term</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="comment1"><span>(**********************************************************
 *                   PROVING THE RULES
 **********************************************************)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_psimps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>valthms</span></span><span> </span><span class="entity"><span>f_iff</span></span><span> </span><span class="entity"><span>graph_is_function</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_psimp</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>qglr </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> cdata </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>valthm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_acc</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "acc R lhs" *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z_smaller</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "R z lhs" *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>z_smaller</span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>lhs_acc</span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>acc_downward</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>graph_is_function</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>z_smaller</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>  </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>valthm</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>lhs_acc</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>asm_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f_iff</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>forall_intr_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map2</span><span> </span><span class="entity"><span>mk_psimp</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>valthms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** Induction rule **)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc_subset_induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.predicate1I|fact"><span>predicate1I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.accp_subset_induct|fact"><span>accp_subset_induct</span></a><span class="antiquote"><span>}</span></span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_partial_induct_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>complete_thm</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>D_subset</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc_R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>D_dcl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(* "!!x z. [| x: D; (z,x):R |] ==&gt; z:D" *)</span></span><span>
      </span><span>Logic.all</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="comment1"><span>(* Inductive Hypothesis: !!z. (z,x):R ==&gt; P z *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.all_const</span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"z"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span>
      </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aihyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>ihyp</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_case</span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>cdata </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span>ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>RCs</span></span><span class="main"><span>,</span></span><span> qglr </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_hyp_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_hyp</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>eq_reflection</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_hyp_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x_D</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sih</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>fconv_rule</span><span>
              </span><span class="main"><span>(</span></span><span>binder_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>arg1_conv</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="entity"><span>case_hyp_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aihyp</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_Prec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RCInfo</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>llRI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RIvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>CCas</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sih</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rcarg</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>llRI</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>CCas</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RIvs</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_Prec</span></span><span> </span><span class="entity"><span>RCs</span></span><span>   </span><span class="comment1"><span>(*  [P rec1, P rec2, ... ]  *)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P_recs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>step</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>lhs_D</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>ags</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>P_recs</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>case_hyp_conv</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.symmetric</span><span> </span><span class="comment1"><span>(* P lhs == P x *)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eql</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.equal_elim</span><span> </span><span class="entity"><span>eql</span></span><span> </span><span class="entity"><span>P_lhs</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* "P x" *)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>cqs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>res</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>prove_case</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>istep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>complete_thm</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cases</span></span><span> </span><span class="comment1"><span>(*  P x  *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ihyp</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>x_D</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subset_induct_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>acc_subset_induct</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>D_subset</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>D_dcl</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>a_D</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>istep</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>a_D</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>D_dcl</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>D_subset</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simple_induct_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>subset_induct_rule</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>acc_R</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc_downward</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>simple_induct_rule</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* FIXME: broken by design *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_domain_intro</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R_cases</span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>cdata </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      qglr </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.init</span><span> </span><span class="entity"><span>goal</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>accI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>R_cases</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span>|&gt;</span><span> </span><span>Goal.conclude</span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>forall_intr_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="comment1"><span>(** Termination rule **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wf_induct_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.wfP_induct_rule|fact"><span>Wellfounded.wfP_induct_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wf_in_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.wf_in_rel|fact"><span>Fun_Def.wf_in_rel</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_rel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.in_rel_def|fact"><span>Fun_Def.in_rel_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_nest_term_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ClauseInfo</span></span><span> </span><span class="main"><span>{</span></span><span>cdata </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ags</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tree</span></span><span class="main"><span>,</span></span><span>
      qglr</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>oqs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ih_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_hyp</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ihyp</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>sub</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Function_Context_Tree.export_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctx</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="comment1"><span>(* additional hyps *)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Function_Context_Tree.export_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumes</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.mk_implies</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ags</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_forall_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>hyp</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="entity"><span>cqs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>ags</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Function_Context_Tree.import_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumes</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.elim_implies</span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="comment1"><span>(*  "(arg, lhs) : R'"  *)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z_eq_arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.assume</span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>ih_case</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z_acc_local</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>acc</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span>
              </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z_eq_arg</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>eq_reflection</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ethm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>z_acc_local</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Function_Context_Tree.export_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>z_eq_arg</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>case_hyp</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ags</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>assumes</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>forall_intr_rename</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oqs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>cqs</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sub'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sub</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>sub'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyp</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ethm</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Function_Context_Tree.traverse_tree</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>tree</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_nest_term_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R_cases</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>acc_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Rn</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"R"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rn</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Rrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inrel_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun_Def.html#Fun_Def.in_rel|const"><span>Fun_Def.in_rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>Rrel</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wfR'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Wellfounded.html#Wellfounded.wfP|const"><span>Wellfounded.wfP</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="comment1"><span>(* "wf R'" *)</span></span><span>

    </span><span class="comment1"><span>(* Inductive Hypothesis: !!z. (z,x):R' ==&gt; z : acc R *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.all_const</span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"z"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span class="main"><span>,</span></span><span>
      </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R'</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc_R</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ihyp_a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>ihyp</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R_z_x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cases</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_nest_term_case</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>ihyp_a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>R_cases</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc_R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>R_z_x</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>COMP</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cases</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>R_z_x</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>accI</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ihyp</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.compose</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>it</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wf_induct_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>wfR'</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr_vars</span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>it</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>allI</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>hyps</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>wfR'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>inrel_R</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>wf_in_rel</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>in_rel_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.forall_intr_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"R"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>Rrel</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_function</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>FunctionConfig</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>domintros</span></span><span class="main"><span>,</span></span><span> default</span><span class="main"><span>=</span></span><span class="entity"><span>default_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>config</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="inner_quoted"><span>"%x. HOL.undefined"</span></span><span> </span><span class="comment1"><span>(* FIXME proper term!? *)</span></span><span> </span><span class="entity"><span>default_opt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>fT</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>fT</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>default_str</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Type.constraint</span><span> </span><span class="entity"><span>fT</span></span><span> </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>globals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fix_globals</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Globals</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>globals</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_clause_context</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_tree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ClauseContext</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="entity"><span>Function_Context_Tree.mk_tree</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rhs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>build_tree</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RCss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>find_calls</span></span><span> </span><span class="entity"><span>trees</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>GIntro_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_elim</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_induct</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"def_graph"</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>define_graph</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>derived_name_suffix</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="inner_quoted"><span>"_graph"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>RCss</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_defthm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"def_fun"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>define_function</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>default</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RCss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_RC</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RCss</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Function_Context_Tree.inst_tree</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trees</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RIntro_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R_elim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"def_rel"</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>define_recursion_relation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derived_name_suffix</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="inner_quoted"><span>"_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>domT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>boolT</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>abstract_qglrs</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>RCss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_acc</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>R</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Local_Theory.abbrev</span><span> </span><span>Syntax.mode_default</span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>derived_name_suffix</span></span><span> </span><span class="entity"><span>defname</span></span><span> </span><span class="inner_quoted"><span>"_dom"</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_clause_ctx</span></span><span> </span><span class="entity"><span>newthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xclauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"xclauses"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 7</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_clause_info</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span> </span><span class="entity"><span>trees</span></span><span>
        </span><span class="entity"><span>RCss</span></span><span> </span><span class="entity"><span>GIntro_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RIntro_thmss</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_completeness</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.assume</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_compat_proof_obligations</span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="entity"><span>ranT</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>fvar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>abstract_qglrs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.assume</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat_store</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>store_compat_thms</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>compat</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goalstate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>values</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"prove_stuff"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>prove_stuff</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>xclauses</span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span class="entity"><span>compat</span></span><span>
         </span><span class="entity"><span>compat_store</span></span><span> </span><span class="entity"><span>G_elim</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_defthm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_partial_rules</span></span><span> </span><span class="entity"><span>newctxt</span></span><span> </span><span class="entity"><span>provedgoal</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>graph_is_function</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>provedgoal</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Conjunction.elim</span><span>
          </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_elim_vars</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_iff</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>graph_is_function</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_defthm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>ex1_implies_iff</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>psimps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"Proving simplification rules"</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_psimps</span></span><span> </span><span class="entity"><span>newctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>xclauses</span></span><span> </span><span class="entity"><span>values</span></span><span> </span><span class="entity"><span>f_iff</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>graph_is_function</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simple_pinduct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"Proving partial induction rule"</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_partial_induct_rule</span></span><span> </span><span class="entity"><span>newctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>complete_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xclauses</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>total_intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"Proving nested termination rule"</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_nest_term_rule</span></span><span> </span><span class="entity"><span>newctxt</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R_elim</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xclauses</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_intros</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>domintros</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PROFILE</span></span><span> </span><span class="inner_quoted"><span>"Proving domain introduction rules"</span></span><span>
             </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_domain_intro</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R_elim</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xclauses</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>FunctionResult</span></span><span> </span><span class="main"><span>{</span></span><span>fs</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> G</span><span class="main"><span>=</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span> R</span><span class="main"><span>=</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> dom</span><span class="main"><span>=</span></span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span>
          cases</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="entity"><span>complete_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> psimps</span><span class="main"><span>=</span></span><span class="entity"><span>psimps</span></span><span class="main"><span>,</span></span><span> pelims</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          simple_pinducts</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="entity"><span>simple_pinduct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          termination</span><span class="main"><span>=</span></span><span class="entity"><span>total_intro</span></span><span class="main"><span>,</span></span><span> domintros</span><span class="main"><span>=</span></span><span class="entity"><span>dom_intros</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goalstate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_partial_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>