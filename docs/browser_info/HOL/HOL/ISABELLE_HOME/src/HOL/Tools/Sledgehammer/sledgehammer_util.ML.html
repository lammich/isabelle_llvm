<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_util.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_util.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_util.ML
    Author:     Jasmin Blanchette, TU Muenchen

General-purpose functions used by the Sledgehammer modules.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_UTIL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sledgehammerN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> log2 </span><span class="main"><span>:</span></span><span> </span><span>real</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>real</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> app_hd </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> plural_s </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> serial_commas </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplify_spaces </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_cleanup </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'b
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_bool_option </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_time </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subgoal_count </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thms_in_proof </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>Symtab.table</span><span> * </span><span>string</span><span> </span><span>Symtab.table</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> </span><span>list</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thms_of_name </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> one_day </span><span class="main"><span>:</span></span><span> </span><span>Time.time</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> one_year </span><span class="main"><span>:</span></span><span> </span><span>Time.time</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hackish_string_of_term </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> spying </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> * </span><span>int</span><span> * </span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Util</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_UTIL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sledgehammerN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sledgehammer"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>log10_2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Math.log10</span><span> </span><span class="inner_numeral"><span>2.0</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>log2</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Math.log10</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>log10_2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app_hd</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>plural_s</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"s"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_commas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Try.serial_commas</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simplify_spaces</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_spaces</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_cleanup</span></span><span> </span><span class="entity"><span>clean_up</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Exn.capture</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>clean_up</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Exn.release</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_bool_option</span></span><span> </span><span class="entity"><span>option</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span class="inner_quoted"><span>"smart"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>option</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Option.Option</span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"false"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"true"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Option.Option</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>option</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="inner_quoted"><span>"smart"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"true"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"false"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Parameter "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" must be assigned "</span></span><span> </span><span>^</span><span>
       </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>serial_commas</span></span><span> </span><span class="inner_quoted"><span>"or"</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_junk</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Symbol.is_digit</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>"."</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>raw_explode</span><span> </span><span class="comment1"><span>(* FIXME Symbol.explode (?) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_time</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>secs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_junk</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Real.fromString</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>secs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>the</span><span> </span><span class="entity"><span>secs</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0.0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Parameter "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" must be assigned a nonnegative number of seconds \
        \(e.g., \"60\", \"0.5\") or \"none\""</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span>seconds</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>secs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.count_prems</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>goal </span><span>o</span><span> </span><span class="entity"><span>Proof.goal</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>TOO_MANY</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span>

</span><span class="comment1"><span>(* FIXME: Similar yet different code in "mirabelle.ML". The code here has a few fixes that seem to
   be missing over there; or maybe the two code portions are not doing the same? *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_body_thm</span></span><span> </span><span class="entity"><span>max_thms</span></span><span> </span><span class="entity"><span>outer_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_plain_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_inclass_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app_thm</span></span><span> </span><span class="entity"><span>map_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm_node</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proofterm.thm_node_name</span><span> </span><span class="entity"><span>thm_node</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proofterm.thm_node_body</span><span> </span><span class="entity"><span>thm_node</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>anonymous</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>enter_class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="comment1"><span>(* The "name = outer_name" case caters for the uncommon case where the proved theorem
             occurs in its own proof (e.g., "Transitive_Closure.trancl_into_trancl"). *)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>outer_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>map_inclass_name</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>outer_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>anonymous</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Future.peek</span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Exn.Res</span><span> </span><span class="entity"><span>the_body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>app_body</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>enter_class</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>map_inclass_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>map_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>the_body</span></span><span> </span><span class="entity"><span>accum</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>map_name</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_MANY</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_thms</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>app_body</span></span><span> </span><span class="entity"><span>map_name</span></span><span> </span><span class="main"><span>(</span></span><span>PBody</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_thm</span></span><span> </span><span class="entity"><span>map_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_body</span></span><span> </span><span class="entity"><span>map_plain_name</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thms_in_proof</span></span><span> </span><span class="entity"><span>max_thms</span></span><span> </span><span class="entity"><span>name_tabs</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>Thm.proof_body_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>name_tabs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apply2</span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>`</span><span>I</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_body_thm</span></span><span> </span><span class="entity"><span>max_thms</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.get_name_hint</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>map_names</span></span><span> </span><span class="main"><span>(</span></span><span>Proofterm.strip_thm_body</span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>TOO_MANY</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thms_of_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.get_fact</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thy_Header.get_keywords'</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Symbol_Pos.explode</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Position.start</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Token.tokenize</span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>{</span></span><span>strict </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span>Token.is_proper</span><span>
    </span><span>|&gt;</span><span> </span><span>Source.of_list</span><span>
    </span><span>|&gt;</span><span> </span><span>Source.source</span><span> </span><span>Token.stopper</span><span> </span><span class="main"><span>(</span></span><span>Parse.thms1</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>get</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Source.exhaust</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_day</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>24.0</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>60.0</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>60.0</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_year</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>365.0</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>24.0</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>60.0</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>60.0</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hackish_string_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(* FIXME: map_aterms (fn Free (s, T) =&gt; Free (if Name.is_internal s then "_" else s, T) | t =&gt; t)
  #&gt; *)</span></span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>YXML.content_of</span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>simplify_spaces</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spying_version</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"d"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span>false</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>message</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.get_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>goal </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.goal</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span>SHA1.rep</span><span> </span><span class="main"><span>(</span></span><span>SHA1.digest</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hackish_string_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>12</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>File.append</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="inner_quoted"><span>"$ISABELLE_HOME_USER/spy_sledgehammer"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>spying_version</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>timestamp</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>hash</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>tool</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>message</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>