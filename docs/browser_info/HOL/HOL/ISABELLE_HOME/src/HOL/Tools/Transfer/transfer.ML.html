<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Transfer/transfer.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Transfer/transfer.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Transfer/transfer.ML
    Author:     Brian Huffman, TU Muenchen
    Author:     Ondrej Kuncar, TU Muenchen

Generic theorem transfer method.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>TRANSFER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pred_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_pred_data</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rel_eq_onp</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pred_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pred_simps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_pred_simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prep_conv</span><span class="main"><span>:</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_relator_eqs_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_relator_eqs_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_transfer_raw</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_relator_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> retrieve_relator_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_sym_relator_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_relator_eq_raw</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_relator_domain</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morph_pred_data</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_pred_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_pred_data</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_compound_lhs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_compound_rhs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_add</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_del</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_raw_add</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_raw_del</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transferred_attribute</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> untransferred_attribute</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prep_transfer_domain_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_domain_add</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_domain_del</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_rule_of_term</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_rule_of_lhs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_start_tac</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_prover_start_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_end_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_prover_end_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_tac</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_prover_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_frees_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Transfer</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TRANSFER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>


</span><span class="comment1"><span>(** Theory Data **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compound_xhs_empty_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span>Thm.eq_thm_prop</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewr_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.init</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span>
  </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRED_DATA</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>pred_def</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span> rel_eq_onp</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span> pred_simps</span><span class="main"><span>:</span></span><span> thm list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_pred_data</span></span><span> </span><span class="entity"><span>pred_def</span></span><span> </span><span class="entity"><span>rel_eq_onp</span></span><span> </span><span class="entity"><span>pred_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRED_DATA</span></span><span> </span><span class="main"><span>{</span></span><span>pred_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_def</span></span><span class="main"><span>,</span></span><span> 
  rel_eq_onp </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_eq_onp</span></span><span class="main"><span>,</span></span><span> pred_simps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_simps</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_pred_data'</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PRED_DATA</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pred_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_eq_onp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_simps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>PRED_DATA</span></span><span> </span><span class="main"><span>{</span></span><span>pred_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>pred_def</span></span><span class="main"><span>,</span></span><span> rel_eq_onp </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>rel_eq_onp</span></span><span class="main"><span>,</span></span><span> pred_simps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>pred_simps</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rep_pred_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PRED_DATA</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_eq_onp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rel_eq_onp </span><span>o</span><span> </span><span class="entity"><span>rep_pred_data</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pred_def </span><span>o</span><span> </span><span class="entity"><span>rep_pred_data</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pred_simps </span><span>o</span><span> </span><span class="entity"><span>rep_pred_data</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_pred_simps</span></span><span> </span><span class="entity"><span>new_pred_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_pred_data'</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>new_pred_data</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      known_frees </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
      compound_lhs </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      compound_rhs </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      relator_eq </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      relator_eq_raw </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      relator_domain </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      pred_data </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>=</span></span><span> </span><span>Thm.item_net_intro</span><span class="main"><span>,</span></span><span>
      known_frees </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      compound_lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compound_xhs_empty_net</span></span><span class="main"><span>,</span></span><span>
      compound_rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compound_xhs_empty_net</span></span><span class="main"><span>,</span></span><span>
      relator_eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewr_rules</span></span><span class="main"><span>,</span></span><span>
      relator_eq_raw </span><span class="main"><span>=</span></span><span> </span><span>Thm.item_net</span><span class="main"><span>,</span></span><span>
      relator_domain </span><span class="main"><span>=</span></span><span> </span><span>Thm.item_net</span><span class="main"><span>,</span></span><span>
      pred_data </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span>
    </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> known_frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span>
        compound_lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span>
        compound_rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> relator_eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span>
        relator_eq_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rw1</span></span><span class="main"><span>,</span></span><span> relator_domain </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span>
        pred_data </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pd1</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> known_frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span>
        compound_lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span>
        compound_rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span> relator_eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>,</span></span><span>
        relator_eq_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rw2</span></span><span class="main"><span>,</span></span><span> relator_domain </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>,</span></span><span>
        pred_data </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pd2</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      known_frees </span><span class="main"><span>=</span></span><span> </span><span>Library.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      compound_lhs </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      compound_rhs </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      relator_eq </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      relator_eq_raw </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rw1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rw2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      relator_domain </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      pred_data </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pd1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pd2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>}</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.content</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="main"><span>#</span></span><span>transfer_raw

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_known_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>known_frees </span><span>o</span><span> </span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_compound</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.retrieve</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_compound_lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_compound</span></span><span> </span><span class="main"><span>#</span></span><span>compound_lhs
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_compound_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_compound</span></span><span> </span><span class="main"><span>#</span></span><span>compound_rhs

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_relator_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="main"><span>#</span></span><span>relator_eq </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>safe_mk_meta_eq</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>retrieve_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.retrieve</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>relator_eq </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_sym_relator_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="main"><span>#</span></span><span>relator_eq </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_mk_meta_eq</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.symmetric</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="main"><span>#</span></span><span>relator_eq_raw

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_relator_domain</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_net_content</span></span><span> </span><span class="main"><span>#</span></span><span>relator_domain

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_pred_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pred_data </span><span>o</span><span> </span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>f6</span></span><span> </span><span class="entity"><span>f7</span></span><span> </span><span class="entity"><span>f8</span></span><span>
  </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>transfer_raw</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>known_frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compound_lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compound_rhs</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>relator_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relator_eq_raw</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relator_domain</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span> transfer_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>transfer_raw</span></span><span class="main"><span>,</span></span><span>
    known_frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>known_frees</span></span><span class="main"><span>,</span></span><span>
    compound_lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>compound_lhs</span></span><span class="main"><span>,</span></span><span>
    compound_rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>compound_rhs</span></span><span class="main"><span>,</span></span><span>
    relator_eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>relator_eq</span></span><span class="main"><span>,</span></span><span>
    relator_eq_raw </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f6</span></span><span> </span><span class="entity"><span>relator_eq_raw</span></span><span class="main"><span>,</span></span><span>
    relator_domain </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f7</span></span><span> </span><span class="entity"><span>relator_domain</span></span><span class="main"><span>,</span></span><span>
    pred_data </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f8</span></span><span> </span><span class="entity"><span>pred_data</span></span><span> </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_transfer_raw</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_known_frees</span></span><span>    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_compound_lhs</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_compound_rhs</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_relator_eq</span></span><span>     </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_relator_eq_raw</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_relator_domain</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_pred_data</span></span><span>      </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_transfer_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.trim_context</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Data.map</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>map_transfer_raw</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
     </span><span class="entity"><span>map_compound_lhs</span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Item_Net.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
     </span><span class="entity"><span>map_compound_rhs</span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Item_Net.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
     </span><span class="entity"><span>map_known_frees</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_transfer_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>map_transfer_raw</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.remove</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
   </span><span class="entity"><span>map_compound_lhs</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Item_Net.remove</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
   </span><span class="entity"><span>map_compound_rhs</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Item_Net.remove</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_raw_add</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_transfer_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_raw_del</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>del_transfer_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(** Conversions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_rel_conv</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.fun2_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Rel_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.symmetric</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel_def|fact"><span>Rel_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>Rel_conv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cT'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_funT</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cU</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_funT</span><span> </span><span class="entity"><span>cT'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cU</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>Rel_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Conversion to preprocess a transfer rule *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_Rel_conv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Conv.try_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.fun_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.fun_conv</span><span> </span><span class="entity"><span>Rel_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_conv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Conv.implies_conv</span><span> </span><span class="entity"><span>safe_Rel_conv</span></span><span> </span><span class="entity"><span>prep_conv</span></span><span>
      </span><span>else_conv</span><span>
      </span><span class="entity"><span>safe_Rel_conv</span></span><span>
      </span><span>else_conv</span><span>
      </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_relator_eqs_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.bottom_rewrs_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_relator_eqs_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.top_rewrs_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_sym_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


</span><span class="comment1"><span>(** Replacing explicit equalities with is_equality premises **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_is_equality</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.is_equality|const"><span>is_equality</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_abstract_equalities</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_prop'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="comment1"><span>(* Only consider "(=)" at non-base types *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eqs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq_consts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqTs</span></span><span> </span><span>|&gt;</span><span> </span><span>Name.variant_list</span><span> </span><span class="entity"><span>used</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>eqTs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_is_equality</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_prop'</span></span><span> </span><span class="main"><span>(</span></span><span>Term.subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_consts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equal_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.is_equality_lemma|fact"><span>is_equality_lemma</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>cprop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forall_elim</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>forall_elim</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>COMP</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equal_thm</span></span><span> </span><span>COMP</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><span>equal_elim_rule2</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_equalities_transfer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span>Term.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_comb</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rel'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>contracted_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_rel_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_relator_eqs_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>gen_abstract_equalities</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>contracted_eq_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_equalities_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rel_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_abstract_equalities</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>rel_eq_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.is_equality_def|fact"><span>is_equality_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.iffD2|fact"><span>iffD2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_equalities_domain</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span>Term.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_comb</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>dom'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>dom'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_rel_conv</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>contracted_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_rel_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_relator_eqs_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>gen_abstract_equalities</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>contracted_eq_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** Replacing explicit Domainp predicates with Domainp assumptions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_Domainp_assm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.Domainp|const"><span>Domainp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.Domainp|const"><span>Domainp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_terms</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_terms</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_terms</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_terms</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_abstract_domains</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_prop'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Domainp_tms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_Domainp</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Domainp_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_funT</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Domainp_tms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Domainp_tms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Var</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rels</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"D"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_names</span></span><span> </span><span>|&gt;</span><span> </span><span>Name.variant_list</span><span> </span><span class="entity"><span>used</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Domainp_Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_Domainp_assm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rels</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_terms</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Domainp_tms</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span>Termtab.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_prop'</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_rename_params</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equal_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Domainp_lemma|fact"><span>Domainp_lemma</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>cprop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forall_elim</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>forall_elim</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>COMP</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equal_thm</span></span><span> </span><span>COMP</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><span>equal_elim_rule2</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_domains_transfer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span>Term.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_comb</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>gen_abstract_domains</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_domains_relator_domain</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span>Term.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_comb</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>gen_abstract_domains</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>detect_transfer_rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_transfer_rule</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.Domainp|const"><span>Domainp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_transfer_rule_conv</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_transfer_rule</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>safe_Rel_conv</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.prems_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>safe_transfer_rule_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Adding transfer domain rules **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_transfer_domain_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>abstract_equalities_domain</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>detect_transfer_rules</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_transfer_domain_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>add_transfer_thm</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_transfer_domain_thm</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_transfer_domain_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>del_transfer_thm</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_transfer_domain_thm</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(** Transfer proof method **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>post_simps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall_eq|fact"><span>transfer_forall_eq</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span>
    </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies_eq|fact"><span>transfer_implies_eq</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_bforall_unfold|fact"><span>transfer_bforall_unfold</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_frees_tac</span></span><span> </span><span class="entity"><span>keepers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keepers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>keepers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>get_known_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>keepers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Induct.arbitrary_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_relT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_Rel</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Transfer.Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_rule_of_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prj</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* precondition: prj(T,U) must consist of only TFrees and type "fun" *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>U1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>U1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>U2</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>r1</span></span><span> </span><span>--&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>r2</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>mk_relT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.rel_fun|const"><span>rel_fun</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r2</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_relT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>cprop</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm0</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span>Thm.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_comb</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cprop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_fun2</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span>Thm.dest_funT</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_funT</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span>Thm.dest_funT</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_funT</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tinsts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b1</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b2</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="entity"><span>tinsts</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel_abs|fact"><span>Rel_abs</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm1</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel_app|fact"><span>Rel_app</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hyps2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>u</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>cprop</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cprop</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.trivial</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Drule.implies_intr_list</span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>rename</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* create a lambda term of the same shape as the given term *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skeleton</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dummy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="inner_quoted"><span>"a"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tu</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>tu</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.is_open</span><span> </span><span class="entity"><span>tu</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dummy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>skel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skel</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>  </span><span class="comment1"><span>(* FIXME avoid syntax operation!? *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Monotonicity analysis **)</span></span><span>

</span><span class="comment1"><span>(* TODO: Put extensible table in theory data *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>monotab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.make</span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies|const"><span>transfer_implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall|const"><span>transfer_forall</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="comment1"><span>(*,
     (@{const_name implies}, [~1, 1]),
     (@{const_name All}, [1])*)</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(*
Function bool_insts determines the set of boolean-relation variables
that can be instantiated to implies, rev_implies, or iff.

Invariants: bool_insts p (t, u) requires that
  u :: _ =&gt; _ =&gt; ... =&gt; bool, and
  t is a skeleton of u
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bool_insts</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>strip2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tus</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip2</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>or3</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_TFree</span><span> </span><span class="main"><span>(</span></span><span>Term.body_type</span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>monotab</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab1</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ps_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tus</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>fold</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>go</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps'</span></span><span> </span><span class="entity"><span>tus</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tab</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>ps_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Symtab.join</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>or3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>go</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.rev_implies|const"><span>rev_implies</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span>                         </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map_filter</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_rule_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skeleton</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_compound_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfrees</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"R"</span></span><span> </span><span>^</span><span> </span><span>Library.unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span class="entity"><span>a</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rnames</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rule_of_terms</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binsts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bool_insts</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tinst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">ctyp</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.clean_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.generalize</span><span> </span><span class="main"><span>(</span></span><span>Names.make_set</span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>,</span></span><span> </span><span>Names.make_set</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>tinst</span></span><span> </span><span class="entity"><span>binsts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>binsts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_rule_of_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skeleton</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_compound_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfrees</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"R"</span></span><span> </span><span>^</span><span> </span><span>Library.unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span class="entity"><span>a</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rnames</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rule_of_terms</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binsts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bool_insts</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tinst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">ctyp</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.clean_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.generalize</span><span> </span><span class="main"><span>(</span></span><span>Names.make_set</span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>,</span></span><span> </span><span>Names.make_set</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>tinst</span></span><span> </span><span class="entity"><span>binsts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>binsts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>TRY</span><span> </span><span>o</span><span> </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span class="main"><span>)</span></span><span>
  </span><span>THEN_ALL_NEW</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.is_equality_eq|fact"><span>is_equality_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_start_tac</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall_eq|fact"><span>transfer_forall_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies_eq|fact"><span>transfer_implies_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>start_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_start|fact"><span>transfer_start</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_start&apos;|fact"><span>transfer_start'</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Transfer failed to convert goal to an object-logic formula"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>main_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>start_rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
        </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>transfer_rule_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>err_msg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>EVERY</span><span>
        </span><span class="main"><span>[</span></span><span>rewrite_goal_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pre_simps</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
         </span><span>SUBGOAL</span><span> </span><span class="entity"><span>main_tac</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_prover_start_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Term.dest_comb</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rule_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expand_eqs_in_rel_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rel_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_relator_eqs_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>EVERY</span><span>
      </span><span class="main"><span>[</span></span><span>CONVERSION</span><span> </span><span class="entity"><span>prep_conv</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
       </span><span>CONVERSION</span><span> </span><span class="entity"><span>expand_eqs_in_rel_conv</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
       </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_prover_start|fact"><span>transfer_prover_start</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
       </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule1</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>post_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall_eq|fact"><span>transfer_forall_eq</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span>
      </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies_eq|fact"><span>transfer_implies_eq</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_bforall_unfold|fact"><span>transfer_bforall_unfold</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>rewrite_goal_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>post_simps</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
           </span><span>Goal.norm_hhf_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_prover_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.refl|fact"><span>refl</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>i</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> THEN_ALL_BUT_FIRST_NEW
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac1</span></span><span> </span><span class="entity"><span>THEN_ALL_BUT_FIRST_NEW</span></span><span> </span><span class="entity"><span>tac2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>st</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac1</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Seq.INTERVAL</span><span> </span><span class="entity"><span>tac2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st'</span></span><span> </span><span>-</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_tac</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="comment1"><span>(* allow unsolved subgoals only for standard transfer method, not for transfer' *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>end_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>all_tac</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span>no_tac</span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_search_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>SOLVED'</span><span>
          </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span>
            </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>ORELSE'</span><span> </span><span class="entity"><span>end_tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_start_tac</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
        </span><span class="entity"><span>THEN_ALL_BUT_FIRST_NEW</span></span><span> </span><span class="entity"><span>transfer_search_tac</span></span><span>
        </span><span>THEN'</span><span> </span><span class="entity"><span>transfer_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_prover_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_prover_search_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span>
          </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_prover_start_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
       </span><span class="entity"><span>THEN_ALL_BUT_FIRST_NEW</span></span><span> </span><span class="entity"><span>transfer_prover_search_tac</span></span><span>
       </span><span>THEN'</span><span> </span><span class="entity"><span>transfer_prover_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** Transfer attribute **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transferred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>extra_rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall_eq|fact"><span>transfer_forall_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies_eq|fact"><span>transfer_implies_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_intr_vars</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instT</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvars</span><span> </span><span class="main"><span>(</span></span><span>Thm.full_prop_of</span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm1</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Raw_Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pre_simps</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_names</span><span> </span><span class="main"><span>(</span></span><span>Thm.full_prop_of</span><span> </span><span class="entity"><span>thm2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rule_of_lhs</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm2</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_start&apos;|fact"><span>transfer_start'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_start|fact"><span>transfer_start</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>
          </span><span>THEN_ALL_NEW</span><span>
            </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
              </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Transfer failed to convert goal to an object-logic formula"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Raw_Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>post_simps</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Simplifier.norm_hhf</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.generalize</span><span>
        </span><span class="main"><span>(</span></span><span>Names.make_set</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_TFree</span><span> </span><span>o</span><span> </span><span>Thm.typ_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Names.empty</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="comment1"><span>(*
    handle THM _ =&gt; thm
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>untransferred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>extra_rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_relator_eq_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_forall_eq|fact"><span>transfer_forall_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.transfer_implies_eq|fact"><span>transfer_implies_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_intr_vars</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instT</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvars</span><span> </span><span class="main"><span>(</span></span><span>Thm.full_prop_of</span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm1</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Raw_Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pre_simps</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_names</span><span> </span><span class="main"><span>(</span></span><span>Thm.full_prop_of</span><span> </span><span class="entity"><span>thm2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rule_of_term</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm2</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.untransfer_start|fact"><span>untransfer_start</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>
          </span><span>THEN_ALL_NEW</span><span>
            </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
              </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>eq_rules_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>eq_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Transfer failed to convert goal to an object-logic formula"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Raw_Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>post_simps</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Simplifier.norm_hhf</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.generalize</span><span>
        </span><span class="main"><span>(</span></span><span>Names.make_set</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_TFree</span><span> </span><span>o</span><span> </span><span>Thm.typ_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Names.empty</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Methods and attributes **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Args.context</span><span> </span><span>--</span><span> </span><span>Args.term</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad free variable: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixing</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"fixing"</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span class="main"><span>)</span></span><span>
  </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>free</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reverse_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>PRIMITIVE</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.permute_prems</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_start_method</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>fixing</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_frees_tac</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>transfer_start_tac</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>THEN'</span><span> </span><span class="entity"><span>reverse_prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_method</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>fixing</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_frees_tac</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>transfer_tac</span></span><span> </span><span class="entity"><span>equiv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_prover_start_method</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_prover_start_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>reverse_prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_prover_method</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_prover_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Attribute for transfer rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>abstract_domains_transfer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>abstract_equalities_transfer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="entity"><span>prep_conv</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_add</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>add_transfer_thm</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_rule</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_del</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>del_transfer_thm</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_rule</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_attribute</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.add_del</span></span><span> </span><span class="entity"><span>transfer_add</span></span><span> </span><span class="entity"><span>transfer_del</span></span><span>

</span><span class="comment1"><span>(* Attributes for transfer domain rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_domain_add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_transfer_domain_thm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_domain_del</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>del_transfer_domain_thm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_domain_attribute</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.add_del</span></span><span> </span><span class="entity"><span>transfer_domain_add</span></span><span> </span><span class="entity"><span>transfer_domain_del</span></span><span>

</span><span class="comment1"><span>(* Attributes for transferred rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transferred_attribute</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.rule_attribute</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>transferred</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>untransferred_attribute</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.rule_attribute</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>untransferred</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transferred_attribute_parser</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.thms</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>transferred_attribute</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>untransferred_attribute_parser</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.thms</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>untransferred_attribute</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_pred_data</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morph_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>map_pred_data'</span></span><span> </span><span class="entity"><span>morph_thm</span></span><span> </span><span class="entity"><span>morph_thm</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>morph_thm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_pred_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pred_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_name</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morph_pred_data</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.transfer_morphism'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_pred_data</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_pred_data</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(* Theory setup *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.relator_eq|attribute"><span class="entity_def" id="Transfer.relator_eq|fact"><span>relator_eq</span></span></span><span>›</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>context</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_eq_raw</span></span><span>
            </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span>
              </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_equalities_relator_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.remove</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_eq_raw</span></span><span>
            </span><span class="main"><span>(</span></span><span>Item_Net.remove</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_equalities_relator_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>del_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"declaration of relator equality rule (used by transfer method)"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.content</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>relator_eq </span><span>o</span><span> </span><span>Data.get</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.add_del</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>del</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.relator_domain|attribute"><span class="entity_def" id="Transfer.relator_domain|fact"><span>relator_domain</span></span></span><span>›</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>abstract_domains_relator_domain</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.trim_context</span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>context</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_domain</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>add_transfer_domain_thm</span></span><span> </span><span class="entity"><span>thm'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abstract_domains_relator_domain</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>context</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_domain</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.remove</span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>del_transfer_domain_thm</span></span><span> </span><span class="entity"><span>thm'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>del_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"declaration of relator domain rule (used by transfer method)"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.content</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>relator_domain </span><span>o</span><span> </span><span>Data.get</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.add_del</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>del</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>content</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_rule|attribute"><span>transfer_rule</span></span><span>›</span></span></span><span> </span><span class="entity"><span>transfer_attribute</span></span><span>
       </span><span class="inner_quoted"><span>"transfer rule for transfer method"</span></span><span>
    </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_raw|fact"><span>transfer_raw</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span>Item_Net.content</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>transfer_raw </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_domain_rule|attribute"><span>transfer_domain_rule</span></span><span>›</span></span></span><span> </span><span class="entity"><span>transfer_domain_attribute</span></span><span>
       </span><span class="inner_quoted"><span>"transfer domain rule for transfer method"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transferred|attribute"><span>transferred</span></span><span>›</span></span></span><span> </span><span class="entity"><span>transferred_attribute_parser</span></span><span>
       </span><span class="inner_quoted"><span>"raw theorem transferred to abstract theorem using transfer rules"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.untransferred|attribute"><span>untransferred</span></span><span>›</span></span></span><span> </span><span class="entity"><span>untransferred_attribute_parser</span></span><span>
       </span><span class="inner_quoted"><span>"abstract theorem transferred to raw theorem using transfer rules"</span></span><span>
    </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.relator_eq_raw|fact"><span>relator_eq_raw</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span>Item_Net.content</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>relator_eq_raw </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_start|method"><span>transfer_start</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_start_method</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"firtst step in the transfer algorithm (for debugging transfer)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_start&apos;|method"><span>transfer_start'</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_start_method</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"firtst step in the transfer algorithm (for debugging transfer)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_prover_start|method"><span>transfer_prover_start</span></span><span>›</span></span></span><span> </span><span class="entity"><span>transfer_prover_start_method</span></span><span>
       </span><span class="inner_quoted"><span>"firtst step in the transfer_prover algorithm (for debugging transfer_prover)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_step|method"><span>transfer_step</span></span><span>›</span></span></span><span>
       </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"step in the search for transfer rules (for debugging transfer and transfer_prover)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_end|method"><span>transfer_end</span></span><span>›</span></span></span><span>
       </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"last step in the transfer algorithm (for debugging transfer)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_prover_end|method"><span>transfer_prover_end</span></span><span>›</span></span></span><span>
       </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_prover_end_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"last step in the transfer_prover algorithm (for debugging transfer_prover)"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer|method"><span>transfer</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_method</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"generic theorem transfer method"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer&apos;|method"><span>transfer'</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_method</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
       </span><span class="inner_quoted"><span>"generic theorem transfer method"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Transfer.transfer_prover|method"><span>transfer_prover</span></span><span>›</span></span></span><span> </span><span class="entity"><span>transfer_prover_method</span></span><span>
       </span><span class="inner_quoted"><span>"for proving transfer rules"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>