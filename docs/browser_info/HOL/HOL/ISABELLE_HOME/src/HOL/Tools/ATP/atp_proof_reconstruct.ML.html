<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/ATP/atp_proof_reconstruct.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/ATP/atp_proof_reconstruct.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/ATP/atp_proof_reconstruct.ML
    Author:     Lawrence C. Paulson, Cambridge University Computer Laboratory
    Author:     Claire Quigley, Cambridge University Computer Laboratory
    Author:     Jasmin Blanchette, TU Muenchen

Basic proof reconstruction from ATP proofs.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ATP_PROOF_RECONSTRUCT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>atp_type</span></span><span> </span><span class="main"><span>=</span></span><span> 'a </span><span class="entity"><span>ATP_Problem.atp_type</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_term</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>atp_step_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Proof.atp_step_name</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Proof.atp_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span> 'a </span><span class="entity"><span>ATP_Proof.atp_proof</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> metisN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> full_typesN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> partial_typesN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_typesN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> really_full_type_enc </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> full_type_enc </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> partial_type_enc </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_type_enc </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> full_type_encs </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> partial_type_encs </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_metis_lam_trans </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> leo2_extcnf_equal_neg_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> satallax_tab_rule_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> forall_of </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> exists_of </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplify_bool </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> var_name_of_typ </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rename_bound_vars </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_enc_aliases </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unalias_type_enc </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> term_of_atp </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prop_of_atp </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_conjecture_used_in_proof </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> used_facts_in_atp_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_proof_prefers_lifting </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_typed_helper_used_in_atp_proof </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> replace_dependencies_in_line </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>atp_step_name</span></span><span> * </span><span class="entity"><span>atp_step_name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> termify_atp_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>ATP_Problem_Generate.type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>int</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> repair_waldmeister_endgame </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> infer_formulas_types </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> introduce_spass_skolems </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> factify_atp_proof </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * 'a</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> termify_atp_abduce_candidate </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>ATP_Problem_Generate.type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>int</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> top_abduce_candidates </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sort_propositions_by_provability </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>ATP_Proof_Reconstruct</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ATP_PROOF_RECONSTRUCT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem_Generate</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>metisN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"metis"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_typesN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"full_types"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>partial_typesN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"partial_types"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_typesN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"no_types"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>really_full_type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"mono_tags"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"poly_guards_query"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>partial_type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"poly_args"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"erased"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_type_encs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>full_type_enc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>really_full_type_enc</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>partial_type_encs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>partial_type_enc</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>full_type_encs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_enc_aliases</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>full_typesN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>full_type_encs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>partial_typesN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>partial_type_encs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>no_typesN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>no_type_enc</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unalias_type_enc</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_enc_aliases</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_metis_lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>combsN</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>leo2_extcnf_equal_neg_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"extcnf_equal_neg"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>satallax_tab_rule_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tab_"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_name'</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>Name.dest_skolem</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_name'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lambda'</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.lambda_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_name'</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forall_of</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lambda'</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_of</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.exists_const</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lambda'</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_tfree</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ww</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ww</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Variable.def_sort</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ww</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>all</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>all</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>s_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>s_disj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>s_imp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>v</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>simplify_bool</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_letter</span></span><span> </span><span class="entity"><span>upper</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"o"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"O"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"z"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>String.extract</span><span> </span><span class="main"><span>(</span></span><span>Name.desymbolize</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>upper</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"p"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>single_letter</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"prod"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"r"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"list"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"s"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>single_letter</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>single_letter</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rename_bound_vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ATP_CLASS</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ATP_TYPE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ATP_TERM</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ATP_FORMULA</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_of_atp_class</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>class_prefix</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_CLASS</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cls</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_type_of_atp_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>atp_type_of_atp_term</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_fun_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_TYPE</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Type variables are given the basic sort "HOL.type". Some will later be constrained by information
   from type literals, or by type inference. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>native_type_prefix</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atp_type_of_atp_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unmangled_type</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>type_const_prefix</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invert_const</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_TYPE</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* only "tconst"s have type arguments *)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>tfree_prefix</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_tfree</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="comment1"><span>(* The term could be an Isabelle variable or a variable from the ATP, say "X1" or "_5018".
                 Sometimes variables from the ATP are indistinguishable from Isabelle variables, which
                 forces us to use a type parameter in all cases. *)</span></span><span>
              </span><span>Type_Infer.param</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>^</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>tvar_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>class_of_atp_class</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_atp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>atp_type_of_atp_term</span></span><span>

</span><span class="comment1"><span>(* Type class literal applied to a type. Returns triple of polarity, class, type. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_constraint_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>class_prefix</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_TERM</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Accumulate type constraints in a formula: negative type literals. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type_constraint</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_type_constraint</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_type_constraint</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_var_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>schematic_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* The number of type arguments of a constant, zero if it's monomorphic. For (instances of) Skolem
   pseudoconstants, this information is encoded in the constant name. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>robust_const_num_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>skolem_const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>Long_Name.explode</span><span> </span><span>|&gt;</span><span> </span><span>List.last</span><span> </span><span>|&gt;</span><span> </span><span>Int.fromString</span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_poly_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Sign.const_typargs</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span>length</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spass_skolem_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sk"</span></span><span> </span><span class="comment1"><span>(* "skc" or "skf" *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vampire_skolem_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sK"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_index_of_textual</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quantify_over_var</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="entity"><span>var_s</span></span><span> </span><span class="entity"><span>var_T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>var_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_index_of_textual</span></span><span> </span><span class="entity"><span>textual</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>|&gt;</span><span> </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_var_types</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>normTs</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm_var_types</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>map_aterms</span><span> </span><span class="entity"><span>norm_var_types</span></span><span> </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Var</span><span> </span><span class="entity"><span>normTs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* This assumes that distinct names are mapped to distinct names by "Variable.variant_frees". This
   does not hold in general but should hold for ATP-generated Skolem function names, since these end
   with a digit and "variant_frees" appends letters. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_up</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Variable.variant_frees</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Higher-order translation. Variables are typed (although we don't use that information). Lambdas
   are typed. The code is similar to "term_of_atp_fo". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_of_atp_ho</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_index_of_textual</span></span><span> </span><span>true</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>opt_T</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>AAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repair_var_name</span></span><span> </span><span class="entity"><span>var</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>term</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>quantify_over_var</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>lambda'</span></span><span> </span><span class="entity"><span>var_name</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="comment1"><span>(* special marker generated on parse error *)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>error</span><span> </span><span class="inner_quoted"><span>"Isar proof reconstruction failed because the ATP proof contains unparsable \
            \material"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_equal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not_equal</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>HOL.Not</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>---&gt;</span><span> </span><span>the_default</span><span> </span><span>dummyT</span><span> </span><span class="entity"><span>opt_T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>func</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>opt_T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>func</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_or</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.disj</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_and</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.conj</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_implies</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.imp</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_iff</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_equal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span>dummyT</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not_iff</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not_equal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.not_equal|const"><span>≠</span></a></span><span> </span><span class="bound"><span>y</span></span><span>›</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_if</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span class="bound"><span>P</span></span><span> </span><span class="bound"><span>Q</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="bound"><span>P</span></span><span>›</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not_and</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span class="bound"><span>P</span></span><span> </span><span class="bound"><span>Q</span></span><span class="main"><span>.</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="bound"><span>Q</span></span><span class="main"><span>)</span></span><span>›</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not_or</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span class="bound"><span>P</span></span><span> </span><span class="bound"><span>Q</span></span><span class="main"><span>.</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="bound"><span>Q</span></span><span class="main"><span>)</span></span><span>›</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_not</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.Not</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_ho_forall</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span>dummyT</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_ho_exists</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.exists_const</span></span><span> </span><span>dummyT</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_hilbert_choice</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.choice_const</span></span><span> </span><span>dummyT</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_hilbert_the</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.The|const"><span>The</span></a><span>›</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mangled_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_const</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>`</span><span class="entity"><span>invert_const</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_ty_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>us</span></span><span> </span><span>-</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>num_ty_args</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="entity"><span>mangled_us</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term_us</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_us</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>robust_const_num_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.const_instance</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span>NONE</span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span>---&gt;</span><span>
                       </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opt_T</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unproxify_const</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(* a free or schematic variable *)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>---&gt;</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>fixed_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_tptp_variable</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fresh_up</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>repair_var_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_index</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* First-order translation. No types are known for variables. "Type_Infer.anyT @{sort type}"
   should allow them to be inferred. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_of_atp_fo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="comment1"><span>(* For Metis, we use 1 rather than 0 because variable references in clauses may otherwise
       conflict with variable constraints in the goal. At least, type inference often fails
       otherwise. See also "axiom_inference" in "Metis_Reconstruct". *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_index_of_textual</span></span><span> </span><span class="entity"><span>textual</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>extra_ts</span></span><span> </span><span class="entity"><span>opt_T</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="comment1"><span>(* special marker generated on parse error *)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>error</span><span> </span><span class="inner_quoted"><span>"Isar proof reconstruction failed because the ATP proof contains unparsable \
            \material"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>native_type_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="comment1"><span>(* ignore TPTP type information (needed?) *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_equal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s''</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mangled_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_const</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>`</span><span class="entity"><span>invert_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_tag_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mangled_us</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>typ_u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>extra_ts</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term_u</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_TERM</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>predicator_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>List.last</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extra_t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>extra_ts</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>extra_t</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>us</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_guard_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="comment1"><span>(* ignore type predicates *)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_skolem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>new_skolem_const_prefix</span></span><span> </span><span class="entity"><span>s''</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_ty_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>us</span></span><span> </span><span>-</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>num_ty_args</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="entity"><span>mangled_us</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term_us</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_atp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_us</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>robust_const_num_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>new_skolem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer.paramify_vars</span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span>hd</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.const_instance</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                       </span><span>NONE</span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                           </span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span>---&gt;</span><span>
                           </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opt_T</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>new_skolem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>new_skolem_var_name_of_const</span></span><span> </span><span class="entity"><span>s''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_index</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unproxify_const</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>extra_ts</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(* a free or schematic variable *)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span>
                </span><span class="comment1"><span>(* SPASS (3.8ds) and Vampire (2.6) pass arguments to Skolem functions in reverse
                   order, which is incompatible with "metis"'s new skolemizer. *)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>spass_skolem_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vampire_skolem_prefix</span></span><span class="main"><span>]</span></span><span> </span><span>?</span><span> </span><span>rev</span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>extra_ts</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>typ_of_atp_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>term_ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>slack_fastype_of</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>---&gt;</span><span> </span><span>Type_Infer.anyT</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>fixed_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_tptp_variable</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>textual</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>fresh_up</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>repair_var_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_index</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_of_atp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATP_Problem.THF</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of_atp_ho</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported Isar reconstruction"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_of_atp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATP_Problem_Generate.is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_of_atp_fo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported Isar reconstruction"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_of_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>class_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>add_type_constraint</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_constraint_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>pair</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of_atp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Update schematic type variables with detected sort constraints. It's not
   totally clear whether this code is necessary. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_tvar_sorts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvar_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tvar_tab</span></span><span> </span><span class="entity"><span>xi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>z</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Vartab.is_empty</span><span> </span><span class="entity"><span>tvar_tab</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Interpret an ATP formula as a HOL term, extracting sort constraints as they appear in the
   formula. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_of_atp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(* FIXME: TFF *)</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>quantify_over_var</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>forall_of</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AExists</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>exists_of</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>repair_var_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>dummyT</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ANot</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phi'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi'</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>s_not</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AImplies</span></span><span> </span><span>?</span><span> </span><span>not</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi1</span></span><span>
        </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi2</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>AAnd</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_conj</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AOr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_disj</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AImplies</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_imp</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AIff</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_iff</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ANot</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"impossible connective"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_of_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>textual</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ATP_FORMULA</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phi</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>repair_tvar_sorts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_formula</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unprefix_fact_number</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>o</span><span> </span><span>tl</span><span> </span><span>o</span><span> </span><span>space_explode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_fact</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>fact_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unprefix_fact_number</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unascii_of</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_conjecture</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>conjecture_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int.fromString</span><span> </span><span class="entity"><span>s'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_facts</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resolve_fact</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>resolve_conjectures</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>resolve_conjecture</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_axiom_used_in_proof</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_conjecture_used_in_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_axiom_used_in_proof</span></span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span class="entity"><span>resolve_conjecture</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>agsyhol_core_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>leo2_extcnf_equal_neg_rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>String.isPrefix</span><span> </span><span class="entity"><span>satallax_tab_rule_prefix</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>short_thm_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Global</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resolve_facts</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>used_facts_in_atp_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ascii_of_lam_fact_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>lam_fact_prefix</span></span><span>

</span><span class="comment1"><span>(* overapproximation (good enough) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_lam_lifted</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>String.isPrefix</span><span> </span><span class="entity"><span>fact_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
  </span><span>String.isSubstring</span><span> </span><span class="entity"><span>ascii_of_lam_fact_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_combinator_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>helper_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>combinator_prefix</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_proof_prefers_lifting</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>is_axiom_used_in_proof</span></span><span> </span><span class="entity"><span>is_combinator_def</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>is_axiom_used_in_proof</span></span><span> </span><span class="entity"><span>is_lam_lifted</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_typed_helper_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>String.isPrefix</span><span> </span><span class="entity"><span>helper_prefix</span></span><span> </span><span>andf</span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>typed_helper_suffix</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_typed_helper_used_in_atp_proof</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>is_axiom_used_in_proof</span></span><span> </span><span class="entity"><span>is_typed_helper_name</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_one_dependency</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_same_atp_step</span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="entity"><span>old</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dep</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_dependencies_in_line</span></span><span> </span><span class="entity"><span>old_new</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>replace_one_dependency</span></span><span> </span><span class="entity"><span>old_new</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_name</span></span><span> </span><span class="inner_quoted"><span>"$true"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c_True"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_name</span></span><span> </span><span class="inner_quoted"><span>"$false"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c_False"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_name</span></span><span> </span><span class="inner_quoted"><span>"$$e"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_equal</span></span><span> </span><span class="comment1"><span>(* seen in Vampire proofs *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
       </span><span class="comment1"><span>(* seen in Vampire proofs *)</span></span><span>
       </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"sQ"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"_eqProxy"</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>tptp_equal</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_var_index</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_formulas_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>set_var_index</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>#&gt;</span><span> </span><span>Type.constraint</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Syntax.check_terms</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_schematic</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>combinator_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBI|const"><span>Meson.COMBI</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBI_def|fact"><span>Meson.COMBI_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBK|const"><span>Meson.COMBK</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBK_def|fact"><span>Meson.COMBK_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBB|const"><span>Meson.COMBB</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBB_def|fact"><span>Meson.COMBB_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBC|const"><span>Meson.COMBC</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBC_def|fact"><span>Meson.COMBC_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBS|const"><span>Meson.COMBS</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBS_def|fact"><span>Meson.COMBS_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncombine_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncomb</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>combinator_table</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>specialize_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>uncomb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unlift_aterm</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="comment1"><span>(* FIXME: do something about the types *)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unlift_term</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unlift_aterm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>unlift_term</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unlift_aterm</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termify_line</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Type_Role</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>termify_line</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>prop_of_atp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>sym_tab</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>unlift_term</span></span><span> </span><span class="entity"><span>lifted</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>uncombine_term</span></span><span> </span><span class="entity"><span>thy</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>simplify_bool</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>waldmeister_conjecture_num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"1.0.0.0"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_waldmeister_endgame</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_tail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Negated_Conjecture</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_body</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_body</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>waldmeister_conjecture_num</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>repair_tail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>repair_body</span></span><span> </span><span class="entity"><span>lines</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>repair_body</span></span><span> </span><span class="entity"><span>proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_proof_terms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lines</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'b * 'c * 'd * 'e</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lines</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termify_atp_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>local_prover</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>nasty_atp_proof</span></span><span> </span><span class="entity"><span>pool</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>map_term_names_in_atp_proof</span></span><span> </span><span class="entity"><span>repair_name</span></span><span>
  </span><span>#&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>termify_line</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>map_proof_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>infer_formulas_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>local_prover</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>waldmeisterN</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>repair_waldmeister_endgame</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unskolemize_spass_term</span></span><span> </span><span class="entity"><span>skos</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_skolem_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skos</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolem_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sk</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sk</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolem_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolem_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safe_abstract_over</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>abstract_over</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_argless_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>HOLogic.exists_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_abstract_over</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_skolem_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>haves</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>have_nots</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>HOLogic.disjuncts</span></span><span> </span><span class="entity"><span>t</span></span><span>
              </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>s_disj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>s_disj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="entity"><span>T</span></span><span>
                </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_abstract_over</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kill_skolem_arg</span></span><span> </span><span class="entity"><span>haves</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="entity"><span>have_nots</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_var</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_abstract_over</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unskolem_outer</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>unskolem_outer</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unskolem_outer</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unskolem_inner</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>unskolem_outer</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_skolem_args</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>spass_skolem_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>take_prefix</span><span> </span><span>is_Var</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>fold</span><span> </span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_of_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sk</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>subst_of_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_skolem_args</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>subst_vars</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_spass_skolems</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_skolem</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>spass_skolem_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_skolem</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

    </span><span class="comment1"><span>(* union-find would be faster *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_cycle</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_cycle</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ss</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span>Graph.add_edge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss</span></span><span> </span><span>~~</span><span> </span><span>tl</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>hd</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_steps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>other_steps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>5</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proof</span></span><span>

    </span><span class="comment1"><span>(* The names of the formulas are added to the Skolem constants, to ensure that formulas giving
       rise to several clauses are skolemized together. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skoXss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.fold_aterms</span><span> </span><span class="entity"><span>add_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input_steps</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>groups0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Graph.strong_conn</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_cycle</span></span><span> </span><span class="entity"><span>skoXss</span></span><span> </span><span>Graph.empty</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>spass_skolem_prefix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>groups0</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skoXss_input_steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skoXss</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>input_steps</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step_name_of_group</span></span><span> </span><span class="entity"><span>skoXs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>implode</span><span> </span><span class="entity"><span>skoXs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>in_group</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span>o</span><span> </span><span>hd</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>group_of</span></span><span> </span><span class="entity"><span>skoX</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>in_group</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="entity"><span>skoX</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>groups</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skoXss_steps</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_step</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step_name_of_group</span></span><span> </span><span class="entity"><span>group</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"0"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skoXss_steps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>rename_skolem_args</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Library.foldr1</span><span> </span><span class="entity"><span>s_conj</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skos</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>spass_skolem_prefix</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skoXss_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skoXss_steps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>name0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unskolemize_spass_term</span></span><span> </span><span class="entity"><span>skos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spass_pre_skolemize_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spass_skolemize_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>name0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sko_steps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>new_steps</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_group</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skoXss_input_steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>groups</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_news</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skoXs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>step_name_of_group</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>group_of</span></span><span> </span><span class="entity"><span>skoXs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>skoXss_input_steps</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repair_deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>replace_dependencies_in_line</span></span><span> </span><span class="entity"><span>old_news</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>input_steps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>sko_steps</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>repair_deps</span></span><span> </span><span class="entity"><span>other_steps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>factify_atp_proof</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>factify_step</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>resolve_conjectures</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Conjecture</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>close_form</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>resolve_facts</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Lemma</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Plain</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>factify_step</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_dep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>repair_dep</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>repair_deps</span></span><span> </span><span class="entity"><span>atp_proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termify_atp_abduce_candidate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>local_prover</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Conjecture</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_anot</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>termify_atp_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>local_prover</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>new_proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>phi'</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Impossible case in termify_atp_abduce_candidate"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sort_top</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>scored_items</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>scored_items</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_min</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_item</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_item</span></span><span class="main"><span>,</span></span><span> </span><span>List.rev</span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_min</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>item</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>scored_items</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_item</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>best_score</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>split_min</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>best_score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_item</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>scored_items</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>item</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>split_min</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>item</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>scored_items</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_item</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_item</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>other_scored_items</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_min</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>scored_items</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>scored_items</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>min_item</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sort_top</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>min_item</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>other_scored_items</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>top_abduce_candidates</span></span><span> </span><span class="entity"><span>max_candidates</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* We prefer free variables to other constructs, so that e.g. "x ≤ y" is
       prioritized over "x ≤ 5". *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span>+</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

    </span><span class="comment1"><span>(* Equations of the form "x = ..." or "... = x" or similar are too specific
       to be useful. Quantified formulas are also filtered out. As for "True",
       it may seem an odd choice for abduction, but it sometimes arises in
       conjunction with type class constraints, which are removed by the
       termifier. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_score</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>prop</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>less</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>zero_class.zero</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>zero_class.zero</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>less</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>one_class.one</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span>
          </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>less</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>zero_class.zero</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span>
          </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>zero_class.zero</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span>
          </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>one_class.one</span></a><span class="main"><span>(</span></span><span class="quoted"><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="comment1"><span>(* We require the presence of at least one free variable. A "missing
           assumption" that does not talk about any free variable is likely
           spurious. *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>sort_top</span></span><span> </span><span class="entity"><span>max_candidates</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="entity"><span>maybe_score</span></span><span> </span><span class="entity"><span>candidates</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>provability_status</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timeout.apply</span><span> </span><span class="main"><span>(</span></span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>Thm.rhs_of</span><span> </span><span>o</span><span> </span><span class="entity"><span>Simplifier.full_rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span>aconv</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>prop</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span>aconv</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>prop</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="comment1"><span>(* Put propositions that simplify to "True" first, and filter out propositions
   that simplify to "False". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sort_propositions_by_provability</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statuses_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>provability_status</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>statuses_ts</span></span><span> </span><span>@</span><span>
    </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>statuses_ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>