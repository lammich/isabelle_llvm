<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/sat_solver.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/sat_solver.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/sat_solver.ML
    Author:     Tjark Weber
    Copyright   2004-2009

Interface to external SAT solvers, and (simple) built-in SAT solvers.

Relevant Isabelle environment settings:

  # MiniSat 1.14
  #MINISAT_HOME=/usr/local/bin

  # zChaff
  #ZCHAFF_HOME=/usr/local/bin

  # BerkMin561
  #BERKMIN_HOME=/usr/local/bin
  #BERKMIN_EXE=BerkMin561-linux
  #BERKMIN_EXE=BerkMin561-solaris

  # Jerusat 1.3
  #JERUSAT_HOME=/usr/local/bin
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SAT_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> NOT_CONFIGURED

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>assignment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span> * </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SATISFIABLE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> assignment
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>UNSATISFIABLE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> proof option
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>UNKNOWN</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prop_Logic.prop_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span>

  </span><span class="comment1"><span>(* auxiliary functions to create external SAT solvers *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> write_dimacs_cnf_file </span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Prop_Logic.prop_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> write_dimacs_sat_file </span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Prop_Logic.prop_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> read_std_result_file </span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>string</span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_external_solver </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.prop_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>solver</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> read_dimacs_cnf_file </span><span class="main"><span>:</span></span><span> </span><span>Path.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Prop_Logic.prop_formula</span></span><span>

  </span><span class="comment1"><span>(* generic solver interface *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_solvers   </span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>solver</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_solver    </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>solver</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoke_solver </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>solver</span></span><span>  </span><span class="comment1"><span>(* exception Option *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>SAT_Solver</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SAT_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Prop_Logic</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* should be raised by an external SAT solver to indicate that the solver is *)</span></span><span>
</span><span class="comment1"><span>(* not configured properly                                                   *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NOT_CONFIGURED</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* type of partial (satisfying) assignments: 'a i = NONE' means that 'a' is  *)</span></span><span>
</span><span class="comment1"><span>(*      a satisfying assignment regardless of the value of variable 'i'      *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>assignment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* a proof of unsatisfiability, to be interpreted as follows: each integer   *)</span></span><span>
</span><span class="comment1"><span>(*      is a clause ID, each list 'xs' stored under the key 'x' in the table *)</span></span><span>
</span><span class="comment1"><span>(*      contains the IDs of clauses that must be resolved (in the given      *)</span></span><span>
</span><span class="comment1"><span>(*      order) to obtain the new clause 'x'.  Each list 'xs' must be         *)</span></span><span>
</span><span class="comment1"><span>(*      non-empty, and the literal to be resolved upon must always be unique *)</span></span><span>
</span><span class="comment1"><span>(*      (e.g. "A | ~B" must not be resolved with "~A | B").  Circular        *)</span></span><span>
</span><span class="comment1"><span>(*      dependencies of clauses are not allowed.  (At least) one of the      *)</span></span><span>
</span><span class="comment1"><span>(*      clauses in the table must be the empty clause (i.e. contain no       *)</span></span><span>
</span><span class="comment1"><span>(*      literals); its ID is given by the second component of the proof.     *)</span></span><span>
</span><span class="comment1"><span>(*      The clauses of the original problem passed to the SAT solver have    *)</span></span><span>
</span><span class="comment1"><span>(*      consecutive IDs starting with 0.  Clause IDs must be non-negative,   *)</span></span><span>
</span><span class="comment1"><span>(*      but do not need to be consecutive.                                   *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span> * </span><span>int</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* return type of SAT solvers: if the result is 'SATISFIABLE', a satisfying  *)</span></span><span>
</span><span class="comment1"><span>(*      assignment must be returned as well; if the result is                *)</span></span><span>
</span><span class="comment1"><span>(*      'UNSATISFIABLE', a proof of unsatisfiability may be returned         *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SATISFIABLE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> assignment
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>UNSATISFIABLE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> proof option
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>UNKNOWN</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* type of SAT solvers: given a propositional formula, a satisfying          *)</span></span><span>
</span><span class="comment1"><span>(*      assignment may be returned                                           *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* write_dimacs_cnf_file: serializes a formula 'fm' of propositional logic   *)</span></span><span>
</span><span class="comment1"><span>(*      to a file in DIMACS CNF format (see "Satisfiability Suggested        *)</span></span><span>
</span><span class="comment1"><span>(*      Format", May 8 1993, Section 2.1)                                    *)</span></span><span>
</span><span class="comment1"><span>(* Note: 'fm' must not contain a variable index less than 1.                 *)</span></span><span>
</span><span class="comment1"><span>(* Note: 'fm' must be given in CNF.                                          *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf_True_False_elim</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cnf_True_False_elim</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cnf_True_False_elim</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>fm</span></span><span>  </span><span class="comment1"><span>(* since 'fm' is in CNF, either 'fm'='True'/'False',
             or 'fm' does not contain 'True'/'False' at all *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_cnf_file</span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>error</span><span> </span><span class="inner_quoted"><span>"formula is not in CNF"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>error</span><span> </span><span class="inner_quoted"><span>"formula is not in CNF"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>&gt;=</span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"formula contains a variable index less than 1"</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>error</span><span> </span><span class="inner_quoted"><span>"formula is not in CNF"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" 0\n"</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fm'</span></span><span>               </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cnf_True_False_elim</span></span><span> </span><span class="entity"><span>fm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of_vars</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span class="entity"><span>fm'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of_clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"c This file was generated by SAT_Solver.write_dimacs_cnf_file\n"</span></span><span class="main"><span>;</span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"p cnf "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>number_of_vars</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
                            </span><span>string_of_int</span><span> </span><span class="entity"><span>number_of_clauses</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm'</span></span><span class="main"><span>;</span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" 0\n"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>File_Stream.open_output</span><span> </span><span class="entity"><span>write_cnf_file</span></span><span> </span><span class="entity"><span>path</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* write_dimacs_sat_file: serializes a formula 'fm' of propositional logic   *)</span></span><span>
</span><span class="comment1"><span>(*      to a file in DIMACS SAT format (see "Satisfiability Suggested        *)</span></span><span>
</span><span class="comment1"><span>(*      Format", May 8 1993, Section 2.2)                                    *)</span></span><span>
</span><span class="comment1"><span>(* Note: 'fm' must not contain a variable index less than 1.                 *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_dimacs_sat_file</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_sat_file</span></span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"*()"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"+()"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>&gt;=</span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"formula contains a variable index less than 1"</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"-("</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"+("</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"*("</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* optimization to make use of n-ary disjunction/conjunction *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula_or</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>;</span></span><span>
           </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>;</span></span><span>
           </span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>write_formula_and</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"c This file was generated by SAT_Solver.write_dimacs_sat_file\n"</span></span><span class="main"><span>;</span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"p sat "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>number_of_vars</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>write_formula</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>;</span></span><span>
      </span><span>File_Stream.output</span><span> </span><span class="entity"><span>out</span></span><span> </span><span class="inner_quoted"><span>")\n"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>File_Stream.open_output</span><span> </span><span class="entity"><span>write_sat_file</span></span><span> </span><span class="entity"><span>path</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* read_std_result_file: scans a SAT solver's output file for a satisfying   *)</span></span><span>
</span><span class="comment1"><span>(*      variable assignment.  Returns the assignment, or 'UNSATISFIABLE' if  *)</span></span><span>
</span><span class="comment1"><span>(*      the file contains 'unsatisfiable', or 'UNKNOWN' if the file contains *)</span></span><span>
</span><span class="comment1"><span>(*      neither 'satisfiable' nor 'unsatisfiable'.  Empty lines are ignored. *)</span></span><span>
</span><span class="comment1"><span>(*      The assignment must be given in one or more lines immediately after  *)</span></span><span>
</span><span class="comment1"><span>(*      the line that contains 'satisfiable'.  These lines must begin with   *)</span></span><span>
</span><span class="comment1"><span>(*      'assignment_prefix'.  Variables must be separated by " ".  Non-      *)</span></span><span>
</span><span class="comment1"><span>(*      integer strings are ignored.  If variable i is contained in the      *)</span></span><span>
</span><span class="comment1"><span>(*      assignment, then i is interpreted as 'true'.  If ~i is contained in  *)</span></span><span>
</span><span class="comment1"><span>(*      the assignment, then i is interpreted as 'false'.  Otherwise the     *)</span></span><span>
</span><span class="comment1"><span>(*      value of i is taken to be unspecified.                               *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_std_result_file</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>satisfiable</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assignment_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsatisfiable</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_list_from_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span>Int.fromString</span><span> </span><span class="main"><span>(</span></span><span>space_explode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assignment_from_list</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>NONE</span><span>  </span><span class="comment1"><span>(* the SAT solver didn't provide a value for this variable *)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assignment_from_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>=</span></span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>assignment_from_list</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_assignment</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>assignment_from_list</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_assignment</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span>::</span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>assignment_prefix</span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>parse_assignment</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>int_list_from_string</span></span><span> </span><span class="entity"><span>line</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lines</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>assignment_from_list</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_substring</span></span><span> </span><span class="entity"><span>needle</span></span><span> </span><span class="entity"><span>haystack</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>length1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.size</span><span> </span><span class="entity"><span>needle</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>length2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.size</span><span> </span><span class="entity"><span>haystack</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>length2</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>length1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>false</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>needle</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>haystack</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>length1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>true</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>is_substring</span></span><span> </span><span class="entity"><span>needle</span></span><span> </span><span class="main"><span>(</span></span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>haystack</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>length2</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_lines</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>UNKNOWN</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_lines</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span>::</span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_substring</span></span><span> </span><span class="entity"><span>unsatisfiable</span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>UNSATISFIABLE</span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_substring</span></span><span> </span><span class="entity"><span>satisfiable</span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>SATISFIABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_assignment</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>parse_lines</span></span><span> </span><span class="entity"><span>lines</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_lines</span></span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>split_lines</span><span> </span><span>o</span><span> </span><span>File.read</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>path</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* make_external_solver: call 'writefn', execute 'cmd', call 'readfn'        *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>Isabelle_System.bash</span></span><span> </span><span class="entity"><span>cmd</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* read_dimacs_cnf_file: returns a propositional formula that corresponds to *)</span></span><span>
</span><span class="comment1"><span>(*      a SAT problem given in DIMACS CNF format                             *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_preamble</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"problem line not found in DIMACS CNF file"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_preamble</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span>::</span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"c "</span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="comment1"><span>(* ignore comments *)</span></span><span>
        </span><span class="entity"><span>filter_preamble</span></span><span> </span><span class="entity"><span>lines</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"p "</span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="comment1"><span>(* ignore the problem line (which must be the last line of the preamble) *)</span></span><span>
        </span><span class="comment1"><span>(* Ignoring the problem line implies that if the file contains more clauses *)</span></span><span>
        </span><span class="comment1"><span>(* or variables than specified in its preamble, we will accept it anyway.   *)</span></span><span>
        </span><span class="entity"><span>lines</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>error</span><span> </span><span class="inner_quoted"><span>"preamble in DIMACS CNF file contains a line that does not begin with \"c \" or \"p \""</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Int.fromString</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"token "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" in DIMACS CNF file is not a number"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop_prefix</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>xs2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>      </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>xs1</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span>::</span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>xs1</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span>::</span><span class="entity"><span>tl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xs1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>tl</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>       </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"SAT_Solver.clauses"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>literal_from_int</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>&lt;&gt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"variable index in DIMACS CNF file is 0"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&gt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>Prop_Logic.Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disjunction</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"empty clause in DIMACS CNF file"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disjunction</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Prop_Logic.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disjunction</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conjunction</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"no clause in DIMACS CNF file"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>conjunction</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Prop_Logic.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conjunction</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>conjunction</span></span><span>
    </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>disjunction</span></span><span class="main"><span>)</span></span><span>
    </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>literal_from_int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>o</span><span> </span><span class="entity"><span>clauses</span></span><span>
    </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span class="main"><span>)</span></span><span>
    </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>String.tokens</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>#" "</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>#"\t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>#"\n"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>o</span><span> </span><span class="entity"><span>filter_preamble</span></span><span>
    </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
    </span><span>o</span><span> </span><span>split_lines</span><span>
    </span><span>o</span><span> </span><span>File.read</span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>path</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* solvers: a table of all registered SAT solvers                            *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solvers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"solvers"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>solver</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_solvers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.value</span><span> </span><span class="entity"><span>solvers</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* add_solver: updates 'solvers' by adding a new solver                      *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_solver</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Synchronized.change</span><span> </span><span class="entity"><span>solvers</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>the_solvers</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>the_solvers</span></span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SAT solver "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" was defined before"</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_solver</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>the_solvers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* invoke_solver: returns the solver associated with the given 'name'        *)</span></span><span>
</span><span class="comment1"><span>(* Note: If no solver is associated with 'name', exception 'Option' will be  *)</span></span><span>
</span><span class="comment1"><span>(*       raised.                                                             *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_solver</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_solvers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>  </span><span class="comment1"><span>(* SAT_Solver *)</span></span><span>


</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Predefined SAT solvers                                                    *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Internal SAT solver, available as 'SAT_Solver.invoke_solver "cdclite"' --  *)</span></span><span>
</span><span class="comment1"><span>(* a simplified implementation of the conflict-driven clause-learning        *)</span></span><span>
</span><span class="comment1"><span>(* algorithm (cf. L. Zhang, S. Malik: "The Quest for Efficient Boolean       *)</span></span><span>
</span><span class="comment1"><span>(* Satisfiability Solvers", July 2002, Fig. 2). This solver produces models  *)</span></span><span>
</span><span class="comment1"><span>(* and proof traces.                                                         *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span>list</span><span> * </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Implied</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> clause </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Level0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>variable</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span> </span><span>option</span><span> * </span><span class="entity"><span>reason</span></span><span> * </span><span>int</span><span> * </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span>int</span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>int</span><span> * </span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>variable</span></span><span> </span><span>Inttab.table</span><span> * </span><span class="entity"><span>clause</span></span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span> * </span><span class="entity"><span>proofs</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>clause</span></span><span> * </span><span class="entity"><span>state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>UNSAT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>clause</span></span><span> * </span><span class="entity"><span>state</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>~</span><span class="entity"><span>i</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lit_value</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Option.map</span><span> </span><span>not</span><span> </span><span class="entity"><span>value</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>variable</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Inttab.lookup</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lit_value</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_true</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_false</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_unassigned</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assignment_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_var</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_rank</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_var</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Inttab.map_entry</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_var</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Inttab.update</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Decided</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_var</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_var</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unassign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_var</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_var</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>Decided</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_proof</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_proof</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Inttab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level0_proof_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Level0</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level0_proof_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level0_proofs_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level0_proof_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>reason_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prems_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>level0_proofs_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lits</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proofs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reason</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>apfst</span><span> </span><span class="entity"><span>Level0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implied</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_decided</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>Decided</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_true</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cx</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_false</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSAT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_unassigned</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>prop</span></span><span> </span><span>o</span><span> </span><span>Inttab.lookup_list</span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="entity"><span>units'</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>CONFLICT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_unassigned</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rank</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rank</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>max_unassigned</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decide</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Inttab.fold</span><span> </span><span class="entity"><span>max_unassigned</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>push_decided</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mark</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Inttab.update</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>Inttab.lookup</span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ignore</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Empty</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Empty</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>lits</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_cls_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>reason_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Implied</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cls</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Option</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>conflicting_cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>back</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lits1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ignore</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lits2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>level</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>lits1</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>lits2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ms'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>mark</span></span><span> </span><span class="entity"><span>lits1</span></span><span> </span><span class="entity"><span>ms</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ls</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level0_proofs_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lits0</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>first_lit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>marked</span></span><span> </span><span class="entity"><span>ms'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neg</span></span><span> </span><span class="entity"><span>lit'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls'</span></span><span class="main"><span>,</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>ps'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>back</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i'</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lit'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reason_cls_of</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lit'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trail'</span></span><span> </span><span class="entity"><span>ms'</span></span><span> </span><span class="entity"><span>ls'</span></span><span> </span><span class="entity"><span>ps'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>back</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>conflicting_cls</span></span><span> </span><span class="entity"><span>trail</span></span><span> </span><span>Inttab.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>keep_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_var</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>incr_rank</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>vars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clss'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Inttab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neg</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>clss</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>learn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>lits</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>keep_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unassign</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>propagate</span></span><span> </span><span class="entity"><span>units</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>decide</span></span><span> </span><span class="entity"><span>state'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SAT_Solver.SATISFIABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assignment_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>state''</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>conflicting_cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>conflicting_cls</span></span><span> </span><span class="entity"><span>state'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_proof</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>proofs</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trail</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs'</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span>o</span><span> </span><span class="entity"><span>level_of</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>learn</span></span><span> </span><span class="entity"><span>cls</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>push</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cls</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lit</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_opposing_lits</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_opposing_lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neg</span></span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has_opposing_lits</span></span><span> </span><span class="entity"><span>lits</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_opposing_lits</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cx</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>units</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>keep_clause</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_clause</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_proof</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve</span></span><span> </span><span class="entity"><span>litss</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>mk_clause</span></span><span> </span><span class="entity"><span>litss</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Inttab.empty</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>litss</span></span><span> </span><span>Inttab.empty</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span>Inttab.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>uncurry</span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_clause</span></span><span> </span><span class="entity"><span>clss</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>UNSAT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conflicting_cls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>conflicting_cls</span></span><span> </span><span class="entity"><span>proofs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ptab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>variable_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"bad propositional variable"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>variable_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>variable_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"expected formula in CNF"</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>literal_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.Not</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>variable_of</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>literal_of</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variable_of</span></span><span> </span><span class="entity"><span>fm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clause_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause_of</span></span><span> </span><span class="entity"><span>fm1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>clause_of</span></span><span> </span><span class="entity"><span>fm2</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clause_of</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>literal_of</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>fm1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>fm2</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>Prop_Logic.True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>Prop_Logic.False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>clause_of</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dpll_solver</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Prop_Logic.is_cnf</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>solve</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clauses_of</span></span><span> </span><span class="entity"><span>fm'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cdclite"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dpll_solver</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Internal SAT solver, available as 'SAT_Solver.invoke_solver "auto"': uses *)</span></span><span>
</span><span class="comment1"><span>(* the last installed solver (other than "auto" itself) that does not raise  *)</span></span><span>
</span><span class="comment1"><span>(* 'NOT_CONFIGURED'.  (However, the solver may return 'UNKNOWN'.)            *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>auto_solver</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>SAT_Solver.UNKNOWN</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>solver</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>solvers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"auto"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="comment1"><span>(* do not call solver "auto" from within "auto" *)</span></span><span>
        </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>solvers</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="comment1"><span>(* apply 'solver' to 'fm' *)</span></span><span>
        </span><span class="entity"><span>solver</span></span><span> </span><span class="entity"><span>fm</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>solvers</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SAT_Solver.get_solvers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"auto"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auto_solver</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* MiniSat 1.14                                                              *)</span></span><span>
</span><span class="comment1"><span>(* (http://www.cs.chalmers.se/Cs/Research/FormalMethods/MiniSat/)            *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* "minisat_with_proofs" requires a modified version of MiniSat 1.14 by John *)</span></span><span>
</span><span class="comment1"><span>(* Matthews, which can output ASCII proof traces.  Replaying binary proof    *)</span></span><span>
</span><span class="comment1"><span>(* traces generated by MiniSat-p_v1.14 has _not_ been implemented.           *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* add "minisat_with_proofs" _before_ "minisat" to the available solvers, so *)</span></span><span>
</span><span class="comment1"><span>(* that the latter is preferred by the "auto" solver                         *)</span></span><span>

</span><span class="comment1"><span>(* There is a complication that is dealt with in the code below: MiniSat     *)</span></span><span>
</span><span class="comment1"><span>(* introduces IDs for original clauses in the proof trace.  It does not (in  *)</span></span><span>
</span><span class="comment1"><span>(* general) follow the convention that the original clauses are numbered     *)</span></span><span>
</span><span class="comment1"><span>(* from 0 to n-1 (where n is the number of clauses in the formula).          *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minisat_with_proofs</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>getenv</span><span> </span><span class="inner_quoted"><span>"MINISAT_HOME"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inpath</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"isabelle"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".cnf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outpath</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proofpath</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".prf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\"$MINISAT_HOME/minisat\" "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -r "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -t "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>proofpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"&gt; /dev/null"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.read_std_result_file</span></span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SAT"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"UNSAT"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>inpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>outpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cnf</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>cnf</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>inpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>outpath</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>split_lines</span><span> </span><span>o</span><span> </span><span>File.read</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proofpath</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>IO.Io</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"Could not read file \"result.prf\""</span></span><span>
      </span><span class="comment1"><span>(* representation of clauses as ordered lists of literals (with duplicates removed) *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Ord_List.union</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="entity"><span>fm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.Not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>[</span></span><span>~</span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"Error: invalid clause in CNF formula."</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of_clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>cnf</span></span><span>
      </span><span class="comment1"><span>(* int list array *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Array.array</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_of_clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* initialize the 'clauses' array *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init_array</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>init_array</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>init_array</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>init_array</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>Array.upd</span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clause_to_lit_list</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>init_array</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnf</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* optimization for the common case where MiniSat "R"s clauses in their *)</span></span><span>
      </span><span class="comment1"><span>(* original order:                                                      *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>last_ref_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_of_clauses</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* search the 'clauses' array for the given list of literals 'lits', *)</span></span><span>
      </span><span class="comment1"><span>(* starting at index '!last_ref_clause + 1'                          *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>original_clause_id</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>original_clause_id_from</span></span><span> </span><span class="entity"><span>index</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>number_of_clauses</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="comment1"><span>(* search from beginning again *)</span></span><span>
            </span><span class="entity"><span>original_clause_id_from</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
          </span><span class="comment1"><span>(* both 'lits' and the list of literals used in 'clauses' are sorted, so *)</span></span><span>
          </span><span class="comment1"><span>(* testing for equality should suffice -- barring duplicate literals     *)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Array.nth</span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="comment1"><span>(* success *)</span></span><span>
            </span><span class="entity"><span>last_ref_clause</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>;</span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>index</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>last_ref_clause</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="comment1"><span>(* failure *)</span></span><span>
            </span><span>NONE</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="comment1"><span>(* continue search *)</span></span><span>
            </span><span class="entity"><span>original_clause_id_from</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>original_clause_id_from</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>last_ref_clause</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Int.fromString</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: number expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* parse the proof file *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause_table</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>Inttab.empty</span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_id</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="comment1"><span>(* contains a mapping from clause IDs as used by MiniSat to clause IDs in *)</span></span><span>
      </span><span class="comment1"><span>(* our proof format, where original clauses are numbered starting from 0  *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause_id_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>Inttab.empty</span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Inttab.table</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sat_to_proof</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Inttab.lookup</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_id_map</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>id'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>     </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Clause ID "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" used, but not defined."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>next_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_of_clauses</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok</span></span><span>::</span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"R"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>id</span></span><span>::</span><span class="entity"><span>sep</span></span><span>::</span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"R\" disallowed after \"X\"."</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cid</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"&lt;="</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"&lt;=\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ls</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>original_clause_id</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                               </span><span>SOME</span><span> </span><span class="entity"><span>orig_id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>orig_id</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>         </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Original clause (new ID is "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") not found."</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* extend the mapping of clause IDs with this newly defined ID *)</span></span><span>
              </span><span class="entity"><span>clause_id_map</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cid</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_id</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_id_map</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: clause "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" defined more than once (in \"R\")."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="comment1"><span>(* the proof itself doesn't change *)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"R\" followed by an insufficient number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"C"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>id</span></span><span>::</span><span class="entity"><span>sep</span></span><span>::</span><span class="entity"><span>ids</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"C\" disallowed after \"X\"."</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cid</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"&lt;="</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"&lt;=\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="comment1"><span>(* ignore the pivot literals in MiniSat's trace *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unevens</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>             </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"C\" followed by an even number of IDs."</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unevens</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unevens</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>unevens</span></span><span> </span><span class="entity"><span>xs</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span>       </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>sat_to_proof</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>unevens</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ids</span></span><span>
              </span><span class="comment1"><span>(* extend the mapping of clause IDs with this newly defined ID *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>next_id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clause_id_map</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cid</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_id</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_id_map</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: clause "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" defined more than once (in \"C\")."</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* update clause table *)</span></span><span>
              </span><span class="entity"><span>clause_table</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Error: internal ID for clause "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" already used."</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"C\" followed by an insufficient number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"D"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>id</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"D\" disallowed after \"X\"."</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sat_to_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* simply ignore "D" *)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"D\" followed by an illegal number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"X"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>            </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: more than one end-of-proof statement."</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>            </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sat_to_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id1</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sat_to_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* update conflict id *)</span></span><span>
              </span><span class="entity"><span>empty_id</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>new_empty_id</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"X\" followed by an illegal number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: unknown token "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span>::</span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>(</span></span><span>String.tokens</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#" "</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"\t"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>process_lines</span></span><span> </span><span class="entity"><span>ls</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* proof *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="entity"><span>proof_lines</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: no conflicting clause specified."</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"minisat_with_proofs"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>minisat_with_proofs</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minisat</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>getenv</span><span> </span><span class="inner_quoted"><span>"MINISAT_HOME"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inpath</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"isabelle"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".cnf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outpath</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\"$MINISAT_HOME/minisat\" "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -r "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" &gt; /dev/null"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.read_std_result_file</span></span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SAT"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"UNSAT"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>inpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>outpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>inpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>outpath</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"minisat"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>minisat</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* zChaff (https://www.princeton.edu/~chaff/zchaff.html)                      *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* 'zchaff_with_proofs' applies the "zchaff" prover to a formula, and if     *)</span></span><span>
</span><span class="comment1"><span>(* zChaff finds that the formula is unsatisfiable, a proof of this is read   *)</span></span><span>
</span><span class="comment1"><span>(* from a file "resolve_trace" that was generated by zChaff.  See the code   *)</span></span><span>
</span><span class="comment1"><span>(* below for the expected format of the "resolve_trace" file.  Aside from    *)</span></span><span>
</span><span class="comment1"><span>(* some basic syntactic checks, no verification of the proof is performed.   *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="comment1"><span>(* add "zchaff_with_proofs" _before_ "zchaff" to the available solvers, so   *)</span></span><span>
</span><span class="comment1"><span>(* that the latter is preferred by the "auto" solver                         *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zchaff_with_proofs</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>SAT_Solver.invoke_solver</span></span><span> </span><span class="inner_quoted"><span>"zchaff"</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="comment1"><span>(* FIXME File.tmp_path (!?) *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proof_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>split_lines</span><span> </span><span>o</span><span> </span><span>File.read</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="inner_quoted"><span>"resolve_trace"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>IO.Io</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"Could not read file \"resolve_trace\""</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="entity"><span>fm2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Int.fromString</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: number expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* parse the "resolve_trace" file *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause_offset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause_table</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>Inttab.empty</span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_id</span></span><span>      </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok</span></span><span>::</span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"CL:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>id</span></span><span>::</span><span class="entity"><span>sep</span></span><span>::</span><span class="entity"><span>ids</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>clause_offset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"CL:\" disallowed after \"VAR:\"."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"CL:\" disallowed after \"CONF:\"."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"&lt;="</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"&lt;=\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>ids</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* update clause table *)</span></span><span>
              </span><span class="entity"><span>clause_table</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cid</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: clause "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" defined more than once."</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"CL:\" followed by an insufficient number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"VAR:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>id</span></span><span>::</span><span class="entity"><span>levsep</span></span><span>::</span><span class="entity"><span>levid</span></span><span>::</span><span class="entity"><span>valsep</span></span><span>::</span><span class="entity"><span>valid</span></span><span>::</span><span class="entity"><span>antesep</span></span><span>::</span><span class="entity"><span>anteid</span></span><span>::</span><span class="entity"><span>litsep</span></span><span>::</span><span class="entity"><span>lits</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"VAR:\" disallowed after \"CONF:\"."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="comment1"><span>(* set 'clause_offset' to the largest used clause ID *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>clause_offset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>clause_offset</span></span><span> </span><span>:=</span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Inttab.max</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cnf_number_of_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>  </span><span class="comment1"><span>(* the first clause ID is 0, not 1 *)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>levsep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"L:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"L:\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>levsep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>levid</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>valsep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"V:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"V:\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>valsep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>valid</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>antesep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"A:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"A:\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>antesep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>anteid</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>litsep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Lits:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"Lits:\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>litsep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ls</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>lits</span></span><span>
              </span><span class="comment1"><span>(* convert the data provided by zChaff to our resolution-style proof format *)</span></span><span>
              </span><span class="comment1"><span>(* each "VAR:" line defines a unit clause, the resolvents are implicitly    *)</span></span><span>
              </span><span class="comment1"><span>(* given by the literals in the antecedent clause                           *)</span></span><span>
              </span><span class="comment1"><span>(* we use the sum of '!clause_offset' and the variable ID as clause ID for the unit clause *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>clause_offset</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>vid</span></span><span>
              </span><span class="comment1"><span>(* the low bit of each literal gives its sign (positive/negative), therefore  *)</span></span><span>
              </span><span class="comment1"><span>(* we have to divide each literal by 2 to obtain the proper variable ID; then *)</span></span><span>
              </span><span class="comment1"><span>(* we add '!clause_offset' to obtain the ID of the corresponding unit clause  *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vids</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>vid</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aid</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>!</span><span class="entity"><span>clause_offset</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vids</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* update clause table *)</span></span><span>
              </span><span class="entity"><span>clause_table</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cid</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: clause "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>cid</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" (derived from antecedent for variable "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") already defined."</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"VAR:\" followed by an insufficient number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"CONF:"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>id</span></span><span>::</span><span class="entity"><span>sep</span></span><span>::</span><span class="entity"><span>ids</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: more than one conflicting clause specified."</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>id</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"=="</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: \"==\" expected ("</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered)."</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ls</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>int_from_string</span></span><span> </span><span class="entity"><span>ids</span></span><span>
              </span><span class="comment1"><span>(* the conflict clause must be resolved with the unit clauses *)</span></span><span>
              </span><span class="comment1"><span>(* for its literals to obtain the empty clause                *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vids</span></span><span>         </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ls</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span>           </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cid</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>!</span><span class="entity"><span>clause_offset</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vids</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_empty_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_offset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Inttab.max</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="comment1"><span>(* update clause table and conflict id *)</span></span><span>
              </span><span class="entity"><span>clause_table</span></span><span> </span><span>:=</span><span> </span><span>Inttab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_empty_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Inttab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: clause "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>new_empty_id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" (empty clause derived from clause "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") already defined."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="entity"><span>empty_id</span></span><span>     </span><span>:=</span><span> </span><span class="entity"><span>new_empty_id</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: \"CONF:\" followed by an insufficient number of tokens."</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"File format error: unknown token "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" encountered."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span>::</span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>process_tokens</span></span><span> </span><span class="main"><span>(</span></span><span>String.tokens</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#" "</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"\t"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>process_lines</span></span><span> </span><span class="entity"><span>ls</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* proof *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_lines</span></span><span> </span><span class="entity"><span>proof_lines</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="inner_quoted"><span>"File format error: no conflicting clause specified."</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>clause_table</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>empty_id</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>INVALID_PROOF</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="entity"><span>reason</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>SAT_Solver.UNSATISFIABLE</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>result</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"zchaff_with_proofs"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zchaff_with_proofs</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zchaff</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>getenv</span><span> </span><span class="inner_quoted"><span>"ZCHAFF_HOME"</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inpath</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"isabelle"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".cnf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outpath</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\"$ZCHAFF_HOME/zchaff\" "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" &gt; "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>outpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.read_std_result_file</span></span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Instance Satisfiable"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Instance Unsatisfiable"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>inpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>outpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>inpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>outpath</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"zchaff"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zchaff</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* BerkMin 561 (http://eigold.tripod.com/BerkMin.html)                       *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>berkmin</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>getenv</span><span> </span><span class="inner_quoted"><span>"BERKMIN_HOME"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inpath</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"isabelle"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".cnf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outpath</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\"$BERKMIN_HOME/${BERKMIN_EXE:-BerkMin561}\" "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" &gt; "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>outpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.read_std_result_file</span></span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Satisfiable          !!"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"solution ="</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"UNSATISFIABLE          !!"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>inpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>outpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>inpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>outpath</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"berkmin"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>berkmin</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>
</span><span class="comment1"><span>(* Jerusat 1.3 (http://www.cs.tau.ac.il/~ale1/)                              *)</span></span><span>
</span><span class="comment1"><span>(* ------------------------------------------------------------------------- *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>jerusat</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>getenv</span><span> </span><span class="inner_quoted"><span>"JERUSAT_HOME"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAT_Solver.NOT_CONFIGURED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inpath</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"isabelle"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>".cnf"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outpath</span></span><span>    </span><span class="main"><span>=</span></span><span> </span><span>File.tmp_path</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"result"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>serial_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cmd</span></span><span>        </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\"$JERUSAT_HOME/Jerusat1.3\" "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" &gt; "</span></span><span> </span><span>^</span><span> </span><span>File.bash_path</span><span> </span><span class="entity"><span>outpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>fm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.write_dimacs_cnf_file</span></span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.defcnf</span></span><span> </span><span class="entity"><span>fm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.read_std_result_file</span></span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"s SATISFIABLE"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"v "</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"s UNSATISFIABLE"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>inpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>inpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.exists</span><span> </span><span class="entity"><span>outpath</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"overwriting existing file "</span></span><span> </span><span>^</span><span> </span><span>Path.print</span><span> </span><span class="entity"><span>outpath</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span>     </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SAT_Solver.make_external_solver</span></span><span> </span><span class="entity"><span>cmd</span></span><span> </span><span class="entity"><span>writefn</span></span><span> </span><span class="entity"><span>readfn</span></span><span> </span><span class="entity"><span>fm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>inpath</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span>          </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span>File.rm</span><span> </span><span class="entity"><span>outpath</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>SAT_Solver.add_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"jerusat"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>jerusat</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>