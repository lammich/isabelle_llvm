<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/monomorph.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/monomorph.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/monomorph.ML
    Author:     Sascha Boehme, TU Muenchen

Monomorphization of theorems, i.e., computation of ground instances for
theorems with type variables.  This procedure is incomplete in general,
but works well for most practical problems.

Monomorphization is essentially an enumeration of substitutions that map
schematic types to ground types. Applying these substitutions to theorems
with type variables results in monomorphized ground instances. The
enumeration is driven by schematic constants (constants occurring with
type variables) and all ground instances of such constants (occurrences
without type variables). The enumeration is organized in rounds in which
all substitutions for the schematic constants are computed that are induced
by the ground instances. Any new ground instance may induce further
substitutions in a subsequent round. To prevent nontermination, there is
an upper limit of rounds involved and of the number of monomorphized ground
instances computed.

Theorems to be monomorphized must be tagged with a number indicating the
initial round in which they participate first. The initial round is
ignored for theorems without type variables. For any other theorem, the
initial round must be greater than zero. Returned monomorphized theorems
carry a number showing from which monomorphization round they emerged.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>MONOMORPH</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* utility functions *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typ_has_tvars</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_schematic_consts_of</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_schematic_consts_of</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span>

  </span><span class="comment1"><span>(* configuration options *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_rounds</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_new_instances</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_thm_instances</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_schematics</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_new_const_instances_per_round</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_duplicated_instances</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>

  </span><span class="comment1"><span>(* monomorphization *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> monomorph</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Monomorph</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MONOMORPH</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* utility functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ_has_tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_schematic_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>typ_has_tvars</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Symtab.insert_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_schematic_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>Symtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clear_grounds</span></span><span> </span><span class="entity"><span>grounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>grounds</span></span><span>


</span><span class="comment1"><span>(* configuration options *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_rounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_rounds|attribute"><span>monomorph_max_rounds</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>5</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_new_instances</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_new_instances|attribute"><span>monomorph_max_new_instances</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>500</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_thm_instances</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_thm_instances|attribute"><span>monomorph_max_thm_instances</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>20</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_schematics|attribute"><span>monomorph_max_schematics</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_new_const_instances_per_round</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_new_const_instances_per_round|attribute"><span>monomorph_max_new_const_instances_per_round</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>5</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="ATP.monomorph_max_duplicated_instances|attribute"><span>monomorph_max_duplicated_instances</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>16000</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>limit_rounds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_rounds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* theorem information and related functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>thm_info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Ground</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Ignored</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Schematic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    id</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
    theorem</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
    tvars</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>indexname * sort</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    schematics</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    initial_round</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_grounds</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ground</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_schematic</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thm_info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>thm_info</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Schematic</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>theorem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>initial_round</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>theorem</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="entity"><span>initial_round</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_schematics</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="entity"><span>initial_round</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>initial_round</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_schematic</span></span><span> </span><span class="entity"><span>apply</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* collecting data *)</span></span><span>

</span><span class="comment1"><span>(*
  Theorems with type variables that cannot be instantiated should be ignored.
  A type variable has only a chance to be instantiated if it occurs in the
  type of one of the schematic constants.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>groundable</span></span><span> </span><span class="entity"><span>all_tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tvarsT</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tvars'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_tvars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare</span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>initial_round</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.exists_type</span><span> </span><span class="entity"><span>typ_has_tvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(* increase indices to avoid clashes of type variables *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.incr_indexes</span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tvars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematics'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

          </span><span class="comment1"><span>(* collect the names of all constants that need to be instantiated *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>consts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schematics</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_info</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>groundable</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Ignored</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>Schematic</span></span><span> </span><span class="main"><span>{</span></span><span>
                id </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span>
                theorem </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>,</span></span><span>
                tvars </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>,</span></span><span>
                schematics </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematics'</span></span><span class="main"><span>,</span></span><span>
                initial_round </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initial_round</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm_info</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ground</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold_map</span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span> </span><span>||&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* collecting instances *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert'</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert'</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_new_grounds</span></span><span> </span><span class="entity"><span>used_grounds</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mem</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup_list</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mem</span></span><span> </span><span class="entity"><span>used_grounds</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>mem</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Symtab.defined</span><span> </span><span class="entity"><span>used_grounds</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Symtab.insert_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.fold_aterms</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_insts</span></span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>round</span></span><span>
    </span><span class="entity"><span>used_grounds</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ENOUGH</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>sort</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>Vartab.table</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Inttab.table</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_grounds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>hits</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>misses</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ENOUGH</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>instantiate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>round</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Inttab.lookup_list</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>id</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n_insts'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span>eq_snd</span><span> </span><span>Thm.eq_thm</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="entity"><span>rthm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>hits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hits'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hits</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>hits'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses'</span></span><span class="main"><span>,</span></span><span> </span><span>Inttab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rthm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>next_grounds'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>add_new_grounds</span></span><span> </span><span class="entity"><span>used_grounds</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="entity"><span>next_grounds</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_grounds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n_insts'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_grounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>matching</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(* one-step refinement of the given substitution *)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>subst'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>matching</span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_matching_ground</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(* Try new grounds before already used grounds. Otherwise only
         substitutions already seen in previous rounds get enumerated. *)</span></span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_grounds</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span>#&gt;</span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_grounds</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_grounds</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_complete</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(* Check if a substitution is defined for all TVars of the theorem,
         which guarantees that the instantiation with this substitution results
         in a ground theorem since all matchings that led to this substitution
         are with ground types only. *)</span></span><span>
      </span><span>subset</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvars</span></span><span class="main"><span>,</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>for_schematics</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>for_schematics</span></span><span> </span><span class="entity"><span>used_new</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>with_matching_ground</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_complete</span></span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>used_new</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>subst'</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>for_schematics</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used_new</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>subst'</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
          </span><span class="entity"><span>for_schematics</span></span><span> </span><span class="entity"><span>used_new</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>subst</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="comment1"><span>(* Enumerate all substitutions that lead to a ground instance of the
       theorem not seen before. A necessary condition for such a new ground
       instance is the usage of at least one ground from the new_grounds
       table. The approach used here is to match all schematics of the theorem
       with all relevant grounds. *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cx</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>for_schematics</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span>Vartab.empty</span><span> </span><span class="entity"><span>cx</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>ENOUGH</span></span><span> </span><span class="entity"><span>cx'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cx'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_new</span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="entity"><span>initial_round</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>round</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initial_round</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_active</span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="entity"><span>initial_round</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>round</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>initial_round</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_instances</span></span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span>
    </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>round</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known_grounds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_grounds0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_grounds</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Symtab.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>grounds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>grounds</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grounds</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>take</span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span>Term_Ord.typ_ord</span><span> </span><span class="entity"><span>grounds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_grounds0</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_new</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_insts</span></span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span>
      </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>round</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_all</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>misses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>hits</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>misses</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>cx</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>fold_schematics</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="entity"><span>cx</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_grounds'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known_grounds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_grounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clear_grounds</span></span><span> </span><span class="entity"><span>known_grounds'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_grounds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>consider_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_active</span></span><span> </span><span class="entity"><span>round</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_new</span></span><span> </span><span class="entity"><span>known_grounds</span></span><span> </span><span class="entity"><span>new_grounds</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>consider_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_new</span></span><span> </span><span class="entity"><span>round</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_new</span></span><span> </span><span class="entity"><span>empty_grounds</span></span><span> </span><span class="entity"><span>known_grounds'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>known_grounds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_grounds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_ground_types</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.map_entry</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_instances</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_grounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_grounds</span></span><span> </span><span class="entity"><span>add_ground_types</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="entity"><span>consts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_grounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clear_grounds</span></span><span> </span><span class="entity"><span>known_grounds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_new_instances</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Schematic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>limit_rounds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_instances</span></span><span> </span><span class="entity"><span>max_instances</span></span><span> </span><span class="entity"><span>max_duplicated_instances</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span>
          </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>empty_grounds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>known_grounds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Inttab.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>insts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* monomorphization *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>size_of_subst</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span>o</span><span> </span><span>size_of_typ</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_ord</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>size_of_subst</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiated_thms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ground</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instantiated_thms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Ignored</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instantiated_thms</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Schematic</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Inttab.lookup_list</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>id</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rthms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>take</span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="entity"><span>subst_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rthms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monomorph</span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_thm_instances</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_new_const_instances_per_round</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm_infos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepare</span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="entity"><span>rthms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.is_empty</span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Inttab.empty</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>collect_instances</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>max_schematics</span></span><span> </span><span class="entity"><span>max_new_grounds</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="entity"><span>consts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiated_thms</span></span><span> </span><span class="entity"><span>max_thm_insts</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm_infos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>