<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_mepo.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_mepo.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_mepo.ML
    Author:     Jia Meng, Cambridge University Computer Laboratory and NICTA
    Author:     Jasmin Blanchette, TU Muenchen

Sledgehammer's iterative relevance filter (MePo = Meng-Paulson).
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_MEPO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Fact.lazy_fact</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Fact.fact</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Prover.params</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>local_const_multiplier </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     worse_irrel_freq </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     higher_order_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     abs_rel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     abs_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     theory_const_rel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     theory_const_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     chained_const_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     intro_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     elim_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     simp_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     local_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     assum_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     chained_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     max_imperfect </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     max_imperfect_exp </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     threshold_divisor </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
     ridiculous_threshold </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pseudo_abs_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_relevance_fudge </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mepo_suggested_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_MePo</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_MEPO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem_Generate</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Fact</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Prover</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Sledgehammer.sledgehammer_mepo_trace|attribute"><span>sledgehammer_mepo_trace</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sledgehammer_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Sledgehammer"</span></span><span> </span><span>^</span><span> </span><span>Long_Name.separator</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pseudo_abs_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sledgehammer_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"abs"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>theory_const_suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.separator</span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" 1"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>local_const_multiplier </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   worse_irrel_freq </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   higher_order_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   abs_rel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   abs_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   theory_const_rel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   theory_const_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   chained_const_irrel_weight </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   intro_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   elim_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   simp_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   local_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   assum_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   chained_bonus </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   max_imperfect </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   max_imperfect_exp </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   threshold_divisor </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>,</span></span><span>
   ridiculous_threshold </span><span class="main"><span>:</span></span><span> </span><span>real</span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(* FUDGE *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_relevance_fudge</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>local_const_multiplier </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.5</span></span><span class="main"><span>,</span></span><span>
   worse_irrel_freq </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>100.0</span></span><span class="main"><span>,</span></span><span>
   higher_order_irrel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.05</span></span><span class="main"><span>,</span></span><span>
   abs_rel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.5</span></span><span class="main"><span>,</span></span><span>
   abs_irrel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2.0</span></span><span class="main"><span>,</span></span><span>
   theory_const_rel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.5</span></span><span class="main"><span>,</span></span><span>
   theory_const_irrel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.25</span></span><span class="main"><span>,</span></span><span>
   chained_const_irrel_weight </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.25</span></span><span class="main"><span>,</span></span><span>
   intro_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.15</span></span><span class="main"><span>,</span></span><span>
   elim_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.15</span></span><span class="main"><span>,</span></span><span>
   simp_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.15</span></span><span class="main"><span>,</span></span><span>
   local_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.55</span></span><span class="main"><span>,</span></span><span>
   assum_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.05</span></span><span class="main"><span>,</span></span><span>
   chained_bonus </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.5</span></span><span class="main"><span>,</span></span><span>
   max_imperfect </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>11.5</span></span><span class="main"><span>,</span></span><span>
   max_imperfect_exp </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span class="main"><span>,</span></span><span>
   threshold_divisor </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2.0</span></span><span class="main"><span>,</span></span><span>
   ridiculous_threshold </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.1</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_of_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_of_type</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>order_of_type</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>order_of_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span>o</span><span> </span><span class="entity"><span>order_of_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>order_of_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="comment1"><span>(* An abstraction of Isabelle types and first-order terms *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PVar</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PApp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * pattern list
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ptype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * typ list

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_patternsT</span></span><span> </span><span class="entity"><span>ps</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>string_of_patternsT</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_patternT</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_ptype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>string_of_patternsT</span></span><span> </span><span class="entity"><span>ps</span></span><span>

</span><span class="comment1"><span>(*Is the second type an instance of the first one?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_patternT</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_patternT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match_patternT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_ptype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match_patternsT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Is there a unifiable constant? *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pconst_mem</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_ptype</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pconst_hyper_mem</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_ptype</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>these</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Pairs a constant with the list of its type instantiations. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ptype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.const_typargs</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rich_ptype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_of_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rich_pconst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rich_ptype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_hyper_pconst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_ptype</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>patternT_eq</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternT_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternT_eq</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternT_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patternT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ptype_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>patternsT_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span>

 </span><span class="comment1"><span>(* Add a pconstant to the table, but a [] entry means a standard connective, which we ignore. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_pconst_to_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>ptype_eq</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Set constants tend to pull in too many irrelevant facts. We limit the damage by treating them
   more or less as if they were built-in but add their axiomatization at the end. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Collect|const"><span>Collect</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.member|const"><span>Set.member</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.Collect_mem_eq|fact"><span>Collect_mem_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.mem_Collect_eq|fact"><span>mem_Collect_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.Collect_cong|fact"><span>Collect_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_pconsts_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set_consts</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_irrelevant_const</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>add_pconst_to_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rich_pconst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>ext_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>ext_arg</span></span><span class="main"><span>)</span></span><span>
         </span><span class="comment1"><span>(* Since lambdas on the right-hand side of equalities are usually extensionalized later by
            "abs_extensionalize_term", we don't penalize them here. *)</span></span><span>
         </span><span>?</span><span> </span><span class="entity"><span>add_pconst_to_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order_of_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span class="entity"><span>ext_arg</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>ext_arg</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term_or_formula</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t3</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span>  </span><span class="comment1"><span>(* theory constant *)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>do_formula</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pconsts_in_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_pconsts_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(* Inserts a dummy "constant" referring to the theory name, so that relevance
   takes the given theory into account. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>theory_constify</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>theory_const_rel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>theory_const_irrel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>thy_name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>theory_const_rel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>theory_const_irrel_weight</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy_name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>theory_const_suffix</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>theory_const_prop_of</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>theory_constify</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.theory_base_name</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pair_consts_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>theory_const_prop_of</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>pconsts_in_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* A two-dimensional symbol table counts frequencies of constants. It's keyed
   first by constant name and second by its list of type instantiations. For the
   latter, we need a linear ordering on "pattern list". *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>patternT_ord</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fast_string_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>dict_ord</span><span> </span><span class="entity"><span>patternT_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>GREATER</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fast_string_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>GREATER</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ptype_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>dict_ord</span><span> </span><span class="entity"><span>patternT_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>PType_Tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ptype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ptype_ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count_fact_consts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(* Two-dimensional table update. Constant maps to types maps to count. *)</span></span><span>
      </span><span>PType_Tab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rich_ptype</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>PType_Tab.empty</span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>theory_const_prop_of</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="comment1"><span>(*The frequency of a constant is the sum of those of all instances of its type.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pconst_freq</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>PType_Tab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>Integer.add</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="comment1"><span>(* A surprising number of theorems contain only a few significant constants. These include all
   induction rules and other general theorems. *)</span></span><span>

</span><span class="comment1"><span>(* "log" seems best in practice. A constant function of one ignores the constant
   frequencies. Rare constants give more points if they are relevant than less
   rare ones. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_weight_for</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>freq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>2.0</span></span><span> </span><span>/</span><span> </span><span>Math.ln</span><span> </span><span class="main"><span>(</span></span><span>Real.fromInt</span><span> </span><span class="entity"><span>freq</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1.0</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Irrelevant constants are treated differently. We associate lower penalties to
   very rare constants and very common ones -- the former because they can't
   lead to the inclusion of too many new facts, and the latter because they are
   so common as to be of little interest. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>irrel_weight_for</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>worse_irrel_freq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>higher_order_irrel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>order</span></span><span>
    </span><span class="entity"><span>freq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>worse_irrel_freq</span></span><span> </span><span>|&gt;</span><span> </span><span>`</span><span>Real.ceil</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>freq</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Math.ln</span><span> </span><span class="main"><span>(</span></span><span>Real.fromInt</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>freq</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>/</span><span> </span><span>Math.ln</span><span> </span><span class="entity"><span>x</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rel_weight_for</span></span><span> </span><span class="entity"><span>order</span></span><span> </span><span class="entity"><span>freq</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>rel_weight_for</span></span><span> </span><span class="entity"><span>order</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
    </span><span>*</span><span> </span><span class="entity"><span>pow_int</span></span><span> </span><span class="entity"><span>higher_order_irrel_weight</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>multiplier_of_const_name</span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="inner_quoted"><span>"."</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span>

</span><span class="comment1"><span>(* Computes a constant's weight, as determined by its frequency. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generic_pconst_weight</span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span> </span><span class="entity"><span>abs_weight</span></span><span> </span><span class="entity"><span>theory_const_weight</span></span><span> </span><span class="entity"><span>chained_const_weight</span></span><span>
    </span><span class="entity"><span>weight_for</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_abs_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>abs_weight</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>theory_const_suffix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>theory_const_weight</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>multiplier_of_const_name</span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span>*</span><span> </span><span class="entity"><span>weight_for</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pconst_freq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_ptype</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>chained_const_weight</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>pconst_hyper_mem</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>*</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>chained_const_weight</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_pconst_weight</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>local_const_multiplier</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_rel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>theory_const_rel_weight</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>generic_pconst_weight</span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span> </span><span class="entity"><span>abs_rel_weight</span></span><span> </span><span class="entity"><span>theory_const_rel_weight</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span>
    </span><span class="entity"><span>rel_weight_for</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span>Symtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>irrel_pconst_weight</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fudge</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>local_const_multiplier</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_irrel_weight</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>theory_const_irrel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chained_const_irrel_weight</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>generic_pconst_weight</span></span><span> </span><span class="entity"><span>local_const_multiplier</span></span><span> </span><span class="entity"><span>abs_irrel_weight</span></span><span> </span><span class="entity"><span>theory_const_irrel_weight</span></span><span>
    </span><span class="entity"><span>chained_const_irrel_weight</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>irrel_weight_for</span></span><span> </span><span class="entity"><span>fudge</span></span><span class="main"><span>)</span></span><span> </span><span>swap</span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>intro_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Intro</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>elim_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Elim</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elim_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>simp_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Simp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>local_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Local</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>local_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>assum_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Assum</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assum_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>chained_bonus</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Chained</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chained_bonus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_odd_const_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_abs_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>theory_const_suffix</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_weight</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span>
                </span><span class="entity"><span>fact_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fact_consts</span></span><span> </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pconst_hyper_mem</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>rel_const_tab</span></span><span class="main"><span>)</span></span><span>
                   </span><span>||&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pconst_hyper_mem</span></span><span> </span><span>swap</span><span> </span><span class="entity"><span>rel_const_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>irrel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_odd_const_name</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>irrel</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="inner_numeral"><span>0.0</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>irrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>irrel</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pconst_mem</span></span><span> </span><span>swap</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rel_pconst_weight</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>const_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>irrel_weight</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>~</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stature_bonus</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>irrel_pconst_weight</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>irrel</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_weight</span></span><span> </span><span>/</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_weight</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>irrel_weight</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Real.isFinite</span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>take_most_relevant</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="entity"><span>remaining_max</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>max_imperfect</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_imperfect_exp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relevance_fudge</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lazy_fact</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ptype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>real</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_imperfect</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Real.ceil</span><span> </span><span class="main"><span>(</span></span><span>Math.pow</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_imperfect</span></span><span class="main"><span>,</span></span><span>
        </span><span>Math.pow</span><span> </span><span class="main"><span>(</span></span><span>Real.fromInt</span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span>/</span><span> </span><span>Real.fromInt</span><span> </span><span class="entity"><span>max_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_imperfect_exp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perfect</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imperfect</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>candidates</span></span><span>
      </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>Real.compare</span><span> </span><span>o</span><span> </span><span>swap</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>chop_prefix</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0.99999</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>accepts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more_rejects</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rejects</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>chop</span><span> </span><span class="entity"><span>max_imperfect</span></span><span> </span><span class="entity"><span>imperfect</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="entity"><span>perfect</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>chop</span><span> </span><span class="entity"><span>remaining_max</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="inner_quoted"><span>"Actually passed ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>accepts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" of "</span></span><span> </span><span>^</span><span>
      </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>candidates</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"): "</span></span><span> </span><span>^</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>accepts</span></span><span>
       </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>weight</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ["</span></span><span> </span><span>^</span><span> </span><span>Real.toString</span><span> </span><span class="entity"><span>weight</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>)</span></span><span>
       </span><span>|&gt;</span><span> </span><span>commas</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>accepts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more_rejects</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rejects</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>if_empty_replace_with_scope</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.is_empty</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>Symtab.empty</span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_pconsts_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sc'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sc'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_arities</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_widely_irrelevant_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span>SOME</span><span> </span><span class="entity"><span>tab</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* FIXME: This is currently only useful for polymorphic type encodings. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_benefit_from_ext</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consider_arities</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>is_none</span><span>

</span><span class="comment1"><span>(* High enough so that it isn't wrongly considered as very relevant (e.g., for E
   weights), but low enough so that it is unlikely to be truncated away if few
   facts are included. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>special_fact_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>45</span></span><span> </span><span class="comment1"><span>(* FUDGE *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_prod</span></span><span> </span><span class="entity"><span>eqx</span></span><span> </span><span class="entity"><span>eqy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>eqy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>really_hopeless_get_kicked_out_iter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span> </span><span class="comment1"><span>(* FUDGE *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relevance_filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thres0</span></span><span> </span><span class="entity"><span>decay</span></span><span> </span><span class="entity"><span>max_facts</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>fudge</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>threshold_divisor</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ridiculous_threshold</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>count_fact_consts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>fudge</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_pconsts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_pconsts_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chained_ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Chained</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_pconsts</span></span><span> </span><span class="entity"><span>chained_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_const_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Symtab.empty</span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_pconsts</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_pconsts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.is_empty</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>if_empty_replace_with_scope</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Chained</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Assum</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Local</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span class="entity"><span>thres</span></span><span> </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span class="entity"><span>hopeless</span></span><span> </span><span class="entity"><span>hopeful</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hopeless</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>hopeless</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>really_hopeless_get_kicked_out_iter</span></span><span> </span><span>?</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0.001</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relevant</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="comment1"><span>(* Nothing has been added this iteration. *)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>thres</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>ridiculous_threshold</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="comment1"><span>(* First iteration? Try again. *)</span></span><span>
              </span><span class="entity"><span>iter</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thres</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>threshold_divisor</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span class="entity"><span>hopeless</span></span><span> </span><span class="entity"><span>hopeful</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>relevant</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="entity"><span>rejects</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accepts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more_rejects</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>take_most_relevant</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>candidates</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accepts</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_const_tab'</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_pconst_to_table</span></span><span> </span><span class="entity"><span>sps</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_dirty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>rel_const_tab'</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span class="entity"><span>s</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hopeful_rejects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless_rejects</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>rejects</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|-&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_weight</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_dirty</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_weight</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>more_rejects</span></span><span>
                             </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_weight</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                        </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_dirty</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
                                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>old_weight</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thres</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>thres</span></span><span class="main"><span>)</span></span><span> </span><span>*</span><span> </span><span>Math.pow</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decay</span></span><span class="main"><span>,</span></span><span> </span><span>Real.fromInt</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>accepts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>accepts</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"New or updated constants: "</span></span><span> </span><span>^</span><span>
                </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_const_tab'</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span>
                  </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="entity"><span>ptype_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>rel_const_tab</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>string_of_hyper_pconst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span>@</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                 </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                 </span><span class="entity"><span>iter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>remaining_max</span></span><span> </span><span class="entity"><span>thres</span></span><span> </span><span class="entity"><span>rel_const_tab'</span></span><span> </span><span class="entity"><span>hopeless_rejects</span></span><span> </span><span class="entity"><span>hopeful_rejects</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>relevant</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="entity"><span>rejects</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_consts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cached_weight</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hopeful</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>weight</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cached_weight</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>w</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>fact_weight</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>const_tab</span></span><span> </span><span class="entity"><span>rel_const_tab</span></span><span> </span><span class="entity"><span>chained_const_tab</span></span><span> </span><span class="entity"><span>fact_consts</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>weight</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>thres</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>relevant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>weight</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>candidates</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rejects</span></span><span> </span><span class="entity"><span>hopeful</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>relevant</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>weight</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rejects</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hopeful</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="inner_quoted"><span>"ITERATION "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": current threshold: "</span></span><span> </span><span>^</span><span>
              </span><span>Real.toString</span><span> </span><span class="entity"><span>thres</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", constants: "</span></span><span> </span><span>^</span><span>
              </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_const_tab</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span>
                      </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;&gt;</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>string_of_hyper_pconst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>relevant</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>hopeful</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uses_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
                  </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uses_const_anywhere</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uses_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uses_const</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl_t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyp_ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_set_const_thms</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uses_const_anywhere</span></span><span> </span><span class="entity"><span>accepts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set_consts</span></span><span> </span><span>?</span><span> </span><span>append</span><span> </span><span class="entity"><span>set_thms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_into_facts</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accepts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_into_facts</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>ths</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bef</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accepts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>ths</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_facts</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>add</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="entity"><span>special_fact_index</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>bef</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>add</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>after</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_special_facts</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(* FIXME: get rid of "ext" here once it is treated as a helper *)</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>could_benefit_from_ext</span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ext|fact"><span>ext</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_set_const_thms</span></span><span> </span><span class="entity"><span>accepts</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>insert_into_facts</span></span><span> </span><span class="entity"><span>accepts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>facts</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pair_consts_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>fudge</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="entity"><span>thres0</span></span><span> </span><span class="entity"><span>goal_const_tab</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>insert_special_facts</span></span><span>
    </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>accepts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="inner_quoted"><span>"Total relevant: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>accepts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mepo_suggested_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>fact_thresholds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thres0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thres1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="entity"><span>fudge</span></span><span>
    </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>default_relevance_fudge</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decay</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Math.pow</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>thres1</span></span><span class="main"><span>)</span></span><span> </span><span>/</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>thres0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span>/</span><span> </span><span>Real.fromInt</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_facts</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Considering "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" facts"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>thres1</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0.0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="entity"><span>facts</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>thres0</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>thres0</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>thres1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span class="entity"><span>relevance_filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thres0</span></span><span> </span><span class="entity"><span>decay</span></span><span> </span><span class="entity"><span>max_facts</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>concl_t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>theory_constify</span></span><span> </span><span class="entity"><span>fudge</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_base_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>fact_of_lazy_fact</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>