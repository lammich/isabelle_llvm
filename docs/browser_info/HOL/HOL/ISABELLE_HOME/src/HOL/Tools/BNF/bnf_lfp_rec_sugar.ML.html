<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_lfp_rec_sugar.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_lfp_rec_sugar.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_lfp_rec_sugar.ML
    Author:     Lorenz Panny, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2013

Recursor sugar ("primrec").
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_LFP_REC_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Proof.context </span><span class="main"><span>-&gt;</span></span><span> Plugin_Name.filter </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Nonexhaustive_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Transfer_Option</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>rec_call</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>No_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * typ </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>int * typ</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>int * typ</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Nested_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * typ

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rec_ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     offset</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     calls</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_call</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rec_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>recx</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     fp_nesting_map_ident0s</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     fp_nesting_map_comps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     fp_nesting_pred_maps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     ctr_specs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     fp_res_index</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     C</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     fun_arg_Tsss </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Ctr_Sugar.ctr_sugar</span></span><span class="main"><span>,</span></span><span>
     recx</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     rec_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lfp_rec_extension</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>nested_simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     special_endgame_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>,</span></span><span>
     is_new_datatype</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     basic_lfp_sugars_of</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
       </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
       </span><span>typ</span><span> </span><span>list</span><span> * </span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span>
       * </span><span>Token.src</span><span> </span><span>list</span><span> * </span><span>bool</span><span> * </span><span>local_theory</span><span class="main"><span>,</span></span><span>
     rewrite_nested_rec_call</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
       </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_lfp_rec_extension</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lfp_rec_extension</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_basic_lfp_sugars_of</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> * </span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span>
    * </span><span>Token.src</span><span> </span><span>list</span><span> * </span><span>bool</span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rec_specs_of</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span class="entity"><span>rec_spec</span></span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span> * </span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lfp_rec_sugar_interpretation</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Rec_Sugar_Util.fp_rec_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs_cmd</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_global</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_simple</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
     * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> </span><span>list</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_LFP_Rec_Sugar</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_LFP_REC_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_General_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Rec_Sugar_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inductN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"induct"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simpsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"simps"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>rec_option</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Proof.context </span><span class="main"><span>-&gt;</span></span><span> Plugin_Name.filter </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Nonexhaustive_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Transfer_Option</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>rec_call</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>No_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * typ </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>int * typ</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>int * typ</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Nested_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * typ</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rec_ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   offset</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   calls</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_call</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rec_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>recx</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   fp_nesting_map_ident0s</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   fp_nesting_map_comps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   fp_nesting_pred_maps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   ctr_specs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   fp_res_index</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   C</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   fun_arg_Tsss </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span>
   recx</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   rec_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lfp_rec_extension</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>nested_simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   special_endgame_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>,</span></span><span>
   is_new_datatype</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   basic_lfp_sugars_of</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span>typ</span><span> </span><span>list</span><span> * </span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span>
     * </span><span>Token.src</span><span> </span><span>list</span><span> * </span><span>bool</span><span> * </span><span>local_theory</span><span class="main"><span>,</span></span><span>
   rewrite_nested_rec_call</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lfp_rec_extension</span></span><span> </span><span>option</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>merge_options</span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_lfp_rec_extension</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.put</span><span> </span><span>o</span><span> </span><span>SOME</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nested_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>nested_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nested_simps</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>special_endgame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>special_endgame_tac</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>special_endgame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_new_datatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>is_new_datatype</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_new_datatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_basic_lfp_sugars_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>arg_T_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unsupported type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>arg_T_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" at this stage"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_arg_Tsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_lfp_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>{</span></span><span>T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> fp_res_index </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> C </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> fun_arg_Tsss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_arg_Tsss</span></span><span class="main"><span>,</span></span><span> ctr_sugar </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span>
         recx </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> rec_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>basic_lfp_sugar</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TrueI</span></span><span> </span><span class="comment1"><span>(*dummy*)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>default_basic_lfp_sugars_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cannot recurse through type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>default_basic_lfp_sugars_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported mutual recursion at this stage"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>basic_lfp_sugars_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>basic_lfp_sugars_of</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>basic_lfp_sugars_of</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>default_basic_lfp_sugars_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_nested_rec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>rewrite_nested_rec_call </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported nested recursion"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LFP_Rec_Sugar_Plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lfp_rec_sugar_interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>LFP_Rec_Sugar_Plugin.interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_fp_rec_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>interpret_lfp_rec_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LFP_Rec_Sugar_Plugin.data</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_specs_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss0</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>missing_arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm0_kks</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>basic_lfp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>basic_lfp_sugars_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss0</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index </span><span class="entity"><span>basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_indices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_ctrss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctrs </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>perm_ctrss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_ctr_offsets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Integer.sum</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>perm_ctrss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kks</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_fpTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>C </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_fun_arg_Tssss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>fun_arg_Tsss </span><span class="entity"><span>perm_basic_lfp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute0</span></span><span> </span><span class="entity"><span>perm0_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm0_kks</span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="entity"><span>perm0_xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_indices</span></span><span> </span><span class="entity"><span>indices</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inducts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conj_dests</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>common_induct</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_fpTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_offsets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_ctr_offsets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_subst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>nn0</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.subst_TVars</span><span> </span><span class="entity"><span>As_rho</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substAT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>As_rho</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substCT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>Cs_rho</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substACT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substAT</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>substCT</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Cs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>substCT</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>call_of</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Nested_Rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>No_Rec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>substACT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>call_of</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>substACT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>substACT</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_spec</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="entity"><span>offset</span></span><span> </span><span class="entity"><span>fun_arg_Tss</span></span><span> </span><span class="entity"><span>rec_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_arg_hss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>indexedd</span></span><span> </span><span class="entity"><span>fun_arg_Tss</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flat_rec_arg_args</span></span><span> </span><span class="entity"><span>fun_arg_hss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_arg_iss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_index_eq</span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_arg_hss</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>{</span></span><span>ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> offset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset</span></span><span class="main"><span>,</span></span><span> calls </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>call_of</span></span><span> </span><span class="entity"><span>fun_arg_iss</span></span><span> </span><span class="entity"><span>fun_arg_Tss</span></span><span class="main"><span>,</span></span><span>
         rec_thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thm</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_specs</span></span><span> </span><span class="entity"><span>fp_res_index</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>rec_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_ctr_spec</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>perm_fun_arg_Tssss</span></span><span> </span><span class="entity"><span>fp_res_index</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>rec_thms</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="entity"><span>ctr_offset</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_res_index</span></span><span class="main"><span>,</span></span><span> ctr_sugar </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_lfp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>recx </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_co_rec</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="entity"><span>perm_Cs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substAT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span>
       fp_nesting_map_ident0s </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span class="main"><span>,</span></span><span> fp_nesting_map_comps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span class="main"><span>,</span></span><span>
       fp_nesting_pred_maps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span class="main"><span>,</span></span><span>
       ctr_specs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ctr_specs</span></span><span> </span><span class="entity"><span>fp_res_index</span></span><span> </span><span class="entity"><span>ctr_offset</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>rec_thms</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2m</span></span><span class="main"><span>,</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="entity"><span>ctr_offsets</span></span><span> </span><span class="entity"><span>basic_lfp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>missing_arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>basic_lfp_sugars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>undef_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>eqn_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  fun_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
  rec_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
  ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
  ctr_args</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  left_args</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  right_args</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  res_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
  rhs_term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
  user_eqn</span><span class="main"><span>:</span></span><span> </span><span>term</span><span>
</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_eqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_all</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_equation_lhs_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn0</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="entity"><span>eqn</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_equation_lhs_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ill_formed_equation_head</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop_prefix</span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nonfrees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop_suffix</span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_nonfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>nonfrees</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_nonfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_nonfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>missing_pattern</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>more_than_one_nonvar_in_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ill_formed_equation_head</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>nonfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>partially_applied_ctr_in_pattern</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_duplicate_variables_in_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>nonprimitive_pattern_in_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                  </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Variable.is_fixed</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span>cons</span><span> </span><span class="entity"><span>x</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>I</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>extra_variable_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>bads</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>fun_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span>
     rec_type </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>type_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span>
     ctr_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>,</span></span><span>
     left_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>left_args</span></span><span class="main"><span>,</span></span><span>
     right_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>,</span></span><span>
     res_type </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>)</span></span><span> </span><span>---&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span>
     rhs_term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span>
     user_eqn </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_rec_calls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>get_ctr_pos</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>mutual_calls</span></span><span> </span><span class="entity"><span>nested_calls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_nested_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_calls</span></span><span> </span><span class="entity"><span>y</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rewrite_nested_rec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>get_ctr_pos</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>y'</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>g'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>z</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>y_head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>head_of</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>y_head</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_nested_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>y_head</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t'</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>g'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_ctr_pos</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ctr_pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>g_args</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>ctr_pos</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>too_few_args_in_rec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_calls</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                     </span><span>SOME</span><span> </span><span class="entity"><span>y'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_args</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_comb</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>try_nested_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rec_call_not_apply_to_ctr_arg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>try_nested_rec</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>subst'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_rec_arg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funs_data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>eqn_data</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_ctr_spec</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>eqn_data_opt</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>eqn_data</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>eqn_data_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>undef_const</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>,</span></span><span> rhs_term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>calls </span><span class="entity"><span>ctr_spec</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>calls</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>No_Rec</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutual_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>calls</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Mutual_Rec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>calls</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Nested_Rec</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_unique</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="main"><span>(</span></span><span>Term.variant_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span>dest_Free</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>n_args</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Term.rename_wrt_term</span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Free</span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>nth_map</span><span> </span><span class="entity"><span>arg_idx</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>no_calls'</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>nth_map</span><span> </span><span class="entity"><span>arg_idx</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ensure_unique</span></span><span> </span><span class="entity"><span>xs</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>retype_const_or_free</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>mutual_calls'</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>nth_map</span><span> </span><span class="entity"><span>arg_idx</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>retype_const_or_free</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>ctr_arg_idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>nested_calls'</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_name_ctr_pos_list</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>left_args </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_ctr_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name_ctr_pos_list</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutual_calls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_calls'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_calls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_calls'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>t</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>subst_rec_calls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>get_ctr_pos</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span> </span><span class="entity"><span>mutual_calls</span></span><span> </span><span class="entity"><span>nested_calls</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>left_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>right_args</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_defs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>nonexhaustives</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funs_data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>eqn_data</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>rec_specs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n_funs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_spec_eqn_data_list'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>zs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>excess_equations</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>rhs_term </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>n_funs</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>funs_data</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>nonexhaustives</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_spec_eqn_data_list'</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>multiple_equations_for_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>user_eqn </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Context_Position.is_visible</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>no_equation_for_ctr_warning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_spec_eqn_data_list</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec_eqn_data_list'</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n_funs</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span> </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>n_funs</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>recx</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_spec_eqn_data_list</span></span><span>
      </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>offset </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>make_ord</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_rec_arg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>funs_data</span></span><span> </span><span class="entity"><span>has_call</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>the_single</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>left_args</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>inconstant_pattern_pos_for_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>hd</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>left_args </span><span>|&gt;</span><span> </span><span>length</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>recs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_poss</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr_pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_args</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>permute_args</span></span><span> </span><span class="entity"><span>ctr_pos</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_rec_calls</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>eqn_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span>fastype_of1</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>ctr_arg</span></span><span> </span><span>o</span><span> </span><span>head_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>f'</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span> </span><span>@</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>args'</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>curry</span><span> </span><span>list_comb</span><span> </span><span class="entity"><span>f'</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>mk_partial_compN</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>arg_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typof</span></span><span> </span><span class="entity"><span>arg_head</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>::</span><span>
                </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span> </span><span>@</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>callss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>callss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_primrec_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>num_extra_args</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span>
    </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span> </span><span class="entity"><span>fun_defs</span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_defs</span></span><span> </span><span>THEN</span><span>
  </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>funpow</span><span> </span><span class="entity"><span>num_extra_args</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nested_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span> </span><span>@</span><span>
    </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
  </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE</span><span>
    </span><span class="entity"><span>special_endgame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span> </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_primrec</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>nonexhaustives</span></span><span> </span><span class="entity"><span>transfers</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mxs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_split</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualifys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span>Binding.qualify</span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Binding.path_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqns_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_eqn</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funs_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span>
      </span><span>|&gt;</span><span> </span><span>partition_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fun_name</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>fun_name </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>y</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>List.Empty</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>missing_equations_for_fun</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;&gt;</span><span> </span><span>Binding.name_of</span><span> </span><span>#&gt;</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rec_type </span><span>o</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>res_type </span><span>o</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funs_data</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>partition_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_rec_calls</span></span><span> </span><span class="entity"><span>has_call</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_only_old_datatype</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Data.get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_new_datatype</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_only_old_datatype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_only_old_datatype</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_top_sort</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rec_specs_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>funs_data</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>ignore</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>not_constructor_in_pattern</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>user_eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>eqns_data</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_defs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>nonexhaustives</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span> </span><span class="entity"><span>funs_data</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span> </span><span class="entity"><span>has_call</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rec_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>eqn_data</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>find_indices</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>fun_data</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_data</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fst</span><span>
          </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>user_eqn </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>left_args </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>right_args </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>rec_thm </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>user_eqn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_extra_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>mk_primrec_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>num_extra_args</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span>
                    </span><span class="entity"><span>fp_nesting_pred_maps</span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="entity"><span>rec_thm</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>js</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inductN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>qualifys</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>inducts</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_common_name</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>I</span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>inductN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>common_induct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>common_qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fun_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>{</span></span><span>transfers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfers</span></span><span class="main"><span>,</span></span><span> fun_names </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>,</span></span><span> funs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span>
             fun_defs </span><span class="main"><span>=</span></span><span> </span><span>Morphism.fact</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>def_thms</span></span><span class="main"><span>,</span></span><span> fpTs </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>map_prod</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interpret_lfp_rec_sugar</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>rec_specs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs_data</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>notes</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>common_notes</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_simple0</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_duplicate_const_names</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nonexhaustives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>transfer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_primrec</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>nonexhaustives</span></span><span> </span><span class="entity"><span>transfers</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span>Local_Theory.define</span><span> </span><span class="entity"><span>defs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_def_consts</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>jss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>{</span></span><span>prefix </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           types </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span>
           result </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>jss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_simple</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>primrec_simple0</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>Plugin_Name.default_filter</span></span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>Old_Primrec.primrec_simple</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> result </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span>map_split</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thms</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>old_primrec</span></span><span> </span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="entity"><span>raw_specs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>Plugin_Name.default_filter</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Nonexhaustive_Option</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Transfer_Option</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="entity"><span>raw_specs</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.conglomerate</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>flat</span><span> </span><span>oooo</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_split</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>nth</span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_simp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>attrss</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>simpsN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>notes</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>primrec_simple0</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>nonexhaustive</span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>prefix </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> result </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>jss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span class="entity"><span>spec_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.equational_primrec</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_notes</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>qualifys</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span>
      </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>code_plugin</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>old_primrec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="entity"><span>raw_specs</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>result </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thms</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>Old_Primrec.primrec</span></span><span> </span><span class="entity"><span>Specification.check_multi_specs</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>Old_Primrec.primrec_cmd</span></span><span> </span><span class="entity"><span>Specification.read_multi_specs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_global</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Named_Target.theory_init</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span>
  </span><span>##&gt;</span><span> </span><span>Local_Theory.exit_global</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_overloaded</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>ops</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Overloading.overloading</span></span><span> </span><span class="entity"><span>ops</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span>
  </span><span>##&gt;</span><span> </span><span>Local_Theory.exit_global</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_option_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.group</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"option"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Plugin_Name.parse_filter</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Plugins_Option</span></span><span>
   </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"nonexhaustive"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Nonexhaustive_Option</span></span><span>
   </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"transfer"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Transfer_Option</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>primrec</span></span><span>›</span></span></span><span>
  </span><span class="inner_quoted"><span>"define primitive recursive functions"</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.list1</span><span> </span><span class="entity"><span>rec_option_parser</span></span><span class="main"><span>)</span></span><span>
      </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Parse_Spec.specification</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>primrec_cmd</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>