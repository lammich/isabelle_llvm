<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Meson/meson.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Meson/meson.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Meson/meson.ML
    Author:     Lawrence C Paulson, Cambridge University Computer Laboratory
    Author:     Jasmin Blanchette, TU Muenchen

The MESON resolution proof procedure for HOL.
When making clauses, avoids using the rewriter -- instead uses RS recursively.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>MESON</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>if_simps </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span> let_simps </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simp_options_all_true </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_clauses </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> first_order_resolve </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> size_of_subgoals</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> has_too_many_clauses</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_cnf</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> finish_cnf</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> presimplified_consts </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> presimplify</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_nnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> choice_theorems </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> skolemize_with_choice_theorems </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> skolemize </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cong_extensionalize_thm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_extensionalize_conv </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_extensionalize_thm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_clauses_unsorted</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_clauses</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_horns</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> best_prolog_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_prolog_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gocls</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> skolemize_prems_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> MESON</span><span class="main"><span>:</span></span><span>
    </span><span>tactic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> best_meson_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_best_meson_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_meson_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prolog_step_tac'</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> iter_deepen_prolog_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> iter_deepen_meson_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_meta_clause</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_meta_clauses</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> meson_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Meson</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MESON</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>if_simps </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span> let_simps </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_options_all_true</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>if_simps </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> let_simps </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Meson.meson_trace|attribute"><span>meson_trace</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Meson.meson_max_clauses|attribute"><span>meson_max_clauses</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>60</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*No known example (on 1-5-2007) needs even thirty*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iter_deepen_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>50</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_forward</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_forward|fact"><span>disj_forward</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_forward2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_forward2|fact"><span>disj_forward2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_pos_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_pos_rule|fact"><span>make_pos_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_pos_rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_pos_rule&apos;|fact"><span>make_pos_rule'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_pos_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_pos_goal|fact"><span>make_pos_goal</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_neg_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_neg_rule|fact"><span>make_neg_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_neg_rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_neg_rule&apos;|fact"><span>make_neg_rule'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_neg_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.make_neg_goal|fact"><span>make_neg_goal</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_forward</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.conj_forward|fact"><span>conj_forward</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_forward</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.all_forward|fact"><span>all_forward</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex_forward</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.ex_forward|fact"><span>ex_forward</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_conjD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_conjD|fact"><span>not_conjD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_disjD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_disjD|fact"><span>not_disjD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_notD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_notD|fact"><span>not_notD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_allD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_allD|fact"><span>not_allD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_exD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_exD|fact"><span>not_exD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imp_to_disjD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.imp_to_disjD|fact"><span>imp_to_disjD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_impD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_impD|fact"><span>not_impD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iff_to_disjD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.iff_to_disjD|fact"><span>iff_to_disjD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_iffD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_iffD|fact"><span>not_iffD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_exD1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.conj_exD1|fact"><span>conj_exD1</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_exD2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.conj_exD2|fact"><span>conj_exD2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_exD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_exD|fact"><span>disj_exD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_exD1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_exD1|fact"><span>disj_exD1</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_exD2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_exD2|fact"><span>disj_exD2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_assoc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_assoc|fact"><span>disj_assoc</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_comm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_comm|fact"><span>disj_comm</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_FalseD1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_FalseD1|fact"><span>disj_FalseD1</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_FalseD2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.disj_FalseD2|fact"><span>disj_FalseD2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Operators for forward proof ****)</span></span><span>


</span><span class="comment1"><span>(** First-order Resolution **)</span></span><span>

</span><span class="comment1"><span>(*FIXME: currently does not "rename variables apart"*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_order_resolve</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thA</span></span><span> </span><span class="entity"><span>thB</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">try</span><span class="hidden">&gt;</span></span></span><span class="entity"><span>‹
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tmA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thA</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>tmB</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thB</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Pattern.first_order_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tmB</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tmA</span></span><span class="main"><span>)</span></span><span>
                                          </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>thA</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>thB</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"first_order_resolve"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thA</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thB</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Hack to make it less likely that we lose our precious bound variable names in
   "rename_bound_vars_RS" below, because of a clash. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>protect_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Meson_xyzzy"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>protect_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix_bound_var_names</span></span><span> </span><span class="entity"><span>old_t</span></span><span> </span><span class="entity"><span>new_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>quant_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flip_quant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span>not</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>some_eq</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant_s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>some_eq</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant_of</span></span><span> </span><span class="entity"><span>quant_s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flip_quant</span></span><span> </span><span class="entity"><span>quant</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flip_quant</span></span><span> </span><span class="entity"><span>quant</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_names</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lost_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>new_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_names</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>old_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant_s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>protect_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span>
                   </span><span>?</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lost_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant_of</span></span><span> </span><span class="entity"><span>quant_s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>new_t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Forward proof while preserving bound variables names *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_bound_vars_RS</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span>Thm.rename_boundvars</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>protect_bound_var_names</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.rename_boundvars</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fix_bound_var_names</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*raises exception if no rules apply*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryres</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tryres"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span>::</span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rl</span></span><span>::</span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>rename_bound_vars_RS</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>tryall</span></span><span> </span><span class="entity"><span>rls</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Special version of "resolve_tac" that works around an explosion in the unifier.
   If the goal has the form "?P c", the danger is that resolving it against a
   property of the form "... c ... c ... c ..." will lead to a huge unification
   problem, due to the (spurious) choices between projection and imitation. The
   workaround is to instantiate "?P := (%c. ... c ... c ... c ...)" manually. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quant_resolve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.lambda</span><span> </span><span class="entity"><span>cc</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>

</span><span class="comment1"><span>(*Permits forward proof from rules that discharge assumptions. The supplied proof state st,
  e.g. from conj_forward, should have the form
    "⟦P' ⟹ ?P; Q' ⟹ ?Q⟧ ⟹ ?P ∧ ?Q"
  and the effect should be to instantiate ?P and ?Q with normalized versions of P' and Q'.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forward_res</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>nf</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tacf</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prem</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quant_resolve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nf</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tacf</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad proof state in forward_res, please inform lcp@cl.cam.ac.uk:"</span></span><span> </span><span>::</span><span>
            </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span>::</span><span>
            </span><span class="inner_quoted"><span>"Premises:"</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Misc_Legacy.METAHYPS</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tacf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"forward_res"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>st</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Are any of the logical connectives in "bs" present in the term?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_conns</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>q</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>q</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>q</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>q</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>has</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Clause handling ****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>P</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>Q</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>Q</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*number of literals in a term*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nliterals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span>o</span><span> </span><span class="entity"><span>literals</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Tautology Checking ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>Q</span></span><span>›</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="entity"><span>Q</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span>›</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span>::</span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span>::</span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>signed_lits</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_lits_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Literals like X=X are tautologous*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>taut_poslit</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>taut_poslit</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>taut_poslit</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_taut</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poslits</span></span><span class="main"><span>,</span></span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_lits</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span>exists</span><span> </span><span class="entity"><span>taut_poslit</span></span><span> </span><span class="entity"><span>poslits</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>neglits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>poslits</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>       </span><span class="comment1"><span>(*probably dest_Trueprop on a weird theorem*)</span></span><span>


</span><span class="comment1"><span>(*** To remove trivial negated equality literals from clauses ***)</span></span><span>

</span><span class="comment1"><span>(*They are typically functional reflexivity axioms and are the converses of
  injectivity equivalences*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_refl_disj_D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.not_refl_disj_D|fact"><span>not_refl_disj_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Is either term a Var that does not properly occur in the other term?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eliminable</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Logic.occs</span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eliminable</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Logic.occs</span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eliminable</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_assoc</span></span><span class="main"><span>)</span></span><span>    </span><span class="comment1"><span>(*isolate an atom as first disjunct*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span></span><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>eliminable</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>not_refl_disj_D</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(*Var inequation: delete*)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_comm</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(*not between Vars: ignore*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_comm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*not a disjunction*)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>Q</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="entity"><span>Q</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Simplify a clause by applying reflexivity to its negated equality literals*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refl_clause</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>notequal_lits_count</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span>zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>refl_clause_aux</span></span><span> </span><span class="entity"><span>neqs</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>  </span><span class="comment1"><span>(*probably dest_Trueprop on a weird theorem*)</span></span><span>


</span><span class="comment1"><span>(*** Removal of duplicate literals ***)</span></span><span>

</span><span class="comment1"><span>(*Forward proof, passing extra assumptions as theorems to the tactic*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forward_res2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>nf</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span>
        </span><span class="main"><span>(</span></span><span>REPEAT</span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>Misc_Legacy.METAHYPS</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>major</span></span><span>::</span><span class="entity"><span>minors</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>minors</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>major</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
         </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"forward_res2"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>st</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Remove duplicates in P∨Q by assuming ¬P in Q
  rls (initially []) accumulates assumptions of the form P==&gt;False*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nodups_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nodups_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_assoc</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>forward_res2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nodups_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_forward2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="main"><span>[</span></span><span class="entity"><span>disj_FalseD1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_FalseD2</span></span><span class="main"><span>,</span></span><span> </span><span>asm_rl</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Remove duplicate literals, if there are any*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nodups</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nodups_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** The basic CNF transformation ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>estimated_num_clauses</span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span>+</span><span class="entity"><span>y</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>bound</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prod</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span>*</span><span class="entity"><span>y</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>bound</span></span><span>
  
  </span><span class="comment1"><span>(*Estimate the number of clauses in order to detect infeasible theorems*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="comment1"><span>(*Boolean equality is if-and-only-if*)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>sum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* literal *)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>signed_nclauses</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_too_many_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_cl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>max_clauses</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>estimated_num_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_cl</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_cl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*Replaces universally quantified variables by FREE variables -- because
  assumptions may not contain scheme variables.  Later, generalize using Variable.export. *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec_var</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.term_of</span><span> </span><span>|&gt;</span><span> </span><span>dest_Var</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.uu</span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_spec</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>spec</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span>
          </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spec_var</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>spec_var</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>spec'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_skolem_theorem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"apply_skolem_theorem"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span>::</span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rl</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>first_order_resolve</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="entity"><span>rls</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>tryall</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Conjunctive normal form, adding clauses from th in front of ths (for foldr).
   Strips universal quantifiers and breaks up conjunctions.
   Eliminates existential quantifiers using Skolemization theorems. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf</span></span><span> </span><span class="entity"><span>old_skolem_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_ref</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="entity"><span>ctxt</span></span><span>   </span><span class="comment1"><span>(* FIXME ??? *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="comment1"><span>(*meta-level: ignore*)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_conns</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nodups</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="comment1"><span>(*no work to do, terminate*)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*conjunction*)</span></span><span>
                </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="comment1"><span>(*universal quantifier*)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>freeze_spec</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span> </span><span class="entity"><span>ctxt_ref</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>ctxt_ref</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="comment1"><span>(*existential quantifier: Insert Skolem functions*)</span></span><span>
              </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_skolem_theorem</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span> </span><span class="entity"><span>ctxt_ref</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_skolem_ths</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="comment1"><span>(*Disjunction of P, Q: Create new goal of proving ?P | ?Q and solve it using
                all combinations of converting P, Q to CNF.*)</span></span><span>
              </span><span class="comment1"><span>(*There is one assumption, which gets bound to prem and then normalized via
                cnf_nil. The normal form is given to resolve_tac, instantiate a Boolean
                variable created by resolution with disj_forward. Since (cnf_nil prem)
                returns a LIST of theorems, we can backtrack to get all combinations.*)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Misc_Legacy.METAHYPS</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prem</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnf_nil</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span>Seq.list_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_forward</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ths</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nodups</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ths</span></span><span>  </span><span class="comment1"><span>(*no work to do*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>cnf_nil</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_too_many_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="inner_quoted"><span>"cnf is ignoring: "</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>cnf_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>ctxt_ref</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_cnf</span></span><span> </span><span class="entity"><span>old_skolem_ths</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>cnf</span></span><span> </span><span class="entity"><span>old_skolem_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*Generalization, removal of redundant equalities, removal of tautologies.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>finish_cnf</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_taut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>refl_clause</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Generation of contrapositives ****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_left</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_left</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Associate disjuctions to right -- make leftmost disjunct a LITERAL*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assoc_right</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_left</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>assoc_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_assoc</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Must check for negative literal first!*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>disj_assoc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_neg_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_pos_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*For ordinary resolution. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>resolution_clause_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>disj_assoc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_neg_rule'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_pos_rule'</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Create a goal or support clause, conclusing False*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_goal</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>   </span><span class="comment1"><span>(*Must check for negative literal first!*)</span></span><span>
    </span><span class="entity"><span>make_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clause_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>make_neg_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make_pos_goal</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rigid</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ok4horn</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rigid</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ok4horn</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rigid</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ok4horn</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Create a meta-level Horn clause*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_horn</span></span><span> </span><span class="entity"><span>crules</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ok4horn</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>make_horn</span></span><span> </span><span class="entity"><span>crules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span class="entity"><span>crules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Generate Horn clauses for all contrapositives of a clause. The input, th,
  is a HOL disjunction.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_contras</span></span><span> </span><span class="entity"><span>crules</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>hcs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rots</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hcs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rots</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_horn</span></span><span> </span><span class="entity"><span>crules</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                        </span><span class="entity"><span>rots</span></span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assoc_right</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>disj_comm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>nliterals</span></span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>::</span><span class="entity"><span>hcs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rots</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assoc_right</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Use "theorem naming" to label the clauses*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_thms</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name1</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.put_name_hint</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="entity"><span>name1</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Is the given disjunction an all-negative support clause?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_negative</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_negative</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(***** MESON PROOF PROCEDURE *****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rhyps</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>A</span></span><span>›</span></span></span><span> </span><span class="entity"><span>phi</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhyps</span></span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span>::</span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rhyps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** Detecting repeated assumptions in a subgoal **)</span></span><span>

</span><span class="comment1"><span>(*The stringtree detects repeated assumptions.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ins_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*detects repetitions in a list of terms*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_reps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_reps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_reps</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_reps</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>ins_term</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>Net.empty</span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Net.INSERT</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Like TRYALL eq_assume_tac, but avoids expensive THEN calls*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>TRYING_eq_assume_tac</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TRYING_eq_assume_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="entity"><span>TRYING_eq_assume_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.eq_assumption</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>TRYING_eq_assume_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>TRYALL_eq_assume_tac</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TRYING_eq_assume_tac</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Loop checking: FAIL if trying to prove the same thing twice
  -- if *ANY* subgoal has repeated literals*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tac</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>has_reps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhyps</span></span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>  </span><span>Seq.empty</span><span>  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>  </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* resolve_from_net_tac actually made it slower... *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prolog_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>APPEND</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>check_tac</span></span><span> </span><span>THEN</span><span>
    </span><span class="entity"><span>TRYALL_eq_assume_tac</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Sums the sizes of the subgoals, ignoring hypotheses (ancestors)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addconcl</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>size_of_term</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>sz</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>size_of_subgoals</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>addconcl</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*Negation Normal Form*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nnf_rls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>imp_to_disjD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iff_to_disjD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_conjD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_disjD</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>not_impD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_iffD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_allD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_exD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_notD</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ok4nnf</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rigid</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ok4nnf</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rigid</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ok4nnf</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_nnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ok4nnf</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>make_nnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nnf_rls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tryres"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>forward_res</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_nnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>tryres</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>conj_forward</span></span><span class="main"><span>,</span></span><span class="entity"><span>disj_forward</span></span><span class="main"><span>,</span></span><span class="entity"><span>all_forward</span></span><span class="main"><span>,</span></span><span class="entity"><span>ex_forward</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tryres"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span>

</span><span class="comment1"><span>(*The simplification removes defined quantifiers and occurrences of True and False.
  nnf_ss also includes the one-point simprocs,
  which are needed to avoid the various one-point theorems from generating junk clauses.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nnf_simps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.simp_implies_def|fact"><span>simp_implies_def</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1_def|fact"><span>Ex1_def</span></a><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.Ball_def|fact"><span>Ball_def</span></a><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.Bex_def|fact"><span>Bex_def</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_True|fact"><span>if_True</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_False|fact"><span>if_False</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_cancel|fact"><span>if_cancel</span></a><span>
         </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_eq_cancel|fact"><span>if_eq_cancel</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.cases_simp|fact"><span>cases_simp</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nnf_extra_simps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>if_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>if_simps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Set.html#Set.split_ifs|fact"><span>split_ifs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ex_simps|fact"><span>ex_simps</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.all_simps|fact"><span>all_simps</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.simp_thms|fact"><span>simp_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="comment1"><span>(* FIXME: "let_simp" is probably redundant now that we also rewrite with
  "Let_def [abs_def]". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nnf_ss</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nnf_extra_simps</span></span><span> </span><span class="entity"><span>simp_options</span></span><span class="main"><span>)</span></span><span>
    </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>defined_All</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>defined_Ex</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>neq</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>let_simp</span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>presimplified_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.simp_implies|const"><span>simp_implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>presimplify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_options</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>let_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simp_options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>safe_mk_meta_eq</span></span><span> </span><span class="entity"><span>nnf_simps</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nnf_ss</span></span><span> </span><span class="entity"><span>simp_options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>let_simps</span></span><span> </span><span>?</span><span> </span><span>rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let_def|fact"><span>Let_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_nnf</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>presimplify</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>make_nnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"make_nnf: premises in argument"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>choice_theorems</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Global_Theory.get_thm</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Hilbert_Choice.choice"</span></span><span> </span><span>|&gt;</span><span> </span><span>the_list</span><span>

</span><span class="comment1"><span>(* Pull existential quantifiers to front. This accomplishes Skolemization for
   clauses that arise from a subgoal. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skolemize_with_choice_theorems</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>choice_ths</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_conns</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>th</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>tryres</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice_ths</span></span><span> </span><span>@</span><span>
                    </span><span class="main"><span>[</span></span><span class="entity"><span>conj_exD1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conj_exD2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_exD</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_exD1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_exD2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>aux</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tryres"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>tryres</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>conj_forward</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_forward</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_forward</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>forward_res</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>aux</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>aux</span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tryres"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>rename_bound_vars_RS</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>ex_forward</span></span><span>
                      </span><span>|&gt;</span><span> </span><span class="entity"><span>forward_res</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>aux</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>make_nnf</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skolemize</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>skolemize_with_choice_theorems</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>choice_theorems</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NO_F_PATTERN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_F_pattern</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>head1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span>strip_comb</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>head1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>args1</span></span><span> </span><span class="entity"><span>args2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head1</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NO_F_PATTERN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NO_F_PATTERN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>NONE</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NO_F_PATTERN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_cong_neq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.ext_cong_neq|fact"><span>ext_cong_neq</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="comment1"><span>(* Strengthens "f g ≠ f h" to "f g ≠ f h ∧ (∃x. g x ≠ h x)". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cong_extensionalize_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_F_pattern</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"F"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ext_cong_neq</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Removes the lambdas from an equation of the form "t = (%x1 ... xn. u)". It
   would be desirable to do this symmetrically but there's at least one existing
   proof in "Tarski" that relies on the current behavior. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs_extensionalize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>ct</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.fun_eq_iff|fact"><span>fun_eq_iff</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
             </span><span>then_conv</span><span> </span><span class="entity"><span>abs_extensionalize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.comb_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_extensionalize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.abs_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_extensionalize_conv</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_extensionalize_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span>o</span><span> </span><span class="entity"><span>abs_extensionalize_conv</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_skolemize_etc</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>cong_extensionalize_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span>
    </span><span class="comment1"><span>(* Extensionalize lambdas in "th", because that makes sense and that's what
       Sledgehammer does, but also keep an unextensionalized version of "th" for
       backward compatibility. *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>insert</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_extensionalize_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>|&gt;</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skolemize</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                               </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                              </span><span class="inner_quoted"><span>"Failed to skolemize "</span></span><span> </span><span>^</span><span>
                                               </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Variable.declare_thm</span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>make_cnf</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cnfs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Sort clauses by number of literals*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fewerlits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nliterals</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>nliterals</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*Make clauses from a list of theorems, previously Skolemized and put into nnf.
  The resulting clauses are HOL disjunctions.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_clauses_unsorted</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>make_ord</span><span> </span><span class="entity"><span>fewerlits</span></span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>make_clauses_unsorted</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Convert a list of clauses (disjunctions) to Horn clauses (contrapositives)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_horns</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>name_thms</span></span><span> </span><span class="inner_quoted"><span>"Horn#"</span></span><span>
      </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_contras</span></span><span> </span><span class="entity"><span>clause_rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Could simply use nprems_of, which would count remaining subgoals -- no
  discrimination as to their size!  With BEST_FIRST, fails for problem 41.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>best_prolog_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sizef</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>BEST_FIRST</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sizef</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prolog_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_prolog_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>DEPTH_FIRST</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prolog_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Return all negative clauses, as possible goal clauses*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gocls</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_thms</span></span><span> </span><span class="inner_quoted"><span>"Goal#"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>make_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neg_clauses</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skolemize_prems_tac</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>cut_facts_tac</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>try_skolemize_etc</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
    </span><span>REPEAT</span><span> </span><span>o</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exE</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(*Basis of all meson-tactics.  Supplies cltac with clauses: HOL disjunctions.
  Function mkcl converts theorems to clauses.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>MESON</span></span><span> </span><span class="entity"><span>preskolem_tac</span></span><span> </span><span class="entity"><span>mkcl</span></span><span> </span><span class="entity"><span>cltac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SELECT_GOAL</span><span>
    </span><span class="main"><span>(</span></span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ccontr|fact"><span>ccontr</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>preskolem_tac</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>negs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>EVERY1</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>skolemize_prems_tac</span></span><span> </span><span class="entity"><span>simp_options_all_true</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>negs</span></span><span class="main"><span>,</span></span><span>
                              </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cltac</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mkcl</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span>    </span><span class="comment1"><span>(*probably from make_meta_clause, not first-order*)</span></span><span>


</span><span class="comment1"><span>(** Best-first search versions **)</span></span><span>

</span><span class="comment1"><span>(*ths is a list of additional clauses (HOL disjunctions) to use.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>best_meson_tac</span></span><span> </span><span class="entity"><span>sizef</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>MESON</span></span><span> </span><span>all_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span>THEN_BEST_FIRST</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gocls</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sizef</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>prolog_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_horns</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(*First, breaks the goal into independent units*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_best_meson_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_meson_tac</span></span><span> </span><span class="entity"><span>size_of_subgoals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** Depth-first search version **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_meson_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>MESON</span></span><span> </span><span>all_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gocls</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>depth_prolog_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_horns</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(** Iterative deepening version **)</span></span><span>

</span><span class="comment1"><span>(*This version does only one inference per call;
  having only one eq_assume_tac speeds it up!*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prolog_step_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>horn0s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*0 subgoals vs 1 or more*)</span></span><span>
            </span><span>take_prefix</span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>horns</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nrtac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Tactic.build_net</span><span> </span><span class="entity"><span>horns</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>eq_assume_tac</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>ORELSE</span><span>
                </span><span>match_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horn0s</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>ORELSE</span><span>  </span><span class="comment1"><span>(*no backtracking if unit MATCHES*)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>APPEND</span><span> </span><span class="entity"><span>nrtac</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>check_tac</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iter_deepen_prolog_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>ITER_DEEPEN</span><span> </span><span class="entity"><span>iter_deepen_limit</span></span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prolog_step_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iter_deepen_meson_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>MESON</span></span><span> </span><span>all_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gocls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>  </span><span class="comment1"><span>(*no goal clauses*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>goes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>horns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_horns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"meson method called:"</span></span><span> </span><span>::</span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
              </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"clauses:"</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>horns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>THEN_ITER_DEEPEN</span><span> </span><span class="entity"><span>iter_deepen_limit</span></span><span>
            </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goes</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prolog_step_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>horns</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>meson_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter_deepen_meson_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Code to support ordinary resolution, rather than Model Elimination ****)</span></span><span>

</span><span class="comment1"><span>(*Convert a list of clauses (disjunctions) to meta-level clauses (==&gt;),
  with no contrapositives, for ordinary resolution.*)</span></span><span>

</span><span class="comment1"><span>(*Rules to convert the head literal into a negated assumption. If the head
  literal is already negated, then using notEfalse instead of notEfalse'
  prevents a double negation.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notEfalse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.notE|fact"><span>notE</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notEfalse'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.notE|fact"><span>notE</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negated_asm_of_head</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>notEfalse</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>notEfalse'</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Converting one theorem from a disjunction to a meta-level clause*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_meta_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thaw</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Misc_Legacy.freeze_thaw_robust</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
      </span><span class="main"><span>(</span></span><span>zero_var_indexes</span><span> </span><span>o</span><span> </span><span>Thm.varifyT_global</span><span> </span><span>o</span><span> </span><span class="entity"><span>thaw</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>o</span><span> 
       </span><span class="entity"><span>negated_asm_of_head</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>make_horn</span></span><span> </span><span class="entity"><span>resolution_clause_rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fth</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_meta_clauses</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>name_thms</span></span><span> </span><span class="inner_quoted"><span>"MClause#"</span></span><span>
      </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_meta_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>