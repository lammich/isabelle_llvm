<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Lifting/lifting_setup.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Lifting/lifting_setup.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Lifting/lifting_setup.ML
    Author:     Ondrej Kuncar

Setting up the lifting infrastructure.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIFTING_SETUP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> SETUP_LIFTING_INFR </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> notes</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_config</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup_by_quotient</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span>binding</span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup_by_typedef_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lifting_restore</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lifting_forget</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_transfer_rules</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pointer_of_bundle_binding</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Lifting_Setup</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIFTING_SETUP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Lifting_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> MRSL

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>SETUP_LIFTING_INFR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="comment1"><span>(* Config *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> notes</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> notes </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_crel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rep_fun</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>dest_funT</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rep_fun</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_fun_graph</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_fun</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_fun_graph</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>crel_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="inner_quoted"><span>"cr_"</span></span><span> </span><span class="entity"><span>qty_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_def_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.importT_terms</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_term</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>notes </span><span class="entity"><span>config</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Local_Theory.define</span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>crel_name</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>crel_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_def_term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> 
        </span><span>Local_Theory.define</span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="entity"><span>crel_name</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_def_term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
    </span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_define_pcrel_warning</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>warning_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cat_lines</span><span> 
      </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Generation of a parametrized correspondence relation failed."</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
         </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Reason:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>warning</span><span> </span><span class="entity"><span>warning_msg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_pcrel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>crel</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_crel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.importT_terms</span><span> </span><span class="entity"><span>crel</span></span><span> </span><span class="entity"><span>lthy0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixed_crel</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.generate_parametrized_relator</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>rty'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_raw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_rel</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyenv_match</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_raw</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_rel_subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.subst_term</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv_match</span></span><span class="main"><span>,</span></span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_rel</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args_subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_term</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv_match</span></span><span class="main"><span>,</span></span><span>Vartab.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Variable.declare_names</span><span> </span><span class="entity"><span>fixed_crel</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Variable.importT_inst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_rel_subst</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args_subst</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args_fixed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args_subst</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_rel_fixed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_rel_subst</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_rel_fixed</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relcomp_op</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>rty'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> 
          </span><span class="entity"><span>rty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="inner_quoted"><span>"pcr_"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty_name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relator_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>type_of</span><span> </span><span class="entity"><span>args_fixed</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>pcrel_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relator_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args_fixed</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>relcomp_op</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param_rel_fixed</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>fixed_crel</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>definition_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_def</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Specification.definition</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcrel_name</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>relator_type</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>definition_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_def</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Local_Defs.derived_def</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>conditional </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>definition_term</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Local_Theory.define</span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="entity"><span>pcrel_name</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>raw_th</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>notes </span><span class="entity"><span>config</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>note_def</span></span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>raw_def</span></span><span> </span><span class="entity"><span>lthy2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Lifting_Term.PARAM_QUOT_THM</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_define_pcrel_warning</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_OO_meta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Relation.html#Relation.eq_OO|fact"><span>eq_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span> 

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_generate_pcr_cr_eq_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>term</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>error_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cat_lines</span><span> 
        </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Generation of a pcr_cr_eq failed."</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
           </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Reason: Cannot prove this: "</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="inner_quoted"><span>"Most probably a relator_eq rule for one of the involved types is missing."</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>error</span><span> </span><span class="entity"><span>error_msg</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_pcr_cr_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>pcr_rel_def</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>Thm.lhs_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcr_rel_def</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span>
          </span><span>List.last</span><span> </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lhs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>strip_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lhs</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_inst</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relation_types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>typ</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fresh_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.invent_types</span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>fresh_var</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args_inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>make_inst</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>pcr_rel_def</span></span><span>
        </span><span>|&gt;</span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>args_ctxt</span></span><span> </span><span class="entity"><span>args_inst</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> 
          </span><span class="main"><span>(</span></span><span>Conv.bottom_rewrs_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_relator_eq</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>Thm.rhs_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="entity"><span>pcr_cr_eq</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>eq_OO_meta</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span>
            </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>args_ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>notes </span><span class="entity"><span>config</span></span><span> </span><span>?</span><span>
              </span><span class="main"><span>(</span></span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="inner_quoted"><span>"pcr_cr_eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>print_generate_pcr_cr_eq_error</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"generate_pcr_cr_eq: implementation error"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_code_constr</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_abs</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Const</span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.importT_terms</span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
         </span><span>Local_Theory.background_theory</span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>Code.declare_datatype_global</span></span><span> </span><span class="main"><span>[</span></span><span>dest_Const</span><span> </span><span class="entity"><span>fixed_abs</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_abs_type</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Lifting_Def.can_generate_code_cert</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span>?</span><span>
    </span><span class="entity"><span>Code.declare_abstype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_abs_rep|fact"><span>Quotient_abs_rep</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>QUOT_ERROR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quot_thm_sanity_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>   
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_ERROR</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span>
            </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The Quotient theorem has extra assumptions:"</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
             </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_Quotient</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_ERROR</span></span><span>
          </span><span class="main"><span>[</span></span><span>Pretty.block</span><span>
            </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The Quotient theorem is not of the right form:"</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
             </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm_fixed</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.importT</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm_fixed</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_tfreesT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfree_namesT</span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_tfreesT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfree_namesT</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_rty_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty_tfreesT</span></span><span> </span><span class="entity"><span>rty_tfreesT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Extra variables in the raw type:"</span></span><span class="main"><span>,</span></span><span>
                                 </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> 
                                 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Pretty.commas</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span>o</span><span> </span><span>quote</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extras</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                                 </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_type_constr</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>Type</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The quotient type "</span></span><span class="main"><span>,</span></span><span>
                                </span><span>Pretty.quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                                </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"is not a type constructor."</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_rty_tfrees</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>not_type_constr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_ERROR</span></span><span> </span><span class="entity"><span>errs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>QUOT_ERROR</span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Sanity check of the quotient theorem failed:"</span></span><span class="main"><span>]</span></span><span> 
                                            </span><span>@</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span>o</span><span> </span><span>Pretty.item</span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>errs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_bundle</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty_full_name</span></span><span> </span><span>|&gt;</span><span> </span><span>Long_Name.base_name</span><span> </span><span>|&gt;</span><span> </span><span>Binding.name</span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"lifting"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morphed_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.binding</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binding</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Name_Space.full_name</span><span> </span><span class="main"><span>(</span></span><span>Name_Space.naming_of</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>morphed_binding</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_qinfo</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.transform_quotient</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>qinfo</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummy_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>Drule.dummy_thm</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>restore_lifting_att</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>dummy_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>map</span><span> </span><span>Token.make_string0</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Lifting.lifting_restore_internal"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Lifting_Info.init_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_qinfo</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Bundle.bundle</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>restore_lifting_att</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>binding</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_lifting_infr</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_sanity_check</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>define_pcrel</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>define_pcr_cr_eq</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span> pcrel_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> pcr_cr_eq </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> quot_thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> pcr_info </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_info</span></span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quot_info</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.transform_quotient</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>quotients</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reflexivity_rule_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Lifting_Info.add_reflexivity_rule_attribute</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>lthy2</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>oo</span><span> </span><span>Local_Theory.note</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>reflexivity_rule_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>reflp_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.reflp_ge_eq|fact"><span>reflp_ge_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>define_code_constr</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>define_abs_type</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy3</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Lifting_Info.update_quotients</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_info</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>lifting_bundle</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="entity"><span>quotients</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>importT_inst_exclude</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tvars</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tfrees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvars</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>import_inst_exclude</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludeT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvarsT</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>importT_inst_exclude</span></span><span> </span><span class="entity"><span>excludeT</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiateT</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>import_terms_exclude</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>import_inst_exclude</span></span><span> </span><span class="entity"><span>exclude</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_goal</span></span><span> </span><span class="entity"><span>not_fix</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>import_terms_exclude</span></span><span> </span><span class="entity"><span>not_fix</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.init</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>fixed_goal</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Goal.conclude</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>init_goal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>OO_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_total_OO|fact"><span>left_total_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_unique_OO|fact"><span>left_unique_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_total_OO|fact"><span>right_total_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_unique_OO|fact"><span>right_unique_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_total_OO|fact"><span>bi_total_OO</span></a><span>
    </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_unique_OO|fact"><span>bi_unique_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_transfer_rule</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.import_terms</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.init</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>fixed_goal</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Transfer.get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>OO_rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pcr_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span> </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Goal.conclude</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>init_goal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_goal</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="entity"><span>constr</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_name</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span class="entity"><span>strip_args</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constr</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>Logic.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_assms</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>right_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"right_total"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"right_unique"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"left_total"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"left_unique"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"bi_total"</span></span><span class="main"><span>,</span></span><span>
            </span><span class="inner_quoted"><span>"bi_unique"</span></span><span class="main"><span>]</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_right_name</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>right_names</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_trivial_assm</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_right_name</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_trivial_assm</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_right_name</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_trivial_assm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_name</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span class="entity"><span>strip_args</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>non_trivial_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_trivial_assm</span></span><span> </span><span class="entity"><span>prems</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>non_trivial_assms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Non-trivial assumptions in "</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="entity"><span>thm_name</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" transfer rule found:"</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> 
                  </span><span>Pretty.commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>non_trivial_assms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span>
                </span><span>|&gt;</span><span> </span><span>warning</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_goal</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="entity"><span>constraint</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_transfer_rule</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_assms</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_unfold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_def|fact"><span>id_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_parametric_id</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>id_transfer_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="comment1"><span>(* it doesn't raise an exception because it would have already raised it in define_pcrel *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.prove_param_quot_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>rty</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parametrized_relator</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> 
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Fixpoint_Base.html#BNF_Fixpoint_Base.id_transfer|fact"><span>id_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>parametrized_relator</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>id_unfold</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.arg1_conv</span><span> </span><span class="entity"><span>id_unfold</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>id_transfer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>parametrized_relator</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_par_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>id_transfer</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Lifting_Def.generate_parametric_transfer_rule</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>id_transfer_rule</span></span><span> </span><span class="entity"><span>id_par_thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Lifting_Term.MERGE_TRANSFER_REL</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>error_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cat_lines</span><span> 
          </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Generation of a parametric transfer rule for the abs. or the rep. function failed."</span></span><span class="main"><span>,</span></span><span>
          </span><span class="inner_quoted"><span>"A non-parametric version will be used."</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
             </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Reason:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="entity"><span>error_msg</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>id_transfer_rule</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_first_Domainp_arg</span></span><span> </span><span class="entity"><span>rewr_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>rewr_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_Domainp_pcrel</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cprop_of</span><span> </span><span>|&gt;</span><span> </span><span>Drule.strip_imp_concl</span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg1</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of_cterm</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>Thm.match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Pattern.MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fold_Domainp_pcrel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>rewrite_first_Domainp_arg</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_Domainp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prems_of</span><span> </span><span>|&gt;</span><span> </span><span>hd</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span>dest_comb</span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span>dest_Var</span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reduced_assm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>reduce_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>reduced_assm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parametrize_domain</span></span><span> </span><span class="entity"><span>dom_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcr_info</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Lifting_Info.pcr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_first_assm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prems_of</span><span> </span><span>|&gt;</span><span> </span><span>hd</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reduced_assm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>reduce_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>reduced_assm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_cr_met_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcr_cr_eq </span><span class="entity"><span>pcr_info</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_Domainp_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewrite_first_Domainp_arg</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>pcr_cr_met_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dom_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcrel_def </span><span class="entity"><span>pcr_info</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_Domainp_par_left_total</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="entity"><span>dom_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pcr_Domainp_par_left_total|fact"><span>pcr_Domainp_par_left_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_Domainp_pcrel</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>reduce_first_assm</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.get_reflexivity_rules</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_Domainp_par</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="entity"><span>dom_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pcr_Domainp_par|fact"><span>pcr_Domainp_par</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>      
          </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_Domainp_pcrel</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>reduce_Domainp</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_relator_domain</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_Domainp</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="entity"><span>dom_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pcr_Domainp|fact"><span>pcr_Domainp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_Domainp_pcrel</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain"</span></span><span class="main"><span>,</span></span><span>                 </span><span class="main"><span>[</span></span><span class="entity"><span>pcr_Domainp</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain_par"</span></span><span class="main"><span>,</span></span><span>             </span><span class="main"><span>[</span></span><span class="entity"><span>pcr_Domainp_par</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain_par_left_total"</span></span><span class="main"><span>,</span></span><span>  </span><span class="main"><span>[</span></span><span class="entity"><span>pcr_Domainp_par_left_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain_eq"</span></span><span class="main"><span>,</span></span><span>              </span><span class="main"><span>[</span></span><span class="entity"><span>pcr_Domainp_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>thms</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parametrize_total_domain</span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>left_total</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pcr_Domainp_total|fact"><span>pcr_Domainp_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_Domainp_pcrel</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> 
          </span><span>|&gt;</span><span> </span><span class="entity"><span>reduce_Domainp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_relator_domain</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span>  
  </span><span class="main"><span>#</span></span><span>pcr_info </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.lookup_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_Domainp_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span>try</span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.eq_onp_to_Domainp|fact"><span>eq_onp_to_Domainp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_to_Domainp|fact"><span>Quotient_to_Domainp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> 
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Local_Theory.notes</span><span> </span><span class="entity"><span>notes</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>map_name</span></span><span> </span><span class="entity"><span>map_thm</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_name</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>map_thm</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>

</span><span class="comment1"><span>(*
  Sets up the Lifting package by a quotient theorem.

  quot_thm - a quotient theorem (Quotient R Abs Rep T)
  opt_reflp_thm - a theorem saying that a relation from quot_thm is reflexive
    (in the form "reflp R")
  opt_par_thm - a parametricity theorem for R
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_by_quotient</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="entity"><span>opt_par_thm</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.induct_type</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>qty_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"abs_induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_total_abs_induct|fact"><span>Quotient_total_abs_induct</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"abs_eq_iff"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_total_abs_eq_iff|fact"><span>Quotient_total_abs_eq_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"abs_induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_abs_induct|fact"><span>Quotient_abs_induct</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_Domainp_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_nonpar</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id_abs_transfer"</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_id_abs_transfer|fact"><span>Quotient_id_abs_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_total"</span></span><span class="main"><span>,</span></span><span>     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_left_total|fact"><span>Quotient_left_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_total"</span></span><span class="main"><span>,</span></span><span>       </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_bi_total|fact"><span>Quotient_bi_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dom_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rel_eq_transfer"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_rel_eq_transfer|fact"><span>Quotient_rel_eq_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_unique"</span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_right_unique|fact"><span>Quotient_right_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_total"</span></span><span class="main"><span>,</span></span><span>     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_right_total|fact"><span>Quotient_right_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span class="entity"><span>notes2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_parametric_rel_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span> </span><span class="entity"><span>opt_param_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_param_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>param_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Def.generate_parametric_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span> </span><span class="entity"><span>param_thm</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Lifting_Term.MERGE_TRANSFER_REL</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Generation of a parametric transfer rule for the quotient relation failed:\n"</span></span><span>
                </span><span>^</span><span> </span><span>Pretty.string_of</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_par</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcrel_def </span><span class="entity"><span>pcrel_info</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_left_total|fact"><span>Quotient_left_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bi_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_bi_total|fact"><span>Quotient_bi_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>domain_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_total_domain</span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_abs_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_parametric_id</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Term.parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_id_abs_transfer|fact"><span>Quotient_id_abs_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>left_total</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bi_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>bi_total</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> 
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id_abs_transfer"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id_abs_transfer</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_total"</span></span><span class="main"><span>,</span></span><span>      </span><span class="main"><span>[</span></span><span class="entity"><span>left_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>  
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_total"</span></span><span class="main"><span>,</span></span><span>        </span><span class="main"><span>[</span></span><span class="entity"><span>bi_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>domain_thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_domain</span></span><span> </span><span class="entity"><span>dom_thm</span></span><span> </span><span class="entity"><span>pcrel_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_eq_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_parametric_rel_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Term.parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_rel_eq_transfer|fact"><span>Quotient_rel_eq_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>opt_par_thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>right_unique</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_right_unique|fact"><span>Quotient_right_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>right_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_right_total|fact"><span>Quotient_right_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rel_eq_transfer"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_eq_transfer</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_unique"</span></span><span class="main"><span>,</span></span><span>    </span><span class="main"><span>[</span></span><span class="entity"><span>right_unique</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_total"</span></span><span class="main"><span>,</span></span><span>     </span><span class="main"><span>[</span></span><span class="entity"><span>right_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>      
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>notes2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_rules</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_par</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>notes1</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_nonpar</span></span><span> </span><span class="entity"><span>notes1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>notes </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy0</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>setup_lifting_infr</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span>
    </span><span>||&gt;</span><span> </span><span class="entity"><span>setup_rules</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Sets up the Lifting package by a typedef theorem.

  gen_code - flag if an abstract type given by typedef_thm should be registred 
    as an abstract type in the code generator
  typedef_thm - a typedef theorem (type_definition Rep Abs S)
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_by_typedef_thm</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>typedef_thm</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rep_fun</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>typedef_set</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typedef_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>define_crel</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>rep_fun</span></span><span> </span><span class="entity"><span>lthy0</span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_def</span></span><span>
    </span><span class="comment1"><span>(**)</span></span><span>    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>typedef_set</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.top_class.top|const"><span>top</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.UNIV_typedef_to_Quotient|fact"><span>UNIV_typedef_to_Quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Collect|const"><span>Collect</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.open_typedef_to_Quotient|fact"><span>open_typedef_to_Quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_to_Quotient|fact"><span>typedef_to_Quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>qty_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>typedef_set</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.top_class.top|const"><span>top</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>typedef_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.UNIV_typedef_to_equivp|fact"><span>UNIV_typedef_to_equivp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.equivp_reflp2|fact"><span>equivp_reflp2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>  </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_Domainp_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_nonpar</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id_abs_transfer"</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_id_abs_transfer|fact"><span>Quotient_id_abs_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_total"</span></span><span class="main"><span>,</span></span><span>     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_left_total|fact"><span>Quotient_left_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_total"</span></span><span class="main"><span>,</span></span><span>       </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_bi_total|fact"><span>Quotient_bi_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"domain"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dom_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_domain_rule|attribute"><span class="operator"><span>transfer_domain_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rep_transfer"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_rep_transfer|fact"><span>typedef_rep_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_unique"</span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_left_unique|fact"><span>typedef_left_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_unique"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_right_unique|fact"><span>typedef_right_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_total"</span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_right_total|fact"><span>typedef_right_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_unique"</span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_bi_unique|fact"><span>typedef_bi_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>                                               
        </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_par</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcrel_def </span><span class="entity"><span>pcrel_info</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_left_total|fact"><span>Quotient_left_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bi_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_bi_total|fact"><span>Quotient_bi_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>domain_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_total_domain</span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>left_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>left_total</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bi_total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="entity"><span>bi_total</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_abs_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_parametric_id</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Term.parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_id_abs_transfer|fact"><span>Quotient_id_abs_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> 
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_total"</span></span><span class="main"><span>,</span></span><span>     </span><span class="main"><span>[</span></span><span class="entity"><span>left_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_total"</span></span><span class="main"><span>,</span></span><span>       </span><span class="main"><span>[</span></span><span class="entity"><span>bi_total</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id_abs_transfer"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>id_abs_transfer</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>              
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>domain_thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parametrize_domain</span></span><span> </span><span class="entity"><span>dom_thm</span></span><span> </span><span class="entity"><span>pcrel_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>thms</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>generate_parametric_id</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Term.parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rep_transfer"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_rep_transfer|fact"><span>typedef_rep_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes3</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>qualify</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parametrize_class_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>typedef_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left_unique"</span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_left_unique|fact"><span>typedef_left_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_unique"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_right_unique|fact"><span>typedef_right_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bi_unique"</span></span><span class="main"><span>,</span></span><span>    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_bi_unique|fact"><span>typedef_bi_unique</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>   </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"right_total"</span></span><span class="main"><span>,</span></span><span>  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.typedef_right_total|fact"><span>typedef_right_total</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>notes3</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.prefix_name</span><span> </span><span class="inner_quoted"><span>"Quotient_"</span></span><span> </span><span class="entity"><span>qty_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_rules</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_par</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>notes1</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>setup_transfer_rules_nonpar</span></span><span> </span><span class="entity"><span>notes1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>notes </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy1</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>setup_lifting_infr</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span>
    </span><span>||&gt;</span><span> </span><span class="entity"><span>setup_rules</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_lifting_cmd</span></span><span> </span><span class="entity"><span>xthm</span></span><span> </span><span class="entity"><span>opt_reflp_xthm</span></span><span> </span><span class="entity"><span>opt_par_xthm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>input_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xthm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>input_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input_thm</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported type of a theorem. Only Quotient or type_definition are supported."</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sanity_check_reflp_thm</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reflp_tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reflp_thm</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Invalid form of the reflexivity theorem. Use \"reflp R\"."</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>reflp_tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.reflp_on|const"><span>reflp_on</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.top_class.top|const"><span>top_class.top</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Invalid form of the reflexivity theorem. Use \"reflp R\"."</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_qty</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_Type</span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The abstract type must be a type constructor."</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
   
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_quotient</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opt_reflp_xthm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>sanity_check_reflp_thm</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_par_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opt_par_xthm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_qty</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>input_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>setup_by_quotient</span></span><span> </span><span class="entity"><span>default_config</span></span><span> </span><span class="entity"><span>input_thm</span></span><span> </span><span class="entity"><span>opt_reflp_thm</span></span><span> </span><span class="entity"><span>opt_par_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_typedef</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>input_term</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_qty</span></span><span> </span><span class="entity"><span>qty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_reflp_xthm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The reflexivity theorem cannot be specified if the type_definition theorem is used."</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_par_xthm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The parametricity theorem cannot be specified if the type_definition theorem is used."</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>setup_by_typedef_thm</span></span><span> </span><span class="entity"><span>default_config</span></span><span> </span><span class="entity"><span>input_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
          </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>input_term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient|const"><span>Quotient</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>setup_quotient</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Typedef.html#Typedef.type_definition|const"><span>type_definition</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>setup_typedef</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unsupported type of a theorem. Only Quotient or type_definition are supported."</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>setup_lifting</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"setup lifting infrastructure"</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Parse.thm</span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Parse.thm</span><span> 
      </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>parametric</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span>Parse.thm</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> 
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>xthm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_reflp_xthm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_par_xthm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="entity"><span>setup_lifting_cmd</span></span><span> </span><span class="entity"><span>xthm</span></span><span> </span><span class="entity"><span>opt_reflp_xthm</span></span><span> </span><span class="entity"><span>opt_par_xthm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* restoring lifting infrastructure *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PCR_ERROR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_restore_sanity_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qinfo</span></span><span class="main"><span>:</span></span><span class="entity"><span>Lifting_Info.quotient</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quot_thm </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_sanity_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_info_err</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>pcr_info </span><span class="entity"><span>qinfo</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>pcr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcrel_def </span><span class="entity"><span>pcr</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pcr_cr_eq </span><span class="entity"><span>pcr</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_equals</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PCR_ERROR</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> 
                    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The pcr definiton theorem is not a plain meta equation:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_const_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>head_of</span><span> </span><span class="entity"><span>def_lhs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PCR_ERROR</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> 
                    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The pcr_cr equation theorem is not a plain equation:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcr_const_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>eq_lhs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_Const</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_Const</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
              </span><span class="main"><span>[</span></span><span>Pretty.block</span><span>
                    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Arguments of the lhs of the pcr_cr equation theorem are not only equalities:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_consts_not_equal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_Const</span></span><span> </span><span class="entity"><span>pcr_const_def</span></span><span> </span><span class="entity"><span>pcr_const_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>[</span></span><span>Pretty.block</span><span>
                    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Parametrized correspondence relation constants in pcr_def and pcr_cr_eq are not equal:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcr_const_def</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"vs."</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcr_const_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>crel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cr_consts_not_equal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_Const</span></span><span> </span><span class="entity"><span>crel</span></span><span> </span><span class="entity"><span>eq_rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>[</span></span><span>Pretty.block</span><span>
                    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Correspondence relation constants in the Quotient theorem and pcr_cr_eq are not equal:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>crel</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"vs."</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_rhs</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>all_eqs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>pcr_consts_not_equal</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cr_consts_not_equal</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_info_err</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PCR_ERROR</span></span><span> </span><span class="entity"><span>errs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PCR_ERROR</span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Sanity check failed:"</span></span><span class="main"><span>]</span></span><span> 
                                            </span><span>@</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span>o</span><span> </span><span>Pretty.item</span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>errs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Registers the data in qinfo in the Lifting infrastructure.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_restore</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lifting_restore_sanity_check</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qinfo</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quot_thm </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stored_qinfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_quotients</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stored_qinfo</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.quotient_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qinfo</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>stored_qinfo</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> 
        </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
          </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Lifting is already setup for the type"</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_typ</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Lifting_Info.update_quotients</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_opt_pcr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.thm</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Attrib.thm</span></span><span> </span><span>&gt;&gt;</span><span> 
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>pcrel_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> pcr_cr_eq </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lifting_restore_attribute_setup</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.lifting_restore|attribute"><span>lifting_restore</span></span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.thm</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_opt_pcr</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_pcr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> quot_thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> pcr_info </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opt_pcr</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lifting_restore</span></span><span> </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"restoring lifting infrastructure"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="entity"><span>lifting_restore_attribute_setup</span></span><span> 

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_restore_internal</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>restore_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_restore_data</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>restore_info</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>restore_info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span> 
        </span><span>|&gt;</span><span> </span><span class="entity"><span>lifting_restore</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quotient </span><span class="entity"><span>restore_info</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>Transfer.transfer_raw_add</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.content</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>transfer_rules </span><span class="entity"><span>restore_info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lifting_restore_internal_attribute_setup</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.lifting_restore_internal|attribute"><span>lifting_restore_internal</span></span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Parse.string</span><span> </span><span>&gt;&gt;</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lifting_restore_internal</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"restoring lifting infrastructure; internal attribute; not meant to be used directly by regular users"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="entity"><span>lifting_restore_internal_attribute_setup</span></span><span> 

</span><span class="comment1"><span>(* lifting_forget *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>monotonicity_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_unique|const"><span>right_unique</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_unique|const"><span>left_unique</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_total|const"><span>right_total</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
  </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_total|const"><span>left_total</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_unique|const"><span>bi_unique</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_total|const"><span>bi_total</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_transfer_rel</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.Rel|const"><span>Transfer.Rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rel</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rel</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_transfer_rel</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> 
    </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.Domainp|const"><span>Domainp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rel</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_transfer_rel</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>monotonicity_names</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_transfer_rel</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_transfer_rules_by_rel</span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rel_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span>|&gt;</span><span> </span><span>dest_Const</span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_transfer_rel</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_transfer_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.add_const_names</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>transfer_rel_name</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>filter</span><span> </span><span class="entity"><span>has_transfer_rel</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>quotient </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span class="main"><span>,</span></span><span> transfer_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_transfer_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qinfo</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_pcrel</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_def</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span>head_of</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcr_info </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_pcrel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcrel_def </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcr_info </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quot_thm </span><span class="entity"><span>qinfo</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pointer_of_bundle_name</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bundle</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Bundle.read</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The provided bundle is not a lifting bundle"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bundle</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_src</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Token.syntax</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Parse.string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_src</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pointer_of_bundle_binding</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.full_name</span><span> </span><span class="main"><span>(</span></span><span>Name_Space.naming_of</span><span> 
      </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binding</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_forget</span></span><span> </span><span class="entity"><span>pointer</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_transfer_rules_to_delete</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_transfer_rel</span></span><span> </span><span class="entity"><span>qinfo</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span class="entity"><span>filter_transfer_rules_by_rel</span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_restore_data</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>pointer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>restore_info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quotient </span><span class="entity"><span>restore_info</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quot_thm </span><span class="entity"><span>qinfo</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_transfer_rules_to_delete</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
            </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.transfer_raw_del</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Lifting_Info.delete_quotients</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The lifting bundle refers to non-existent restore data."</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_forget_cmd</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="entity"><span>lifting_forget</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pointer_of_bundle_name</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>lifting_forget</span></span><span>›</span></span></span><span> 
    </span><span class="inner_quoted"><span>"unsetup Lifting and Transfer for the given lifting bundle"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.name_position</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>lifting_forget_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* lifting_update *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_transfer_rules</span></span><span> </span><span class="entity"><span>pointer</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_transfer_rules</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span> quotient </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qinfo</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>Lifting_Info.restore_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_transfer_rel</span></span><span> </span><span class="entity"><span>qinfo</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter_transfer_rules_by_rel</span></span><span> </span><span class="entity"><span>transfer_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_transfer_raw</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> 
          </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span>o</span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span>Thm.item_net</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_restore_data</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>pointer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>refresh_data</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span>  </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Lifting_Info.add_transfer_rules_in_restore_data</span></span><span> </span><span class="entity"><span>pointer</span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>new_transfer_rules</span></span><span> </span><span class="entity"><span>refresh_data</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The lifting bundle refers to non-existent restore data."</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_update_cmd</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="entity"><span>update_transfer_rules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pointer_of_bundle_name</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>lifting_update</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"add newly introduced transfer rules to a bundle storing the state of Lifting and Transfer"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.name_position</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>lifting_update_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>