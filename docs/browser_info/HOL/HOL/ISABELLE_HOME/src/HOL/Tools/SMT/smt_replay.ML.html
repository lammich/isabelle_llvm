<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/smt_replay.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/smt_replay.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/smt_replay.ML
    Author:     Sascha Boehme, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen
    Author:     Mathias Fleury, MPII

Shared library for parsing and replay.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SMT_REPLAY</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*theorem nets*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thm_net_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_instances</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(*proof combinators*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> under_assumption</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> discharge</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="comment1"><span>(*a faster COMP*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>compose_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> precompose</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>compose_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> precompose2</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> * </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>compose_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compose</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>compose_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="comment1"><span>(*simpset*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_simproc</span><span class="main"><span>:</span></span><span> </span><span>Simplifier.simproc</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_simpset</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>simpset</span><span>

  </span><span class="comment1"><span>(*assertion*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_asserted</span><span class="main"><span>:</span></span><span>  </span><span class="main"><span>(</span></span><span>'a * </span><span class="main"><span>(</span></span><span>'b * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c </span><span class="main"><span>-&gt;</span></span><span> 'c</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    'c </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'d </span><span class="main"><span>-&gt;</span></span><span> 'a * 'e * </span><span>term</span><span> * 'b</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'e </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'd </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>'a * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> * 'c</span><span class="main"><span>)</span></span><span>
  
  </span><span class="comment1"><span>(*statistics*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_statistics</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intermediate_statistics</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Timing.start</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="comment1"><span>(*theorem transformation*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> varify</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> params_of</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(*spy*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> spying</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_stats</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>SMT_Replay</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_REPLAY</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* theorem nets *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thm_net_of</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xthms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="entity"><span>xthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xthm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xthm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="entity"><span>xthms</span></span><span> </span><span>Net.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_instantiate</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>try</span><span> </span><span>Thm.first_order_match</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instances_from_net</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Net.match_term</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Net.unify_term</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_instantiate</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xthms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select'</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.trivial</span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xthms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>select</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>select'</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xthms'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xthms'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>net_instances</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>instances_from_net</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>net</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* proof combinators *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>under_assumption</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Util.mk_cprop</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>ct'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>discharge</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>pq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>pq</span></span><span> </span><span class="entity"><span>p</span></span><span>


</span><span class="comment1"><span>(* a faster COMP *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>compose_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>precompose</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>compose_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>precompose2</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>compose_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>precompose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list2</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>discharge</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span>
      </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cvs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* simpset *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>antisym_le1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.order_class.antisym_conv|fact"><span>order_class.antisym_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>antisym_le2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.order_class.antisym_conv2|fact"><span>order_class.antisym_conv2</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>antisym_less1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.order_class.antisym_conv1|fact"><span>order_class.antisym_conv1</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>antisym_less2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.linorder_class.antisym_conv3|fact"><span>linorder_class.antisym_conv3</span></a><span class="antiquote"><span>}</span></span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_prop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_binop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_binop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_binop"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_antisym_le</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>less</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>less</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>le</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.prems_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>less</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>antisym_less1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>antisym_le1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_antisym_less</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>less</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_not</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>le</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>less</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.prems_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>less</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>antisym_less2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>antisym_le2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_simpset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
      </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.field_simps|fact"><span class="dynamic"><span class="dynamic"><span>field_simps</span></span></span></a><span> </span><a class="entity_ref" href="../../../../../Fields.html#Fields.division_ring_class.times_divide_eq_right|fact"><span>times_divide_eq_right</span></a><span> </span><a class="entity_ref" href="../../../../../Fields.html#Fields.field_class.times_divide_eq_left|fact"><span>times_divide_eq_left</span></a><span> </span><a class="entity_ref" href="../../../../../Num.html#Num.arith_special|fact"><span>arith_special</span></a><span>
        </span><a class="entity_ref" href="../../../../../Num.html#Num.arith_simps|fact"><span>arith_simps</span></a><span> </span><a class="entity_ref" href="../../../../../Num.html#Num.rel_simps|fact"><span>rel_simps</span></a><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.array_rules|fact"><span>array_rules</span></a><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.z3div_def|fact"><span>z3div_def</span></a><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.z3mod_def|fact"><span>z3mod_def</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.NO_MATCH_def|fact"><span>NO_MATCH_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>numeral_divmod</span><span>›</span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>Simplifier.make_simproc</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"fast_int_arith"</span></span><span>
         </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="free"><span>m</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>&lt;</span></a></span><span> </span><span class="free"><span>n</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="free"><span>m</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>n</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="free"><span>m</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>n</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          proc </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>Lin_Arith.simproc</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>Simplifier.make_simproc</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"antisym_le"</span></span><span>
         </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.order|class"><span>order</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>y</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          proc </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>prove_antisym_le</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>Simplifier.make_simproc</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"antisym_less"</span></span><span>
         </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.linorder|class"><span>linorder</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>&lt;</span></a></span><span> </span><span class="free"><span>y</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          proc </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>prove_antisym_less</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Simpset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
  </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>simpset</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>basic_simpset</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Simplifier.merge_ss</span><span>
  </span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_simproc</span></span><span> </span><span class="entity"><span>simproc</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Simpset.map</span><span> </span><span class="main"><span>(</span></span><span>simpset_map</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>simproc</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_simpset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span>Simpset.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remove_trigger</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger_def|fact"><span>trigger_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remove_fun_app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.fun_app_def|fact"><span>fun_app_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_conv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.all_conv</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.full_rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>empty_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite_true_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="operator"><span>simp</span></span><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prep_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let_def|fact"><span>Let_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remove_trigger</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remove_fun_app</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rewrite_true_rule</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_assm</span></span><span> </span><span class="entity"><span>assms_net</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>net_instances</span></span><span> </span><span class="entity"><span>assms_net</span></span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ithm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ithm</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_asserted</span></span><span> </span><span class="entity"><span>tab_update</span></span><span> </span><span class="entity"><span>tab_empty</span></span><span> </span><span class="entity"><span>p_extract</span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="entity"><span>rewrite_rules</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rewrite_true_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rewrite_rules</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span>Thm.eq_thm</span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>prep_rules</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms_net</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>assms</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>eqs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span>Thm.eta_conversion</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>thm_net_of</span></span><span> </span><span>snd</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>revert_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewrite_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqs'</span></span><span> </span><span>then_conv</span><span> </span><span>Thm.eta_conversion</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Assumption.add_assumes</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm'</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add1</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iidths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exact</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exact</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>iidths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>step</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iidths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p_extract</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="comment1"><span>(*Z3_Proof.is_assumption rule andalso rule &lt;&gt; Z3_Proof.Hypothesis*)</span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.trivial</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>revert_conv</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm1</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_assm</span></span><span> </span><span class="entity"><span>assms_net</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assume</span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>iidths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add1</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>cx</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab_empty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>params_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_qnt_vars</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>params_of</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>maxidx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Drule.forall_elim_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intermediate_statistics</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="entity"><span>total</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Config.statistics_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>current</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="inner_quoted"><span>"Reconstructed "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>current</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" of "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>total</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" steps in "</span></span><span> </span><span>^</span><span>
    </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toMilliseconds</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>elapsed </span><span class="main"><span>(</span></span><span>Timing.result</span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_statistics</span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="entity"><span>total</span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>curry</span><span> </span><span>Int.div</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="inner_numeral"><span>1000000</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stats</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mean_of</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>is</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span>mod</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mid</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span>nth</span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="entity"><span>mid</span></span><span class="main"><span>)</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="entity"><span>mid</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_item</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.item</span><span> </span><span class="main"><span>(</span></span><span>Pretty.separate</span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>milliseconds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>^</span><span class="inner_quoted"><span>": "</span></span><span class="main"><span>)</span></span><span>  </span><span>::</span><span> </span><span>Pretty.separate</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>milliseconds</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" occurrences"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mean_of</span></span><span> </span><span class="entity"><span>milliseconds</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms mean time"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Integer.max</span><span> </span><span class="entity"><span>milliseconds</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms maximum time"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Integer.add</span><span> </span><span class="entity"><span>milliseconds</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms total time"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Pretty.big_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>solver</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" proof reconstruction statistics:"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>pretty_item</span></span><span> </span><span class="inner_quoted"><span>"total time"</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>total</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ms"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span>map</span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>timestamp_format</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Date.fmt</span><span> </span><span class="inner_quoted"><span>"%Y-%m-%d %H:%M:%S."</span></span><span> </span><span class="main"><span>(</span></span><span>Date.fromTimeLocal</span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
  </span><span class="main"><span>(</span></span><span>StringCvt.padLeft</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toMilliseconds</span><span> </span><span class="entity"><span>time</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1000</span></span><span> </span><span>*</span><span> </span><span>Time.toSeconds</span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_stats</span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_list</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>print_list</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span>false</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>spying</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>filename</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>message</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_long_name</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spying_version</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"1"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>File.append</span><span> </span><span class="main"><span>(</span></span><span>Path.explode</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"$ISABELLE_HOME_USER/"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>filename</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>spying_version</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"; "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>timestamp_format</span></span><span> </span><span class="main"><span>(</span></span><span>Time.now</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>";\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>message</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>