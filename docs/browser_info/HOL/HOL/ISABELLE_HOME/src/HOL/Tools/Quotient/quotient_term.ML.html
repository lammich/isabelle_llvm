<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Quotient/quotient_term.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Quotient/quotient_term.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Quotient/quotient_term.ML
    Author:     Cezary Kaliszyk and Christian Urban

Constructs terms corresponding to goals from lifting theorems to
quotient types.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>QUOTIENT_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> LIFT_MATCH </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RepF</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> absrep_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> absrep_fun_chk</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="comment1"><span>(* Allows Nitpick to represent quotient types as single elements from raw type *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> absrep_const_chk</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equiv_relation</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equiv_relation_chk</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_rel_from_quot_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_quot_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> regularize_trm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> regularize_trm_chk</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inj_repabs_trm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inj_repabs_trm_chk</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> derive_qtyp</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> derive_qtrm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> derive_rtyp</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> derive_rtrm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Quotient_Term</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>QUOTIENT_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>



</span><span class="comment1"><span>(*** Aggregate Rep/Abs Function ***)</span></span><span>


</span><span class="comment1"><span>(* The flag RepF is for types in negative position; AbsF is for types
   in positive position. Because of this, function types need to be
   treated specially, since there the polarity changes.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RepF</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negF</span></span><span> </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RepF</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>negF</span></span><span> </span><span class="entity"><span>RepF</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AbsF</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_identity</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.id|const"><span>id</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_identity</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_identity</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.id|const"><span>id</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_fun_compose</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp|const"><span>comp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RepF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp|const"><span>comp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_mapfun_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Functor.entries</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>map_data</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>dest_Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>mapper </span><span class="entity"><span>map_data</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>variances </span><span class="entity"><span>map_data</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"map function for type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not a constant."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"map function for type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is non-singleton entry."</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No map function for type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>defined_mapfun_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Functor.entries</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* looks up the (varified) rty and qty for
   a quotient definition
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_rty_qty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotients_global</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rtyp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtyp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtyp</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No quotient type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* matches a type pattern with a type *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* produces the rep or abs constant for a qty *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>qty_str</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* FIXME *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_dummyT</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_dummyT</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_dummyT</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Expecting abs/rep term to be a constant or a free variable"</span></span><span>     
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_abs_rep</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_str</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_dummyT</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RepF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No abs/rep terms for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>qty_str</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
</span><span class="comment1"><span>(* Lets Nitpick represent elements of quotient types as elements of the raw type *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_const_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>qty_str</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absrep_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>qty_str</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_match_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_pat_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span>
      </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"absrep_fun (Types "</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_pat_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"and"</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>" do not match.)"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** generation of an aggregate absrep function **)</span></span><span>

</span><span class="comment1"><span>(* - In case of equal types we just return the identity.

   - In case of TFrees we also return the identity.

   - In case of function types we recurse taking
     the polarity change into account.

   - If the type constructors are equal, we recurse for the
     arguments and build the appropriate map function.

   - If the type constructors are unequal, there must be an
     instance of quotient types:

       - we first look up the corresponding rty_pat and qty_pat
         from the quotient definition; the arguments of qty_pat
         must be some distinct TVars
       - we then match the rty_pat with rty and qty_pat with qty;
         if matching fails the types do not correspond -&gt; error
       - the matching produces two environments; we look up the
         assignments for the qty_pat variables and recurse on the
         assignments
       - we prefix the aggregate map function for the rty_pat,
         which is an abstraction over all type variables
       - finally we compose the result with the appropriate
         absrep function in case at least one argument produced
         a non-identity function /
         otherwise we just return the appropriate absrep
         function

     The composition is necessary for types like

        ('a list) list / ('a foo) foo

     The matching is necessary for types like

        ('a * 'a) list / 'a bar

     The test is necessary in order to eliminate superfluous
     identity maps.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_args</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>tys'</span></span><span> </span><span class="entity"><span>variances</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variant</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>variant</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negF</span></span><span> </span><span class="entity"><span>flag</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negF</span></span><span> </span><span class="entity"><span>flag</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>maps</span><span> </span><span class="entity"><span>absrep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>variances</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_identities</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtys'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_identity</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
          </span><span class="entity"><span>absrep_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>s'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> 
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No map function for type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_identity</span></span><span> </span><span class="entity"><span>rty</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variances</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_mapfun_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>absrep_args</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>tys'</span></span><span> </span><span class="entity"><span>variances</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_rty_qty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s'</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>absrep_match_err</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span> </span><span class="entity"><span>qty</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>qtyenv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtys</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>defined_mapfun_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="comment1"><span>(*
                    If we don't know a map function for the raw type,
                    we are not necessarilly in troubles because
                    it can still be the case we don't need the map 
                    function &lt;=&gt; all abs/rep functions are identities.
                *)</span></span><span>
                </span><span class="entity"><span>test_identities</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>s'</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variances</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_mapfun_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>absrep_args</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="entity"><span>variances</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_identity</span></span><span> </span><span class="entity"><span>args</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>absrep_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>s'</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_fun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="entity"><span>mk_fun_compose</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absrep_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_identity</span></span><span> </span><span class="entity"><span>rty</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="inner_quoted"><span>"absrep_fun (frees)"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="inner_quoted"><span>"absrep_fun (vars)"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="inner_quoted"><span>"absrep_fun (default)"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>absrep_fun_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>



</span><span class="comment1"><span>(*** Aggregate Equivalence Relation ***)</span></span><span>


</span><span class="comment1"><span>(* works very similar to the absrep generation,
   except there is no need for polarities
*)</span></span><span>

</span><span class="comment1"><span>(* instantiates TVars so that the term is of type ty *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>force_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trm_ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>trm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>ty_inst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rel_compose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.rel_conj|const"><span>rel_conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_relmap</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotmaps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>relmap</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relmap</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_relmap (no relation map function found for type "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_equiv_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>equiv_rel</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>equiv_rel</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_equiv_rel (no quotient found for type "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_match_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_pat_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span>
      </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"equiv_relation (Types "</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_pat_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"and"</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>" do not match.)"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* builds the aggregate equivalence relation
   that will be the argument of Respects
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>rty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relmap</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_rty_qty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>equiv_match_err</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span> </span><span class="entity"><span>qty</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>qtyenv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtys</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtys'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqv_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_equiv_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqv_rel'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqv_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eqv_rel'</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relmap</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>mk_rel_compose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqv_rel'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>rty</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(* generation of the Quotient theorem  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CODE_GEN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CODE_GEN</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No quotient type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotmaps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CODE_GEN</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_relmap (no relation map function found for type "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_id_quot</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.identity_quotient3|fact"><span>identity_quotient3</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Lifting_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> MRSL

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NOT_IMPL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_rel_from_quot_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rel</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>rel</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_quot_thm_compose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_rel_from_quot_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.OOO_eq_quotient3|fact"><span>OOO_eq_quotient3</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NOT_IMPL</span></span><span> </span><span class="inner_quoted"><span>"nested quotients: not implemented yet"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.identity_quotient3|fact"><span>identity_quotient3</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_rty_qty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>equiv_match_err</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span> </span><span class="entity"><span>qty</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>qtyenv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtys</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtys'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_id_quot</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>quot_thm</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>mk_quot_thm_compose</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.identity_quotient3|fact"><span>identity_quotient3</span></a><span class="antiquote"><span>}</span></span></span></span><span>



</span><span class="comment1"><span>(*** Regularization ***)</span></span><span>

</span><span class="comment1"><span>(* Regularizing an rtrm means:

 - Quantifiers over types that need lifting are replaced
   by bounded quantifiers, for example:

      All P  ----&gt; All (Respects R) P

   where the aggregate relation R is given by the rty and qty;

 - Abstractions over types that need lifting are replaced
   by bounded abstractions, for example:

      %x. P  ----&gt; Ball (Respects R) %x. P

 - Equalities over types that need lifting are replaced by
   corresponding equivalence relations, for example:

      A = B  ----&gt; R A B

   or

      A = B  ----&gt; (R ===&gt; R) A B

   for more complicated types of A and B


 The regularize_trm accepts raw theorems in which equalities
 and quantifiers match exactly the ones in the lifted theorem
 but also accepts partially regularized terms.

 This means that the raw theorems can have:
   Ball (Respects R),  Bex (Respects R), Bex1_rel (Respects R), Babs, R
 in the places where:
   All, Ex, Ex1, %, (op =)
 is required the lifted theorem.

*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_babs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Babs|const"><span>Babs</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_ball</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_bex</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_bex1_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Bex1_rel|const"><span>Bex1_rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_resp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Respects|const"><span>Respects</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* - applies f to the subterm of an abstraction,
     otherwise to the given term,
   - used by regularize, therefore abstracted
     variables do not have to be treated specially
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1_ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2_ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>str</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>t1_ty_str</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>t2_ty_str</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* the major type of All and Ex quantifiers *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Checks that two types match, for example:
     rty -&gt; rty   matches   qty -&gt; qty *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>matches_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rT</span></span><span> </span><span class="entity"><span>qT</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>true</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rtys</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>false</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>matches_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtys</span></span><span> </span><span class="entity"><span>qtys</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotients_global</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rtyp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Sign.typ_instance</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyp</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* produces a regularized version of rtrm

   - the result might contain dummyTs

   - for regularization we do not need any
     special treatment of bound variables
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_babs</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Babs|const"><span>Babs</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needres</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>needres</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (Babs)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span class="entity"><span>needres</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_babs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_ball</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_bex</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.member|const"><span>Set.member</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Respects|const"><span>Respects</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>incr_boundvars</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (Bex1)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_bex1_rel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_bex1_rel</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Respects|const"><span>Respects</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>
     </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (Ball)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_ball</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Respects|const"><span>Respects</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>
     </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (Bex)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_bex</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_resp</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Bex1_rel|const"><span>Bex1_rel</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_subt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needrel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qnt_typ</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (Bex1_res)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span class="entity"><span>needrel</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_bex1_rel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>resrel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="comment1"><span>(* equalities need to be replaced by appropriate equivalence relations *)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="comment1"><span>(* in this case we just check whether the given equivalence relation is correct *)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rel</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_relation_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>rel_ty</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rel'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (relation mismatch)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="entity"><span>rel'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>same_const</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>matches_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>same_const</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>same_const</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="entity"><span>qtrm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtrm'</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quotient_Info.lookup_quotconsts_global</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>qtrm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rconst</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rconst</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (constant not found)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtrm</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>term_mismatch</span></span><span> </span><span class="inner_quoted"><span>"regularize (constant mismatch)"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="entity"><span>qtrm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>v1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>v2'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="inner_quoted"><span>"regularize (bounds mismatch)"</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtrm_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtrm_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"regularize failed (default: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>rtrm_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>qtrm_str</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>regularize_trm_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>regularize_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>



</span><span class="comment1"><span>(*** Rep/Abs Injection ***)</span></span><span>

</span><span class="comment1"><span>(*
Injection of Rep/Abs means:

  For abstractions:

  * If the type of the abstraction needs lifting, then we add Rep/Abs
    around the abstraction; otherwise we leave it unchanged.

  For applications:

  * If the application involves a bounded quantifier, we recurse on
    the second argument. If the application is a bounded abstraction,
    we always put an Rep/Abs around it (since bounded abstractions
    are assumed to always need lifting). Otherwise we recurse on both
    arguments.

  For constants:

  * If the constant is (op =), we leave it always unchanged.
    Otherwise the type of the constant needs lifting, we put
    and Rep/Abs around it.

  For free variables:

  * We put a Rep/Abs around it if the type needs lifting.

  Vars case cannot occur.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_repabs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>RepF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absrep_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>AbsF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inj_repabs_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="entity"><span>qtrm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtrm_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtrm_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtrm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>LIFT_MATCH</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>rtrm_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"and"</span></span><span class="main"><span>,</span></span><span> </span><span>quote</span><span> </span><span class="entity"><span>qtrm_str</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* bound variables need to be treated properly,
   as the type of subterms needs to be calculated   *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Babs|const"><span>Babs</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>qtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>mk_repabs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quotient.html#Quotient.Babs|const"><span>Babs</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>qtrm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.dest_abs_global</span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.dest_abs_global</span><span> </span><span class="entity"><span>t'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>yvar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.lambda_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>yvar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>result</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_repabs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>result</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_repabs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_repabs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>inj_repabs_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"injection (default):"</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="entity"><span>qtrm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inj_repabs_trm_chk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>inj_repabs_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtrm</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>



</span><span class="comment1"><span>(*** Wrapper for automatically transforming an rthm into a qthm ***)</span></span><span>

</span><span class="comment1"><span>(* substitutions functions for r/q-types and
   r/q-constants, respectively
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtys</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>tail</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>tail</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rty</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rconst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qconst</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>tail</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Pattern.match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rconst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtrm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>tail</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_subst</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_term</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>qconst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>trm_subst</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* generate type and term substitutions out of the
   qtypes involved in a quotient; the direction flag
   indicates in which direction the substitutions work:

     true:  quotient -&gt; raw
     false: raw -&gt; quotient
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Quotient_Info.dest_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rtyp </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>qtyp </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_instance</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>swap</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_trm_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst_typ'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_typ'</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t2</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_substs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Quotient_Info.dest_quotconsts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rconst </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>qconst </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>swap</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_substs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Quotient_Info.dest_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equiv_rel </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>qtyp </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>swap</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>filter</span><span> </span><span class="entity"><span>proper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_substs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rel_substs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* derives a qtyp and qtrm out of a rtyp and rtrm,
   respectively
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_qtyp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_qtrm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>rtrm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_trm_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rtrm</span></span><span>

</span><span class="comment1"><span>(* derives a rtyp and rtrm out of a qtyp and qtrm,
   respectively
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_rtyp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>subst_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_rtrm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span class="entity"><span>qtrm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>subst_trm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ty_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_trm_subst</span></span><span> </span><span class="entity"><span>qtys</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qtrm</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>