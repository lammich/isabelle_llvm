<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nitpick/nitpick_model.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nitpick/nitpick_model.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nitpick/nitpick_model.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2009, 2010

Model reconstruction for Nitpick.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NITPICK_MODEL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Scope.scope</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Rep.rep</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Nut.nut</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>show_types</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     show_skolems</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     show_consts</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>term_postprocessor</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> NameTable </span><span class="main"><span>:</span></span><span> </span><span>TABLE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> irrelevant </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unknown </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unrep_mixfix </span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_term_postprocessor </span><span class="main"><span>:</span></span><span>
    </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>term_postprocessor</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_term_postprocessor_global </span><span class="main"><span>:</span></span><span>
    </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>term_postprocessor</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unregister_term_postprocessor </span><span class="main"><span>:</span></span><span>
    </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unregister_term_postprocessor_global </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tuple_list_for_name </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>nut</span></span><span> </span><span>NameTable.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.raw_bound</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_plain_fun </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reconstruct_hol_model </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>option</span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>option</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>nut</span></span><span> </span><span>NameTable.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.raw_bound</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> * </span><span>bool</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nitpick_Model</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NITPICK_MODEL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_HOL</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Scope</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Peephole</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Rep</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Nut</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>KK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Kodkod</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>show_types</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   show_skolems</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   show_consts</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>term_postprocessor</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span class="entity"><span>term_postprocessor</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>print_mode_active</span><span> </span><span>Print_Mode.ASCII</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>irrelevant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unknown</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"?"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unrep_mixfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"…"</span></span><span> </span><span class="inner_quoted"><span>"..."</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maybe_mixfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"_<span class="hidden">⇧</span><sup>?</sup>"</span></span><span> </span><span class="inner_quoted"><span>"_?"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_mixfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"_<span class="hidden">⇘</span><sub>base</sub><span class="hidden">⇙</span>"</span></span><span> </span><span class="inner_quoted"><span>"_.base"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step_mixfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"_<span class="hidden">⇘</span><sub>step</sub><span class="hidden">⇙</span>"</span></span><span> </span><span class="inner_quoted"><span>"_.step"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_mixfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"«_»"</span></span><span> </span><span class="inner_quoted"><span>"\"_\""</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cyclic_co_val_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"ω"</span></span><span> </span><span class="inner_quoted"><span>"w"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cyclic_const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"ξ"</span></span><span> </span><span class="inner_quoted"><span>"X"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cyclic_type_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nitpick_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>cyclic_const_prefix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nitpick_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"opt"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>non_opt_flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nitpick_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"non_opt"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>atom_pool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Mixfix</span><span> </span><span class="main"><span>(</span></span><span>Input.string</span><span> </span><span class="entity"><span>sy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_wacky_syntax</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unrep_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹nitpick_unrep›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unrep_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹nitpick_maybe›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="tfree"><span>'a</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹nitpick_abs›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="tfree"><span>'b</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>40</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>40</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹nitpick_base›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="tfree"><span>'a</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹nitpick_step›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="tfree"><span>'a</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>unrep_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step_s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span>Proof_Context.transfer</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Term reconstruction **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_atom_number</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>pool</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span>length</span><span> </span><span class="entity"><span>js</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>js</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_suffix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>nat_subscript</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Symbol.is_ascii_digit</span><span> </span><span class="main"><span>(</span></span><span>List.last</span><span> </span><span class="main"><span>(</span></span><span>raw_explode</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(* FIXME Symbol.explode (?) *)</span></span><span>
     </span><span>?</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"<span class="hidden">⇩</span><sub>,</sub>"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_atom_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>triple_lookup</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_atom_number</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>&lt;=</span><span> </span><span>length</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>nth</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>shortest_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../String.html#String.string|type"><span>string</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"s"</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"\\"</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s'</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>atom_suffix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>m</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>atom_suffix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>m</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.nth_atom_name"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_atom</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nth_atom_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_real_number</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Rings.html#Rings.divide_class.divide|const"><span>divide</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>real</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>/</span><span> </span><span>real</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_real_number</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>real</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Real.compare</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>extract_real_number</span></span><span> </span><span class="entity"><span>tp</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_number"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>t11</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t12</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t21</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t22</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t21</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t12</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t22</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term_Ord.fast_term_ord</span><span> </span><span class="entity"><span>tp</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_term_postprocessor_generic</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>postproc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* TODO: Consider morphism. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_term_postprocessor</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>register_term_postprocessor_generic</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>postproc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_term_postprocessor_global</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Context.theory_map</span><span> </span><span>oo</span><span> </span><span class="entity"><span>register_term_postprocessor_generic</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unregister_term_postprocessor_generic</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>AList.delete</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(* TODO: Consider morphism. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unregister_term_postprocessor</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>unregister_term_postprocessor_generic</span></span><span> </span><span class="entity"><span>T</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unregister_term_postprocessor_global</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Context.theory_map</span><span> </span><span>o</span><span> </span><span class="entity"><span>unregister_term_postprocessor_generic</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuple_list_for_name</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_rel</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.fun_box.FunBox|const"><span>FunBox</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.pair_box.PairBox|const"><span>PairBox</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
                </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>$</span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t2</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T12</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>T2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T22</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>num_factors_in_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T21</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T11'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_T12'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_T22'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T12</span></span><span> </span><span class="entity"><span>T22</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T11'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_T12'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T21'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_T22'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T21</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21'</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T22'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T22'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T22</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>swap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T12</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T11</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T12</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T22</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T21</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Term-encoded data structure for holding key-value pairs as well as an "opt"
   flag indicating whether the function is approximated. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_plain_fun</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>opt_flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>non_opt_flag</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>o</span><span> </span><span>rev</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_plain_fun</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opt_flag</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>non_opt_flag</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_plain_fun</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_plain_fun</span></span><span> </span><span class="entity"><span>t0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_plain_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_plain_fun</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>irrelevant</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>non_opt_flag</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.dest_plain_fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>break_in_two</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.flat_tupleT_paths</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cut</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.strip_tupleT</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>HOLogic.flat_tupleT_paths</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.strip_ptuple</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="entity"><span>cut</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_ptuple</span></span><span> </span><span class="entity"><span>ps1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_ptuple</span></span><span> </span><span class="entity"><span>ps2</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pair_up</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
                          </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span>
                                </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>$</span><span> </span><span class="entity"><span>t11</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t12</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pair_up</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>t12</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pair_up</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>multi_pair_up</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>o</span><span> </span><span class="entity"><span>pair_up</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="entity"><span>ts3</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>format_fun</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="entity"><span>T'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_curry</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1a</span></span><span> </span><span class="entity"><span>T1b</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tsp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_plain_fun</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>tsp</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>break_in_two</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1a</span></span><span> </span><span class="entity"><span>T1b</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>AList.coalesce</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_plain_fun</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1b</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_plain_fun</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1a</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1b</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_uncurry</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tsp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_plain_fun</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>tsp</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span>
              </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>multi_pair_up</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_plain_fun</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_plain_fun</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span>
                 </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>T1'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.format_fun.do_arrow"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_fun</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>factor_out_types</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1a</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T1b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_curry</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1a</span></span><span> </span><span class="entity"><span>T1b</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1a</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1b</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T1a'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T1b'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_arrow</span></span><span> </span><span class="entity"><span>T1a'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1b'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_uncurry</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.format_fun.do_fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>do_fun</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.format_fun.do_term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>do_fun</span></span><span> </span><span class="entity"><span>T1'</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>truth_const_sort_key</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"0"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>truth_const_sort_key</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"2"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>truth_const_sort_key</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"1"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.flatten_tupleT</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.mk_tuple"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varified_type_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>candid_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>strict_type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>candid_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>varify_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat_T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_values_of_type</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>wacky_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>scope</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>card</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_value_of_type</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>reconstruct_term</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>wacky_names</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>sel_names</span></span><span>
                           </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>n</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>false</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cyclic_const_prefix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>nth_value_of_type</span></span><span> </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="entity"><span>nice_term_ord</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>reconstruct_term</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="entity"><span>pool</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>wacky_names</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>unrep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>scope</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="entity"><span>data_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value_of_bits</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span>›</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>the_single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Integer.add</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasonable_power</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span>?</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="entity"><span>js</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_values</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>all_values_of_type</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>wacky_names</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                         </span><span class="entity"><span>bounds</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess_term</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>postprocess_term</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>postprocs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varified_type_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>postprocs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>postproc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>maybe_name</span></span><span> </span><span class="entity"><span>all_values</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>postprocess_term</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>postprocess_term</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.empty|const"><span>Set.empty</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insert_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.insert|const"><span>insert</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>set_T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>insert_const</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unrep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>empty_const</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>empty_const</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>zs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>zs</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span>
               </span><span>?</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>insert_const</span></span><span>
                        </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
                                 </span><span>?</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span>
                                         </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>tps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>tps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>update_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Map.html#Map.empty|const"><span>Map.empty</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>aux'</span></span><span> </span><span class="entity"><span>tps</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_const</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>aux'</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>update_const</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>aux'</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unrep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
            </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.Some|const"><span>Some</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>aux'</span></span><span> </span><span class="entity"><span>tps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_plain_fun</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T2'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maybe_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts_pair</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="entity"><span>dest_plain_fun</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>||&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_map</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T2'</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts_pair</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t11</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
               </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unknown</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t11</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opt_flag</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>non_opt_flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                 </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span>
                      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                               </span><span class="entity"><span>irrelevant</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                               </span><span class="entity"><span>unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                 </span><span class="entity"><span>t</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fun_or_set</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ts1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts2</span></span><span>
      </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nice_term_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>sort_by</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>truth_const_sort_key</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
            </span><span>#&gt;</span><span> </span><span class="entity"><span>make_set</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>make_plain_fun</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span>
            </span><span>#&gt;</span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span>
            </span><span>#&gt;</span><span> </span><span class="entity"><span>format_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_for_fun_or_set</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>[</span></span><span class="entity"><span>nth_combination</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>k1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>General.Subscript</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_term.\
                            \term_for_fun_or_set"</span></span><span class="main"><span>,</span></span><span>
                            </span><span>signed_string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" for "</span></span><span> </span><span>^</span><span>
                            </span><span class="entity"><span>string_for_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>term_for_fun_or_set</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>j</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>term_for_fun_or_set</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>j</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>k1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.pair_const</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span>
                          </span><span class="comment1"><span>(* ### k2 or k1? FIXME *)</span></span><span>
                          </span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>mod</span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>bool_T</span></span><span> </span><span class="entity"><span>bool_T</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="entity"><span>nat_T</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="entity"><span>int_T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_for_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fp_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="entity"><span>nat_T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator|type"><span>bisim_iterator</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="entity"><span>nat_T</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nth_atom</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>deep </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nth_atom</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>co</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuples_for_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>tuple_list_for_name</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ConstName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Any</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cyclic_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>nth_atom</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cyclic_type_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cyclic_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>nth_atom_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discr_jsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tuples_for_const</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>discr_for_constr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span>
                                 </span><span class="entity"><span>constrs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>real_j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>jss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>real_j</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>const</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>discr_jsss</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curried_binder_types</span></span><span> </span><span class="entity"><span>constr_T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_xs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binarized_and_boxed_nth_sel_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
                                                          </span><span class="entity"><span>constr_x</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_Rs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>get_first</span><span>
                               </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ConstName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_\
                                                   \term.term_for_atom"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="entity"><span>sel_names</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Func</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_Rs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_jsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>tuples_for_const</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_jsss</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>real_j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_jsss</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncur_arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>constr_T</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
               </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seen</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>split_last</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>cyclic_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>constr_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word.Word|const"><span>Word</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>HOLogic.mk_number</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nat_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>int_T</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>value_of_bits</span></span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>arg_jsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>co</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>arg_Rs</span></span><span>
                         </span><span class="entity"><span>arg_jsss</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>uncur_arg_Ts</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_n_tuple</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>uncur_arg_Ts</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>constr_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.Abs_Frac|const"><span>Abs_Frac</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                      </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>frac_from_term_pair</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_term.\
                                       \term_for_atom (Abs_Frac)"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_abs_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>constr_x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                          </span><span class="entity"><span>constr_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.Quot|const"><span>Quot</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>the_single</span><span> </span><span class="entity"><span>ts</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>constr_x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cyclic_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.The|const"><span>The</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                        </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cyclic_co_val_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
                               </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>)</span></span><span>
                               </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span>abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                        </span><span class="entity"><span>cyclic_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>t</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="entity"><span>t</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>term_for_vect</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>make_fun_or_set</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T'</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>chunk_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term_for_atom</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_term.term_for_rep"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>js</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>js1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="entity"><span>js</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.pair_const</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span>
                          </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>js1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>js2</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>js</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>term_for_vect</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>js</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>jss1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_combinations_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>int_from_bool</span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="entity"><span>jss1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_fun_or_set</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>jss1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_combinations_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_for_rep</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>grouped_jss2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>arity1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_for_rep</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span>o</span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                         </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>grouped_jss2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_fun_or_set</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opt</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>jss</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>jss</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_term.term_for_rep"</span></span><span class="main"><span>,</span></span><span>
                   </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
                   </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>jss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>postprocess_subterms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>polish_funs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>unarize_unbox_etc_term</span></span><span>
    </span><span>oooo</span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Constant postprocessing **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_n_tuple_type</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_n_tuple_type</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>T1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>dest_n_tuple_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_n_tuple_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.dest_n_tuple_type"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>const_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>unrolled_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>const_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>skolem_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unprefix</span><span> </span><span class="entity"><span>skolem_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>strip_first_name_sep</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span>space_explode</span><span> </span><span class="inner_quoted"><span>"@"</span></span><span>
              </span><span>|&gt;</span><span> </span><span>hd</span><span> </span><span>|&gt;</span><span> </span><span>Int.fromString</span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def_of_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fixpoint_kind_of_rhs</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>NoFp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>strip_abs_vars</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                   </span><span class="main"><span>[</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>]</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                 </span><span class="main"><span>[</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="entity"><span>ks1</span></span><span> </span><span class="entity"><span>ks2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ks1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ks2'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ks1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ks1'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k1</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>k2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>k1</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>ks2'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k2</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>k1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>k2</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k1</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>[</span></span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>term_match</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>formats</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>format</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="entity"><span>format</span></span><span>
                                             </span><span class="main"><span>(</span></span><span class="entity"><span>const_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>format</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binder_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>batched</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>binder_Ts</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>default_format</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>rev</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>chunk_list_unevenly</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>format</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span>o</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>List.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body_T</span></span><span> </span><span class="entity"><span>batched</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>format_term_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>format_type</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_special_format</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>m</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>chunk_list_unevenly</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>format</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span>o</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span>null</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>length</span><span> </span><span>|&gt;</span><span> </span><span>rev</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>user_friendly_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>evals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_tables</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>special_funs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span>
                         </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>hol_context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>special_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span>AList.find</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>special_funs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>the_single</span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.last</span><span> </span><span class="entity"><span>js</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing_js</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>max_j</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter_indices</span></span><span> </span><span class="entity"><span>missing_js</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_missing_var</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>arg_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>nat_subscript</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>missing_Ts</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>nth_missing_var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>missing_js</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>special_bounds</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>missing_vars</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>js</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>missing_vars</span></span><span>
                                </span><span class="main"><span>(</span></span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>missing_js</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>max_j</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>SOME</span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>repair_special_format</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>const_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>x'</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>repair_special_format</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>intersect_formats</span></span><span> </span><span class="entity"><span>default_format</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>abs_var</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>uncurry_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unprefix</span><span> </span><span class="entity"><span>uncurry_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span>
                          </span><span>|&gt;</span><span> </span><span class="entity"><span>strip_first_name_sep</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>space_explode</span><span> </span><span class="inner_quoted"><span>"@"</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>step_prefix</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="entity"><span>do_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Int.fromString</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Int.fromString</span><span> </span><span class="main"><span>(</span></span><span>List.last</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>before_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tuple_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="entity"><span>strip_n_binders</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_n_binders</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>before_Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>dest_n_tuple_type</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>tuple_T</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>rest_T</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>unrolled_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter_var_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>base_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>base_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>step_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>step_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>default_format</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>quot_normal_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nitpick_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"quotient normal form"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>format_term_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>skolem_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>skolems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>s</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>lambda</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>format_type</span></span><span> </span><span class="entity"><span>default_format</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_format</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>eval_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>evals</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Int.fromString</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>eval_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>format_term_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="comment1"><span>(* The selector case can occur in conjunction with fractional types.
            It's not pretty. *)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_sel</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>original_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>format_term_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>map_types</span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>shorten_names_in_term</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>Term.map_abs_vars</span><span> </span><span class="entity"><span>shortest_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assign_operator_for_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>ubfp_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"≤"</span></span><span> </span><span class="inner_quoted"><span>"&lt;="</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lbfp_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>xsym</span></span><span> </span><span class="inner_quoted"><span>"≥"</span></span><span> </span><span class="inner_quoted"><span>"&gt;="</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>assign_operator_for_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_first_name_sep</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="inner_quoted"><span>"="</span></span><span>

</span><span class="comment1"><span>(** Model reconstruction **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_outer_the_binders</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.The|const"><span>The</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
                                   </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
                                                </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unfold_outer_the_binders</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_outer_the_binders</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bisimilar_values</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bisimilar_values</span></span><span> </span><span class="entity"><span>coTs</span></span><span> </span><span class="entity"><span>max_depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>coTs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>head1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span>o</span><span> </span><span class="entity"><span>unfold_outer_the_binders</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_depth</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>coTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>head1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
          </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bisimilar_values</span></span><span> </span><span class="entity"><span>coTs</span></span><span> </span><span class="entity"><span>max_depth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>args2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_term_auto_global</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>irrelevant</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unknown</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Term.dummy</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t0</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fake_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Symbol_Pos.is_identifier</span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>globals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_const_names</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>String.isSubstring</span><span> </span><span>Long_Name.separator</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fake_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Proof_Context.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>thy</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Sign.map_naming</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Name_Space.global_naming</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span>o</span><span> </span><span class="entity"><span>add_fake_const</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>globals</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Sign.restore_naming</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>fake_ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reconstruct_hol_model</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>show_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>show_skolems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>show_consts</span></span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_bisim_depth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>boxes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>user_axioms</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>debug</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>whacks</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binary_ints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>destroy_constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specialize</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>star_linear_preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>total_consts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>needs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac_timeout</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>evals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_tables</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nondef_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nondefs</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>simp_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>psimp_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice_spec_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro_table</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>ground_thm_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ersatz_table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>special_funs</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>unrolled_preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wf_cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_cache</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ofs</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>real_frees</span></span><span> </span><span class="entity"><span>pseudo_frees</span></span><span> </span><span class="entity"><span>free_names</span></span><span> </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>nonsel_names</span></span><span>
        </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wacky_names</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base_step_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_wacky_syntax</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>thy </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> max_bisim_depth </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_bisim_depth</span></span><span class="main"><span>,</span></span><span> boxes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>boxes</span></span><span class="main"><span>,</span></span><span>
       wfs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wfs</span></span><span class="main"><span>,</span></span><span> user_axioms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>user_axioms</span></span><span class="main"><span>,</span></span><span> debug </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>debug</span></span><span class="main"><span>,</span></span><span> whacks </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whacks</span></span><span class="main"><span>,</span></span><span>
       binary_ints </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binary_ints</span></span><span class="main"><span>,</span></span><span> destroy_constrs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>destroy_constrs</span></span><span class="main"><span>,</span></span><span>
       specialize </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>specialize</span></span><span class="main"><span>,</span></span><span> star_linear_preds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>star_linear_preds</span></span><span class="main"><span>,</span></span><span>
       total_consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>total_consts</span></span><span class="main"><span>,</span></span><span> needs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>needs</span></span><span class="main"><span>,</span></span><span> tac_timeout </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac_timeout</span></span><span class="main"><span>,</span></span><span>
       evals </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>evals</span></span><span class="main"><span>,</span></span><span> case_names </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_names</span></span><span class="main"><span>,</span></span><span> def_tables </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_tables</span></span><span class="main"><span>,</span></span><span>
       nondef_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nondef_table</span></span><span class="main"><span>,</span></span><span> nondefs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nondefs</span></span><span class="main"><span>,</span></span><span> simp_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_table</span></span><span class="main"><span>,</span></span><span>
       psimp_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>psimp_table</span></span><span class="main"><span>,</span></span><span> choice_spec_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>choice_spec_table</span></span><span class="main"><span>,</span></span><span>
       intro_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro_table</span></span><span class="main"><span>,</span></span><span> ground_thm_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ground_thm_table</span></span><span class="main"><span>,</span></span><span>
       ersatz_table </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ersatz_table</span></span><span class="main"><span>,</span></span><span> skolems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>,</span></span><span>
       special_funs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>special_funs</span></span><span class="main"><span>,</span></span><span> unrolled_preds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unrolled_preds</span></span><span class="main"><span>,</span></span><span>
       wf_cache </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wf_cache</span></span><span class="main"><span>,</span></span><span> constr_cache </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr_cache</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span class="main"><span>,</span></span><span> binarize </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> card_assigns </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span>
       bits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>,</span></span><span> bisim_depth </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span class="main"><span>,</span></span><span> data_types </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data_types</span></span><span class="main"><span>,</span></span><span>
       ofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ofs</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>reconstruct_term</span></span><span> </span><span class="entity"><span>maybe_opt</span></span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>wacky_names</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="entity"><span>atomss</span></span><span>
                       </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_values</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>all_values_of_type</span></span><span> </span><span class="entity"><span>pool</span></span><span> </span><span class="entity"><span>wacky_names</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="entity"><span>atomss</span></span><span> </span><span class="entity"><span>sel_names</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                         </span><span class="entity"><span>bounds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_codatatype_wellformed</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cos</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_values</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>typ</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.sum</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>card </span><span class="entity"><span>cos</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>bisimilar_values</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>typ </span><span class="entity"><span>cos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>max_depth</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>all_distinct_unordered_pairs_of</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_for_assign</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oper</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>FreeName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>format_term_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>def_tables</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ConstName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>assign_operator_for_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>user_friendly_const</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>base_step_names</span></span><span> </span><span class="entity"><span>formats</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_hol_model.\
                            \pretty_for_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Any</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span class="entity"><span>tuple_list_for_name</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>name</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>term_for_rep</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_fully_representable_set</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span>
                                   </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.breaks</span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_term_auto_global</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>oper</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>pretty_term_auto_global</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_for_data_type</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.breaks</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_for_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>::</span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.fun_box|type"><span>fun_box</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"[boxed]"</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.pair_box|type"><span>pair_box</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"[boxed]"</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
           </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>
                </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_term_auto_global</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_values</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fun_from_pair</span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span>false</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unrep_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>integer_data_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>{</span></span><span>typ </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> card </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> co </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
        self_rec </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> complete </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> concrete </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        deep </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> constrs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_HOL.card_of_type"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>data_types</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>#</span></span><span>deep
                 </span><span>|&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="entity"><span>integer_data_type</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nat_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>block_of_data_types</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_types</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>data_types</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>[</span></span><span>Pretty.big_list</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Type"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>plural_s_for_list</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_for_data_type</span></span><span> </span><span class="entity"><span>data_types</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>block_of_names</span></span><span> </span><span class="entity"><span>show</span></span><span> </span><span class="entity"><span>title</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>title</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>plural_s_for_list</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>)</span></span><span>
        </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.indent</span><span> </span><span class="entity"><span>indent_size</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>pretty_for_assign</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span>sort_by</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>original_name</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>nickname_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_name_for_term</span></span><span> </span><span class="entity"><span>keep_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
                   </span><span>o</span><span> </span><span class="entity"><span>pairf</span></span><span> </span><span class="entity"><span>nickname_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uniterize_unarize_unbox_etc_type</span></span><span>
                                        </span><span>o</span><span> </span><span class="entity"><span>type_of</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>free_names</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>keep_all</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FreeName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Any</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Model.reconstruct_hol_model.\
                         \free_name_for_term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skolem_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nonskolem_nonsel_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>List.partition</span><span> </span><span class="entity"><span>is_skolem_name</span></span><span> </span><span class="entity"><span>nonsel_names</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noneval_nonskolem_nonsel_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>eval_prefix</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>nickname_of</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="entity"><span>nonskolem_nonsel_names</span></span><span>
      </span><span>||&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim|const"><span>bisim</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
                                     </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator_max|const"><span>bisim_iterator_max</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
                      </span><span>o</span><span> </span><span class="entity"><span>nickname_of</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>free_name_for_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pseudo_frees</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>real_free_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>free_name_for_term</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>real_frees</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block_of_names</span></span><span> </span><span>true</span><span> </span><span class="inner_quoted"><span>"Free variable"</span></span><span> </span><span class="entity"><span>real_free_names</span></span><span> </span><span>@</span><span>
                 </span><span class="entity"><span>block_of_names</span></span><span> </span><span class="entity"><span>show_skolems</span></span><span> </span><span class="inner_quoted"><span>"Skolem constant"</span></span><span> </span><span class="entity"><span>skolem_names</span></span><span> </span><span>@</span><span>
                 </span><span class="entity"><span>block_of_names</span></span><span> </span><span>true</span><span> </span><span class="inner_quoted"><span>"Evaluated term"</span></span><span> </span><span class="entity"><span>eval_names</span></span><span> </span><span>@</span><span>
                 </span><span class="entity"><span>block_of_data_types</span></span><span> </span><span>@</span><span>
                 </span><span class="entity"><span>block_of_names</span></span><span> </span><span class="entity"><span>show_consts</span></span><span> </span><span class="inner_quoted"><span>"Constant"</span></span><span>
                                </span><span class="entity"><span>noneval_nonskolem_nonsel_names</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>codatatypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>#</span></span><span>co </span><span class="entity"><span>data_types</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Empty assignment"</span></span><span class="main"><span>]</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>chunks</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>bisim_depth</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
     </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_codatatype_wellformed</span></span><span> </span><span class="entity"><span>codatatypes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>codatatypes</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>