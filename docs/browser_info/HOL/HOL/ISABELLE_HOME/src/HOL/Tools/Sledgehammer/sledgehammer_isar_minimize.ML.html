<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_isar_minimize.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_isar_minimize.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_isar_minimize.ML
    Author:     Steffen Juilf Smolka, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen

Minimize dependencies (used facts) of Isar proof steps.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_MINIMIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.isar_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Preplay.isar_preplay_data</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> keep_fastest_method_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> minimized_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>Time.time</span><span> * </span><span class="entity"><span>isar_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> minimize_isar_step_dependencies </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> postprocess_isar_proof_remove_show_stuttering </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> postprocess_isar_proof_remove_unreferenced_steps </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_proof</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Minimize</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_MINIMIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Preplay</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>keep_fastest_method_of_isar_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
      qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
      obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
      label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
      goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
      subproofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
      facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
      proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span>
        </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fastest_method_of_isar_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span class="main"><span>,</span></span><span>
      comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>keep_fastest_method_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>slack</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.025</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minimized_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>time</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>proof_methods</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_step_lfs_gfs</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="entity"><span>gfs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
        qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
        obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
        label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
        goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
        subproofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
        facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sort_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
        comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>min_facts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>min_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>preplay_isar_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>slack</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meth</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>mk_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_facts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>min_facts</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>time'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>min_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>time'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_step_lfs_gfs</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="entity"><span>gfs0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lfs0</span></span><span> </span><span class="entity"><span>time</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_gfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>time''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>minimize_half</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_step_lfs_gfs</span></span><span> </span><span class="entity"><span>min_lfs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>gfs0</span></span><span> </span><span class="entity"><span>time'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>time''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_step_lfs_gfs</span></span><span> </span><span class="entity"><span>min_lfs</span></span><span> </span><span class="entity"><span>min_gfs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minimize_isar_step_dependencies</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Lazy.force</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preplay_outcome_of_isar_step_for_method</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>old_data_for_method</span></span><span> </span><span class="entity"><span>meth'</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>meth'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>peek_at_outcome</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preplay_outcome_of_isar_step_for_method</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>meth'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>minimized_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>step</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>set_preplay_outcomes_of_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>time'</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>step'</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>step'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>old_data_for_method</span></span><span> </span><span class="entity"><span>meths</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>step'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="comment1"><span>(* don't touch steps that time out or fail *)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>minimize_isar_step_dependencies</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess_isar_proof_remove_show_stuttering</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> obtains </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Show</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> obtains </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
             qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Show</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
             obtains </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
             label </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>label </span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span>
             goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span>
             subproofs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>subproofs </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span>
             facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>facts </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span>
             proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>proof_methods </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span>
             comment </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>comment </span><span class="entity"><span>p1</span></span><span> </span><span>^</span><span> </span><span class="main"><span>#</span></span><span>comment </span><span class="entity"><span>p2</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>process_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess_isar_proof_remove_unreferenced_steps</span></span><span> </span><span class="entity"><span>postproc_step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>process_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="comment1"><span>(* the last step is always implicitly referenced *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>steps</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>process_used_step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>fold_rev</span><span> </span><span class="entity"><span>process_step</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>process_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>label_of_isar_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Ord_List.member</span><span> </span><span class="entity"><span>label_ord</span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>process_used_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>Ord_List.union</span><span> </span><span class="entity"><span>label_ord</span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>process_used_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_used_step_subproofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>postproc_step</span></span><span> </span><span class="entity"><span>step</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>process_used_step_subproofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
          facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="entity"><span>process_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>split_list</span><span>
          </span><span>|&gt;&gt;</span><span> </span><span>Ord_List.unions</span><span> </span><span class="entity"><span>label_ord</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Ord_List.insert</span><span> </span><span class="entity"><span>label_ord</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
          qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
          obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
          label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
          goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
          subproofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs'</span></span><span class="main"><span>,</span></span><span>
          facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
          comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>used</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>process_proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>