<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_isar_proof.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_isar_proof.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_isar_proof.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Author:     Steffen Juilf Smolka, TU Muenchen

Basic data structures for representing and basic methods
for dealing with Isar proof texts.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.proof_method</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* local and global facts *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>isar_qualifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Show</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Then</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
      fixes </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      assumptions</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>label * term</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      steps </span><span class="main"><span>:</span></span><span> isar_step list
    </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Let</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
      lhs </span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
      rhs </span><span class="main"><span>:</span></span><span> term
    </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Prove</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
      qualifiers </span><span class="main"><span>:</span></span><span> isar_qualifier list</span><span class="main"><span>,</span></span><span>
      obtains </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
      label </span><span class="main"><span>:</span></span><span> label</span><span class="main"><span>,</span></span><span>
      goal </span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
      subproofs </span><span class="main"><span>:</span></span><span> isar_proof list</span><span class="main"><span>,</span></span><span>
      facts </span><span class="main"><span>:</span></span><span> facts</span><span class="main"><span>,</span></span><span>
      proof_methods </span><span class="main"><span>:</span></span><span> proof_method list</span><span class="main"><span>,</span></span><span>
      comment </span><span class="main"><span>:</span></span><span> string
    </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_label </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> label_ord </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>ord</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_label </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sort_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>facts</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> steps_of_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> isar_proof_with_steps </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> label_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> facts_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>facts</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> proof_methods_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_isar_steps </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_isar_steps </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_isar_steps </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Canonical_Label_Tab </span><span class="main"><span>:</span></span><span> </span><span>TABLE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> canonical_label_ord </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>ord</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> comment_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chain_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> kill_useless_labels_in_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> relabel_isar_proof_canonically </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> relabel_isar_proof_nicely </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rationalize_obtains_in_isar_proofs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem_Generate</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Proof_Reconstruct</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Annotate</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span>int</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* local and global facts *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>isar_qualifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Show</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Then</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    fixes </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    assumptions</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>label * term</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    steps </span><span class="main"><span>:</span></span><span> isar_step list
  </span><span class="main"><span>}</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Let</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    lhs </span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
    rhs </span><span class="main"><span>:</span></span><span> term
  </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Prove</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    qualifiers </span><span class="main"><span>:</span></span><span> isar_qualifier list</span><span class="main"><span>,</span></span><span>
    obtains </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    label </span><span class="main"><span>:</span></span><span> label</span><span class="main"><span>,</span></span><span>
    goal </span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
    subproofs </span><span class="main"><span>:</span></span><span> isar_proof list</span><span class="main"><span>,</span></span><span>
    facts </span><span class="main"><span>:</span></span><span> facts</span><span class="main"><span>,</span></span><span>
    proof_methods </span><span class="main"><span>:</span></span><span> proof_method list</span><span class="main"><span>,</span></span><span>
    comment </span><span class="main"><span>:</span></span><span> string
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* cf. "label_ord" below *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assume_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"a"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>have_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>label_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>String.size</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>string_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="comment1"><span>(* "assume" before "have" *)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_label</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>num</span></span><span>

</span><span class="comment1"><span>(* Put the nearest local label first, since it's the most likely to be replaced by a "hence".
   (Some preplaying proof methods, e.g. "blast", react poorly to fact reorderings.) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sort_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label_ord</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span>sort</span><span> </span><span>string_ord</span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span>fixes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> assumptions </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> steps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>label_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>label</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>label_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subproofs_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subproofs_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>facts_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>facts_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proof_methods_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_methods_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_isar_step</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subproofs_of_isar_step</span></span><span> </span><span class="entity"><span>step</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>step</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_isar_step</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_isar_steps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_step</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>map_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Let</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>step</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
            label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
            goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            subproofs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>map_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
            facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
            proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>map_proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_isar_steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* canonical proof labels: 1, 2, 3, ... in post traversal order *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>canonical_label_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span> * </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Canonical_Label_Tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>canonical_label_ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>comment_isar_step</span></span><span> </span><span class="entity"><span>comment_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
      qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
      obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
      label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
      goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
      subproofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
      facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
      proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
      comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment_of</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>}</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>comment_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>comment_isar_proof</span></span><span> </span><span class="entity"><span>comment_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comment_isar_step</span></span><span> </span><span class="entity"><span>comment_of</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chain_qs_lfs</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chain_qs_lfs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>l0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="entity"><span>l0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Then</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l0</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chain_isar_step</span></span><span> </span><span class="entity"><span>lbl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
      facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chain_qs_lfs</span></span><span> </span><span class="entity"><span>lbl</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
        qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
        obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
        label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
        goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
        subproofs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>chain_isar_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
        facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
        comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chain_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>chain_isar_steps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chain_isar_steps</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>chain_isar_step</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>chain_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label_of_isar_step</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>chain_isar_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chain_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>List.last</span><span> </span><span>#&gt;</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_useless_labels_in_isar_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used_ls</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts_of_isar_step</span></span><span> </span><span>#&gt;</span><span> </span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_ls</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>no_label</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
          qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
          obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
          label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kill_label</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
          goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
          subproofs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>kill_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
          facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
          proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
          comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kill_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>kill_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assumptions'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>kill_label</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>steps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>kill_step</span></span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span>fixes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> assumptions </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> steps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>kill_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relabel_isar_proof_canonically</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relabel_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lfs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>subs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span>
            </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>label</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
            label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span>
            goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            subproofs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subs'</span></span><span class="main"><span>,</span></span><span>
            facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>relabel_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>#&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span>
      </span><span>##&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>relabel_step</span></span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span>fixes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> assumptions </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> steps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relabel_isar_proof_nicely</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_label</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>replicate_string</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relabel_step</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="entity"><span>have_prefix</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="entity"><span>accum</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
            label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span>
            goal </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            subproofs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
            facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>relabel_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>next_label</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="entity"><span>assume_prefix</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>#&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relabel_step</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span>fixes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> assumptions </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> steps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>relabel_proof</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stutter_single_letter</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.extract</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rationalize_obtains_in_isar_proofs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_obtains</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>xs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_names0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stutter_single_letter</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>var_name_of_typ</span></span><span> </span><span>o</span><span> </span><span>body_type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="entity"><span>new_names0</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>pair</span><span> </span><span class="entity"><span>new_names</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>ys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rationalize_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>obtains'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_ctxt'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rename_obtains</span></span><span> </span><span class="entity"><span>obtains</span></span><span> </span><span class="entity"><span>subst_ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            qualifiers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            obtains </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains'</span></span><span class="main"><span>,</span></span><span>
            label </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
            goal </span><span class="main"><span>=</span></span><span> </span><span>subst_atomic</span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            subproofs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rationalize_proof</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>subst_ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
            facts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
            proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            comment </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rationalize_proof</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_ctxt'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="comment1"><span>(* last call: eliminate any remaining skolem names (from SMT proofs) *)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>Name.skolem</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>rename_obtains</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>subst_ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assumptions'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>subst_atomic</span><span> </span><span class="entity"><span>subst'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>steps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="entity"><span>rationalize_step</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>subst_ctxt'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span>fixes </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes'</span></span><span class="main"><span>,</span></span><span> assumptions </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assumptions'</span></span><span class="main"><span>,</span></span><span> steps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps'</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>rationalize_proof</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thesis_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Auto_Bind.thesisN</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_thesis</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Vartab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Variable.binds_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>thesis_var</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indent_size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_isar_proof</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thy_Header.get_keywords'</span><span> </span><span class="entity"><span>ctxt0</span></span><span>

    </span><span class="comment1"><span>(* Make sure only type constraints inserted by the type annotation code are printed. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>show_markup</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>Printer.show_type_emphasis</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>show_types</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>show_sorts</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>show_consts</span><span> </span><span>false</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate_string</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>indent_size</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_moreover</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"moreover\n"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_label</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>string_of_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_obtain</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Then</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"ultimately "</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Then</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"then "</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"obtain"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_show_have</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Show</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"show"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"have"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_thus_hence</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Show</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"then show"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"then have"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_have</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Then</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"ultimately "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_show_have</span></span><span> </span><span class="entity"><span>qs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Then</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>of_thus_hence</span></span><span> </span><span class="entity"><span>qs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>of_show_have</span></span><span> </span><span class="entity"><span>qs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_term</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span>
            </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Syntax.uncheck_terms</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>annotate_types_in_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.unparse_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span>Pretty.string_of</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>simplify_spaces</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>maybe_quote</span></span><span> </span><span class="entity"><span>keywords</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>using_facts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>using_facts</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"using "</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_label</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="comment1"><span>(* Local facts are always passed via "using", which affects "meson" and "metis". This is
       arguably stylistically superior, because it emphasises the structure of the proof. It is also
       more robust w.r.t. preplay: Preplay is performed before chaining of local facts with "then"
       is introduced. See also "tac_of_method" in "Sledgehammer_Isar_Preplay". *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_method</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>direct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>using_facts</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span class="inner_quoted"><span>"by "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_proof_method</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meth</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_free</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>maybe_quote</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" :: "</span></span><span> </span><span>^</span><span>
      </span><span class="entity"><span>maybe_quote</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_spaces</span></span><span> </span><span class="main"><span>(</span></span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_frees</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" and "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>of_free</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Proof_Context.augment</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Free</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fix</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_fix</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"fix "</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_frees</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_assm</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"assume "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_label</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_subproof</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_proof</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>proof</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"{ "</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>" }"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>replicate_string</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>indent_size</span></span><span> </span><span>-</span><span> </span><span>size</span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span>
        </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>indent_size</span></span><span class="main"><span>,</span></span><span> </span><span>size</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>indent_size</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span class="entity"><span>suffix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>of_subproofs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>of_subproofs</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>Then</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>of_moreover</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span>space_implode</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_moreover</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_subproof</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>add_step_pre</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_subproofs</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qs</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>add_step</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Let</span></span><span> </span><span class="main"><span>{</span></span><span>lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"let "</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_term</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_term</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_step</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> facts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          proof_methods </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_subproofs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>add_step_pre</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span> </span><span class="entity"><span>subproofs</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>obtains</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_have</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span> </span><span class="entity"><span>num_subproofs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_obtain</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span> </span><span class="entity"><span>num_subproofs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span>
              </span><span>#&gt;</span><span> </span><span class="entity"><span>add_frees</span></span><span> </span><span class="entity"><span>obtains</span></span><span>
              </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" where\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>of_label</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="entity"><span>add_term</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_thesis</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>thesis_var</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="entity"><span>add_str</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_method</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span>^</span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>comment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>" (* "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>comment</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" *)"</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>add_steps</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_step</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>of_proof</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_fix</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_assm</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumptions</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_steps</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>steps</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>of_indent</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(* robustness *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"prefer "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
    </span><span class="entity"><span>of_indent</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"proof -\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>of_proof</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span>^</span><span>
    </span><span class="entity"><span>of_indent</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"qed"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"next"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>