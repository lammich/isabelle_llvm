<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/smtlib_proof.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/smtlib_proof.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/smtlib_proof.ML
    Author:     Sascha Boehme, TU Muenchen
    Author:     Mathias Fleury, ENS Rennes
    Author:     Jasmin Blanchette, TU Muenchen

SMT-LIB-2-style proofs: parsing and abstract syntax tree.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SMTLIB_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> 'b </span><span class="entity"><span>shared</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tree</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> SMTLIB.tree </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'b </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>None</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b </span><span class="entity"><span>shared</span></span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span>list</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctxt_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_binding</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b </span><span class="entity"><span>shared</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_binding</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * 'b </span><span class="entity"><span>shared</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_bindings</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * 'b </span><span class="entity"><span>shared</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c * </span><span class="main"><span>(</span></span><span>'d</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'c * </span><span class="main"><span>(</span></span><span>'d</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> next_id</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_fresh_names</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>'a </span><span>list</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(*type and term parsers*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>type_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>term_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_type_parser</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>type_parser</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_term_parser</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>term_parser</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> SMTLIB_PARSE </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>SMTLIB.tree</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declare_fun</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_binding</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * 'a </span><span class="entity"><span>shared</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_of</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> term_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(*name bindings*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name_bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_name_binding</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_name_binding</span><span class="main"><span>:</span></span><span> </span><span>Symtab.key</span><span> * </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_name_bindings</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> * </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> expand_name_bindings</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span class="entity"><span>name_bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_and_update_name_bindings</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span class="entity"><span>name_bindings</span></span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> remove_name_bindings</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>SMTLIB_Proof</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* proof parser context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> 'b </span><span class="entity"><span>shared</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tree</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> SMTLIB.tree </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'b </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>None</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span>
  id</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
  syms</span><span class="main"><span>:</span></span><span> 'b </span><span class="entity"><span>shared</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
  typs</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
  funs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
  extra</span><span class="main"><span>:</span></span><span> 'a</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> id </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> syms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> typs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> funs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> extra </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>empty_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>Symtab.empty</span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the_default</span><span> </span><span class="entity"><span>None</span></span><span> </span><span>o</span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>syms</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_syms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>extra</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_binding</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_syms</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_bindings</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_binding</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>cx</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>update_binding</span></span><span> </span><span class="entity"><span>bs</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
    </span><span>||&gt;</span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_binding</span></span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>bs'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_id</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_fresh_names</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.all_const</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needs_inferT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>equal</span><span> </span><span>Term.dummyT</span><span> </span><span>orf</span><span> </span><span>Term.is_TVar</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>needs_infer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span> </span><span class="entity"><span>needs_inferT</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer_Context.infer_types</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
      </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.standard_term_check_finish</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>needs_infer</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>infer_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> extra </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>infer</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>typs</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>funs</span></span><span>


</span><span class="comment1"><span>(* core type and term parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>core_type_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"Bool"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>HOL.bool</span></a><span>›</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_type_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"Int"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>Int.int</span></a><span>›</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_type_parser</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_unary</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binary'</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binary</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_binary'</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rassoc</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_lassoc</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_lassoc'</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_lassoc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binary</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binary_pred</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>Term.dummyT</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>T1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>Term.dummyT</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>T2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"?a"</span></span><span class="main"><span>,</span></span><span> </span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_binary'</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>HOL.bool</span></a><span>›</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_less</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_binary_pred</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>ord_class.less</span></a><span>›</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.linorder|class"><span>linorder</span></a><span>›</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_less_eq</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_binary_pred</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>ord_class.less_eq</span></a><span>›</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.linorder|class"><span>linorder</span></a><span>›</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"true"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"false"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"not"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"and"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rassoc</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"or"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rassoc</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"=&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_imp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"implies"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_imp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"~"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"ite"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>HOL.If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>HOL.bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t3</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Num</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>Int.int</span></a><span>›</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_unary</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.uminus_class.uminus|const"><span>uminus_class.uminus</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"~"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_unary</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.uminus_class.uminus|const"><span>uminus_class.uminus</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"+"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_lassoc'</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.plus_class.plus|const"><span>plus_class.plus</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_lassoc'</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.minus_class.minus|const"><span>minus_class.minus</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_lassoc'</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.times_class.times|const"><span>times_class.times</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"div"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binary</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.z3div|const"><span>z3div</span></a><span>›</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"mod"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binary</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.z3mod|const"><span>z3mod</span></a><span>›</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"&lt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_less</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_less</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"&lt;="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_less_eq</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"&gt;="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_less_eq</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>


</span><span class="comment1"><span>(* custom type and term parsers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>type_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>term_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Parsers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>type_parser</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>term_parser</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>core_type_parser</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>core_term_parser</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tys1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span>Ord_List.merge</span><span> </span><span class="entity"><span>id_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Ord_List.merge</span><span> </span><span class="entity"><span>id_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type_parser</span></span><span> </span><span class="entity"><span>type_parser</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Parsers.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Ord_List.insert</span><span> </span><span class="entity"><span>id_ord</span></span><span> </span><span class="main"><span>(</span></span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_parser</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_term_parser</span></span><span> </span><span class="entity"><span>term_parser</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Parsers.map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Ord_List.insert</span><span> </span><span class="entity"><span>id_ord</span></span><span> </span><span class="main"><span>(</span></span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term_parser</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_type_parsers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Parsers.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_term_parsers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Parsers.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_parsers</span></span><span> </span><span class="entity"><span>parsers</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parser</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>parsers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parser</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>parsers</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>parsers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* type and term parsing *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>SMTLIB.tree</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>desymbolize</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"?"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_fun</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_fun</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span class="entity"><span>fresh_fun</span></span><span> </span><span>cons</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>desymbolize</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_free</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_fun</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>desymbolize</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>apply_parsers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_type_parsers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_typ</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unknown SMT type"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT type format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>apply_parsers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_term_parsers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_fun</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>declare_free</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>Term.dummyT</span><span> </span><span class="entity"><span>cx</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT term"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT term format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT type"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_var</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>desymbolize</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT quantifier variable format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_body</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>body</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_body</span></span><span> </span><span class="entity"><span>body</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_body</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tree</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_binding</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT let binding format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_choice</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.choice_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>absfree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"forall"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>HOLogic.mk_all</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"exists"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>HOLogic.mk_exists</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"choice"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>mk_choice</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"let"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>with_bindings</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>dest_binding</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>cx</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_binding</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Tree</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>cx</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>u</span></span><span>
          </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="entity"><span>u'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>update_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cx</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad SMT term format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>quant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_var</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>cx</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>with_bindings</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Term</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_body</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Sharing of terms via "! _ :named name"*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span>Symtab.table</span><span> * </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span>Symtab.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_name_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_name_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>body</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>body</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"forall"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"exists"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"choice"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"let"</span></span><span class="main"><span>,</span></span><span>  </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>lets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lets</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bdgs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>bdgs</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>body</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"let"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unsupported let construction in name extraction"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>fold</span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.Dec</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.Str</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exp_tab</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span>Symtab.table</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span>fold_map</span><span> </span><span class="entity"><span>expand_update</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span>
         </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>expand_update</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp_tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_and_update_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>extract_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>tab</span></span><span>
  </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>expand_name_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>