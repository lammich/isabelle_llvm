<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_gfp_rec_sugar.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_gfp_rec_sugar.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_gfp_rec_sugar.ML
    Author:     Lorenz Panny, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2013

Corecursor sugar ("primcorec" and "primcorecursive").
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_GFP_REC_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Proof.context </span><span class="main"><span>-&gt;</span></span><span> Plugin_Name.filter </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Sequential_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Exhaustive_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Transfer_Option</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>corec_call</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Dummy_No_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>No_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Mutual_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * int * int </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Nested_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     disc</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     sels</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     pred</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
     calls</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_call</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     discI</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     sel_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     distinct_discss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     collapse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     corec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     corec_disc</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     corec_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>corec_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     corec</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     exhaust_discs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     sel_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     fp_nesting_maps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     fp_nesting_map_ident0s</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     fp_nesting_map_comps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     ctr_specs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abstract_over_list</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_tuple_balanced</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_conjs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_disjs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_dnf</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conjuncts_s</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_not</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_not_conj</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_conjs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_disjs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_dnf</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> case_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_rev_let_if_case</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> massage_let_if_case</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> massage_nested_corec_call</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> expand_to_ctr_term</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> massage_corec_code_rhs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_rev_corec_code_rhs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> case_thms_of_term</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_thms_of_type</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> corec_specs_of</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>corec_spec</span></span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span> * </span><span>thm</span><span> * </span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>Token.src</span><span> </span><span>list</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    * </span><span>bool</span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gfp_rec_sugar_interpretation</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Rec_Sugar_Util.fp_rec_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primcorec_ursive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.T</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>  </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> * 'a </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primcorec_ursive_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> * 'a </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primcorecursive_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primcorec_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_GFP_Rec_Sugar</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_GFP_REC_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_General_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Def</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Def_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_N2M_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Rec_Sugar_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Rec_Sugar_Transfer</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_GFP_Rec_Sugar_Tactics</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>codeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"code"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ctr"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"disc"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_iffN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"disc_iff"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"exclude"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sel"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>use_primcorecursive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"\"auto\" failed (try "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>primcorecursive</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" instead of "</span></span><span> </span><span>^</span><span>
    </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>primcorec</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>corec_option</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Proof.context </span><span class="main"><span>-&gt;</span></span><span> Plugin_Name.filter </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Sequential_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Exhaustive_Option</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Transfer_Option</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>corec_call</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Dummy_No_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>No_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Mutual_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * int * int </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Nested_Corec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   disc</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   sels</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   disc</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   sels</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   pred</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   calls</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_call</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   discI</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   sel_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   distinct_discss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   collapse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   corec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   corec_disc</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   corec_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>corec_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   corec</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   exhaust_discs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   sel_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   fp_nesting_maps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   fp_nesting_map_ident0s</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   fp_nesting_map_comps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   ctr_specs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NO_MAP</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>rev_vs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>rev_vs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>abs</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_tuple_balanced</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_tuple_balanced</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>curried_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sort_list_duplicates</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_conjs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>the_default</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_disjs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>the_default</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_dnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_disjs</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_conjs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjuncts_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.conjuncts</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_not_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conjuncts_s</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_conjs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate_unit_pos</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate_unit_neg</span></span><span> </span><span class="entity"><span>not_u</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>not_u</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>propagate_units</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>the_single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>css</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>uss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>css'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>propagate_units</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>propagate_unit_neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>propagate_unit_pos</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uss</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>css'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_conjs</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_conjs</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_disjs</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_disjs</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_dnf</span></span><span> </span><span class="entity"><span>css0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>propagate_units</span></span><span> </span><span class="entity"><span>css0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span>null</span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>css</span></span><span>
      </span><span>|&gt;</span><span> </span><span>AList.coalesce</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>css</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>s_dnf</span></span><span> </span><span class="entity"><span>css</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cs</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s_disjs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>s_conjs</span></span><span> </span><span class="entity"><span>css</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_rev_let_if_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fld</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fld</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>then_branch</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>else_branch</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>fld</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>conjuncts_s</span></span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>then_branch</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>fld</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>s_not_conj</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cond</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>else_branch</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>split_sels </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>branches</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>fld</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="entity"><span>conds</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>conjuncts_s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conds'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>branches</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>fld</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>case_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>casex </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_let_if_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>unexpected_call</span></span><span> </span><span class="entity"><span>unsupported_case</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_no_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unexpected_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_abs</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>massage_abs</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>massage_abs</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span>fastype_of1</span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>branches</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>List.partition</span><span> </span><span>Term.is_dummy_pattern</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>branches</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>dummy_branch'</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dummy_branch'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>branch'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>branch'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>branches'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>If_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typof</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>branches'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_no_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>branches'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span>Envir.eta_long</span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>strip_fun_type</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_branch_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_body_fun_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_branch_ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>gen_branch_Ts</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>gen_branch_ms</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen_body_fun_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>case_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>has_split_sels</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_split_sels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>branches</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj_leftovers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>branches'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_abs</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_branch_ms</span></span><span> </span><span class="entity"><span>branches</span></span><span class="main"><span>;</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>branch_Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="entity"><span>branches'</span></span><span class="main"><span>;</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_typeN</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>gen_branch_ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>branch_Ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>casex'</span></span><span> </span><span class="main"><span>=</span></span><span>
                            </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>branch_Ts'</span></span><span> </span><span>---&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="entity"><span>obj_leftovers</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>body_T'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                          </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casex'</span></span><span class="main"><span>,</span></span><span>
                            </span><span class="entity"><span>branches'</span></span><span> </span><span>@</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_no_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>obj_leftovers</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                        </span><span class="entity"><span>unsupported_case</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>massage_rec</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t0</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Term.map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_dummy_pattern</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_let_if_case_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>massage_let_if_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>massage_leaf</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unexpected_corec_call_in</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsupported_case_around_corec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t0</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_nested_corec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>massage_call</span></span><span> </span><span class="entity"><span>massage_noncall</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_no_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unexpected_corec_call_in</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t0</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>U2</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>massage_call</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>massage_noncall</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_map</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_map</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_map</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dom_Ts</span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="entity"><span>map0</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>map_flattened_map_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_map_or_map_arg</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NO_MAP</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>massage_map</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NO_MAP</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>massage_map_or_map_arg</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>tap</span><span> </span><span class="entity"><span>check_no_call</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>massage_map</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NO_MAP</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_mutual_fun</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>massage_mutual_fun</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_body</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Term.lambda</span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>(</span></span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp|const"><span>comp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>massage_body</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_comp</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_mutual_fun</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_body</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>massage_let_if_case_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span>fastype_of1</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="entity"><span>f</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f'_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>typof</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>f'_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curried_type</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curried_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U'</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>t'</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span class="entity"><span>massage_map</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>
                   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>NO_MAP</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_mutual_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_corec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>massage_noncall</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>massage_any_call</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>massage_noncall</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_to_ctr_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"expand_to_ctr_term"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>massage_let_if_case_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>expand_to_ctr_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"expand_corec_code_rhs"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>massage_ctr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>massage_let_if_case_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>massage_ctr</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Term.strip_comb</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_rev_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>fold_rev_let_if_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>conds</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Term.strip_comb</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>case_thms_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ctr_Sugar.ctr_sugar_of_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_consts</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>distincts </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>discIs </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>exhaust_discs </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>,</span></span><span>
     </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>split_sels </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>split_sel_asms </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>basic_corec_specs_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>res_T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>res_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Ctr_Sugar.ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_codatatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>res_T</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fpT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_subst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fpT</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>res_T</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.subst_TVars</span><span> </span><span class="entity"><span>As_rho</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="entity"><span>disc</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> disc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> sels </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="entity"><span>selss</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ListPair.UnequalLengths</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_codatatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>res_T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_codatatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_thms_of_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fp_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>fp_bnf_sugar </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>map_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_thms_of_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>GFP_Rec_Sugar_Plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gfp_rec_sugar_interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>GFP_Rec_Sugar_Plugin.interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_fp_rec_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>interpret_gfp_rec_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>GFP_Rec_Sugar_Plugin.data</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>corec_specs_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss0</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>missing_res_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm0_kks</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
          fp_co_induct_sugar </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>common_co_inducts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>common_coinduct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfp_sugar_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>nested_to_mutual_fps</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Greatest_FP</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss0</span></span><span> </span><span class="entity"><span>lthy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>coinduct_attrs_pair</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gfp_sugar_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs_pair</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>attrs_pair</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_fp_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_indices</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>fp_res_index </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_fpTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_ctrXs_Tsss'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repair_nullary_single_ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctrXs_Tss </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>perm_fpTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_ns'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>length</span><span> </span><span class="entity"><span>perm_ctrXs_Tsss'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>X </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span>o</span><span> </span><span class="entity"><span>body_fun_type</span></span><span> </span><span>o</span><span> </span><span>fastype_of</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>co_rec </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Xs_TCs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>perm_Xs</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>perm_Cs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip_corecT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sumTN</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>zip_corecT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip_corecT</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Xs_TCs</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_p_Tss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_corec_p_pred_types</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span> </span><span class="entity"><span>perm_ns'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_f_Tssss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>zip_corecT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span> </span><span class="entity"><span>perm_ctrXs_Tsss'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_q_Tssss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_f_Tssss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_p_hss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>indexedd</span></span><span> </span><span class="entity"><span>perm_p_Tss</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_q_hssss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>indexedddd</span></span><span> </span><span class="entity"><span>perm_q_Tssss</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_f_hssss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>indexedddd</span></span><span> </span><span class="entity"><span>perm_f_Tssss</span></span><span> </span><span class="entity"><span>h'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>flat_corec_preds_predsss_gettersss</span></span><span> </span><span class="entity"><span>perm_p_hss</span></span><span> </span><span class="entity"><span>perm_q_hssss</span></span><span> </span><span class="entity"><span>perm_f_hssss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute0</span></span><span> </span><span class="entity"><span>perm0_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm0_kks</span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="entity"><span>perm0_xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_indices</span></span><span> </span><span class="entity"><span>indices</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>coinduct_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute0</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>conj_dests</span></span><span> </span><span class="entity"><span>nn</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>common_coinduct_thms</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_iss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_index_eq</span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_p_hss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>q_issss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_index_eq</span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_q_hssss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_issss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_index_eq</span></span><span> </span><span class="entity"><span>fun_arg_hs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_f_hssss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_Tssss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_f_Tssss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_fpTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_subst</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>nn0</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs_rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.subst_TVars</span><span> </span><span class="entity"><span>As_rho</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substAT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>As_rho</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substCT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>Cs_rho</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_Cs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>substCT</span></span><span> </span><span class="entity"><span>perm_Cs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>call_of</span></span><span> </span><span class="entity"><span>nullary</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>g_i</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Nested_Corec</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nullary</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Dummy_No_Corec</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>No_Corec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_i</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>call_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>q_i</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>g_i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g_i'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mutual_Corec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q_i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g_i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g_i'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_spec</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="entity"><span>disc</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="entity"><span>p_io</span></span><span> </span><span class="entity"><span>q_iss</span></span><span> </span><span class="entity"><span>f_iss</span></span><span> </span><span class="entity"><span>f_Tss</span></span><span> </span><span class="entity"><span>discI</span></span><span> </span><span class="entity"><span>sel_thms</span></span><span> </span><span class="entity"><span>distinct_discss</span></span><span> </span><span class="entity"><span>collapse</span></span><span>
        </span><span class="entity"><span>corec_thm</span></span><span> </span><span class="entity"><span>corec_disc</span></span><span> </span><span class="entity"><span>corec_sels</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nullary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>{</span></span><span>ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> disc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> sels </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>substA</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>,</span></span><span> pred </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p_io</span></span><span class="main"><span>,</span></span><span>
         calls </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>call_of</span></span><span> </span><span class="entity"><span>nullary</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>q_iss</span></span><span> </span><span class="entity"><span>f_iss</span></span><span> </span><span class="entity"><span>f_Tss</span></span><span class="main"><span>,</span></span><span> discI </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discI</span></span><span class="main"><span>,</span></span><span> sel_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_thms</span></span><span class="main"><span>,</span></span><span>
         distinct_discss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct_discss</span></span><span class="main"><span>,</span></span><span> collapse </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collapse</span></span><span class="main"><span>,</span></span><span> corec_thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_thm</span></span><span class="main"><span>,</span></span><span>
         corec_disc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_disc</span></span><span class="main"><span>,</span></span><span> corec_sels </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_sels</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_specs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_discsss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>collapses</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span>
        </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p_is</span></span><span> </span><span class="entity"><span>q_isss</span></span><span> </span><span class="entity"><span>f_isss</span></span><span> </span><span class="entity"><span>f_Tsss</span></span><span> </span><span class="entity"><span>corec_thms</span></span><span> </span><span class="entity"><span>corec_discs</span></span><span> </span><span class="entity"><span>corec_selss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_ios</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p_is</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 14</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_ctr_spec</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="entity"><span>p_ios</span></span><span> </span><span class="entity"><span>q_isss</span></span><span> </span><span class="entity"><span>f_isss</span></span><span> </span><span class="entity"><span>f_Tsss</span></span><span> </span><span class="entity"><span>discIs</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span>
          </span><span class="entity"><span>distinct_discsss</span></span><span> </span><span class="entity"><span>collapses</span></span><span> </span><span class="entity"><span>corec_thms</span></span><span> </span><span class="entity"><span>corec_discs</span></span><span> </span><span class="entity"><span>corec_selss</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> fp_ctr_sugar </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>exhaust_discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
        fp_co_induct_sugar </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>co_rec </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec</span></span><span class="main"><span>,</span></span><span> co_rec_thms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_thms</span></span><span class="main"><span>,</span></span><span>
        co_rec_discs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_discs</span></span><span class="main"><span>,</span></span><span> co_rec_selss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>corec_selss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p_is</span></span><span> </span><span class="entity"><span>q_isss</span></span><span>
        </span><span class="entity"><span>f_isss</span></span><span> </span><span class="entity"><span>f_Tsss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> corec </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_co_rec</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Greatest_FP</span></span><span> </span><span class="entity"><span>perm_Cs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substAT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec</span></span><span class="main"><span>,</span></span><span>
       exhaust_discs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust_discs</span></span><span class="main"><span>,</span></span><span> sel_defs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span>
       fp_nesting_maps </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_thms_of_type</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>T_of_bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
       fp_nesting_map_ident0s </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>map_ident0_of_bnf</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
       fp_nesting_map_comps </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>map_comp_of_bnf</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
       ctr_specs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ctr_specs</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="entity"><span>p_is</span></span><span> </span><span class="entity"><span>q_isss</span></span><span> </span><span class="entity"><span>f_isss</span></span><span> </span><span class="entity"><span>f_Tsss</span></span><span> </span><span class="entity"><span>corec_thms</span></span><span> </span><span class="entity"><span>corec_discs</span></span><span>
         </span><span class="entity"><span>corec_selss</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_spec</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="entity"><span>p_iss</span></span><span> </span><span class="entity"><span>q_issss</span></span><span> </span><span class="entity"><span>f_issss</span></span><span> </span><span class="entity"><span>f_Tssss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>missing_res_Ts</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>co_induct_of</span></span><span> </span><span class="entity"><span>common_coinduct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>strong_co_induct_of</span></span><span> </span><span class="entity"><span>common_coinduct_thms</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>co_induct_of</span></span><span> </span><span class="entity"><span>coinduct_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>strong_co_induct_of</span></span><span> </span><span class="entity"><span>coinduct_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_attrs_pair</span></span><span class="main"><span>,</span></span><span>
     </span><span>is_some</span><span> </span><span class="entity"><span>gfp_sugar_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>undef_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>fun_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
   fun_T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   fun_args</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   ctr_no</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   disc</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   prems</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   auto_gen</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   ctr_rhs_opt</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   code_rhs_opt</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   eqn_pos</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   user_eqn</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>fun_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
   fun_T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   fun_args</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   sel</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   rhs_term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   ctr_rhs_opt</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   code_rhs_opt</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
   eqn_pos</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   user_eqn</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_sel_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>coeqn_data</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Disc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> coeqn_data_disc </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Sel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> coeqn_data_sel</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_free_in</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_free_in</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_catch_all_prem</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.uu_</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_catch_all_prem</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
     </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Variable.is_fixed</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_catch_all_prem</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>?</span><span> </span><span>cons</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>extra_variable_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>bads</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_fun_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_duplicate_variables_in_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>
   </span><span class="entity"><span>check_all_fun_arg_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_coeqn_disc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="entity"><span>prems0</span></span><span>
    </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_subterm</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(* FIXME ∃? *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>merge_options</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>applied_fun</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>find_subterm</span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span> </span><span>o</span><span> </span><span>head_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>the</span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed discriminator formula"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>applied_fun</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>dest_Free</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_fun_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_free_in</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>unexpected_rec_call_in</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>bads</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sequential</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_names</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sequentials</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>disc </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_disc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>head_of</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>not_disc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Negated discriminator for a type with ≠ 2 constructors"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_subterm</span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span>o</span><span> </span><span>head_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_ctr0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>|&gt;</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_not</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>disc'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_not</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="entity"><span>disc'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed discriminator formula"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>disc'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>eq_ctr0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"No discriminator in equation"</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_no'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>disc'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>the</span><span> </span><span class="entity"><span>eq_ctr0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>disc'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_no</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>not_disc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>ctr_no'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ctr_no'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>catch_all</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prems0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>prem</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_catch_all_prem</span></span><span> </span><span class="entity"><span>prem</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_catch_all_prem</span></span><span> </span><span class="entity"><span>prems0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Superfluous premises"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>matchedss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>actual_prems</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>catch_all</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>s_not_conj</span></span><span> </span><span class="entity"><span>matchedss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>catch_all</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>matchedsss'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.delete</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span>
      </span><span>|&gt;</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>matchedss</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prems</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>matchedss</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>actual_prems</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>user_eqn</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>actual_prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Logic.list_implies</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Disc</span></span><span> </span><span class="main"><span>{</span></span><span>fun_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> fun_T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> fun_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> ctr_no </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>,</span></span><span>
       disc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>actual_prems</span></span><span class="main"><span>,</span></span><span> auto_gen </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>catch_all</span></span><span class="main"><span>,</span></span><span> ctr_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span class="main"><span>,</span></span><span>
       code_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> eqn_pos </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> user_eqn </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>matchedsss'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_coeqn_sel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
    </span><span class="entity"><span>ctr_rhs_opt</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="entity"><span>of_spec_opt</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="entity"><span>eqn</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_equation_lhs_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>head_of</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_comb</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span>strip_comb</span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>dest_Free</span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed selector argument in left-hand side"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_fun_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed selector argument in left-hand side"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>of_spec_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>of_spec</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>of_spec</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>sels</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span>|&gt;</span><span> </span><span>the_single</span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>List.Empty</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Ambiguous selector (without \"of\")"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>user_eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_all</span></span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Sel</span></span><span> </span><span class="main"><span>{</span></span><span>fun_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> fun_T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> fun_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> sel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span>
      rhs_term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> ctr_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span class="main"><span>,</span></span><span> code_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> eqn_pos </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span>
      user_eqn </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_coeqn_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_fun_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>drop_all</span></span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_constructor_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqn_data_disc_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>matchedsss'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>apfst</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_coeqn_disc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
          </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>disc_concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_concls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ctr_args</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ListPair.UnequalLengths</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>partially_applied_ctr_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqns_data_sel</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_coeqn_sel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
          </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>sel_concls</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span class="entity"><span>eqn_data_disc_opt</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>eqns_data_sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>matchedsss'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_coeqn_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>||&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>expand_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_fun_args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_rev_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>not_constructor_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_premss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_dnf</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_concls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>massage_corec_code_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ctr'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Term.dummy_pattern</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Term.list_comb</span><span> </span><span class="entity"><span>ctr</span></span><span>
      </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_free_in</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_premss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>unexpected_corec_call_in</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn0</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_coeqn_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>eqn0</span></span><span>
        </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>ctr_premss</span></span><span> </span><span class="entity"><span>ctr_concls</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dissect_coeqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>of_spec_opt</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>drop_all</span></span><span> </span><span class="entity"><span>eqn0</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_formula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_horn</span><span> </span><span class="entity"><span>eqn</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ill_formed_equation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span>
      </span><span>|&gt;</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_not</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>head_of</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>|&gt;</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_not</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_num_args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>is_none</span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>rhs_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>missing_args_to_fun_on_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>disc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>sels</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
       </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>rhs_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_coeqn_disc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span>
         </span><span class="entity"><span>matchedsss</span></span><span>
       </span><span>|&gt;&gt;</span><span> </span><span>single</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Unexpected condition in selector formula"</span></span><span class="main"><span>;</span></span><span>
       </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>dissect_coeqn_sel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="entity"><span>of_spec_opt</span></span><span>
           </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_free_in</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>rhs_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>check_num_args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span class="entity"><span>dissect_coeqn_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>eqn0</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>eqn0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>NONE</span><span class="main"><span>)</span></span><span>
           </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>check_num_args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span class="entity"><span>dissect_coeqn_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="entity"><span>eqn0</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>matchedsss</span></span><span>
         </span><span>|&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Cannot mix constructor and code views"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Ill-formed equation head: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eqn</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"Expected equation or discriminator formula"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_corec_arg_disc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_none</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pred </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>s_conjs</span></span><span> </span><span class="entity"><span>prems</span></span><span>
    </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>List.rev</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>abs_tuple_balanced</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
    </span><span>|&gt;</span><span> </span><span>K</span><span> </span><span>|&gt;</span><span> </span><span>nth_map</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pred </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_corec_arg_no_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span>
  </span><span>|&gt;</span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>abs_tuple_balanced</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>undef_const</span></span><span>
  </span><span>|&gt;</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_corec_args_mutual_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>I</span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_stop</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_end</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>undef_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_cont</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_tuple1_balanced</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>undef_const</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>massage_let_if_case_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>abs_tuple_balanced</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>massage</span></span><span> </span><span class="entity"><span>rewrite_stop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage</span></span><span> </span><span class="entity"><span>rewrite_end</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>massage</span></span><span> </span><span class="entity"><span>rewrite_cont</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_corec_arg_nested_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U2</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_sumT</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>U1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>U2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>invalid_map</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t0</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>invalid_map</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="entity"><span>Inr_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>mk_tuple1_balanced</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>vs</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                  </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_case_prod</span></span><span> </span><span>o</span><span> </span><span>the_single</span><span>
                  </span><span>|&gt;</span><span> </span><span>Term.list_comb</span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Inr_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>U2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.unit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>t0</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>massage_noncall</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>build_map</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>Inl_const</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_sumT</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>rhs_term</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>massage_nested_corec_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>massage_call</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>massage_noncall</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span>
        </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>abs_tuple_balanced</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_corec_args_sel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>ctr_spec</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_sel_eqns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_call_list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>sels </span><span class="entity"><span>ctr_spec</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>#</span></span><span>calls </span><span class="entity"><span>ctr_spec</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>No_Corec</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_call_list</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutual_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Mutual_Corec</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_call_list</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_calls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Nested_Corec</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_call_list</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>I</span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_corec_arg_no_call</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>no_calls'</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fh</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_corec_args_mutual_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>nth_map</span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>fq</span></span><span> </span><span>o</span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>fg</span></span><span> </span><span>o</span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>fh</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_calls'</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>build_corec_arg_nested_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nested_calls'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_defs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>arg_Tss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>corec_specs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqnss</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>corecs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>corec </span><span class="entity"><span>corec_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs </span><span class="entity"><span>corec_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>corec_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>corecs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>split_last</span><span> </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu_</span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>o</span><span> </span><span class="entity"><span>build_corec_arg_disc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>o</span><span> </span><span class="entity"><span>build_corec_args_sel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_extra_frees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_args</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>bad</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>corec_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nonprimitive_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>extra_variable_in_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>bad</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludess'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>disc_eqnss</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>ctr_no </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>prems </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>auto_gen </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>pair</span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_conjs</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>||&gt;</span><span> </span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
            </span><span>||&gt;</span><span> </span><span>Logic.list_implies</span><span>
            </span><span>||&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span>o</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>corec_args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corecs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map2</span><span> </span><span class="entity"><span>abs_curried_balanced</span></span><span> </span><span class="entity"><span>arg_Tss</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>nonprimitive_corec</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>excludess'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_actual_disc_eqns</span></span><span> </span><span class="entity"><span>fun_binding</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>exhaustive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_binding</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_disc_eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exhaustive</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>num_disc_eqns</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>num_disc_eqns</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>num_ctrs</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>num_disc_eqns</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Missing discriminator formula for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_no</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>ctr_specs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_no</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_eqn_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span>---&gt;</span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_args </span><span>o</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>,</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_args </span><span>o</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span> </span><span>Name.uu</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>merge_options</span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not_conj</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>ctr_rhs_opt </span><span class="entity"><span>sel_eqn_opt</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt </span><span class="entity"><span>sel_eqn_opt</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>eqn_pos</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqn_opt</span></span><span>
          </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>100000</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(* FIXME *)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_disc_eqn</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>{</span></span><span>fun_name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> fun_T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> fun_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> ctr </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> ctr_no </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>,</span></span><span>
           disc </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> auto_gen </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> ctr_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span class="main"><span>,</span></span><span>
           code_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> eqn_pos </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> user_eqn </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>undef_const</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>chop</span><span> </span><span class="entity"><span>ctr_no</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span>||&gt;</span><span> </span><span>cons</span><span> </span><span class="entity"><span>extra_disc_eqn</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_corec_calls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basic_ctr_specs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>basic_corec_ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_no</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>sels </span><span>o</span><span> </span><span>the</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>fold_rev_let_if_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>cons</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>sel_no</span></span><span> </span><span>|&gt;</span><span> </span><span>AList.map_entry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_trivial_implies</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_horn</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primcorec_ursive</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>of_specs_opt</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mxs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_split</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>strip_type</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>mk_tupleT_balanced</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span>|&gt;</span><span> </span><span>split_list</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primcorec_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_duplicate_const_names</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_top_sort</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Plugins_Option</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>Plugin_Name.default_filter</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Sequential_Option</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaustives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Exhaustive_Option</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Transfer_Option</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualifys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span>Binding.qualify</span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Binding.path_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basic_corec_specs_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;&gt;</span><span> </span><span>Binding.name_of</span><span> </span><span>#&gt;</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqns_data</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dissect_coeqn</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>of_specs_opt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_names</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Disc</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span>
        </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span>oo</span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>missing</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>missing_equations_for_const</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>missing</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Sel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span>
      </span><span>|&gt;</span><span> </span><span>partition_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fun_name</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>o</span><span> </span><span class="entity"><span>find_corec_calls</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>has_call</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>|&gt;</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basic_ctr_specss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>corec_specs0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_strong_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_strong_thms</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>coinduct_attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_coinduct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>corec_specs_of</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>res_Ts</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>corec_specs0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs </span><span class="entity"><span>corec_specs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_eqnss0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Disc</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span>
      </span><span>|&gt;</span><span> </span><span>partition_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fun_name</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>ctr_no </span><span>|&gt;</span><span> </span><span>make_ord</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc_eqnss0</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>ctr_no</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>null</span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr_no </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_no</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span>
           </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>ctr_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>user_eqn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="inner_quoted"><span>"Overspecified case(s)"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Sel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns_data</span></span><span>
      </span><span>|&gt;</span><span> </span><span>partition_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>fun_name</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_names</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>ctr_sel_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>null</span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="entity"><span>error_at</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sel_of</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>ctr_sel_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span>
           </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>ctr_rhs_opt </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>user_eqn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>user_eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="inner_quoted"><span>"Overspecified case(s)"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Tss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 6</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_actual_disc_eqns</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>arg_Tss</span></span><span> </span><span class="entity"><span>exhaustives</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span>
      </span><span class="entity"><span>disc_eqnss0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>excludess'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>build_defs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>mxs</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>arg_Tss</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac_opts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exclude_tac</span></span><span> </span><span class="entity"><span>tac_opt</span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_primcorec_assumption_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>tac_opt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludess''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac_opt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove</span><span> </span><span class="comment1"><span>(*no sorry*)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>exclude_tac</span></span><span> </span><span class="entity"><span>tac_opt</span></span><span> </span><span class="entity"><span>sequential</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>tac_opts</span></span><span> </span><span class="entity"><span>sequentials</span></span><span> </span><span class="entity"><span>excludess'</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>use_primcorecursive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>taut_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>excludess''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_idxss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclude_goalss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>excludess''</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>split_list</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_all_fun_args</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extras</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syntactic_exhaustives</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems </span><span>orf</span><span> </span><span>is_some</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>#</span></span><span>auto_gen </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>de_facto_exhaustives</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaustives</span></span><span> </span><span class="entity"><span>syntactic_exhaustives</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nchotomy_goalss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_dnf</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>de_facto_exhaustives</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>list_all_fun_args</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nchotomy_taut_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac_opt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>exhaust_discs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>res_exhaust_discs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_exhaust_discs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>case_thms_of_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>Term.dummy</span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>[</span></span><span>Goal.prove</span><span> </span><span class="comment1"><span>(*no sorry*)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="entity"><span>mk_primcorec_nchotomy_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_exhaust_discs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>arg_exhaust_discs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>use_primcorecursive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tac_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>tac_opts</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>nchotomy_goalss</span></span><span> </span><span class="entity"><span>syntactic_exhaustives</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syntactic_exhaustives</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems </span><span>orf</span><span> </span><span>is_some</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>#</span></span><span>auto_gen </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nchotomy_goalss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac_opts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>syntactic_exhaustives</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>nchotomy_goalss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goalss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nchotomy_goalss</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>exclude_goalss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>thmss''</span></span><span> </span><span class="entity"><span>def_infos</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>def_infos</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nchotomy_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclude_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>thmss''</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nchotomy_taut_thmss</span></span><span class="main"><span>,</span></span><span> </span><span>drop</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>thmss''</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Variable.variant_frees</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>fun_args</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="entity"><span>Qs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>de_facto_exhaustives</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>list_all_fun_args</span></span><span> </span><span class="entity"><span>ps</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nchotomy_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>[</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_primcorec_exhaust_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span> </span><span class="comment1"><span>(* for "P" *)</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nchotomy_thm</span></span><span class="main"><span>)</span></span><span>
                 </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>nchotomy_thmss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nontriv_exhaust_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="entity"><span>is_trivial_implies</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_thmss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludess'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_idxss</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>exclude_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_excludesss</span></span><span> </span><span class="entity"><span>excludes</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span>nth_map</span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>excludes</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>[</span></span><span>asm_rl</span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>excludessss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>excludes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_excludesss</span></span><span> </span><span class="entity"><span>excludes</span></span><span> </span><span>o</span><span> </span><span>length</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_specs</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span>append</span><span> </span><span class="entity"><span>excludess'</span></span><span> </span><span class="entity"><span>taut_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_disc</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>excludesss</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>disc </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="bound"><span>x</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corec_disc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>betapply</span><span> </span><span class="entity"><span>disc</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_primcorec_disc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="entity"><span>corec_disc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>excludesss</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>disc </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
                </span><span>|&gt;</span><span> </span><span>single</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_sel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_maps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>excludesss</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span>
             </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_no</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not_conj</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_no</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>prems</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>corec_sel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>sels </span><span class="entity"><span>ctr_spec</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>corec_sels </span><span class="entity"><span>ctr_spec</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
              </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>betapply</span><span> </span><span class="entity"><span>sel</span></span><span>
              </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span>
              </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_thms_of_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>rhs_term</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>mk_primcorec_sel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="entity"><span>distincts</span></span><span> </span><span class="entity"><span>split_sels</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span>
                  </span><span class="entity"><span>fp_nesting_maps</span></span><span> </span><span class="entity"><span>fp_nesting_map_ident0s</span></span><span> </span><span class="entity"><span>fp_nesting_map_comps</span></span><span> </span><span class="entity"><span>corec_sel</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>m</span></span><span>
                  </span><span class="entity"><span>excludesss</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
            </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span>?</span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*mildly too aggressive*)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>sel</span></span><span>
            </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_ctr</span></span><span> </span><span class="entity"><span>disc_alist</span></span><span> </span><span class="entity"><span>sel_alist</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>collapse</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="comment1"><span>(* don't try to prove theorems when some sel_eqns are missing *)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
              </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span>
              </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>,</span></span><span>
                 </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_T </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>prems </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="main"><span>#</span></span><span>ctr_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>eqn_pos </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>||&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_T </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="main"><span>#</span></span><span>ctr_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>eqn_pos </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>merge_options</span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_rhs_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>rhs_term </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span>#-&gt;</span><span> </span><span class="entity"><span>abstract_over_list</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Term.list_comb</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_thm_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_alist</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_alist</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_primcorec_ctr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>collapse</span></span><span> </span><span class="entity"><span>disc_thm_opt</span></span><span> </span><span class="entity"><span>sel_thms</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>is_some</span><span> </span><span class="entity"><span>code_rhs_opt</span></span><span> </span><span>?</span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span> </span><span class="comment1"><span>(*mildly too aggressive*)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>ctr</span></span><span>
                </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
                </span><span>|&gt;</span><span> </span><span>single</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_code</span></span><span> </span><span class="entity"><span>exhaustive</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>sel_eqns</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_sel</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nchotomys</span></span><span> </span><span class="entity"><span>ctr_alist</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_data_opt</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>,</span></span><span>
               </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctr </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_T </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>||&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_name </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_T </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>code_rhs_opt </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>merge_options</span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fun_data_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_info_opt</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rhs_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_corec_code_rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>has_call</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>fold_rev_corec_code_rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>oo</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>oo</span><span> </span><span>pair</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>FalseE</span></span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_alist</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cond_ctrs</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_code_ctr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sels</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_ctr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_alist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                          </span><span>NONE</span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eqns</span></span><span>
                              </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>prems </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
                              </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_eqns</span></span><span>
                              </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>finds</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>sel</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span>
                              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fun_args </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>rhs_term </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span>#-&gt;</span><span> </span><span class="entity"><span>abstract_over_list</span></span><span class="main"><span>)</span></span><span>
                              </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Term.list_comb</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>;</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_conds_argss_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>prove_code_ctr</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaustive_code</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>exhaustive</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>andf</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>the</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_conds_argss_opt</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>forall</span><span> </span><span>is_some</span><span> </span><span class="entity"><span>ctr_conds_argss_opt</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>#</span></span><span>auto_gen </span><span class="entity"><span>disc_eqns</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exhaustive_code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                           </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>ctr_conds_argss_opt</span></span><span class="main"><span>)</span></span><span> </span><span>||&gt;</span><span> </span><span>snd</span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                           </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../String.html#String.Code.abort|const"><span>Code.abort</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../String.html#String.literal|type"><span>String.literal</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span>--&gt;</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
                             </span><span class="entity"><span>HOLogic.mk_literal</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span>$</span><span>
                             </span><span>absdummy</span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
                           </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>ctr_conds_argss_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span>|-&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_If</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_conjs</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exhaustive_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>ctr_alist</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rhs_info_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exhaustive_code</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Logic.count_prems</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_thms</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span>
                        </span><span>#&gt;</span><span> </span><span class="entity"><span>abstract_over_list</span></span><span> </span><span class="entity"><span>fun_args</span></span><span>
                        </span><span>#&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discIs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="entity"><span>case_thms_of_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span class="main"><span>;</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_code_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>raw_goal</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>mk_primcorec_raw_code_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>distincts</span></span><span> </span><span class="entity"><span>discIs</span></span><span> </span><span class="entity"><span>split_sels</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span>
                            </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>ctr_thms</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exhaustive_code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>try</span><span> </span><span>the_single</span><span> </span><span class="entity"><span>nchotomys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="entity"><span>mk_primcorec_code_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>distincts</span></span><span> </span><span class="entity"><span>split_sels</span></span><span> </span><span class="entity"><span>raw_code_thm</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                    </span><span>|&gt;</span><span> </span><span>single</span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_alistss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>oo</span><span> </span><span class="entity"><span>prove_disc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>excludessss</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_alists</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_alistss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_alists</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>ooo</span><span> </span><span class="entity"><span>prove_sel</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>excludessss</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>sort_list_duplicates</span></span><span> </span><span>o</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_alistss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_thmsss'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_alistss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>sort_list_duplicates</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_alists</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_disc_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>corec_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_thms</span></span><span> </span><span class="entity"><span>disc_thmss'</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>fun_args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust_fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_thms</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>coeqn_data_disc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>exhaust_thms</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>disc_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_discss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ctr_specs</span></span><span> </span><span class="entity"><span>ctr_no</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>applied_fun_of</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>fun_T</span></span><span> </span><span class="entity"><span>fun_args</span></span><span> </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>betapply</span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>mk_conjs</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>fun_args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>mk_primcorec_disc_iff_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_fun_args</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>exhaust_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_thms</span></span><span> </span><span class="entity"><span>disc_thmss'</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>distinct_discss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Meson.first_order_resolve</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eqTrueE|fact"><span>eqTrueE</span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_False|fact"><span>eq_False</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.iffD1|fact"><span>iffD1</span></a><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.notnotD|fact"><span>notnotD</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>eqn_pos</span></span><span>
              </span><span>|&gt;</span><span> </span><span>single</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_iff_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 6</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span>ooo</span><span> </span><span>map2</span><span> </span><span>oooo</span><span> </span><span class="entity"><span>prove_disc_iff</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>exhaust_thmss</span></span><span>
          </span><span class="entity"><span>disc_thmsss'</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>disc_thmsss'</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>sort_list_duplicates</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_alists</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 6</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_alist</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>maps</span><span> </span><span>oooo</span><span> </span><span class="entity"><span>prove_ctr</span></span><span> </span><span class="entity"><span>disc_alist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_alists</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_alists</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>corec_specs</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_thmss0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_alists</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_alists</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 6</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>prove_code</span></span><span> </span><span class="entity"><span>exhaustives</span></span><span> </span><span class="entity"><span>disc_eqnss</span></span><span> </span><span class="entity"><span>sel_eqnss</span></span><span> </span><span class="entity"><span>nchotomy_thmss</span></span><span> </span><span class="entity"><span>ctr_thmss0</span></span><span> </span><span class="entity"><span>ctr_specss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_iff_or_disc_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disc_iffs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>disc_iffs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_iff_thmss</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span>append</span><span> </span><span class="entity"><span>disc_iff_or_disc_thmss</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_common_name</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>I</span><span> </span><span class="entity"><span>qualifys</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>anonymous_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>disc_iff_or_disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>coinductN</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>coinduct_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_coinduct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>coinduct_strongN</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>coinduct_strong_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_coinduct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>common_qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>coinductN</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>single</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>coinduct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coinduct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>coinduct_strongN</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>single</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>coinduct_strong_thms</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>coinduct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>codeN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>ctrN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>discN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>disc_iffN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_iff_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>excludeN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclude_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>exhaustN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_exhaust_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>selN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>simpsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>fun_names</span></span><span> </span><span class="entity"><span>qualifys</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_ts0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>def_infos</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>lthy</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.equational_primcorec</span></span><span> </span><span class="entity"><span>primcorec_types</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>fun_ts0</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span> </span><span class="entity"><span>fun_ts0</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>ctr_thmss</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span> </span><span class="entity"><span>fun_ts0</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>code_thmss</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>code_plugin</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>code_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>anonymous_notes</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>common_notes</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>snd</span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>actual_nn</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>T </span><span class="entity"><span>corec_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>{</span></span><span>transfers </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfers</span></span><span class="main"><span>,</span></span><span> fun_names </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_names</span></span><span class="main"><span>,</span></span><span> funs </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span>
               fun_defs </span><span class="main"><span>=</span></span><span> </span><span>Morphism.fact</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>def_thms</span></span><span class="main"><span>,</span></span><span> fpTs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>interpret_gfp_rec_sugar</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>fp_rec_sugar</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thmss'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span>Local_Theory.define</span><span> </span><span class="entity"><span>defs</span></span><span>
      </span><span>#&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_def_consts</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>#-&gt;</span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>thmss'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primcorec_ursive_cmd</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_specs_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>of_specs_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>split_list</span><span> </span><span class="entity"><span>raw_specs_of</span></span><span> </span><span>||&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.read_term</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Specification.read_multi_specs</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spec</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_specs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>primcorec_ursive</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="entity"><span>opts</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>of_specs_opt</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primcorecursive_cmd</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>goalss</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.refine_singleton</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.primitive_text</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ooo</span><span>
  </span><span class="entity"><span>primcorec_ursive_cmd</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primcorec_cmd</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>use_primcorecursive</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goalss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ooo</span><span>
  </span><span class="entity"><span>primcorec_ursive_cmd</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>corec_option_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.group</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"option"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Plugin_Name.parse_filter</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Plugins_Option</span></span><span>
   </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"sequential"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Sequential_Option</span></span><span>
   </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"exhaustive"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Exhaustive_Option</span></span><span>
   </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"transfer"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Transfer_Option</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>where_alt_props_of_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.where_</span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.prop</span><span> </span><span>&gt;&gt;</span><span> </span><span>pair</span><span> </span><span>Binding.empty_atts</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"of"</span></span><span> </span><span>|--</span><span> </span><span>Parse.const</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>primcorecursive</span></span><span>›</span></span></span><span>
  </span><span class="inner_quoted"><span>"define primitive corecursive functions"</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
      </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.list1</span><span> </span><span class="entity"><span>corec_option_parser</span></span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
    </span><span class="main"><span>(</span></span><span>Parse.vars</span><span> </span><span>--</span><span> </span><span class="entity"><span>where_alt_props_of_parser</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>primcorecursive_cmd</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>primcorec</span></span><span>›</span></span></span><span>
  </span><span class="inner_quoted"><span>"define primitive corecursive functions"</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.list1</span><span> </span><span class="entity"><span>corec_option_parser</span></span><span class="main"><span>)</span></span><span>
      </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
    </span><span class="main"><span>(</span></span><span>Parse.vars</span><span> </span><span>--</span><span> </span><span class="entity"><span>where_alt_props_of_parser</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>primcorec_cmd</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gfp_rec_sugar_interpretation</span></span><span> </span><span class="entity"><span>transfer_plugin</span></span><span>
  </span><span class="entity"><span>gfp_rec_sugar_transfer_interpretation</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>