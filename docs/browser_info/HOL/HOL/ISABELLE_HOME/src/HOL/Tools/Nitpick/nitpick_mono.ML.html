<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nitpick/nitpick_mono.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nitpick/nitpick_mono.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nitpick/nitpick_mono.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2009, 2010

Monotonicity inference for higher-order logic.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NITPICK_MONO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_HOL.hol_context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Unsynchronized.ref</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> formulas_monotonic </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nitpick_Mono</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NITPICK_MONO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_HOL</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>sign</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Minus</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>annotation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Gen</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Fls</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tru</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>annotation_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> annotation </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> var

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>assign_literal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>sign</span></span><span> * </span><span class="entity"><span>annotation</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mtyp</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>MFun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mtyp * annotation_atom * mtyp </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>MPair</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mtyp * mtyp </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>MType</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * mtyp list </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>MRec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * typ list

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>hol_ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>hol_context</span></span><span class="main"><span>,</span></span><span>
   binarize</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   alpha_T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   max_fresh</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
   data_type_mcache</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>mtyp</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Unsynchronized.ref</span><span class="main"><span>,</span></span><span>
   constr_mcache</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>mtyp</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Unsynchronized.ref</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>mtyp</span></span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_sign</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"+"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_sign</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negate_sign</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Minus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>negate_sign</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plus</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>string_for_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>signed_string_of_int</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_vars</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"0⇘"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"⇙"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_vars</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_for_var</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subscript_string_for_vars</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"⇘"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_vars</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"⇙"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>Gen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"G"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>New</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"N"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>Fls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"F"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>Tru</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"T"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>a</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>string_for_var</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>string_for_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>" ≠ "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
  </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>a</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bool_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummy_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nitpick_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"dummy"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_MRec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_MRec</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>z</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_MFun</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.dest_MFun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_prec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>100</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>precedence_of_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>precedence_of_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>precedence_of_mtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_prec</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>outer_prec</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>precedence_of_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>need_parens</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prec</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>outer_prec</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>need_parens</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dummy_M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="inner_quoted"><span>"_"</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"α"</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prec</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" ⇒⇗"</span></span><span> </span><span>^</span><span>
             </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"⇖ "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>M2</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prec</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" × "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>M2</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>prop</span><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"o"</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>need_parens</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flatten_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>flatten_mtype</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flatten_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>flatten_mtype</span></span><span> </span><span class="entity"><span>Ms</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flatten_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>initial_mdata</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span class="main"><span>,</span></span><span> binarize </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> alpha_T </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>,</span></span><span>
    max_fresh </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> data_type_mcache </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    constr_mcache </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_exist_alpha_subtype</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_fp_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                        </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>could_exist_alpha_subtype</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_exist_alpha_subtype</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_exist_alpha_sub_mtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alpha_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>could_exist_alpha_subtype</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_exist_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_data_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>exists</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>exists</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>Ms</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>exists</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>exists</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="entity"><span>Ms</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constr_mtype_for_binders</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>curry3</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="entity"><span>Mp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Mp</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten_mtype</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>MRec</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_data_type_mcache</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_one</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>cache</span></span><span>
          </span><span class="main"><span>(</span></span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>List.app</span><span> </span><span class="entity"><span>repair_one</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_constr_mcache</span></span><span> </span><span class="entity"><span>dtype_cache</span></span><span> </span><span class="entity"><span>constr_mcache</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_one</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>constr_mcache</span></span><span>
          </span><span class="main"><span>(</span></span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repair_mtype</span></span><span> </span><span class="entity"><span>dtype_cache</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>List.app</span><span> </span><span class="entity"><span>repair_one</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_fin_fun_supported_type</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_fin_fun_supported_type</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_fin_fun_supported_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_fin_fun_supported_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="comment1"><span>(* TODO: clean this up *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="entity"><span>dom_T</span></span><span> </span><span class="entity"><span>ran_T</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span>
                  </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span>NONE</span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="entity"><span>dom_T</span></span><span> </span><span class="entity"><span>ran_T</span></span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.is_unknown|const"><span>is_unknown</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom_T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span>
                </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unknown|const"><span>unknown</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ran_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="comment1"><span>(* FIXME: make sure well-annotated *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_mfun_for_fun_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>max_fresh</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_minus</span></span><span>
                            </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>all_minus</span></span><span> </span><span class="entity"><span>T1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>all_minus</span></span><span> </span><span class="entity"><span>T2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>all_minus</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                </span><span class="entity"><span>is_fin_fun_supported_type</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
               </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
               </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>,</span></span><span>
                                    </span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>all_minus</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>MAlpha</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fresh_mfun_for_fun_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>all_minus</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>could_exist_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>M</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>data_type_mcache</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MRec</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarized_and_boxed_data_type_constrs</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>T</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_Ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_Ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binder_Ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_Ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>exists_alpha_sub_mtype_fresh</span></span><span>
                                                   </span><span class="entity"><span>binder_Ms</span></span><span>
                               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr_mtype_for_binders</span></span><span> </span><span class="entity"><span>z</span></span><span>
                                                                       </span><span class="entity"><span>binder_Ms</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                               </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_Ms</span></span><span> </span><span class="entity"><span>all_Ms</span></span><span class="main"><span>,</span></span><span>
                                </span><span class="entity"><span>constr_M</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>constr_Ms</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_Ms</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>data_type_mcache</span></span><span>
                          </span><span class="main"><span>(</span></span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>constr_mcache</span></span><span>
                          </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>constr_Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_MRec</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>repair_data_type_mcache</span></span><span> </span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>;</span></span><span>
                 </span><span class="entity"><span>repair_constr_mcache</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>;</span></span><span>
                 </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>data_type_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>M</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simple_string_of_typ</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ground_and_sole_base_constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="comment1"><span>(* FIXME: [@{const_name Nil}, @{const_name None}], cf. lists_empty *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prodM_factors</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>prodM_factors</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prodM_factors</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>curried_strip_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>curried_strip_mtype</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prodM_factors</span></span><span> </span><span class="entity"><span>M1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>curried_strip_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_mtype_from_constr_mtype</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dataM</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curried_strip_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ground_and_sole_base_constrs</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>constr_name_for_sel_like</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>Fls</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>Gen</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dataM</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sel_no_from_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bool_M</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>arg_Ms</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mtype_for_constr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>,</span></span><span>
                                </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>could_exist_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>M</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span>Unsynchronized.change</span><span> </span><span class="entity"><span>constr_mcache</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                 </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>constr_mcache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>T</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mtype_for_sel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>hol_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>binarized_and_boxed_constr_for_sel</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_constr</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>sel_mtype_from_constr_mtype</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_annotation_atom</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>resolve_annotation_atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aa</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_mtype</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>resolve_annotation_atom</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="entity"><span>Mp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>Mp</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRec</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MRec</span></span><span> </span><span class="entity"><span>z</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>comp_op</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Leq</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>annotation_atom</span></span><span> * </span><span class="entity"><span>annotation_atom</span></span><span> * </span><span class="entity"><span>comp_op</span></span><span> * </span><span class="entity"><span>var</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>assign_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assign_literal</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>constraint_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>assign_clause</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"≠"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"≤"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span>^</span><span>
  </span><span class="entity"><span>subscript_string_for_vars</span></span><span> </span><span class="inner_quoted"><span>" ∧ "</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_assign_clause</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"⊤"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_assign_clause</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\&lt;bot&gt;"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_for_assign_clause</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>asgs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" ∨ "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_for_assign_literal</span></span><span> </span><span class="entity"><span>asgs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sn'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>sn'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_assign_disjunct</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_assign_disjunct</span></span><span> </span><span class="entity"><span>asg</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>asgs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asg</span></span><span> </span><span class="entity"><span>asgs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_assign_clause</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_assign_clause</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>clause</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clause</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sign_for_comp_op</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sign_for_comp_op</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Minus</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sign_for_comp_op</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"sign_for_comp_op"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"unexpected \"Leq\""</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cset</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Leq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cset</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>clauses</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign_for_comp_op</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>comps</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>cset</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Add "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"**** Unsolvable"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cset</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>M11</span></span><span> </span><span class="entity"><span>M21</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>M12</span></span><span> </span><span class="entity"><span>M22</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>M11</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>M21</span></span><span> </span><span class="entity"><span>M11</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>M11</span></span><span> </span><span class="entity"><span>M21</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M11</span></span><span> </span><span class="entity"><span>M21</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>M12</span></span><span> </span><span class="entity"><span>M22</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>M11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M21</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M12</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M22</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
     </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ListPair.UnequalLengths</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.do_mtype_comp"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span class="comment1"><span>(* no need to compare them thanks to the cache *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.do_mtype_comp ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_mtype_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Add "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
                       </span><span class="entity"><span>string_for_comp_op</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_mtype_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"**** Unsolvable"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_mtypes_equal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mtype_comp</span></span><span> </span><span class="entity"><span>Eq</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_is_sub_mtype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_mtype_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cset</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>asg</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>clauses</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_assign_literal</span></span><span> </span><span class="entity"><span>asg</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Gen</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M1</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Gen</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M1</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>add_assign_disjunct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>unless</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>unless'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless'</span></span><span> </span><span class="entity"><span>M1</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M1</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_assign_disjunct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Fls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>]</span></span><span>
                       </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>unless</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>unless'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>unless'</span></span><span> </span><span class="entity"><span>M1</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ms</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.do_notin_mtype_fv"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Add "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is "</span></span><span> </span><span>^</span><span>
                       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"concrete"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"complete"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_notin_mtype_fv</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"**** Unsolvable"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_mtype_is_concrete</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>z</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_mtype_is_complete</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_notin_mtype_fv</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>z</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bool_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>New</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Fls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Tru</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fst_var</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>n</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>snd_var</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bools_from_annotation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bool_table</span></span><span> </span><span>#&gt;</span><span> </span><span>the</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>annotation_from_bools</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.find</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bool_table</span></span><span> </span><span>#&gt;</span><span> </span><span>the_single</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_bool</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Prop_Logic.True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Prop_Logic.False</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_bool_var_equality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Prop_Logic.SAnd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.SOr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span>
                                   </span><span class="entity"><span>Prop_Logic.SNot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="entity"><span>Prop_Logic.SOr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.SNot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>v1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                   </span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bools_from_annotation</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Prop_Logic.SAnd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fst_var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>b1</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Prop_Logic.SNot</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="entity"><span>Prop_Logic.BoolVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>snd_var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>b2</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Prop_Logic.SNot</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_for_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Minus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SNot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_atom_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_for_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_atom_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_for_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_atom_equality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_for_atom_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_atom_equality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_for_atom_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_atom_equality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SAnd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_bool_var_equality</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>fst_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>prop_for_bool_var_equality</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>snd_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_for_assign_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prop_Logic.exists</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>prop_for_assign_literal</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_exists_var_assign_literal</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Prop_Logic.exists</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prop_for_assign_literal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SAnd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Leq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Leq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SNot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Leq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SOr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_atom_equality</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>prop_for_atom_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Prop_Logic.SOr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_for_exists_var_assign_literal</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_assigns</span></span><span> </span><span class="entity"><span>max_var</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="entity"><span>accum</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fst_var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>snd_var</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annotation_from_bools</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>::</span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>max_var</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asgs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_problem</span></span><span> </span><span class="entity"><span>comps</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Problem:\n"</span></span><span> </span><span>^</span><span>
                      </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_for_comp</span></span><span> </span><span class="entity"><span>comps</span></span><span> </span><span>@</span><span>
                                 </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_for_assign_clause</span></span><span> </span><span>o</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_solution</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Solution:\n"</span></span><span> </span><span>^</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>asgs</span></span><span>
       </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>swap</span><span>
       </span><span>|&gt;</span><span> </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
       </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_for_annotation</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span>
                             </span><span class="entity"><span>string_for_vars</span></span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span>int_ord</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span>|&gt;</span><span> </span><span>cat_lines</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* The ML solver timeout should correspond more or less to the overhead of invoking an external
   prover. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml_solver_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.02</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve</span></span><span> </span><span class="entity"><span>tac_timeout</span></span><span> </span><span class="entity"><span>max_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_assigns</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_assigns</span></span><span> </span><span class="entity"><span>max_var</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="entity"><span>print_solution</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_problem</span></span><span> </span><span class="entity"><span>comps</span></span><span> </span><span class="entity"><span>clauses</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Prop_Logic.all</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>prop_for_comp</span></span><span> </span><span class="entity"><span>comps</span></span><span> </span><span>@</span><span>
                      </span><span>map</span><span> </span><span class="entity"><span>prop_for_assign_clause</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Prop_Logic.eval</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>do_assigns</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Prop_Logic.eval</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>do_assigns</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(* use the first ML solver (to avoid startup overhead) *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ml_solvers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nonml_solvers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>SAT_Solver.get_solvers</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"dptsat"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"cdclite"</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>nonml_solvers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>Timeout.apply</span><span> </span><span class="entity"><span>tac_timeout</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ml_solvers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>Timeout.apply</span><span> </span><span class="entity"><span>ml_solver_timeout</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ml_solvers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span>Timeout.apply</span><span> </span><span class="entity"><span>tac_timeout</span></span><span>
                                       </span><span class="main"><span>(</span></span><span class="entity"><span>SAT_Solver.invoke_solver</span></span><span> </span><span class="inner_quoted"><span>"auto"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>SAT_Solver.SATISFIABLE</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_assigns</span></span><span> </span><span class="entity"><span>assigns</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** Unsolvable"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** Timed out"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mcontext</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>bound_Ts</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   bound_Ms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mtyp</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   frame</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>annotation_atom</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   frees</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>mtyp</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   consts</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>mtyp</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" :⇗"</span></span><span> </span><span>^</span><span>
  </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"⇖ "</span></span><span> </span><span>^</span><span>
  </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_free</span></span><span> </span><span class="entity"><span>relevant_frees</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>relevant_frees</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" : "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mcontext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_for_free</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_free_names</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span>@</span><span>
   </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_for_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>commas</span><span> </span><span>|&gt;</span><span> </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span class="inner_quoted"><span>"]"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>initial_gamma</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> frame </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> frees </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_bound</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span>
   frame </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pop_bound</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span>
   frame </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>List.Empty</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>initial_gamma</span></span><span> </span><span class="comment1"><span>(* FIXME: needed? *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mcontext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> frame </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span>
   consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_bound_frame</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_frame</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frame</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>new_frame</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>gen_frame</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>max_fresh</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fls</span></span><span> </span><span class="entity"><span>tru</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tru</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conj_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disj_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>imp_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aa2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Neq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meta_conj_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"∧"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conj_clauses</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meta_imp_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"\&lt;implies&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp_clauses</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"∧"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conj_clauses</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disj_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"∨"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disj_clauses</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imp_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"\&lt;implies&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp_clauses</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>annotation_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="entity"><span>a'</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="entity"><span>accum</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="entity"><span>accum</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign_for_comp_op</span></span><span> </span><span class="entity"><span>cmp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assign_clause_from_quasi_clause</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_annotation_clause_from_quasi_clause</span></span><span> </span><span class="entity"><span>unless</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_connective_var</span></span><span> </span><span class="entity"><span>conn</span></span><span> </span><span class="entity"><span>mk_quasi_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Add "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span>
                       </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>conn</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span>
                       </span><span class="entity"><span>string_for_annotation_atom</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_assign_clause</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>assign_clause_from_quasi_clause</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mk_quasi_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_connective_frames</span></span><span> </span><span class="entity"><span>conn</span></span><span> </span><span class="entity"><span>mk_quasi_clauses</span></span><span> </span><span class="entity"><span>res_frame</span></span><span> </span><span class="entity"><span>frame1</span></span><span> </span><span class="entity"><span>frame2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_aa</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="entity"><span>add_connective_var</span></span><span> </span><span class="entity"><span>conn</span></span><span> </span><span class="entity"><span>mk_quasi_clauses</span></span><span> </span><span class="entity"><span>res_aa</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span class="main"><span>)</span></span><span>
               </span><span class="entity"><span>res_frame</span></span><span> </span><span class="entity"><span>frame1</span></span><span> </span><span class="entity"><span>frame2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kill_unused_in_frame</span></span><span> </span><span class="entity"><span>is_in</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mcontext</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used_frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unused_frame</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>is_in</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>used_frame</span></span><span>
          </span><span>||&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>unused_frame</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_frame</span></span><span> </span><span class="entity"><span>is_in_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mcontext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bubble</span></span><span> </span><span class="entity"><span>fun_frame</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>fun_frame</span></span><span class="main"><span>,</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>arg_frame</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bubble</span></span><span> </span><span class="entity"><span>fun_frame</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_in_fun</span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>bubble</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fun_frame</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span> </span><span class="entity"><span>rest</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>bubble</span></span><span> </span><span class="entity"><span>fun_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_frame</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="entity"><span>cset</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>bubble</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span>||&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>gamma</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_annotation_atom_comp_alt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_annotation_atom_comp_alt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** Expected G"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_annotation_atom_comp_alt</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>aa1</span></span><span> </span><span class="entity"><span>aa2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_arg_order1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_aa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="entity"><span>add_annotation_atom_comp_alt</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="entity"><span>prev_aa</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aa</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_app1</span></span><span> </span><span class="entity"><span>fun_aa</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_aa</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_aa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>arg_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_aa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                 </span><span>|&gt;</span><span> </span><span class="entity"><span>assign_clause_from_quasi_clause</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"*** Add "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_assign_clause</span></span><span> </span><span class="entity"><span>clause</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_assign_clause</span></span><span> </span><span class="entity"><span>clause</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp_alt</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>arg_aa</span></span><span> </span><span class="entity"><span>fun_aa</span></span><span> </span><span class="entity"><span>res_aa</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_app</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_app</span></span><span> </span><span class="entity"><span>fun_aa</span></span><span> </span><span class="entity"><span>res_frame</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>arg_frame</span></span><span>
    </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_arg_order1</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>arg_frame</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>arg_frame</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_app1</span></span><span> </span><span class="entity"><span>fun_aa</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_frame</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>arg_frame</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_connective</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_quasi_clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>do_t1</span></span><span> </span><span class="entity"><span>do_t2</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_frame</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>frame</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_frame</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>frame</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_t1</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_t2</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame</span></span><span>
          </span><span>||&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_connective_frames</span></span><span> </span><span class="entity"><span>conn</span></span><span> </span><span class="entity"><span>mk_quasi_clauses</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="entity"><span>frame1</span></span><span>
                                           </span><span class="entity"><span>frame2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_fresh</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_enough_eta_expanded</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_built_in_const</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;=</span><span> </span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_M</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_mtype_is_complete</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>abs_M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nth_range_type</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_mtype_is_concrete</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>M</span></span><span>
                      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_robust_set_operation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>set_T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>set_T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>set_T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_is_sub_mtype</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="entity"><span>M3</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_is_sub_mtype</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="entity"><span>M3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_fragile_set_operation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>set_T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>set_M</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>custom_mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_mtype_is_concrete</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>set_M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_pair_constr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nth_range_type</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>M</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.consider_term.do_pair_constr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_nth_pair_sel</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>M</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>MPair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>a_M</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>b_M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.consider_term.do_nth_pair_sel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>bool_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consider_connective</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>gamma</span></span><span> </span><span>^</span><span>
                           </span><span class="inner_quoted"><span>" ⊢ "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span>
                           </span><span class="inner_quoted"><span>" : _?"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bool_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bool_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Tru</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="comment1"><span>(* hack to exploit symmetry of equality when typing "insert" *)</span></span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>could_exist_alpha_subtype</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_T</span></span><span class="main"><span>,</span></span><span>
                              </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span>
                                  </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>set_T</span></span><span class="main"><span>,</span></span><span>
                                        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                   </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.The|const"><span>The</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** The"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Hilbert_Choice.html#Hilbert_Choice.Eps|const"><span>Eps</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** Eps"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>do_robust_set_operation</span></span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
              </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>curry3</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="entity"><span>bool_M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_pair_constr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.fst|const"><span>fst</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_nth_pair_sel</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.snd|const"><span>snd</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_nth_pair_sel</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.Id|const"><span>Id</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elem_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.converse|const"><span>converse</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ab_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ba_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ab_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ba_set_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Transitive_Closure.html#Transitive_Closure.trancl|const"><span>trancl</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_fragile_set_operation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcomp|const"><span>relcomp</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bc_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ab_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ac_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_range_type</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bc_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ab_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ac_set_M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Finite_Set.html#Finite_Set.finite|const"><span>finite</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elem_type</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_alpha_sub_mtype</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Fls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Gen</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.prod|const"><span>prod</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_set_M</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>range_type</span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ab_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_range_type</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mtype_for_set</span></span><span> </span><span class="entity"><span>x</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ab_set_M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Neq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>New</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.safe_The|const"><span>safe_The</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_set_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_MFun</span></span><span> </span><span class="entity"><span>a_set_M</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_set_M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_M</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>ord_class.less_eq</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                      </span><span class="entity"><span>is_set_like_type</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>do_fragile_set_operation</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_sel</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for_sel</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_constr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for_constr</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_built_in_const</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> frame </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span>
                        frees </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
           </span><span>||&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>bound_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> bound_Ms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_Ms</span></span><span class="main"><span>,</span></span><span> frame </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span>
                      frees </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> consts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
           </span><span>||&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_comp_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Eq</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"*** Var"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>bound_Ms</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_bound_frame</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fin_fun_body</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>push_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>pop_bound</span></span><span>
                       </span><span>||&gt;</span><span> </span><span class="entity"><span>add_annotation_atom_comp</span></span><span> </span><span class="entity"><span>Leq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Fls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="entity"><span>t1'</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                     </span><span class="entity"><span>is_enough_eta_expanded</span></span><span> </span><span class="entity"><span>t1'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t11</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t13</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t13</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t11</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t13</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>T</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>push_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>pop_bound</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>imp_spec</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="entity"><span>accum</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>conj_spec</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>disj_spec</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>imp_spec</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_in</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>frame</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>kill_unused_in_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_in</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>frame1a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame1b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>split_frame</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_in</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame2a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame1a</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame2b</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="entity"><span>frame1b</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>(</span></span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame2a</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>frame2b</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame1a</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t1</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t2</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M12</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_MFun</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>M12</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>set_frame</span></span><span> </span><span class="entity"><span>frame</span></span><span>
                           </span><span>||&gt;</span><span> </span><span class="entity"><span>add_is_sub_mtype</span></span><span> </span><span class="entity"><span>M2</span></span><span> </span><span class="entity"><span>M11</span></span><span>
                           </span><span>||&gt;</span><span> </span><span class="entity"><span>add_app</span></span><span> </span><span class="entity"><span>aa</span></span><span> </span><span class="entity"><span>frame1b</span></span><span> </span><span class="entity"><span>frame2b</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>gamma</span></span><span> </span><span>^</span><span>
                                       </span><span class="inner_quoted"><span>" ⊢ "</span></span><span> </span><span>^</span><span>
                                       </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" : "</span></span><span> </span><span>^</span><span>
                                       </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>force_gen_funs</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>force_gen_funs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>add_mtypes_equal</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>force_gen_funs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>force_gen_funs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.force_gen_funs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>M</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_general_equals</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>M2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>add_mtypes_equal</span></span><span> </span><span class="entity"><span>M1</span></span><span> </span><span class="entity"><span>M2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head_M1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>head1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>force_gen_funs</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>head_M1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>accum</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_general_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_fresh</span></span><span class="main"><span>,</span></span><span>
                                        </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="entity"><span>mdata</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_quantifier</span></span><span> </span><span class="entity"><span>quant_s</span></span><span> </span><span class="entity"><span>abs_T</span></span><span> </span><span class="entity"><span>body_t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_M</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>abs_T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.inc</span><span> </span><span class="entity"><span>max_fresh</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>side_cond</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Minus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ann</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>quant_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Fls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Tru</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>accum</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>side_cond</span></span><span>
                      </span><span>?</span><span> </span><span class="entity"><span>add_mtype_is_complete</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ann</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>abs_M</span></span><span>
                  </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>push_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs_T</span></span><span> </span><span class="entity"><span>abs_M</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>body_t</span></span><span>
                  </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>pop_bound</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>neg1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>consider_connective</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>spec</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sn</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>neg1</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>negate_sign</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>accum</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>consider_general_equals</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>gamma</span></span><span> </span><span>^</span><span>
                            </span><span class="inner_quoted"><span>" ⊢ "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span>
                            </span><span class="inner_quoted"><span>" : o⇧"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_sign</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"?"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>do_quantifier</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>do_quantifier</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_quantifier</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1'</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Minus</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="comment1"><span>(* FIXME: Needed? *)</span></span><span>
             </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span>
                      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span>
                         </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_equals</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>sn</span></span><span> </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.conjunction</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>meta_conj_spec</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>meta_imp_spec</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>imp_spec</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>conj_spec</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>disj_spec</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_connect</span></span><span> </span><span class="entity"><span>imp_spec</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_for_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>gamma</span></span><span> </span><span>^</span><span>
                                     </span><span class="inner_quoted"><span>" ⊢ "</span></span><span> </span><span>^</span><span>
                                     </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span>
                                     </span><span class="inner_quoted"><span>" : o⇧"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_sign</span></span><span> </span><span class="entity"><span>sn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* The harmless axiom optimization below is somewhat too aggressive in the face
   of (rather peculiar) user-defined axioms. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>harmless_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>ord_class.less</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>ord_class.less_eq</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounteous_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim|const"><span>bisim</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_harmless_axiom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Term.add_consts</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_built_in_const</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>harmless_consts</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>original_name</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>orf</span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounteous_consts</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_nondefinitional_axiom</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_harmless_axiom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>consider_general_formula</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_definitional_axiom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>hol_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_constr_pattern_formula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>consider_nondefinitional_axiom</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_harmless_axiom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mtype_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_mtype_for_type</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span class="entity"><span>consider_term</span></span><span> </span><span class="entity"><span>mdata</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>abs_T</span></span><span> </span><span class="entity"><span>body_t</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>push_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Gen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs_T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mtype_for</span></span><span> </span><span class="entity"><span>abs_T</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>body_t</span></span><span>
              </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>pop_bound</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_implies</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>consider_general_equals</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_implies</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.conjunction</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_formula</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_all</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>consider_general_equals</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_formula</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_implies</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Mono.consider_definitional_axiom.\
                           \do_formula"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_for_mtype_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" : "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resolve_mtype</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mcontext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_for_mtype_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span>@</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_for_mtype_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>cat_lines</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>formulas_monotonic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac_timeout</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>nondef_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trace_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"****** Monotonicity analysis: "</span></span><span> </span><span>^</span><span>
                                </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>MAlpha</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is "</span></span><span> </span><span>^</span><span>
                                </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>max_fresh</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initial_mdata</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>alpha_T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>initial_gamma</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>consider_general_formula</span></span><span> </span><span class="entity"><span>mdata</span></span><span> </span><span class="entity"><span>Plus</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>nondef_ts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consider_nondefinitional_axiom</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>nondef_ts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consider_definitional_axiom</span></span><span> </span><span class="entity"><span>mdata</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>solve</span></span><span> </span><span class="entity"><span>tac_timeout</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>max_fresh</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_mcontext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>asgs</span></span><span> </span><span class="entity"><span>gamma</span></span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>UNSOLVABLE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MTYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loc</span></span><span class="main"><span>,</span></span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_for_mtype</span></span><span> </span><span class="entity"><span>Ms</span></span><span> </span><span>@</span><span>
                                 </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>